(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app.6d4550e2"],{"6a5c":function(e,t,o){},9197:function(e,t,o){"use strict";o("6a5c")},fc3d:function(e,t,o){"use strict";var r=function(){var e=this,t=e._self._c;return t("div",{staticClass:"existencias-crudos-container"},[t("h1",[e._v("Existencias de Crudos")]),t("div",{staticClass:"actions-container"},[t("router-link",{staticClass:"action-button new-entrada-btn",attrs:{to:"/existencias-crudos/new"}},[e._v(" Nueva Entrada/Salida ")]),t("button",{staticClass:"action-button",on:{click:e.showGestionarModal}},[e._v(" Gestionar Proveedores y Medidas ")]),t("button",{staticClass:"action-button",on:{click:e.imprimirReporte}},[e._v(" Imprimir Reporte ")])],1),t("div",{staticClass:"resumen-existencias"},[t("h2",[e._v("Resumen de Existencias Actuales")]),e.isLoadingExistencias?t("div",{staticClass:"loading"},[e._v("Cargando existencias...")]):0===Object.keys(e.existenciasPorProveedor).length?t("div",{staticClass:"no-existencias"},[e._v(" No hay existencias registradas. ")]):t("div",{staticClass:"existencias-grid"},e._l(e.existenciasPorProveedor,(function(o,r){return t("div",{key:r,staticClass:"proveedor-card"},[t("h3",[e._v(e._s(r))]),t("table",{staticClass:"productos-table"},[t("thead",[t("tr",[t("th",[e._v("Medida")]),t("th",[e._v("Kilos")]),t("th",[e._v("Taras")]),e.tienePreciosValidos(o)?t("th",[e._v("Precio")]):e._e(),e.tienePreciosValidos(o)?t("th",[e._v("Valor")]):e._e()])]),t("tbody",e._l(o,(function(r){return r.kilos>0?t("tr",{key:r.clave},[t("td",[e._v(e._s(r.nombre))]),t("td",{staticClass:"kilos-cell"},[e._v(e._s(e.formatNumber(r.kilos)))]),t("td",{staticClass:"taras-cell"},[e._v(e._s((r.kilos/19).toFixed(1)))]),e.tienePreciosValidos(o)?t("td",{staticClass:"precio-cell"},[e._v("$"+e._s(e.formatearPrecio(r.ultimoPrecio)))]):e._e(),e.tienePreciosValidos(o)?t("td",{staticClass:"valor-cell"},[e._v("$"+e._s(e.formatearValor(r.valor)))]):e._e()]):e._e()})),0)]),t("div",{staticClass:"total-proveedor"},[t("div",[t("strong",[e._v("Total "+e._s(r)+": "+e._s(e.formatNumber(e.calcularTotalProveedor(o)))+" kg")])]),e.tienePreciosValidos(o)?t("div",[t("strong",[e._v("Valor Total: $"+e._s(e.formatearValor(e.calcularTotalValorProveedor(o))))])]):e._e()])])})),0),t("div",{staticClass:"total-general"},[t("h3",[e._v("Total General: "+e._s(e.formatNumber(e.totalGeneral))+" kg")]),e.tieneAlgunPrecioValido?t("h3",[e._v("Valor Total General: $"+e._s(e.formatearValor(e.valorTotalGeneral)))]):e._e()])]),t("div",{staticClass:"registros-list"},[t("h2",[e._v("Registros Recientes")]),e.isLoadingRegistros?t("div",{staticClass:"loading"},[e._v("Cargando registros...")]):0===e.registros.length?t("div",{staticClass:"no-records"},[e._v(" No hay registros de crudos. ")]):t("ul",e._l(e.paginatedRegistros,(function(o){return t("li",{key:o.id,staticClass:"registro-item"},[t("div",{staticClass:"registro-content",on:{click:function(t){return e.editRegistro(o.id)}}},[t("span",{staticClass:"registro-date"},[e._v(e._s(e.formatDate(o.fecha)))]),t("div",{staticClass:"registro-summary"},[t("div",{staticClass:"registro-entry"},[t("span",{staticClass:"registro-label"},[e._v("Entradas:")]),t("span",{staticClass:"registro-value"},[e._v(e._s(e.formatNumber(o.totalEntradas))+" kg")])]),t("div",{staticClass:"registro-entry"},[t("span",{staticClass:"registro-label"},[e._v("Salidas:")]),t("span",{staticClass:"registro-value"},[e._v(e._s(e.formatNumber(o.totalSalidas))+" kg")])])])]),t("div",{staticClass:"registro-actions"},[t("button",{staticClass:"delete-btn",on:{click:function(t){return t.stopPropagation(),e.deleteRegistro(o.id)}}},[e._v("Borrar")])])])})),0),t("div",{staticClass:"pagination"},[t("button",{attrs:{disabled:1===e.currentPage},on:{click:e.prevPage}},[e._v("Anterior")]),t("span",[e._v("Página "+e._s(e.currentPage)+" de "+e._s(e.totalPages))]),t("button",{attrs:{disabled:e.currentPage===e.totalPages},on:{click:e.nextPage}},[e._v("Siguiente")])])]),t("GestionProveedoresCrudos",{attrs:{mostrar:e.showGestionModal},on:{cerrar:e.closeGestionarModal,actualizado:e.onProveedoresActualizados}})],1)},a=[],i=(o("14d9"),o("13d5"),o("fa1c"),o("dc59")),s=o("1494"),n=o("c1df"),c=o.n(n),l=o("8cca"),d={name:"ExistenciasCrudos",components:{GestionProveedoresCrudos:l["a"]},data(){return{registros:[],existenciasPorProveedor:{},isLoadingRegistros:!0,isLoadingExistencias:!0,currentPage:1,itemsPerPage:10,showGestionModal:!1}},computed:{paginatedRegistros(){const e=(this.currentPage-1)*this.itemsPerPage,t=e+this.itemsPerPage;return this.registros.slice(e,t)},totalPages(){return Math.ceil(this.registros.length/this.itemsPerPage)},totalGeneral(){return Object.values(this.existenciasPorProveedor).flat().reduce((e,t)=>e+t.kilos,0)},valorTotalGeneral(){return Object.values(this.existenciasPorProveedor).flat().reduce((e,t)=>e+t.valor,0)},tieneAlgunPrecioValido(){return Object.values(this.existenciasPorProveedor).some(e=>e.some(e=>e.ultimoPrecio>0||e.valor>0))}},methods:{async loadRegistros(){try{this.isLoadingRegistros=!0;const e=Object(s["c"])(i["a"],"existenciasCrudos"),t=Object(s["o"])(e,Object(s["l"])("fecha","desc")),o=await Object(s["g"])(t);this.registros=o.docs.map(e=>{const t=e.data();let o;return o=t.fecha instanceof Date?c()(t.fecha).toDate():t.fecha&&"function"===typeof t.fecha.toDate?c()(t.fecha.toDate()).toDate():c()(t.fecha).toDate(),{id:e.id,...t,fecha:o,totalEntradas:t.totalEntradas||0,totalSalidas:t.totalSalidas||0}})}catch(e){console.error("Error al cargar registros de crudos: ",e),this.registros=[]}finally{this.isLoadingRegistros=!1}},async loadExistencias(){try{this.isLoadingExistencias=!0;const e=await Object(s["g"])(Object(s["c"])(i["a"],"existenciasCrudos")),t={},o=e.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>{const o=e.fecha instanceof Date?e.fecha:e.fecha.toDate(),r=t.fecha instanceof Date?t.fecha:t.fecha.toDate();return o-r});o.forEach(e=>{e.entradas&&e.entradas.forEach(e=>{t[e.proveedor]||(t[e.proveedor]={});const o=e.precio?e.precio.toString():"sin_precio",r=`${e.producto}_${o}`;t[e.proveedor][r]||(t[e.proveedor][r]={nombre:e.producto,kilos:0,ultimoPrecio:e.precio||0,proveedor:e.proveedor,producto:e.producto}),t[e.proveedor][r].kilos+=e.kilos,e.precio&&(t[e.proveedor][r].ultimoPrecio=e.precio)}),e.salidas&&e.salidas.forEach(e=>{t[e.proveedor]||(t[e.proveedor]={});const o=Object.keys(t[e.proveedor]).filter(o=>t[e.proveedor][o].producto===e.producto).sort((o,r)=>{const a=t[e.proveedor][o].ultimoPrecio,i=t[e.proveedor][r].ultimoPrecio;return a-i});let r=e.kilos;for(const a of o){if(r<=0)break;const o=t[e.proveedor][a];if(o.kilos>0){const e=Math.min(r,o.kilos);o.kilos-=e,r-=e}}})}),await this.actualizarPreciosDelHistorial(t);const r={};Object.keys(t).forEach(e=>{const o=Object.values(t[e]).filter(e=>e.kilos>0).map(e=>({...e,clave:`${e.producto}_${e.ultimoPrecio}`,valor:e.kilos*e.ultimoPrecio}));o.length>0&&(r[e]=o)}),this.existenciasPorProveedor=r}catch(e){console.error("Error al cargar existencias de crudos: ",e),this.existenciasPorProveedor={}}finally{this.isLoadingExistencias=!1}},async actualizarPreciosDelHistorial(e){try{const t=await Object(s["g"])(Object(s["c"])(i["a"],"historialPreciosCrudos")),o={};t.docs.forEach(e=>{const t=e.data(),r=`${t.proveedor}_${t.medida}`;o[r]||(o[r]=[]),o[r].push({precio:t.precio,fecha:t.fecha instanceof Date?t.fecha:t.fecha.toDate()})}),Object.keys(o).forEach(e=>{o[e].sort((e,t)=>t.fecha-e.fecha)}),Object.keys(e).forEach(t=>{Object.keys(e[t]).forEach(r=>{const a=e[t][r];if(0===a.ultimoPrecio){const e=`${t}_${a.producto}`;o[e]&&o[e].length>0&&(a.ultimoPrecio=o[e][0].precio)}})})}catch(t){console.error("Error al actualizar precios del historial: ",t)}},formatDate(e){return c()(e).format("DD [de] MMMM [de] YYYY")},formatNumber(e){return(e||0).toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:0})},formatearPrecio(e){return e?e.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00"},formatearValor(e){return e?e.toLocaleString("es-MX",{minimumFractionDigits:0,maximumFractionDigits:0}):"0"},calcularTotalProveedor(e){return e.reduce((e,t)=>e+t.kilos,0)},calcularTotalValorProveedor(e){return e.reduce((e,t)=>e+t.valor,0)},tienePreciosValidos(e){return e.some(e=>e.ultimoPrecio>0||e.valor>0)},editRegistro(e){this.$router.push("/existencias-crudos/"+e)},async deleteRegistro(e){if(confirm("¿Estás seguro de que quieres borrar este registro de crudos?"))try{await Object(s["d"])(Object(s["e"])(i["a"],"existenciasCrudos",e)),this.registros=this.registros.filter(t=>t.id!==e),await this.loadExistencias(),alert("Registro de crudos borrado con éxito")}catch(t){console.error("Error al borrar el registro de crudos: ",t),alert("Error al borrar el registro de crudos")}},prevPage(){this.currentPage>1&&this.currentPage--},nextPage(){this.currentPage<this.totalPages&&this.currentPage++},showGestionarModal(){this.showGestionModal=!0},closeGestionarModal(){this.showGestionModal=!1},imprimirReporte(){const e=(new Date).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"}),t='\n        <style>\n          @page { \n            size: A4 landscape; \n            margin: 0.5cm 0.5cm;\n            @bottom-right {\n              content: "Página " counter(page) " de " counter(pages);\n              font-size: 11pt;\n            }\n          }\n          body {\n            font-family: Arial, sans-serif;\n            font-size: 16pt;\n            line-height: 1.2;\n            color: #333;\n            margin: 0;\n            padding: 0;\n          }\n          .header {\n            margin-bottom: 15px;\n            padding-bottom: 8px;\n            text-align: center;\n          }\n          h1 {\n            color: #3760b0;\n            font-size: 26pt;\n            margin: 0;\n            padding: 0;\n          }\n          .fecha-reporte {\n            font-size: 18pt;\n            color: #666;\n            margin-top: 5px;\n          }\n          .existencias-grid {\n            display: grid;\n            grid-template-columns: repeat(4, 1fr);\n            gap: 12px;\n            margin-top: 15px;\n          }\n          .proveedor-card {\n            background-color: white;\n            border: 2px solid #3760b0;\n            border-radius: 8px;\n            padding: 12px;\n            break-inside: avoid;\n            page-break-inside: avoid;\n          }\n          .proveedor-card h2 {\n            color: #3760b0;\n            font-size: 20pt;\n            margin: 0 0 8px 0;\n            padding-bottom: 6px;\n            border-bottom: 2px solid #3760b0;\n          }\n          table {\n            width: 100%;\n            border-collapse: collapse;\n            margin-top: 8px;\n          }\n          th {\n            background-color: #3760b0;\n            color: white;\n            text-align: left;\n            padding: 6px;\n            font-size: 14pt;\n            border: 1px solid #3760b0;\n          }\n          td {\n            padding: 5px 6px;\n            font-size: 14pt;\n            border: 1px solid #ddd;\n          }\n          tr:nth-child(even) {\n            background-color: #f8f9fa;\n          }\n          .kilos-cell, .taras-cell, .precio-cell, .valor-cell {\n            text-align: right;\n            font-weight: bold;\n          }\n          .taras-cell {\n            color: #3760b0;\n          }\n          .precio-cell {\n            color: #2c3e50;\n          }\n          .valor-cell {\n            color: #27ae60;\n          }\n          .total-proveedor {\n            text-align: right;\n            font-size: 14pt;\n            color: #3760b0;\n            font-weight: bold;\n            margin-top: 8px;\n          }\n          .total-general {\n            margin-top: 20px;\n            text-align: center;\n            background-color: #f0f4f8;\n            padding: 15px;\n            border-radius: 8px;\n            border: 2px solid #3760b0;\n          }\n          .total-general h2 {\n            color: #3760b0;\n            font-size: 22pt;\n            margin: 0;\n          }\n          @media print {\n            .existencias-grid {\n              display: grid;\n              grid-template-columns: repeat(4, 1fr);\n            }\n            .proveedor-card {\n              break-inside: avoid;\n              page-break-inside: avoid;\n            }\n            .total-general {\n              break-before: avoid;\n              page-break-before: avoid;\n            }\n          }\n        </style>\n      ';let o=`\n        ${t}\n        <div class="header">\n          <h1>Reporte de Existencias de Crudos</h1>\n          <div class="fecha-reporte">Fecha: ${e}</div>\n        </div>\n        <div class="existencias-grid">\n      `;Object.keys(this.existenciasPorProveedor).forEach(e=>{const t=this.existenciasPorProveedor[e],r=this.tienePreciosValidos(t);o+=`\n          <div class="proveedor-card">\n            <h2>${e}</h2>\n            <table>\n              <thead>\n                <tr>\n                  <th>Medida</th>\n                  <th>Kilos</th>\n                  <th>Taras</th>\n                  ${r?"<th>Precio</th>":""}\n                  ${r?"<th>Valor</th>":""}\n                </tr>\n              </thead>\n              <tbody>\n        `,t.forEach(e=>{o+=`\n            <tr>\n              <td>${e.nombre}</td>\n              <td class="kilos-cell">${this.formatNumber(e.kilos)}</td>\n              <td class="taras-cell">${(e.kilos/19).toFixed(1)}</td>\n              ${r?`<td class="precio-cell">$${this.formatearPrecio(e.ultimoPrecio)}</td>`:""}\n              ${r?`<td class="valor-cell">$${this.formatearValor(e.valor)}</td>`:""}\n            </tr>\n          `}),o+=`\n              </tbody>\n            </table>\n            <div class="total-proveedor">\n              <div>Total ${e}: ${this.formatNumber(this.calcularTotalProveedor(t))} kg</div>\n              ${r?`<div>Valor Total: $${this.formatearValor(this.calcularTotalValorProveedor(t))}</div>`:""}\n            </div>\n          </div>\n        `});const r=Object.values(this.existenciasPorProveedor).some(e=>this.tienePreciosValidos(e));o+=`\n        </div>\n        <div class="total-general">\n          <h2>Total General: ${this.formatNumber(this.totalGeneral)} kg</h2>\n          ${r?`<h2>Valor Total General: $${this.formatearValor(this.valorTotalGeneral)}</h2>`:""}\n        </div>\n      `;const a=window.open("","_blank");a.document.write(o),a.document.close(),setTimeout(()=>{a.print(),a.close()},250)},async onProveedoresActualizados(){await this.loadExistencias()}},async mounted(){await Promise.all([this.loadRegistros(),this.loadExistencias()])}},g=d,u=(o("9197"),o("2877")),h=Object(u["a"])(g,r,a,!1,null,"0b2a8350",null);t["a"]=h.exports}}]);