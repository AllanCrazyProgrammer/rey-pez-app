(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app.ec030a48"],{1292:function(e,a,t){},"4dc0":function(e,a,t){"use strict";t.r(a);var o=function(){var e=this,a=e._self._c;return a("div",{staticClass:"rendimientos-container"},[a("div",{staticClass:"header-container"},[a("button",{staticClass:"btn-volver",on:{click:e.volverAEmbarque}},[a("i",{staticClass:"fas fa-arrow-left"}),e._v(" Volver al Embarque ")]),a("h2",[e._v("Rendimientos por Medida")]),a("button",{staticClass:"btn-nota",on:{click:e.abrirModalNota}},[a("i",{staticClass:"fas fa-sticky-note"}),e._v(" Agregar Nota ")]),a("button",{staticClass:"btn-costos",on:{click:e.abrirModalCostos}},[a("i",{staticClass:"fas fa-dollar-sign"}),e._v(" Costos ")]),a("button",{staticClass:"btn-pdf",on:{click:e.generarPDF}},[a("i",{staticClass:"fas fa-file-pdf"}),e._v(" Generar PDF ")])]),e.embarqueData?a("div",{staticClass:"rendimientos-grid"},e._l(e.medidasUnicas,(function(t,o){return a("div",{key:o,staticClass:"rendimiento-card"},[a("div",{staticClass:"medida-info"},[a("div",{staticClass:"medida-header"},[a("span",{staticClass:"medida-label editable-label",on:{click:function(a){return e.editarNombreMedida(t)}}},[e._v(" "+e._s(e.obtenerNombreMedidaPersonalizado(t))+" ")]),a("div",{staticClass:"ocultar-control"},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.medidaOculta[t],expression:"medidaOculta[medida]"}],attrs:{type:"checkbox",id:"ocultar-"+o},domProps:{checked:Array.isArray(e.medidaOculta[t])?e._i(e.medidaOculta[t],null)>-1:e.medidaOculta[t]},on:{change:[function(a){var o=e.medidaOculta[t],r=a.target,i=!!r.checked;if(Array.isArray(o)){var s=null,n=e._i(o,s);r.checked?n<0&&e.$set(e.medidaOculta,t,o.concat([s])):n>-1&&e.$set(e.medidaOculta,t,o.slice(0,n).concat(o.slice(n+1)))}else e.$set(e.medidaOculta,t,i)},e.guardarEstadoOculto]}}),a("label",{attrs:{for:"ocultar-"+o}},[e._v("Ocultar en PDF")])])]),a("div",{staticClass:"costo-input"},[a("div",{staticClass:"costo-container"},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.costosPorMedida[t],expression:"costosPorMedida[medida]"}],attrs:{type:"number",placeholder:"Precio",step:"0.01"},domProps:{value:e.costosPorMedida[t]},on:{input:[function(a){a.target.composing||e.$set(e.costosPorMedida,t,a.target.value)},e.guardarCostos]}}),e.costosPorMedida[t]?a("span",{staticClass:"costo-final"},[e._v(" Costo Final: $"+e._s(e.calcularCostoFinal(t))+" ")]):e._e()])]),a("div",{staticClass:"input-group"},[e.esMedidaMix(t)?[a("div",{staticClass:"mix-inputs"},[a("div",{staticClass:"mix-input"},[a("label",{staticClass:"editable-label",on:{click:function(a){return e.editarEtiqueta(t,"medida1")}}},[e._v(" "+e._s(e.obtenerEtiqueta(t,"medida1"))+": ")]),a("input",{directives:[{name:"model",rawName:"v-model",value:e.kilosCrudos[t].medida1,expression:"kilosCrudos[medida].medida1"}],attrs:{type:"number",placeholder:"Kilos medida 1"},domProps:{value:e.kilosCrudos[t].medida1},on:{input:[function(a){a.target.composing||e.$set(e.kilosCrudos[t],"medida1",a.target.value)},function(a){return e.calcularRendimiento(t)}]}})]),a("div",{staticClass:"mix-input"},[a("label",{staticClass:"editable-label",on:{click:function(a){return e.editarEtiqueta(t,"medida2")}}},[e._v(" "+e._s(e.obtenerEtiqueta(t,"medida2"))+": ")]),a("input",{directives:[{name:"model",rawName:"v-model",value:e.kilosCrudos[t].medida2,expression:"kilosCrudos[medida].medida2"}],attrs:{type:"number",placeholder:"Kilos medida 2"},domProps:{value:e.kilosCrudos[t].medida2},on:{input:[function(a){a.target.composing||e.$set(e.kilosCrudos[t],"medida2",a.target.value)},function(a){return e.calcularRendimiento(t)}]}})])])]:[a("label",[e._v("Kilos en crudo:")]),a("input",{directives:[{name:"model",rawName:"v-model",value:e.kilosCrudos[t],expression:"kilosCrudos[medida]"}],attrs:{type:"number",placeholder:"Ingrese kilos"},domProps:{value:e.kilosCrudos[t]},on:{input:[function(a){a.target.composing||e.$set(e.kilosCrudos,t,a.target.value)},function(a){return e.calcularRendimiento(t)}]}})]],2),a("div",{staticClass:"resultados"},[a("p",[e._v("Total embarcado: "+e._s(e.obtenerTotalEmbarcado(t).toFixed(1))+" kg")]),a("p",{staticClass:"rendimiento"},[e._v(" Rendimiento: "),a("span",{class:{"rendimiento-alto":e.getRendimiento(t)>1}},[e._v(" "+e._s(e.getRendimiento(t).toFixed(2))+" ")])])])])])})),0):a("div",[a("p",[e._v("Cargando datos del embarque...")])]),e.mostrarModal?a("div",{staticClass:"modal-overlay"},[a("div",{staticClass:"modal-content"},[a("h3",[e._v("Agregar Nota")]),a("textarea",{directives:[{name:"model",rawName:"v-model",value:e.nota,expression:"nota"}],attrs:{placeholder:"Escriba su nota aquí...",rows:"4"},domProps:{value:e.nota},on:{input:function(a){a.target.composing||(e.nota=a.target.value)}}}),a("div",{staticClass:"modal-buttons"},[a("button",{staticClass:"btn-guardar",on:{click:e.guardarNota}},[e._v("Guardar")]),a("button",{staticClass:"btn-cancelar",on:{click:e.cerrarModal}},[e._v("Cancelar")])])])]):e._e(),a("CostosModal",{attrs:{showModal:e.showCostosModal,costosPorMedida:e.costosPorMedida,rendimientos:e.rendimientosPorMedida},on:{"update:showModal":function(a){e.showCostosModal=a},guardar:e.guardarCostos}})],1)},r=[],i=(t("14d9"),t("13d5"),t("1494")),s=t("2ef0"),n=t("6d4d"),c=t("2729"),d={name:"Rendimientos",components:{CostosModal:c["a"]},data(){return{kilosCrudos:{},medidasUnicas:[],embarqueData:null,guardadoAutomaticoActivo:!1,nombresMedidasPersonalizados:{},mostrarModal:!1,nota:"",medidaOculta:{},costosPorMedida:{},showCostosModal:!1,unsubscribePreciosGlobales:null}},async created(){await this.cargarEmbarque(),await this.iniciarEscuchaPreciosGlobales(),this.guardarCambiosEnTiempoReal=Object(s["debounce"])(this.guardarCambiosEnTiempoReal,300)},methods:{obtenerNombreCliente(e){if(!this.embarqueData||!this.embarqueData.clientes)return"";const a=this.embarqueData.clientes.find(a=>a.id.toString()===e.toString());return a?a.nombre:""},async cargarEmbarque(){try{const e=Object(i["h"])(),a=this.$route.params.id,t=Object(i["e"])(e,"embarques",a),o=await Object(i["f"])(t);if(o.exists()){this.embarqueData=o.data(),this.nombresMedidasPersonalizados=this.embarqueData.nombresMedidasPersonalizados||{},this.obtenerMedidasUnicas(),this.medidaOculta=this.embarqueData.medidaOculta||{},this.costosPorMedida=this.embarqueData.costosPorMedida||{};const e=this.embarqueData.kilosCrudos||{};this.kilosCrudos={...e},this.medidasUnicas.forEach(e=>{this.kilosCrudos[e]||(this.esMedidaMix(e)?this.$set(this.kilosCrudos,e,{medida1:0,medida2:0,etiqueta1:"Kilos en crudo (Medida 1)",etiqueta2:"Kilos en crudo (Medida 2)"}):this.$set(this.kilosCrudos,e,0))}),console.log("Datos cargados:",this.kilosCrudos),this.guardadoAutomaticoActivo=!0}else console.error("No se encontró el embarque")}catch(e){console.error("Error al cargar el embarque:",e)}},async guardarCambiosEnTiempoReal(){if(this.guardadoAutomaticoActivo)try{const e=Object(i["h"])(),a=this.$route.params.id,t=Object(i["e"])(e,"embarques",a);await Object(i["r"])(t,{kilosCrudos:this.kilosCrudos}),console.log("Rendimientos guardados:",this.kilosCrudos)}catch(e){console.error("Error al guardar los rendimientos:",e)}},obtenerMedidasUnicas(){if(!this.embarqueData||!this.embarqueData.clientes)return;const e=new Map,a=new Map;this.embarqueData.clientes.forEach(t=>{t.productos.forEach(o=>{if(o.medida){const r=o.medida.toLowerCase().trim();let i=o.medida;if("Ozuna"!==t.nombre||o.esVenta||(i=o.medida+" Maquila Ozuna"),r.endsWith("mix")){const e=r.split(" ")[0];a.set(e,i)}else e.has(i)||e.set(i,i)}})});const t=Array.from(a.keys()).sort();if(t.length>=2)for(let o=0;o<t.length;o+=2)if(o+1<t.length){const a=`${t[o]}-${t[o+1]} mix`;e.set(a,a),this.kilosCrudos[a]||this.$set(this.kilosCrudos,a,{medida1:0,medida2:0,etiqueta1:`Kilos en crudo (${t[o]})`,etiqueta2:`Kilos en crudo (${t[o+1]})`})}this.medidasUnicas=Array.from(e.values())},obtenerTotalEmbarcado(e){if(!this.embarqueData||!this.embarqueData.clientes)return 0;if(e.includes("-")&&e.endsWith("mix")){const[a,t]=e.split("-").map(e=>e.trim()),o=this.calcularTotalParaMedida(a+" mix"),r=this.calcularTotalParaMedida(t.replace(" mix","")+" mix");return o+r}return this.calcularTotalParaMedida(e)},calcularTotalParaMedida(e){const a=e.includes("Maquila Ozuna"),t=e.replace(" Maquila Ozuna","").toLowerCase().trim();return this.embarqueData.clientes.reduce((e,o)=>e+o.productos.filter(e=>!!e.medida&&(a?e.medida.toLowerCase().trim()===t&&"Ozuna"===o.nombre&&!e.esVenta:e.medida.toLowerCase().trim()===t&&("Ozuna"!==o.nombre||e.esVenta))).reduce((e,a)=>{if("c/h20"===a.tipo){const t=this.calcularTotalBolsas(a),o=parseFloat(a.camaronNeto)||.65;return e+t*o}{const t=a.kilos.reduce((e,a)=>e+(Number(a)||0),0),o=this.calcularTotalTaras(a),r=a.restarTaras?3*o:0;return e+(t-r)}},0),0)},obtenerTotalParaRendimiento(e){if(!this.embarqueData||!this.embarqueData.clientes)return 0;const a=e.toLowerCase(),t=this.embarqueData.clientes.flatMap(e=>e.productos.filter(e=>e.medida&&e.medida.toLowerCase()===a)),o=t.some(e=>"c/h20"===e.tipo);return o?this.obtenerTotalEmbarcado(e):this.obtenerTotalReal(e)},obtenerTotalReal(e){if(!this.embarqueData||!this.embarqueData.clientes)return 0;const a=e.includes("Maquila Ozuna"),t=e.replace(" Maquila Ozuna","").toLowerCase().trim();return this.embarqueData.clientes.reduce((e,o)=>e+o.productos.filter(e=>!!e.medida&&(a?e.medida.toLowerCase().trim()===t&&"Ozuna"===o.nombre&&!e.esVenta:e.medida.toLowerCase().trim()===t&&("Ozuna"!==o.nombre||e.esVenta))).reduce((e,a)=>e+this.calcularTotalKilos(a),0),0)},calcularTotalKilos(e){if(!e.kilos)return 0;const a=e.kilos.reduce((e,a)=>e+(Number(a)||0),0),t=(e.taras||[]).reduce((e,a)=>e+(Number(a)||0),0),o=e.restarTaras?3*t:0;return a-o},calcularTotalTaras(e){const a=(e.taras||[]).reduce((e,a)=>e+(Number(a)||0),0),t=(e.tarasExtra||[]).reduce((e,a)=>e+(Number(a)||0),0);return a+t},calcularTotalBolsas(e){const a=e.reporteTaras||[],t=e.reporteBolsas||[];let o=0;for(let r=0;r<a.length;r++){const e=parseInt(a[r])||0,i=parseInt(t[r])||0;o+=e*i}return o},calcularRendimiento(e){const a=this.obtenerTotalEmbarcado(e);if(0===a)return 0;let t;var o,r;this.esMedidaMix(e)?t=Number((null===(o=this.kilosCrudos[e])||void 0===o?void 0:o.medida1)||0)+Number((null===(r=this.kilosCrudos[e])||void 0===r?void 0:r.medida2)||0):t=Number(this.kilosCrudos[e]||0);const i=t/a;return this.guardarCambiosEnTiempoReal(),i},getRendimiento(e){return this.calcularRendimiento(e)||0},volverAEmbarque(){this.$router.push({name:"EditarEmbarque",params:{id:this.$route.params.id}})},esMedidaMix(e){return e.toLowerCase().includes("mix")},obtenerEtiqueta(e,a){return this.kilosCrudos[e]?"medida1"===a?this.kilosCrudos[e].etiqueta1||"Kilos en crudo (Medida 1)":this.kilosCrudos[e].etiqueta2||"Kilos en crudo (Medida 2)":"medida1"===a?"Kilos en crudo (Medida 1)":"Kilos en crudo (Medida 2)"},editarEtiqueta(e,a){this.kilosCrudos[e]||this.$set(this.kilosCrudos,e,{medida1:0,medida2:0,etiqueta1:"Kilos en crudo (Medida 1)",etiqueta2:"Kilos en crudo (Medida 2)"});const t="medida1"===a?this.kilosCrudos[e].etiqueta1:this.kilosCrudos[e].etiqueta2,o=prompt("Ingrese el nuevo nombre para la medida:",t);null!==o&&("medida1"===a?this.$set(this.kilosCrudos[e],"etiqueta1",o):this.$set(this.kilosCrudos[e],"etiqueta2",o),this.guardarCambiosEnTiempoReal())},generarPDF(){var e;const a=Object.values(this.costosPorMedida).some(e=>Number(e)>0),t=this.medidasUnicas.filter(e=>!this.medidaOculta[e]).map(e=>{let a;var t,o;this.esMedidaMix(e)?a={medida1:Number((null===(t=this.kilosCrudos[e])||void 0===t?void 0:t.medida1)||0),medida2:Number((null===(o=this.kilosCrudos[e])||void 0===o?void 0:o.medida2)||0)}:a=Number(this.kilosCrudos[e]||0);const r=Number(this.costosPorMedida[e])||0,i=this.getRendimiento(e),s=r>0?(r*i+20).toFixed(1):null;return{medida:e,kilosCrudos:a,totalEmbarcado:this.obtenerTotalEmbarcado(e),rendimiento:i,costo:r,costoFinal:s}}),o={...this.embarqueData,notaRendimientos:(null===(e=this.embarqueData)||void 0===e?void 0:e.notaRendimientos)||"",mostrarColumnaCosto:a};Object(n["a"])(t,o)},obtenerNombreMedidaPersonalizado(e){return this.nombresMedidasPersonalizados[e]||e},async editarNombreMedida(e){const a=this.obtenerNombreMedidaPersonalizado(e),t=prompt("Ingrese el nuevo nombre para la medida:",a);if(null!==t&&""!==t.trim()){this.$set(this.nombresMedidasPersonalizados,e,t.trim());try{const e=Object(i["h"])(),a=this.$route.params.id,t=Object(i["e"])(e,"embarques",a);await Object(i["r"])(t,{nombresMedidasPersonalizados:this.nombresMedidasPersonalizados}),console.log("Nombre de medida actualizado correctamente")}catch(o){console.error("Error al guardar el nuevo nombre:",o)}}},abrirModalNota(){var e;this.nota=(null===(e=this.embarqueData)||void 0===e?void 0:e.notaRendimientos)||"",this.mostrarModal=!0},async guardarNota(){try{const e=Object(i["h"])(),a=this.$route.params.id,t=Object(i["e"])(e,"embarques",a);await Object(i["r"])(t,{notaRendimientos:this.nota}),this.embarqueData.notaRendimientos=this.nota,this.cerrarModal(),console.log("Nota guardada correctamente")}catch(e){console.error("Error al guardar la nota:",e)}},cerrarModal(){this.mostrarModal=!1,this.nota=""},async guardarEstadoOculto(){try{const e=Object(i["h"])(),a=this.$route.params.id,t=Object(i["e"])(e,"embarques",a);await Object(i["r"])(t,{medidaOculta:this.medidaOculta}),console.log("Estado de ocultación guardado correctamente")}catch(e){console.error("Error al guardar estado de ocultación:",e)}},abrirModalCostos(){this.showCostosModal=!0},async guardarCostos(e){try{const a=Object(i["h"])(),t=this.$route.params.id;Object(i["e"])(a,"embarques",t);this.costosPorMedida=e,console.log("Costos actualizados correctamente")}catch(a){console.error("Error al actualizar los costos:",a)}},calcularCostoFinal(e){const a=Number(this.costosPorMedida[e])||0,t=Number(this.getRendimiento(e).toFixed(2)),o=a*t+20;return o.toFixed(1)},rendimientosPorMedida(){return this.medidasUnicas.reduce((e,a)=>(e[a]=this.getRendimiento(a),e),{})},async iniciarEscuchaPreciosGlobales(){try{const e=Object(i["h"])(),a=Object(i["c"])(e,"precios_globales"),t=Object(i["o"])(a,Object(i["l"])("timestamp","desc"));this.unsubscribePreciosGlobales=Object(i["k"])(t,e=>{const a={};e.forEach(e=>{const t=e.data();(!a[t.medida]||new Date(t.fecha)>new Date(a[t.medida].fecha))&&(a[t.medida]=t.costoBase)}),this.costosPorMedida=a})}catch(e){console.error("Error al iniciar escucha de precios globales:",e)}}},watch:{kilosCrudos:{handler(){this.guardarCambiosEnTiempoReal()},deep:!0}},beforeDestroy(){this.unsubscribePreciosGlobales&&this.unsubscribePreciosGlobales(),this.guardarCambiosEnTiempoReal.cancel&&this.guardarCambiosEnTiempoReal.cancel()}},l=d,u=(t("dc98"),t("2877")),m=Object(u["a"])(l,o,r,!1,null,"7e5e8ec2",null);a["default"]=m.exports},"50c7":function(e,a,t){"use strict";t("9ff0")},"9ff0":function(e,a,t){},b34e:function(e,a,t){"use strict";var o=function(){var e=this,a=e._self._c;return a("div",{staticClass:"lista-embarques"},[e.cargando?a("div",{staticClass:"cargando"},[e._v("Cargando embarques...")]):e.error?a("div",{staticClass:"error"},[e._v(e._s(e.error))]):a("div",[e.embarques.length>0?a("table",{staticClass:"tabla-embarques"},[e._m(0),a("tbody",e._l(e.embarques,(function(t){return a("tr",{key:t.id,class:{"fila-bloqueada":t.embarqueBloqueado}},[a("td",[e._v(" "+e._s(e.formatearFecha(t.fecha))+" "),t.embarqueBloqueado?a("span",{staticClass:"indicador-bloqueado",attrs:{title:"Este embarque está bloqueado"}},[e._v("🔒")]):e._e()]),a("td",[e._v(e._s(e.calcularKilosLimpios(t))+" kg")]),a("td",[e._v(e._s(e.calcularKilosCrudos(t))+" kg")]),a("td",[e._v(e._s((Number(e.calcularKilosLimpios(t))+Number(e.calcularKilosCrudos(t))).toFixed(1))+" kg")]),a("td",[e._v(e._s(e.calcularTotalTaras(t)))]),a("td",[a("button",{staticClass:"btn-detalles",on:{click:function(a){return e.editarEmbarque(t.id)}}},[e._v("Editar")]),a("button",{staticClass:"btn-eliminar",class:{"btn-deshabilitado":t.embarqueBloqueado},attrs:{title:t.embarqueBloqueado?"Este embarque está bloqueado y no puede ser eliminado":""},on:{click:function(a){t.embarqueBloqueado?e.mostrarMensajeBloqueado():e.eliminarEmbarque(t.id)}}},[e._v("Eliminar")])])])})),0)]):a("div",{staticClass:"sin-embarques"},[e._v("No hay embarques registrados.")])])])},r=[function(){var e=this,a=e._self._c;return a("thead",[a("tr",[a("th",[e._v("Fecha")]),a("th",[e._v("Kilos Limpios")]),a("th",[e._v("Kilos Crudos")]),a("th",[e._v("Total Kilos")]),a("th",[e._v("Total Taras")]),a("th",[e._v("Acciones")])])])}],i=(t("14d9"),t("13d5"),t("1494")),s={name:"ListaEmbarques",data(){return{embarques:[],cargando:!0,error:null}},methods:{async cargarEmbarques(){try{const a=Object(i["h"])(),t=Object(i["c"])(a,"embarques"),o=await Object(i["g"])(t),r={};o.docs.forEach(e=>{const a=e.data();let t;if(a.fecha&&"function"===typeof a.fecha.toDate)t=a.fecha.toDate();else if(a.fecha instanceof Date)t=a.fecha;else{if("string"!==typeof a.fecha)return void(r[e.id]=[{id:e.id,data:a}]);t=new Date(a.fecha)}const o=t.toISOString().split("T")[0];r[o]||(r[o]=[]),r[o].push({id:e.id,data:a,fecha:t})});const s=[];for(const e in r)if(r[e].length>1){console.warn(`Se encontraron ${r[e].length} embarques con la fecha ${e}`),r[e].sort((e,a)=>{const t=e.data.clientes?e.data.clientes.reduce((e,a)=>e+(a.productos?a.productos.length:0),0):0,o=a.data.clientes?a.data.clientes.reduce((e,a)=>e+(a.productos?a.productos.length:0),0):0;return o-t});for(let a=1;a<r[e].length;a++)s.push(r[e][a].id)}if(s.length>0){console.warn(`Se eliminarán ${s.length} embarques duplicados`);for(const t of s)try{await Object(i["d"])(Object(i["e"])(a,"embarques",t)),console.log(`Embarque duplicado con ID ${t} eliminado correctamente`)}catch(e){console.error(`Error al eliminar embarque duplicado con ID ${t}:`,e)}if(s.length>0)return this.cargarEmbarques()}const n=[];for(const e in r)if(r[e].length>0){const a=r[e][0];let t=!1;void 0!==a.data.embarqueBloqueado&&("boolean"===typeof a.data.embarqueBloqueado?t=a.data.embarqueBloqueado:"string"===typeof a.data.embarqueBloqueado?t=["true","1","si","yes","verdadero"].includes(a.data.embarqueBloqueado.toLowerCase()):"number"===typeof a.data.embarqueBloqueado&&(t=0!==a.data.embarqueBloqueado)),n.push({id:a.id,...a.data,embarqueBloqueado:t})}this.embarques=n.sort((e,a)=>{const t=e.fecha.toDate?e.fecha.toDate():new Date(e.fecha),o=a.fecha.toDate?a.fecha.toDate():new Date(a.fecha);return o-t}),this.cargando=!1}catch(e){console.error("Error al cargar los embarques:",e),this.error="Hubo un error al cargar los embarques. Por favor, intente de nuevo más tarde.",this.cargando=!1}},formatearFecha(e){if(!e)return"Fecha no disponible";const a=e.toDate?e.toDate():new Date(e);return a.setDate(a.getDate()+1),a.toLocaleDateString("es-ES")},calcularTotalKilos(e){let a=0;return e.clientes.forEach(e=>{e.productos.forEach(e=>{if("c/h20"===e.tipo){const t=e.reporteTaras||[],o=e.reporteBolsas||[];let r=0;for(let e=0;e<t.length;e++){const a=parseInt(t[e])||0,i=parseInt(o[e])||0;r+=a*i}const i=r*(e.camaronNeto||.65);a+=i}else{const t=(e.kilos||[]).reduce((e,a)=>e+(Number(a)||0),0),o=this.calcularTotalTarasProducto(e),r=e.restarTaras?3*o:0;a+=t-r}})}),a.toFixed(1)},calcularTotalTaras(e){let a=0;const t=["OTILIO","JOSELITO","CATARRO","OZUNA","CANELO"];return e.clientes.forEach(e=>{t.includes(e.nombre.toUpperCase())&&(e.productos.forEach(e=>{a+=this.calcularTotalTarasProducto(e)}),e.crudos&&Array.isArray(e.crudos)&&e.crudos.forEach(e=>{e&&e.items&&Array.isArray(e.items)&&e.items.forEach(e=>{if(e.taras){const[t]=e.taras.split("-").map(Number);a+=t||0}if(e.sobrante){const[t]=e.sobrante.split("-").map(Number);a+=t||0}})}))}),a},calcularTotalTarasProducto(e){const a=(e.taras||[]).reduce((e,a)=>e+(Number(a)||0),0),t=(e.tarasExtra||[]).reduce((e,a)=>e+(Number(a)||0),0);return a+t},verDetalles(e){console.log("Navegando a detalles del embarque:",e),this.$router.push({name:"DetallesEmbarque",params:{id:e}})},editarEmbarque(e){this.$router.push({name:"NuevoEmbarque",params:{id:e}})},regresarAMenu(){this.$router.push({name:"EmbarquesMenu"})},async eliminarEmbarque(e){const a=this.embarques.find(a=>a.id===e);if(a&&a.embarqueBloqueado)alert("Este embarque está bloqueado y no puede ser eliminado.");else if(confirm("¿Estás seguro de que quieres eliminar este embarque?"))try{const a=Object(i["h"])();await Object(i["d"])(Object(i["e"])(a,"embarques",e)),this.embarques=this.embarques.filter(a=>a.id!==e),alert("Embarque eliminado con éxito")}catch(t){console.error("Error al eliminar el embarque:",t),alert("Hubo un error al eliminar el embarque. Por favor, intente de nuevo.")}},calcularKilosLimpios(e){let a=0;return e.clientes.forEach(e=>{e.productos.forEach(e=>{if("c/h20"===e.tipo){const t=e.reporteTaras||[],o=e.reporteBolsas||[];let r=0;for(let e=0;e<t.length;e++){const a=parseInt(t[e])||0,i=parseInt(o[e])||0;r+=a*i}const i=r*(e.camaronNeto||.65);a+=i}else{const t=(e.kilos||[]).reduce((e,a)=>e+(Number(a)||0),0),o=this.calcularTotalTarasProducto(e),r=e.restarTaras?3*o:0;a+=t-r}})}),a.toFixed(1)},calcularKilosCrudos(e){let a=0;return e.clientes.forEach(e=>{e.crudos&&Array.isArray(e.crudos)&&e.crudos.forEach(e=>{e&&e.items&&Array.isArray(e.items)&&e.items.forEach(e=>{if(e.taras){const t=/^(\d+)-(\d+)$/.exec(e.taras);if(t){const e=parseInt(t[1])||0;let o=parseInt(t[2])||0;19===o&&(o=20),a+=(e||0)*(o||0)}else{const[t,o]=e.taras.split("-").map(Number);a+=(t||0)*(o||0)}}if(e.sobrante){const t=/^(\d+)-(\d+)$/.exec(e.sobrante);if(t){const e=parseInt(t[1])||0;let o=parseInt(t[2])||0;19===o&&(o=20),a+=(e||0)*(o||0)}else{const[t,o]=e.sobrante.split("-").map(Number);a+=(t||0)*(o||0)}}})})}),a.toFixed(1)},mostrarMensajeBloqueado(){alert("Este embarque está bloqueado y no puede ser eliminado.")}},mounted(){this.cargarEmbarques()},created(){this.$nextTick(()=>{setTimeout(()=>{},1e3)})}},n=s,c=(t("50c7"),t("2877")),d=Object(c["a"])(n,o,r,!1,null,"54296ffe",null);a["a"]=d.exports},dc70:function(e,a,t){"use strict";t("1292")},dc98:function(e,a,t){"use strict";t("ecde")},ecde:function(e,a,t){},f458:function(e,a,t){"use strict";var o=function(){var e,a,t,o,r,i,s=this,n=s._self._c;return n("div",{staticClass:"nuevo-embarque-container"},[n("Sidebar",{attrs:{embarque:s.embarque,clientesPredefinidos:s.clientesPredefinidos,clientesPersonalizadosEmbarque:s.clientesPersonalizadosEmbarque,clienteCrudos:s.clienteCrudos,clienteActivo:s.clienteActivo},on:{"seleccionar-cliente":function(e){s.clienteActivo=e},"toggle-sidebar":function(e){s.sidebarCollapsed=e},"mostrar-modal-nuevo-cliente":function(e){s.mostrarModalNuevoCliente=!0}}}),n("div",{staticClass:"nuevo-embarque",class:{"sidebar-collapsed":s.sidebarCollapsed}},[n("header-embarque",{attrs:{"modo-edicion":s.modoEdicion,"embarque-bloqueado":s.embarqueBloqueado,embarque:s.embarque,"is-generating-pdf":s.isGeneratingPdf,"pdf-type":s.pdfType,"embarque-id":s.embarqueId},on:{volver:s.volverAEmbarquesMenu,"toggle-bloqueo":s.toggleBloqueo,"update:fecha":function(e){s.embarque.fecha=e},"update:cargaCon":function(e){s.embarque.cargaCon=e},"generar-taras":function(e){return s.generarPDF("taras")},"generar-resumen":function(e){return s.generarPDF("resumen")},"verificar-fecha":s.verificarFechaExistente}}),n("div",{staticClass:"botones-undo-redo"},[n("button",{staticClass:"btn btn-secondary btn-sm",attrs:{type:"button",disabled:s.undoStack.length<=1},on:{click:s.undo}},[s._v(" Deshacer ")]),n("button",{staticClass:"btn btn-secondary btn-sm",attrs:{type:"button",disabled:0===s.redoStack.length},on:{click:s.redo}},[s._v(" Rehacer ")])]),n("form",{on:{submit:function(e){return e.preventDefault(),s.guardarEmbarque.apply(null,arguments)},keydown:function(e){if(!e.type.indexOf("key")&&s._k(e.keyCode,"enter",13,e.key,"Enter"))return null;e.preventDefault()}}},s._l(s.productosPorCliente,(function(e,a){return n("ClienteProductos",{key:a,attrs:{"cliente-id":a,productos:e,crudos:s.clienteCrudos[a]||[],"clientes-juntar-medidas":s.clientesJuntarMedidas,"nombre-cliente":s.obtenerNombreCliente(a),"cliente-activo":s.clienteActivo,"embarque-bloqueado":s.embarqueBloqueado,"medidas-usadas":s.medidasUsadas,"is-generating-pdf":s.isGeneratingPdf,"pdf-type":s.pdfType,"is-creating-account":s.isCreatingAccount},on:{"update:productos":function(e){return s.actualizarProductosCliente(a,e)},"update:crudos":function(e){return s.actualizarCrudosCliente(a,e)},"juntarMedidas-change":s.handleJuntarMedidasChange,"eliminar-cliente":s.eliminarCliente,"eliminar-producto":s.eliminarProducto,"eliminar-crudo":s.eliminarCrudo,"eliminar-crudo-item":s.eliminarCrudoItem,"agregar-producto":s.agregarProducto,"agregar-crudo":s.agregarCrudo,"agregar-crudo-item":s.agregarCrudoItem,"toggle-sobrante":s.toggleSobrante,"mostrar-modal-precio":s.abrirModalPrecio,"mostrar-modal-hilos":s.abrirModalHilos,"mostrar-modal-nota":s.abrirModalNota,"mostrar-modal-nombre-alternativo":s.abrirModalNombreAlternativo,"mostrar-modal-alt":s.abrirModalAlt,"seleccionar-medida":s.seleccionarMedida,"generar-pdf":s.generarPDF,"crear-cuenta-joselito":s.crearCuentaJoselito,"crear-cuenta-catarro":s.crearCuentaCatarro,"crear-cuenta-ozuna":s.crearCuentaOzuna}})})),1)],1),n("NuevoClienteModal",{attrs:{mostrar:s.mostrarModalNuevoCliente},on:{cerrar:function(e){s.mostrarModalNuevoCliente=!1},agregar:s.agregarNuevoCliente}}),n("NombreAlternativoModal",{attrs:{mostrar:s.mostrarModalNombreAlternativo,"nombre-original":(null===(e=s.productoSeleccionado)||void 0===e?void 0:e.medida)||"","nombre-alternativo":(null===(a=s.productoSeleccionado)||void 0===a?void 0:a.nombreAlternativoPDF)||""},on:{cerrar:function(e){s.mostrarModalNombreAlternativo=!1},guardar:s.guardarNombreAlternativo}}),n("PrecioModal",{attrs:{mostrar:s.mostrarModalPrecio,precio:(null===(t=s.itemSeleccionado)||void 0===t?void 0:t.precio)||""},on:{cerrar:s.cerrarModalPrecio,guardar:s.guardarPrecio}}),n("HilosModal",{attrs:{mostrar:s.mostrarModalHilos,hilos:(null===(o=s.itemSeleccionado)||void 0===o?void 0:o.hilos)||""},on:{cerrar:s.cerrarModalHilos,guardar:s.guardarHilos}}),n("NotaModal",{attrs:{mostrar:s.mostrarModalNota,nota:(null===(r=s.itemSeleccionado)||void 0===r?void 0:r.nota)||""},on:{cerrar:s.cerrarModalNota,guardar:s.guardarNota}}),n("AltModal",{attrs:{mostrar:s.mostrarModalAlt,alt:(null===(i=s.itemSeleccionado)||void 0===i?void 0:i.textoAlternativo)||""},on:{cerrar:s.cerrarModalAlt,guardar:s.guardarAlt}})],1)},r=[],i=(t("14d9"),t("88e6"),t("70cc"),t("eb03"),t("22e5c"),t("c01e"),t("fa76"),t("8306"),t("1494")),s=t("2ef0"),n=t("7c01"),c=t("dc59"),d=t("f549"),l=t("2b0e"),u=t("5ea5"),m=t("fdb2"),h=t("e7ae"),b=t("ad72"),p=t("b9b6"),f=t("e7e0"),g=t("eb99"),q=t("57d4"),C=t("6123"),v=t("c005"),E=t("6d00"),M=t("c0b0"),S=t("fa40");const O=Object(l["defineAsyncComponent"])(()=>Promise.resolve().then(t.bind(null,"4dc0")));var P={mixins:[h["a"],b["a"]],name:"NuevoEmbarque",components:{Rendimientos:O,Sidebar:u["a"],HeaderEmbarque:m["a"],ClienteProductos:p["a"],NuevoClienteModal:g["a"],NombreAlternativoModal:q["a"],PrecioModal:C["a"],HilosModal:v["a"],NotaModal:E["a"],AltModal:M["a"]},setup(){const e=Object(d["a"])();return{authStore:e}},data(){return{usuariosActivos:[],clientesJuntarMedidas:{},clientesPredefinidos:f["a"],clientesPersonalizados:[],ultimoIdPersonalizado:0,embarque:{fecha:null,cargaCon:"",productos:[],crudos:[]},nuevoClienteId:"",undoStack:[],redoStack:[],isUndoRedo:!1,cambios:[],producto:{reporteTaras:[],reporteBolsas:[]},embarqueId:null,modoEdicion:!1,guardadoAutomaticoActivo:!1,clienteCrudos:{},unsubscribe:null,medidasSugeridas:[],medidasUsadas:[],mostrarSugerencias:!1,sugerenciasMedidas:[],mostrarModalNuevoCliente:!1,nuevoClienteNombre:"",nuevoClienteColor:"#007bff",mostrarModalNombreAlternativo:!1,nombreAlternativoTemp:"",productoSeleccionado:null,mostrarModalPrecio:!1,precioTemp:"",itemSeleccionado:null,mostrarModalHilos:!1,hilosTemp:"",mostrarModalNota:!1,notaTemp:"",mostrarModalAlt:!1,altTemp:"",clientesOffsets:{},embarqueBloqueado:!1,clienteActivo:null,sidebarCollapsed:!1,isGeneratingPdf:!1,pdfType:null,isCreatingAccount:!1,_creandoEmbarque:!1,_guardandoEmbarque:!1}},computed:{clientesDisponibles(){const e=new Set,a=this.clientesPredefinidos.filter(a=>!e.has(a.nombre)&&(e.add(a.nombre),!0)),t=this.clientesPersonalizados.filter(a=>!e.has(a.nombre)&&(e.add(a.nombre),!0));return[...a,...t,{id:"otro",nombre:"Otro",key:"otro"}]},productosPorCliente(){console.log("Calculando productosPorCliente. Contenido de embarque.productos:",this.embarque.productos);const e={};return this.embarque.productos.forEach(a=>{const t=a.clienteId;e[t]||(e[t]=[]),e[t].push(a),a.isEditing||e[t].sort((e,a)=>e.medida&&e.tipo&&a.medida&&a.tipo?this.compararMedidas(a.medida,e.medida):e.medida&&e.tipo?a.medida&&a.tipo?0:-1:1)}),e},clientesPersonalizadosEmbarque(){const e=Object.keys(this.productosPorCliente),a=this.clientesPredefinidos.map(e=>e.id.toString());return this.clientesPersonalizados.filter(t=>e.includes(t.id.toString())&&!a.includes(t.id.toString()))}},methods:{actualizarProductosCliente(e,a){this.embarque.productos=this.embarque.productos.filter(a=>a.clienteId!==e),this.embarque.productos=[...this.embarque.productos,...a],this.guardadoAutomaticoActivo&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},actualizarCrudosCliente(e,a){this.$set(this.clienteCrudos,e,a),this.guardadoAutomaticoActivo&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},agregarProducto(e){const a=Object(f["c"])(e);this.setTipoDefaultParaCliente(a),a.nombreCliente=this.obtenerNombreCliente(e),this.embarque.productos.push(a),!this.guardadoAutomaticoActivo&&this.embarqueId&&(this.guardadoAutomaticoActivo=!0),this.embarqueId&&this.guardarCambiosEnTiempoReal(),this.actualizarMedidasUsadas(),this.$nextTick(()=>{const e=document.querySelectorAll(".medida-input"),t=Array.from(e).find(e=>{var t;const o=null===(t=e.closest(".producto"))||void 0===t||null===(t=t.dataset)||void 0===t?void 0:t.productoId;return o===String(a.id)});t&&t.focus()})},eliminarProducto(e){const a=this.embarque.productos.indexOf(e);a>-1&&this.embarque.productos.splice(a,1)},async agregarClienteProducto(){const e=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(!e)if(this.embarque.fecha){if("otro"===this.nuevoClienteId){const e=prompt("Ingrese el nombre del nuevo cliente:");if(e&&""!==e.trim()){this.ultimoIdPersonalizado++;const a="personalizado_"+this.ultimoIdPersonalizado,t={id:a,nombre:e.trim(),editable:!0,personalizado:!0};this.clientesPersonalizados.push(t),await this.guardarEmbarqueInicial(a)}}else this.nuevoClienteId&&await this.guardarEmbarqueInicial(this.nuevoClienteId);this.nuevoClienteId=""}else alert("Por favor, seleccione una fecha para el embarque.")},async guardarEmbarqueInicial(e){const a=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(a)return null;if(this._creandoEmbarque)return console.warn("Ya hay una operación de creación de embarque en curso"),null;this._creandoEmbarque=!0;try{if(this.embarqueId)return this.agregarProducto(e),this.clienteActivo=e,this._creandoEmbarque=!1,this.embarqueId;{const o=Object(i["h"])();try{const a=new Date(this.embarque.fecha),r=a.toISOString().split("T")[0],s=Object(i["c"])(o,"embarques"),n=await Object(i["g"])(s),c=n.docs.filter(e=>{const a=e.data();let t;if(a.fecha&&"function"===typeof a.fecha.toDate)t=a.fecha.toDate();else if(a.fecha instanceof Date)t=a.fecha;else{if("string"!==typeof a.fecha)return!1;t=new Date(a.fecha)}const o=t.toISOString().split("T")[0];return o===r&&e.id!==this.embarqueId});if(c.length>0)return alert("Ya existe un embarque para la fecha seleccionada. Por favor, seleccione otra fecha."),this._creandoEmbarque=!1,null;const d=Object(i["e"])(o,"reservas_fechas",r);await Object(i["q"])(d,{fecha:r,timestamp:Object(i["p"])(),usuario:this.authStore.userId||"anónimo","expiración":new Date(Date.now()+6e4)});const l=this.prepararDatosEmbarque(),u=await Object(i["b"])(Object(i["c"])(o,"embarques"),l);try{await Object(i["d"])(d)}catch(t){console.error("Error al eliminar la reserva de fecha:",t)}return this.embarqueId=u.id,this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0,this.agregarProducto(e),this.clienteActivo=e,this._creandoEmbarque=!1,this.embarqueId}catch(t){return this._creandoEmbarque=!1,console.error("Error al crear el embarque inicial:",t),a||alert("Hubo un error al crear el embarque. Por favor, intente nuevamente."),null}}}catch(t){return this._creandoEmbarque=!1,console.error("Error inesperado en guardarEmbarqueInicial:",t),null}},eliminarCliente(e){this.embarque.productos=this.embarque.productos.filter(a=>a.clienteId!==e),this.$forceUpdate(),this.cambios.push(`Cliente ${this.obtenerNombreCliente(e)} eliminado`)},obtenerNombreCliente(e){const a=this.clientesDisponibles.find(a=>a.id.toString()===e.toString());if(a)return a.nombre;const t=this.embarque.productos.find(a=>a.clienteId.toString()===e.toString());return t?t.nombreCliente:"Cliente Desconocido"},editarNombreCliente(e){const a=this.clientesDisponibles.find(a=>a.id===e);if(a&&a.editable){const t=prompt("Ingrese el nuevo nombre del cliente:",a.nombre);null!==t&&""!==t.trim()&&(a.nombre=t.trim(),this.embarque.productos.forEach(a=>{a.clienteId===e&&(a.nombreCliente=t.trim())}))}},async cargarEmbarque(e){if("nuevo"===e)return void this.resetearEmbarque();const a=Object(i["h"])(),t=Object(i["e"])(a,"embarques",e);this.unsubscribe=Object(i["k"])(t,a=>{if(a.exists()){const t=a.data();let o;this.embarqueBloqueado=t.embarqueBloqueado||!1,t.clientesJuntarMedidas?this.clientesJuntarMedidas=t.clientesJuntarMedidas:(this.clientesJuntarMedidas={},t.clientes.forEach(e=>{this.$set(this.clientesJuntarMedidas,e.id,!1)})),t.fecha&&"function"===typeof t.fecha.toDate?o=t.fecha.toDate():t.fecha instanceof Date?o=t.fecha:"string"===typeof t.fecha?o=new Date(t.fecha):(console.warn("Formato de fecha no reconocido, usando la fecha actual"),o=new Date);const r=new Map(this.clientesPredefinidos.map(e=>[e.id,e]));this.clientesPersonalizados=t.clientes.filter(e=>!r.has(e.id)).map(e=>({id:e.id,nombre:e.nombre,editable:!0,personalizado:!0,key:"personalizado_"+e.id})),this.embarque={fecha:o.toISOString().split("T")[0],cargaCon:t.cargaCon||"",productos:t.clientes.flatMap(e=>{const a=r.get(e.id)||e;return e.productos.map(t=>({...t,clienteId:e.id,nombreCliente:a.nombre,restarTaras:t.restarTaras||!1}))}),kilosCrudos:t.kilosCrudos||{}},this.clienteCrudos={},t.clientes.forEach(e=>{e.crudos&&e.crudos.length>0&&this.$set(this.clienteCrudos,e.id,e.crudos)}),this.embarqueId=e,this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0}else console.error("No se encontró el embarque"),this.resetearEmbarque()},e=>{console.error("Error al escuchar cambios del embarque:",e)})},async resetearEmbarque(){const e=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(e)return;const a=performance&&performance.navigation&&1===performance.navigation.type;if(a&&localStorage.getItem("ultimoEmbarqueId"))return void console.log("Recarga detectada con ID existente, no creando un nuevo embarque");const t=(new Date).toISOString().split("T")[0];try{const e=Object(i["h"])(),o=Object(i["c"])(e,"embarques"),r=await Object(i["g"])(o),s={};r.docs.forEach(e=>{const a=e.data();let t;if(a.fecha&&"function"===typeof a.fecha.toDate)t=a.fecha.toDate();else if(a.fecha instanceof Date)t=a.fecha;else{if("string"!==typeof a.fecha)return;t=new Date(a.fecha)}const o=t.toISOString().split("T")[0];s[o]||(s[o]=[]),s[o].push({id:e.id,fecha:o,data:e.data()})});const n=s[t]||[];let c=t;if(n.length>0){let e=new Date(t),o=!1;for(let a=1;a<=7&&!o;a++){e.setDate(e.getDate()+1);const a=e.toISOString().split("T")[0];s[a]&&0!==s[a].length||(o=!0,c=a)}if(!o)return console.warn("No se encontró una fecha disponible en los próximos 7 días"),this.embarque={fecha:t,cargaCon:"",productos:[]},this.clientesJuntarMedidas={},this.embarqueId=null,this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1,this.embarqueBloqueado=!1,this.clientesPersonalizados=[],void(a||alert("Ya existe un embarque para hoy y los próximos días. Por favor, seleccione manualmente una fecha diferente."))}this.embarque={fecha:c,cargaCon:"",productos:[]},this.clientesJuntarMedidas={},this.embarqueId=null,this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1,this.embarqueBloqueado=!1,this.clientesPersonalizados=[],this.$nextTick(async()=>{if(this.embarque.fecha)try{const a=Object(i["c"])(e,"embarques"),t=await Object(i["g"])(a),o=t.docs.some(e=>{const a=e.data();let t;if(a.fecha&&"function"===typeof a.fecha.toDate)t=a.fecha.toDate();else if(a.fecha instanceof Date)t=a.fecha;else{if("string"!==typeof a.fecha)return!1;t=new Date(a.fecha)}const o=t.toISOString().split("T")[0];return o===this.embarque.fecha});if(o)return console.warn("Se detectó un embarque con la misma fecha durante la inicialización"),void alert("Ya existe un embarque para la fecha seleccionada. Se cancelará la creación automática.");await this.guardarEmbarqueInicial(this.clientesPredefinidos[0].id.toString()),await new Promise(e=>setTimeout(e,100));for(let e=1;e<this.clientesPredefinidos.length;e++){const a=this.clientesPredefinidos[e].id.toString(),t=this.embarque.productos.some(e=>e.clienteId.toString()===a);if(!t){const e=Object(f["c"])(a);this.setTipoDefaultParaCliente(e),this.embarque.productos.push(e),await new Promise(e=>setTimeout(e,50))}}this.clienteActivo=this.clientesPredefinidos[0].id.toString(),this.$forceUpdate(),this.guardarCambiosEnTiempoReal()}catch(a){console.error("Error al crear clientes predeterminados:",a)}})}catch(o){console.error("Error al verificar fechas de embarques existentes:",o),this.embarque={fecha:t,cargaCon:"",productos:[]},this.clientesJuntarMedidas={},this.embarqueId=null,this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1,this.embarqueBloqueado=!1,this.clientesPersonalizados=[]}},guardarCambiosEnTiempoReal:Object(s["debounce"])((function(){if(!this.guardadoAutomaticoActivo||!this.embarqueId||this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente)return;const e={...JSON.parse(JSON.stringify(this.prepararDatosEmbarque())),clientesJuntarMedidas:{...this.clientesJuntarMedidas}},a=Object(i["h"])();Object(i["r"])(Object(i["e"])(a,"embarques",this.embarqueId),e).then(()=>{console.log("Cambios guardados automáticamente:",(new Date).toLocaleString()),this.$emit("guardado-automatico")}).catch(e=>{console.error("Error al guardar automáticamente:",e)})}),2e3),async guardarEmbarque(){if(!this.embarque.fecha)return void alert("Por favor, seleccione una fecha para el embarque.");const e=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(e)return;if(this._guardandoEmbarque)return void console.warn("Ya hay una operación de guardado en curso");this._guardandoEmbarque=!0;const a=this.prepararDatosEmbarque(),t=Object(i["h"])();try{if(this.modoEdicion)await Object(i["r"])(Object(i["e"])(t,"embarques",this.embarqueId),a),alert("Embarque actualizado exitosamente."),this._guardandoEmbarque=!1;else{const e=new Date(this.embarque.fecha),r=e.toISOString().split("T")[0],s=Object(i["c"])(t,"embarques"),d=await Object(i["g"])(s),l=d.docs.filter(e=>{const a=e.data();let t;if(a.fecha&&"function"===typeof a.fecha.toDate)t=a.fecha.toDate();else if(a.fecha instanceof Date)t=a.fecha;else{if("string"!==typeof a.fecha)return!1;t=new Date(a.fecha)}const o=t.toISOString().split("T")[0];return o===r});if(l.length>0)return alert("Ya existe un embarque para la fecha seleccionada. Por favor, seleccione otra fecha."),void(this._guardandoEmbarque=!1);const u=Object(i["e"])(t,"reservas_fechas",r);await Object(i["q"])(u,{fecha:r,timestamp:Object(i["p"])(),usuario:this.authStore.userId||"anónimo","expiración":new Date(Date.now()+6e4)});try{const e=await Object(i["b"])(Object(i["c"])(t,"embarques"),{...a,ultimaEdicion:{userId:this.authStore.userId,username:this.authStore.user.username,timestamp:Object(i["p"])()}}),r=Object(n["d"])(c["c"],"cambios/"+e.id);await Object(n["e"])(r,{tipo:"guardar",userId:this.authStore.userId,username:this.authStore.user.username,timestamp:Object(i["p"])()}),this.embarqueId=e.id,alert("Embarque creado exitosamente y guardado en la base de datos."),this.modoEdicion=!0}finally{try{await Object(i["d"])(u)}catch(o){console.error("Error al eliminar la reserva de fecha:",o)}this._guardandoEmbarque=!1}}this.guardadoAutomaticoActivo=!0,this.$router.push("/lista-embarques")}catch(o){this._guardandoEmbarque=!1,console.error("Error al guardar el embarque: ",o),alert("Hubo un error al guardar el embarque. Por favor, intente nuevamente.")}},prepararDatosEmbarque(){console.log("Preparando datos del embarque:",this.embarque);const e={fecha:new Date(this.embarque.fecha),cargaCon:this.embarque.cargaCon,clientes:[],clientesJuntarMedidas:this.clientesJuntarMedidas,embarqueBloqueado:this.embarqueBloqueado},a=new Map(this.clientesPredefinidos.map(e=>[e.id,e]));if(0===Object.keys(this.productosPorCliente).length&&this.clientesPredefinidos.length>0){const e=this.clientesPredefinidos[0].id.toString(),a=this.clientesPredefinidos[0],t=Object(f["c"])(e);t.nombreCliente=a.nombre,this.embarque.productos.push(t),this.clienteActivo=e,this.$forceUpdate()}return Object.entries(this.productosPorCliente).forEach(([t,o])=>{const r=a.get(parseInt(t)),i={id:t,nombre:r?r.nombre:this.obtenerNombreCliente(t),productos:o.map(e=>({...e,restarTaras:e.restarTaras||!1,noSumarKilos:e.noSumarKilos||!1})),crudos:this.clienteCrudos[t]||[]};e.clientes.push(i)}),console.log("Datos del embarque preparados:",e),e},setTipoDefaultParaCliente(e){const a=this.obtenerNombreCliente(e.clienteId);"Catarro"===a&&(e.tipo="s/h20")},undo(){if(this.undoStack.length>1){const e=this.undoStack.pop();this.redoStack.push(e);const a=this.undoStack[this.undoStack.length-1];this.isUndoRedo=!0,this.embarque=JSON.parse(a),console.log("Undo realizado. Estado actual restaurado."),this.guardarCambiosEnTiempoReal()}else console.log("No hay más acciones para deshacer.")},redo(){if(this.redoStack.length>0){const e=this.redoStack.pop();this.undoStack.push(e),this.isUndoRedo=!0,this.embarque=JSON.parse(e),console.log("Redo realizado. Estado actual restaurado."),this.guardarCambiosEnTiempoReal()}else console.log("No hay más acciones para rehacer.")},actualizarProducto(e){const a=this.embarque.productos.findIndex(a=>a.id===e.id);if(-1!==a){const t=JSON.parse(JSON.stringify(e));this.$set(this.embarque.productos,a,t),this.$forceUpdate()}},onTipoChange(e){"otro"!==e.tipo&&(e.tipoPersonalizado=""),"c/h20"!==e.tipo||e.camaronNeto||(e.camaronNeto=.65),e.isEditing=!0,this.$nextTick(()=>{setTimeout(()=>{e.medida&&e.tipo&&(e.isEditing=!1)},100)})},agregarCrudo(e){this.clienteCrudos[e]||this.$set(this.clienteCrudos,e,[]),this.clienteCrudos[e].push({items:[Object(f["b"])()]}),this.guardarCambiosEnTiempoReal()},agregarCrudoItem(e,a){this.clienteCrudos[e]||this.$set(this.clienteCrudos,e,[]),this.clienteCrudos[e][a]||this.$set(this.clienteCrudos[e],a,{items:[]}),Array.isArray(this.clienteCrudos[e][a].items)||this.$set(this.clienteCrudos[e][a],"items",[]),this.clienteCrudos[e][a].items.push(Object(f["b"])()),this.guardarCambiosEnTiempoReal()},eliminarCrudoItem(e,a,t){this.clienteCrudos[e]?this.clienteCrudos[e][a]?this.clienteCrudos[e][a].items?(this.clienteCrudos[e][a].items.splice(t,1),0===this.clienteCrudos[e][a].items.length&&this.eliminarCrudo(e,a),this.guardarCambiosEnTiempoReal()):console.error("El objeto crudo no tiene propiedad items"):console.error("Índice de crudo no válido:",a):console.error("Cliente no encontrado:",e)},eliminarCrudo(e,a){this.clienteCrudos[a]?(this.clienteCrudos[a].splice(e,1),0===this.clienteCrudos[a].length&&this.$delete(this.clienteCrudos,a),this.guardarCambiosEnTiempoReal()):console.error("Cliente no encontrado:",a)},toggleSobrante(e,a,t){if(!this.clienteCrudos[e])return void console.error("Cliente no encontrado:",e);if(!this.clienteCrudos[e][a])return void console.error("Índice de crudo no válido:",a);if(!this.clienteCrudos[e][a].items)return this.$set(this.clienteCrudos[e][a],"items",[]),void console.error("El objeto crudo no tiene propiedad items");if(!this.clienteCrudos[e][a].items[t])return void console.error("Índice de item no válido:",t);const o=this.clienteCrudos[e][a].items[t];o.hasOwnProperty("mostrarSobrante")?o.mostrarSobrante=!o.mostrarSobrante:this.$set(o,"mostrarSobrante",!0),this.guardarCambiosEnTiempoReal()},actualizarTotalCrudos(e,a){this.$forceUpdate(),this.guardarCambiosEnTiempoReal()},actualizarCrudos(){this.guardarCambiosEnTiempoReal()},onRestarTarasChange(e){console.log("Restar taras cambiado:",e.restarTaras),this.$nextTick(()=>{this.actualizarProducto(e)})},handleJuntarMedidasChange(e,a){this.$set(this.clientesJuntarMedidas,e,a),this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},agregarNuevoCliente(e){if(!e||!e.nombre)return;const a={id:Date.now().toString(),nombre:e.nombre,color:e.color||this.nuevoClienteColor,editable:!0,personalizado:!0,key:"personalizado_"+Date.now()};this.clientesPersonalizados.push(a);const t=Object(f["c"])(a.id);this.embarque.productos.push(t),this.guardarClientesPersonalizados(),this.guardarCambiosEnTiempoReal(),this.mostrarModalNuevoCliente=!1,this.seleccionarCliente(a.id)},abrirModalNombreAlternativo(e){this.productoSeleccionado=e,this.mostrarModalNombreAlternativo=!0},guardarNombreAlternativo(e){if(this.productoSeleccionado){const a=this.guardadoAutomaticoActivo;this.guardadoAutomaticoActivo=!1,e?this.$set(this.productoSeleccionado,"nombreAlternativoPDF",e):this.$delete(this.productoSeleccionado,"nombreAlternativoPDF"),this.actualizarProducto(this.productoSeleccionado),this.$nextTick(()=>{this.guardadoAutomaticoActivo=a,this.guardarCambiosEnTiempoReal(),this.mostrarModalNombreAlternativo=!1})}else this.mostrarModalNombreAlternativo=!1},abrirModalPrecio(e){this.itemSeleccionado=e,this.mostrarModalPrecio=!0},cerrarModalPrecio(){this.mostrarModalPrecio=!1,this.itemSeleccionado=null},guardarPrecio(e){if(this.itemSeleccionado){null!==e?this.$set(this.itemSeleccionado,"precio",e):this.$delete(this.itemSeleccionado,"precio");const a=this.guardadoAutomaticoActivo;this.guardadoAutomaticoActivo=!1,this.$nextTick(()=>{this.guardadoAutomaticoActivo=a,this.guardarCambiosEnTiempoReal()})}this.cerrarModalPrecio()},abrirModalHilos(e){this.itemSeleccionado=e,this.mostrarModalHilos=!0},cerrarModalHilos(){this.mostrarModalHilos=!1,this.itemSeleccionado=null},guardarHilos(e){if(this.itemSeleccionado){e?this.$set(this.itemSeleccionado,"hilos",e):this.$delete(this.itemSeleccionado,"hilos");const a=this.guardadoAutomaticoActivo;this.guardadoAutomaticoActivo=!1,this.$nextTick(()=>{this.guardadoAutomaticoActivo=a,this.guardarCambiosEnTiempoReal()})}this.cerrarModalHilos()},abrirModalNota(e){this.itemSeleccionado=e,this.mostrarModalNota=!0},cerrarModalNota(){this.mostrarModalNota=!1,this.itemSeleccionado=null},guardarNota(e){if(this.itemSeleccionado){e?this.$set(this.itemSeleccionado,"nota",e):this.$delete(this.itemSeleccionado,"nota");const a=this.guardadoAutomaticoActivo;this.guardadoAutomaticoActivo=!1,this.$nextTick(()=>{this.guardadoAutomaticoActivo=a,this.guardarCambiosEnTiempoReal()})}this.cerrarModalNota()},abrirModalAlt(e){this.itemSeleccionado=e,this.mostrarModalAlt=!0},cerrarModalAlt(){this.mostrarModalAlt=!1,this.itemSeleccionado=null},guardarAlt(e){this.itemSeleccionado&&(e?this.$set(this.itemSeleccionado,"textoAlternativo",e):this.$delete(this.itemSeleccionado,"textoAlternativo"),this.guardarCambiosEnTiempoReal()),this.cerrarModalAlt()},seleccionarCliente(e){const a=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(a)return;if(!this.embarque.fecha)return void alert("Por favor, seleccione una fecha para el embarque.");const t=this.embarque.productos.some(a=>a.clienteId.toString()===e.toString());t?this.clienteActivo=e:this.guardarEmbarqueInicial(e).then(()=>{this.clienteActivo=e})},scrollToCliente(e){this.$nextTick(()=>{const a=document.querySelector(`.cliente-header[data-cliente="${this.obtenerNombreCliente(e)}"]`);a&&(document.querySelectorAll(".cliente-header").forEach(e=>{e.classList.remove("cliente-seleccionado")}),a.classList.add("cliente-seleccionado"),a.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{a.classList.remove("cliente-seleccionado")},2e3))})},toggleSidebar(){this.sidebarCollapsed=!this.sidebarCollapsed},toggleBloqueo(){if(this.embarqueBloqueado=!this.embarqueBloqueado,this.modoEdicion&&this.embarqueId){const e=Object(i["h"])();Object(i["r"])(Object(i["e"])(e,"embarques",this.embarqueId),{embarqueBloqueado:this.embarqueBloqueado}).catch(e=>{console.error("Error al guardar estado de bloqueo:",e)})}},actualizarMedidasUsadas(){const e=this.embarque.productos.map(e=>e.medida).filter(e=>e&&e.trim()).filter((e,a,t)=>t.indexOf(e)===a);this.medidasUsadas=e},onMedidaInput(e,a){const t=a.target.value.toLowerCase();this.productoEditandoId=e.id,e.medida=a.target.value,this.sugerenciasMedidas=t?this.medidasUsadas.filter(e=>e.toLowerCase().includes(t)&&e.toLowerCase()!==t):[],e.isEditing=!0,this.actualizarProducto(e)},onMedidaBlur(e){setTimeout(()=>{this.productoEditandoId=null},200),e.medida&&e.medida.length>0&&e.tipo&&(e.isEditing=!1,e.isNew=!1)},seleccionarMedida(e,a){e.medida=a,this.productoEditandoId=null,this.actualizarProducto(e)},onTallaCrudoChange(e){e.medida||(e.medida=e.talla),this.guardarCambiosEnTiempoReal()},guardarClientesPersonalizados(){localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados))},cargarClientesPersonalizados(){const e=localStorage.getItem("clientesPersonalizados");e&&(this.clientesPersonalizados=JSON.parse(e))},async escucharUsuariosActivos(){try{console.log("Iniciando escucha de usuarios activos");const a=Object(n["d"])(c["c"],"status");if(this.authStore.isLoggedIn&&this.authStore.user){console.log("Usuario autenticado:",this.authStore.user.username);const a=Object(n["d"])(c["c"],"status/"+this.authStore.userId);try{await Object(n["e"])(a,{username:this.authStore.user.username,status:"online",lastSeen:(new Date).toISOString()}),console.log("Estado del usuario actualizado correctamente")}catch(e){console.error("Error al actualizar estado del usuario:",e)}}else console.log("Usuario no autenticado");this.unsubscribeUsuarios=Object(n["c"])(a,e=>{const a=[];console.log("Recibiendo actualización de usuarios activos"),e.forEach(e=>{const t=e.val();console.log("Usuario encontrado:",t),t&&t.username&&a.push({userId:e.key,username:t.username,status:t.status||"online",lastSeen:t.lastSeen})}),console.log("Total usuarios activos:",a.length),this.usuariosActivos=a},e=>{console.error("Error al escuchar usuarios activos:",e)})}catch(e){console.error("Error al iniciar escucha de usuarios:",e)}},async iniciarPresenciaUsuario(){try{if(!this.authStore.isLoggedIn||!this.authStore.user)return void console.log("Usuario no autenticado");const e=Object(n["d"])(c["c"],"status/"+this.authStore.userId);await Object(n["b"])(e).remove(),await Object(n["e"])(e,{username:this.authStore.user.username,status:"online",lastSeen:(new Date).toISOString()})}catch(e){console.error("Error al iniciar presencia:",e.message,e.stack)}},volverAEmbarquesMenu(){this.$router.push({name:"EmbarquesMenu"})},calcularPosicionSticky(e){const a=Object.keys(this.productosPorCliente),t=a.indexOf(e.toString());if(0===t)return 0;let o=0;for(let i=0;i<t;i++){var r;const e=a[i],t=(null===(r=this.$el.querySelector(`[data-cliente="${this.obtenerNombreCliente(e)}"]`))||void 0===r?void 0:r.offsetHeight)||0;o+=t}return o},async crearCuentaJoselito(e,a,t){try{this.isCreatingAccount=!0;const e={...this.embarque,productos:a,crudos:t};await S["a"].crearCuentaJoselito(e,this.$router)}catch(o){console.error("Error al crear cuenta para Joselito:",o),alert("Error al crear cuenta para Joselito")}finally{this.isCreatingAccount=!1}},async crearCuentaCatarro(e,a,t){try{this.isCreatingAccount=!0;const a=this.obtenerEmbarqueCliente(e);await S["a"].crearCuentaCatarro(a,this.$router),alert("Cuenta de Catarro creada exitosamente y abierta en una nueva pestaña.")}catch(o){console.error("Error al crear cuenta de Catarro:",o),alert("Error al crear cuenta: "+o.message)}finally{this.isCreatingAccount=!1}},esClienteJoselito(e){const a=this.clientesDisponibles.find(a=>a.id.toString()===e.toString());return a&&a.nombre.toLowerCase().includes("joselito")},esClienteCatarro(e){const a=this.clientesDisponibles.find(a=>a.id.toString()===e.toString());return a&&a.nombre.toLowerCase().includes("catarro")},obtenerEmbarqueCliente(e){const a=this.productosPorCliente[e],t=this.clienteCrudos[e];return{fecha:this.embarque.fecha,cargaCon:this.embarque.cargaCon,productos:a,clienteCrudos:{[e]:t},kilosCrudos:this.embarque.kilosCrudos||{}}},async verificarFechaExistente(e){if(this.embarqueBloqueado)alert("El embarque está bloqueado. No se puede cambiar la fecha.");else if(e!==this.embarque.fecha)try{const a=Object(i["h"])(),t=new Date(e),o=t.toISOString().split("T")[0],r=Object(i["c"])(a,"embarques"),s=await Object(i["g"])(r),n=s.docs.filter(e=>{if(this.embarqueId&&e.id===this.embarqueId)return!1;const a=e.data();let t;if(a.fecha&&"function"===typeof a.fecha.toDate)t=a.fecha.toDate();else if(a.fecha instanceof Date)t=a.fecha;else{if("string"!==typeof a.fecha)return!1;t=new Date(a.fecha)}const r=t.toISOString().split("T")[0];return r===o});if(n.length>0)return void alert("Ya existe un embarque para la fecha seleccionada. Por favor, seleccione otra fecha.");this.embarqueId&&localStorage.setItem("ultimoEmbarqueId",this.embarqueId),this.embarque.fecha=e,this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()}catch(a){console.error("Error al verificar fecha existente:",a),alert("Hubo un error al verificar la fecha. Por favor, intente nuevamente.")}},async crearCuentaCatarro(e,a,t){try{this.isCreatingAccount=!0;const e={...this.embarque,productos:a,crudos:t};await S["a"].crearCuentaCatarro(e,this.$router)}catch(o){console.error("Error al crear cuenta para Catarro:",o),alert("Error al crear cuenta para Catarro")}finally{this.isCreatingAccount=!1}},async crearCuentaOzuna(e,a,t){try{this.isCreatingAccount=!0;const e="4",o={...this.embarque,productos:a,clienteCrudos:{[e]:t}};await S["a"].crearCuentaOzuna(o,this.$router),alert("Cuenta de Ozuna creada exitosamente y abierta en una nueva pestaña.")}catch(o){console.error("Error al crear cuenta para Ozuna:",o),alert("Error al crear cuenta para Ozuna: "+o.message)}finally{this.isCreatingAccount=!1}}},watch:{embarque:{handler(e){this.isUndoRedo?this.isUndoRedo=!1:(localStorage.setItem("embarque",JSON.stringify(e)),this.undoStack.push(JSON.stringify(e)),this.redoStack=[],this.guardarCambiosEnTiempoReal())},deep:!0},clienteCrudos:{handler(){this.guardarCambiosEnTiempoReal()},deep:!0},"embarque.productos":{handler(e){e.forEach(e=>{})},deep:!0}},async created(){const e=this.$route.params.id;await this.cargarEmbarque(e),this.undoStack.push(JSON.stringify(this.embarque)),this.actualizarMedidasUsadas(),this.cargarClientesPersonalizados(),await this.iniciarPresenciaUsuario(),this.escucharUsuariosActivos()},mounted(){const e=this.detectarRecarga(),a=this.$route.params.id;if(a&&"nuevo"!==a)this.cargarEmbarque(a);else{const a=localStorage.getItem("ultimoEmbarqueId"),t=localStorage.getItem("ultimaRuta");if(e&&a&&t&&t.includes("nuevo-embarque"))return console.log("Detectada recarga de página, restaurando embarque "+a),void this.$router.replace({name:"NuevoEmbarque",params:{id:a}});this.resetearEmbarque()}localStorage.setItem("ultimaRuta",window.location.pathname),a&&"nuevo"!==a&&localStorage.setItem("ultimoEmbarqueId",a),this.cargarClientesPersonalizados(),this.authStore.user&&this.embarqueId&&this.iniciarPresencia(),window.addEventListener("beforeunload",this.handleBeforeUnload),this.$nextTick(()=>{const e=document.querySelectorAll(".crudo input, .crudo select");e.forEach(e=>{e.addEventListener("input",this.actualizarCrudos)})})},detectarRecarga(){if(window.performance&&window.performance.navigation)return 1===window.performance.navigation.type;if(window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("navigation")){const e=window.performance.getEntriesByType("navigation");if(e.length>0&&e[0].type)return"reload"===e[0].type}const e=localStorage.getItem("ultimaVisita"),a=Date.now();return localStorage.setItem("ultimaVisita",a),!!(e&&a-parseInt(e)<5e3)},handleBeforeUnload(e){this.embarqueId&&(localStorage.setItem("ultimoEmbarqueId",this.embarqueId),localStorage.setItem("ultimaRuta",window.location.pathname))},beforeDestroy(){this.unsubscribe&&this.unsubscribe();const e=document.querySelectorAll(".crudo input, .crudo select");e.forEach(e=>{e.removeEventListener("input",this.actualizarCrudos)}),this.unsubscribeUsuarios&&(console.log("Limpiando escucha de usuarios activos"),this.unsubscribeUsuarios()),window.removeEventListener("beforeunload",this.handleBeforeUnload)},updated(){}},y=P,A=(t("dc70"),t("2877")),w=Object(A["a"])(y,o,r,!1,null,"567e2a15",null);a["a"]=w.exports}}]);