(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app.69dbab32"],{"4dc0":function(a,e,i){"use strict";i.r(e);var t=function(){var a=this,e=a._self._c;return e("div",{staticClass:"rendimientos-container"},[e("div",{staticClass:"header-container"},[e("button",{staticClass:"btn-volver",on:{click:a.volverAEmbarque}},[e("i",{staticClass:"fas fa-arrow-left"}),a._v(" Volver al Embarque ")]),e("h2",[a._v("Rendimientos por Medida")]),e("button",{staticClass:"btn-nota",on:{click:a.abrirModalNota}},[e("i",{staticClass:"fas fa-sticky-note"}),a._v(" Agregar Nota ")]),e("button",{staticClass:"btn-costos",on:{click:a.irAGestionCostos}},[e("i",{staticClass:"fas fa-dollar-sign"}),a._v(" Gesti√≥n de Costos ")]),e("button",{staticClass:"btn-preparacion",on:{click:a.irAPreparacion}},[e("i",{staticClass:"fas fa-tasks"}),a._v(" Ir a Preparaci√≥n ")]),e("button",{staticClass:"btn-configuracion",on:{click:a.abrirModalConfiguracion}},[e("i",{staticClass:"fas fa-cog"}),a._v(" Configurar Pesos ")]),e("button",{staticClass:"btn-pdf",on:{click:a.generarPDF}},[e("i",{staticClass:"fas fa-file-pdf"}),a._v(" Generar PDF ")])]),a.embarqueData?e("div",{staticClass:"rendimientos-grid"},a._l(a.medidasUnicas,(function(i,t){var s;return e("div",{key:t,staticClass:"rendimiento-card"},[e("div",{staticClass:"medida-info"},[e("div",{staticClass:"medida-header"},[e("span",{staticClass:"medida-label editable-label",on:{click:function(e){return a.editarNombreMedida(i)}}},[a._v(" "+a._s(a.obtenerNombreMedidaPersonalizado(i))+" ")]),e("div",{staticClass:"controles-medida"},[e("div",{staticClass:"ocultar-control"},[e("input",{directives:[{name:"model",rawName:"v-model",value:a.medidaOculta[i],expression:"medidaOculta[medida]"}],attrs:{type:"checkbox",id:"ocultar-"+t},domProps:{checked:Array.isArray(a.medidaOculta[i])?a._i(a.medidaOculta[i],null)>-1:a.medidaOculta[i]},on:{change:[function(e){var t=a.medidaOculta[i],s=e.target,o=!!s.checked;if(Array.isArray(t)){var n=null,r=a._i(t,n);s.checked?r<0&&a.$set(a.medidaOculta,i,t.concat([n])):r>-1&&a.$set(a.medidaOculta,i,t.slice(0,r).concat(t.slice(r+1)))}else a.$set(a.medidaOculta,i,o)},a.guardarEstadoOculto]}}),e("label",{attrs:{for:"ocultar-"+t}},[a._v("Ocultar en PDF")])]),e("div",{staticClass:"analizar-ganancia-control"},[e("input",{directives:[{name:"model",rawName:"v-model",value:a.analizarGanancia[i],expression:"analizarGanancia[medida]"}],attrs:{type:"checkbox",id:"analizar-"+t},domProps:{checked:Array.isArray(a.analizarGanancia[i])?a._i(a.analizarGanancia[i],null)>-1:a.analizarGanancia[i]},on:{change:[function(e){var t=a.analizarGanancia[i],s=e.target,o=!!s.checked;if(Array.isArray(t)){var n=null,r=a._i(t,n);s.checked?r<0&&a.$set(a.analizarGanancia,i,t.concat([n])):r>-1&&a.$set(a.analizarGanancia,i,t.slice(0,r).concat(t.slice(r+1)))}else a.$set(a.analizarGanancia,i,o)},a.guardarEstadoAnalisis]}}),e("label",{attrs:{for:"analizar-"+t}},[a._v("Analizar ganancia")])]),e("div",{staticClass:"maquila-ganancia-control"},[e("input",{directives:[{name:"model",rawName:"v-model",value:a.analizarMaquilaGanancia[i],expression:"analizarMaquilaGanancia[medida]"}],attrs:{type:"checkbox",id:"maquila-"+t},domProps:{checked:Array.isArray(a.analizarMaquilaGanancia[i])?a._i(a.analizarMaquilaGanancia[i],null)>-1:a.analizarMaquilaGanancia[i]},on:{change:[function(e){var t=a.analizarMaquilaGanancia[i],s=e.target,o=!!s.checked;if(Array.isArray(t)){var n=null,r=a._i(t,n);s.checked?r<0&&a.$set(a.analizarMaquilaGanancia,i,t.concat([n])):r>-1&&a.$set(a.analizarMaquilaGanancia,i,t.slice(0,r).concat(t.slice(r+1)))}else a.$set(a.analizarMaquilaGanancia,i,o)},a.guardarEstadoAnalisis]}}),e("label",{attrs:{for:"maquila-"+t}},[a._v("Maquila ganancia")])]),a.analizarMaquilaGanancia[i]?e("div",{staticClass:"maquila-precio-input"},[e("input",{directives:[{name:"model",rawName:"v-model",value:a.precioMaquila[i],expression:"precioMaquila[medida]"}],staticClass:"precio-maquila-input",attrs:{type:"number",step:"0.01",placeholder:"Precio por kg"},domProps:{value:a.precioMaquila[i]},on:{input:[function(e){e.target.composing||a.$set(a.precioMaquila,i,e.target.value)},a.guardarEstadoAnalisis]}})]):a._e()])]),e("div",{staticClass:"input-group"},[a.esMedidaMix(i)?[e("div",{staticClass:"mix-inputs"},[e("div",{staticClass:"mix-input"},[e("label",{staticClass:"editable-label",on:{click:function(e){return a.editarEtiqueta(i,"medida1")}}},[a._v(" "+a._s(a.obtenerEtiqueta(i,"medida1"))+": ")]),e("input",{directives:[{name:"model",rawName:"v-model",value:a.kilosCrudos[i].medida1,expression:"kilosCrudos[medida].medida1"}],attrs:{type:"number",placeholder:"Kilos medida 1"},domProps:{value:a.kilosCrudos[i].medida1},on:{input:[function(e){e.target.composing||a.$set(a.kilosCrudos[i],"medida1",e.target.value)},function(e){return a.calcularRendimiento(i)}]}})]),e("div",{staticClass:"mix-input"},[e("label",{staticClass:"editable-label",on:{click:function(e){return a.editarEtiqueta(i,"medida2")}}},[a._v(" "+a._s(a.obtenerEtiqueta(i,"medida2"))+": ")]),e("input",{directives:[{name:"model",rawName:"v-model",value:a.kilosCrudos[i].medida2,expression:"kilosCrudos[medida].medida2"}],attrs:{type:"number",placeholder:"Kilos medida 2"},domProps:{value:a.kilosCrudos[i].medida2},on:{input:[function(e){e.target.composing||a.$set(a.kilosCrudos[i],"medida2",e.target.value)},function(e){return a.calcularRendimiento(i)}]}})])])]:[e("label",[a._v("Kilos en crudo:")]),e("input",{directives:[{name:"model",rawName:"v-model",value:a.kilosCrudos[i],expression:"kilosCrudos[medida]"}],attrs:{type:"number",placeholder:"Ingrese kilos"},domProps:{value:a.kilosCrudos[i]},on:{input:[function(e){e.target.composing||a.$set(a.kilosCrudos,i,e.target.value)},function(e){return a.calcularRendimiento(i)}]}})]],2),e("div",{staticClass:"resultados"},[e("p",[a._v("Total embarcado: "+a._s(a.formatearNumero(a.obtenerTotalEmbarcado(i)))+" kg")]),e("p",{staticClass:"rendimiento"},[a._v(" Rendimiento: "),e("span",{class:{"rendimiento-alto":a.getRendimiento(i)>1}},[a._v(" "+a._s(a.getRendimiento(i).toFixed(2))+" ")])]),a.gananciasCalculadas[i]&&a.analizarGanancia[i]?e("div",{staticClass:"ganancia-info"},[a._m(0,!0),e("div",{staticClass:"ganancia-detalles"},[e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Precio de Venta:")]),e("div",{staticClass:"precio-venta-container"},[e("span",{staticClass:"valor precio-venta"},[a._v("$"+a._s(a.formatearPrecio(a.gananciasCalculadas[i].precioVenta)))]),a.gananciasCalculadas[i].esPromedio?e("span",{staticClass:"precio-promedio-badge",attrs:{title:"Precio promedio ponderado. Clientes con precios espec√≠ficos: "+a.gananciasCalculadas[i].clientesConEspecifico.join(", ")}},[a._v(" üìä Promedio ")]):a.gananciasCalculadas[i].esEspecifico?e("span",{staticClass:"precio-especifico-badge",attrs:{title:"Precio espec√≠fico m√°s reciente para "+a.gananciasCalculadas[i].clienteEspecifico}},[a._v(" üìå "+a._s(a.gananciasCalculadas[i].clienteEspecifico)+" ")]):e("span",{staticClass:"precio-general-badge",attrs:{title:"Precio general"}},[a._v(" üåê General ")])])]),e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Costo Final:")]),e("div",{staticClass:"costo-final-container"},[e("span",{staticClass:"valor costo-final"},[a._v("$"+a._s(a.formatearPrecio(a.gananciasCalculadas[i].costoFinal)))]),a.debeAplicarCostoExtra(i)?e("span",{staticClass:"costo-extra-indicator"},[a._v(" (+ $"+a._s((null===(s=a.embarqueData)||void 0===s?void 0:s.costoExtra)||18)+" extra) ")]):a._e()])]),e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Ganancia/kg:")]),e("span",{staticClass:"valor ganancia-unitaria",class:{"ganancia-positiva":a.gananciasCalculadas[i].gananciaUnitaria>0,"ganancia-negativa":a.gananciasCalculadas[i].gananciaUnitaria<0}},[a._v(" $"+a._s(a.formatearPrecio(a.gananciasCalculadas[i].gananciaUnitaria))+" ")])]),e("div",{staticClass:"ganancia-item ganancia-total-item"},[e("span",{staticClass:"label"},[a._v("Ganancia Total:")]),e("span",{staticClass:"valor ganancia-total",class:{"ganancia-positiva":a.gananciasCalculadas[i].gananciaTotal>0,"ganancia-negativa":a.gananciasCalculadas[i].gananciaTotal<0}},[a._v(" $"+a._s(a.formatearPrecio(a.gananciasCalculadas[i].gananciaTotal))+" ")])]),e("div",{staticClass:"ganancia-fecha"},[e("span",{staticClass:"fecha-precio"},[a._v("Precio del: "+a._s(a.formatearFecha(a.gananciasCalculadas[i].fechaPrecio)))])])])]):a.analizarGanancia[i]?e("div",{staticClass:"sin-precio-venta"},[e("p",{staticClass:"aviso-sin-precio"},[a._v("‚ö†Ô∏è No se encontr√≥ precio de venta para esta medida")])]):a._e(),a.analizarMaquilaGanancia[i]?e("div",{staticClass:"maquila-ganancia-info"},[a._m(1,!0),e("div",{staticClass:"maquila-ganancia-detalles"},[e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Kilos Embarcados:")]),e("span",{staticClass:"valor"},[a._v(a._s(a.formatearNumero(a.obtenerTotalEmbarcado(i)))+" kg")])]),e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Precio Maquila:")]),e("span",{staticClass:"valor precio-maquila"},[a._v("$"+a._s(a.formatearPrecio(a.precioMaquila[i]||0)))])]),e("div",{staticClass:"ganancia-item ganancia-total-item"},[e("span",{staticClass:"label"},[a._v("Ganancia Total Maquila:")]),e("span",{staticClass:"valor ganancia-total ganancia-positiva"},[a._v(" $"+a._s(a.formatearPrecio(a.calcularGananciaMaquila(i)))+" ")])])])]):a._e()])])])})),0):e("div",[e("p",[a._v("Cargando datos del embarque...")])]),a.embarqueData&&a.obtenerTallasCrudosUnicas().length>0?e("div",{staticClass:"crudos-ganancias-section"},[e("h2",[a._v("üí∞ Ganancias de Crudos por Talla")]),e("div",{staticClass:"crudos-ganancias-grid"},a._l(a.obtenerTallasCrudosUnicas(),(function(i){return e("div",{key:"crudo-"+i,staticClass:"crudo-ganancia-card"},[e("div",{staticClass:"crudo-ganancia-header"},[e("h4",[a._v(a._s(i))]),e("div",{staticClass:"crudo-ganancia-controls"},[e("label",{staticClass:"checkbox-container"},[e("input",{directives:[{name:"model",rawName:"v-model",value:a.analizarGananciaCrudos[i],expression:"analizarGananciaCrudos[talla]"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(a.analizarGananciaCrudos[i])?a._i(a.analizarGananciaCrudos[i],null)>-1:a.analizarGananciaCrudos[i]},on:{change:[function(e){var t=a.analizarGananciaCrudos[i],s=e.target,o=!!s.checked;if(Array.isArray(t)){var n=null,r=a._i(t,n);s.checked?r<0&&a.$set(a.analizarGananciaCrudos,i,t.concat([n])):r>-1&&a.$set(a.analizarGananciaCrudos,i,t.slice(0,r).concat(t.slice(r+1)))}else a.$set(a.analizarGananciaCrudos,i,o)},a.guardarEstadoAnalisisCrudos]}}),e("span",{staticClass:"checkmark"}),a._v(" Analizar ganancia ")])])]),a.gananciasCalculadasCrudos[i]&&a.analizarGananciaCrudos[i]?e("div",{staticClass:"crudo-ganancia-info"},[e("div",{staticClass:"crudo-ganancia-detalles"},[e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Total Kilos:")]),e("span",{staticClass:"valor"},[a._v(a._s(a.formatearNumero(a.gananciasCalculadasCrudos[i].totalKilos))+" kg")])]),e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Precio Promedio:")]),e("div",{staticClass:"precio-container"},[e("span",{staticClass:"valor precio-venta"},[a._v("$"+a._s(a.formatearPrecio(a.gananciasCalculadasCrudos[i].precioVenta)))]),a.gananciasCalculadasCrudos[i].hayPreciosIndividuales?e("span",{staticClass:"precio-individual-badge",attrs:{title:"Incluye precios individuales"}},[a._v(" üìù Individual ")]):e("span",{staticClass:"precio-sistema-badge",attrs:{title:"Precio del sistema"}},[a._v(" üåê Sistema ")])])]),e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Costo Base:")]),e("span",{staticClass:"valor costo-base"},[a._v("$"+a._s(a.formatearPrecio(a.gananciasCalculadasCrudos[i].costoBase)))])]),e("div",{staticClass:"ganancia-item"},[e("span",{staticClass:"label"},[a._v("Ganancia/kg:")]),e("span",{staticClass:"valor ganancia-unitaria",class:{"ganancia-positiva":a.gananciasCalculadasCrudos[i].gananciaUnitaria>0,"ganancia-negativa":a.gananciasCalculadasCrudos[i].gananciaUnitaria<0}},[a._v(" $"+a._s(a.formatearPrecio(a.gananciasCalculadasCrudos[i].gananciaUnitaria))+" ")])]),e("div",{staticClass:"ganancia-item ganancia-total-item"},[e("span",{staticClass:"label"},[a._v("Ganancia Total:")]),e("span",{staticClass:"valor ganancia-total",class:{"ganancia-positiva":a.gananciasCalculadasCrudos[i].gananciaTotal>0,"ganancia-negativa":a.gananciasCalculadasCrudos[i].gananciaTotal<0}},[a._v(" $"+a._s(a.formatearPrecio(a.gananciasCalculadasCrudos[i].gananciaTotal))+" ")])]),a.deberMostrarDetallePorCliente(i)?e("div",{staticClass:"detalles-clientes"},[e("h5",[a._v("Detalle por Cliente:")]),a._l(a.gananciasCalculadasCrudos[i].detallesPorCliente,(function(i){return e("div",{key:i.cliente,staticClass:"detalle-cliente"},[e("span",{staticClass:"cliente-nombre"},[a._v(a._s(i.cliente)+":")]),e("span",{staticClass:"cliente-kilos"},[a._v(a._s(a.formatearNumero(i.kilos))+"kg")]),e("span",{staticClass:"cliente-precio"},[a._v("$"+a._s(a.formatearPrecio(i.precioVenta)))]),e("span",{staticClass:"cliente-ganancia",class:{"ganancia-positiva":i.gananciaTotal>0,"ganancia-negativa":i.gananciaTotal<0}},[a._v(" $"+a._s(a.formatearPrecio(i.gananciaTotal))+" ")]),e("span",{staticClass:"fuente-precio",attrs:{title:"Fuente del precio: "+i.fuentePrecio}},[a._v(" "+a._s("individual"===i.fuentePrecio?"üìù":"sistema-especifico"===i.fuentePrecio?"üìå":"üåê")+" ")])])}))],2):a._e()])]):a.analizarGananciaCrudos[i]?e("div",{staticClass:"sin-datos-crudo"},[e("p",{staticClass:"aviso-sin-datos"},[a._v("‚ö†Ô∏è No se encontraron datos de venta para esta talla")])]):e("div",{staticClass:"sin-analisis-crudo"},[e("p",{staticClass:"aviso-sin-analisis"},[a._v("Activar an√°lisis de ganancia para ver detalles")])])])})),0)]):a._e(),a.mostrarModal?e("div",{staticClass:"modal-overlay"},[e("div",{staticClass:"modal-content"},[e("h3",[a._v("Agregar Nota")]),e("textarea",{directives:[{name:"model",rawName:"v-model",value:a.nota,expression:"nota"}],attrs:{placeholder:"Escriba su nota aqu√≠...",rows:"4"},domProps:{value:a.nota},on:{input:function(e){e.target.composing||(a.nota=e.target.value)}}}),e("div",{staticClass:"modal-buttons"},[e("button",{staticClass:"btn-guardar",on:{click:a.guardarNota}},[a._v("Guardar")]),e("button",{staticClass:"btn-cancelar",on:{click:a.cerrarModal}},[a._v("Cancelar")])])])]):a._e(),a.mostrarModalConfiguracion?e("div",{staticClass:"modal-overlay"},[e("div",{staticClass:"modal-content"},[e("h3",[a._v("Configurar Pesos de Taras")]),e("div",{staticClass:"configuracion-grid"},[e("div",{staticClass:"config-item"},[e("label",[a._v("Peso para c√°lculo de costos:")]),e("input",{directives:[{name:"model",rawName:"v-model",value:a.pesoTaraCosto,expression:"pesoTaraCosto"}],attrs:{type:"number",min:"1",max:"50",placeholder:"Peso en kg"},domProps:{value:a.pesoTaraCosto},on:{input:function(e){e.target.composing||(a.pesoTaraCosto=e.target.value)}}}),e("small",{staticClass:"config-help"},[a._v("Peso por defecto usado para calcular costos de crudos")])]),e("div",{staticClass:"config-item"},[e("label",[a._v("Peso para c√°lculo de ventas:")]),e("input",{directives:[{name:"model",rawName:"v-model",value:a.pesoTaraVenta,expression:"pesoTaraVenta"}],attrs:{type:"number",min:"1",max:"50",placeholder:"Peso en kg"},domProps:{value:a.pesoTaraVenta},on:{input:function(e){e.target.composing||(a.pesoTaraVenta=e.target.value)}}}),e("small",{staticClass:"config-help"},[a._v("Peso por defecto usado para calcular ventas de crudos")])])]),e("div",{staticClass:"modal-buttons"},[e("button",{staticClass:"btn-guardar",on:{click:a.guardarConfiguracion}},[a._v("Guardar")]),e("button",{staticClass:"btn-cancelar",on:{click:a.cerrarModalConfiguracion}},[a._v("Cancelar")])])])]):a._e()])},s=[function(){var a=this,e=a._self._c;return e("div",{staticClass:"ganancia-header"},[e("h4",[a._v("üí∞ An√°lisis de Ganancia")])])},function(){var a=this,e=a._self._c;return e("div",{staticClass:"maquila-ganancia-header"},[e("h4",[a._v("üè≠ Maquila Ganancia")])])}],o=(i("14d9"),i("13d5"),i("88e6"),i("70cc"),i("eb03"),i("22e5c"),i("c01e"),i("fa76"),i("8306"),i("1494")),n=i("2ef0"),r=i("6d4d"),c=i("b1ba"),l={name:"Rendimientos",data(){return{kilosCrudos:{},medidasUnicas:[],embarqueData:null,guardadoAutomaticoActivo:!1,nombresMedidasPersonalizados:{},mostrarModal:!1,nota:"",medidaOculta:{},preciosVenta:{},gananciasCalculadas:{},gananciasCalculadasCrudos:{},analizarGanancia:{},analizarGananciaCrudos:{},aplicarCostoExtra:{},diasRecientes:3,pesoTaraCosto:19,pesoTaraVenta:20,mostrarModalConfiguracion:!1,analizarMaquilaGanancia:{},precioMaquila:{},costosCalculados:{},costosGlobalesCache:null}},async created(){var a;this.guardarCambiosEnTiempoReal=Object(n["debounce"])(this.guardarCambiosEnTiempoReal,300),await c["a"].init(),window.addEventListener("online",this.syncOfflineRendimientos);const e=this.$route.params.id;let i=null;try{i=await c["a"].getById(e)}catch(t){console.warn("[Rendimientos] No se pudo obtener el registro offline:",t)}if(null!==(a=i)&&void 0!==a&&a.preciosVentaCache&&0===Object.keys(this.preciosVenta).length&&(this.preciosVenta=this.deepClone(i.preciosVentaCache)),navigator.onLine&&await this.syncOfflineRendimientos(),!navigator.onLine&&i)return this.aplicarDatosOffline(i),await this.precargarCostos(),void this.$nextTick(()=>{this.calcularGanancias(),this.calcularGananciasCrudos()});await this.cargarEmbarque(),await this.cargarPreciosVenta(),await this.precargarCostos()},async activated(){console.log("Recargando datos de rendimientos..."),navigator.onLine&&await this.syncOfflineRendimientos();const a=this.$route.params.id,e=await c["a"].getById(a).catch(()=>null);if(!navigator.onLine&&e)return this.aplicarDatosOffline(e),await this.precargarCostos(),void this.$nextTick(()=>{this.calcularGanancias(),this.calcularGananciasCrudos()});await this.cargarEmbarque(),await this.cargarPreciosVenta(),await this.precargarCostos(),this.$nextTick(()=>{this.calcularGanancias(),this.calcularGananciasCrudos()})},methods:{deepClone(a){if(void 0===a||null===a)return a;try{return JSON.parse(JSON.stringify(a))}catch(e){return console.warn("[Rendimientos] No se pudo clonar profundamente un valor, devolviendo referencia original.",e),a}},crearPayloadRendimientos(){var a;return{kilosCrudos:this.deepClone(this.kilosCrudos),medidaOculta:{...this.medidaOculta},analizarGanancia:{...this.analizarGanancia},analizarGananciaCrudos:{...this.analizarGananciaCrudos},analizarMaquilaGanancia:{...this.analizarMaquilaGanancia},precioMaquila:{...this.precioMaquila},pesoTaraCosto:Number(this.pesoTaraCosto)||0,pesoTaraVenta:Number(this.pesoTaraVenta)||0,nombresMedidasPersonalizados:{...this.nombresMedidasPersonalizados},notaRendimientos:(null===(a=this.embarqueData)||void 0===a?void 0:a.notaRendimientos)||""}},async actualizarOfflineRendimientos(a,e={},i={}){const t=!1!==i.includeInDocData,s=this.$route.params.id;await c["a"].mergeSave(s,i=>{const o=i?{...i}:{},n=this.deepClone(e)||{};let r=i&&i.docData?{...i.docData}:void 0;t&&(r=r||{},Object.assign(r,n));const c={...o,id:s,...n};return void 0!==r&&(c.docData=r),{record:c,options:{pendingSync:a,syncState:a?"pending":"synced"}}})},async persistirCamposRendimientos(a,e={}){if(!a||0===Object.keys(a).length)return;const i=this.deepClone(a);if(await this.actualizarOfflineRendimientos(!navigator.onLine,i,e),navigator.onLine)try{const a=Object(o["h"])(),t=Object(o["e"])(a,"embarques",this.$route.params.id);await Object(o["s"])(t,i),await this.actualizarOfflineRendimientos(!1,i,e)}catch(t){console.error("[Rendimientos] Error al guardar cambios en Firestore:",t)}},aplicarDatosOffline(a){var e,i,t,s;const o=null!==a&&void 0!==a&&a.docData?this.deepClone(a.docData):{},n=o.clientes||(null===a||void 0===a?void 0:a.clientes)||[];this.embarqueData={...o,clientes:n},this.nombresMedidasPersonalizados=this.deepClone(o.nombresMedidasPersonalizados||(null===a||void 0===a?void 0:a.nombresMedidasPersonalizados)||{}),this.medidaOculta=this.deepClone((null===a||void 0===a?void 0:a.medidaOculta)||o.medidaOculta||{}),this.analizarGanancia=this.deepClone((null===a||void 0===a?void 0:a.analizarGanancia)||o.analizarGanancia||{}),this.analizarGananciaCrudos=this.deepClone((null===a||void 0===a?void 0:a.analizarGananciaCrudos)||o.analizarGananciaCrudos||{}),this.analizarMaquilaGanancia=this.deepClone((null===a||void 0===a?void 0:a.analizarMaquilaGanancia)||o.analizarMaquilaGanancia||{}),this.precioMaquila=this.deepClone((null===a||void 0===a?void 0:a.precioMaquila)||o.precioMaquila||{}),this.pesoTaraCosto=null!==(e=null!==(i=null===a||void 0===a?void 0:a.pesoTaraCosto)&&void 0!==i?i:o.pesoTaraCosto)&&void 0!==e?e:this.pesoTaraCosto,this.pesoTaraVenta=null!==(t=null!==(s=null===a||void 0===a?void 0:a.pesoTaraVenta)&&void 0!==s?s:o.pesoTaraVenta)&&void 0!==t?t:this.pesoTaraVenta,this.kilosCrudos=this.deepClone((null===a||void 0===a?void 0:a.kilosCrudos)||o.kilosCrudos||{}),o.notaRendimientos&&(this.embarqueData.notaRendimientos=o.notaRendimientos),this.preciosVenta=this.deepClone((null===a||void 0===a?void 0:a.preciosVentaCache)||this.preciosVenta||{}),this.obtenerMedidasUnicas(),this.guardadoAutomaticoActivo=!0},async syncOfflineRendimientos(){if(navigator.onLine)try{const a=this.$route.params.id,e=await c["a"].getById(a);if(!e||!e.pendingSync)return;const i=["kilosCrudos","medidaOculta","analizarGanancia","analizarGananciaCrudos","analizarMaquilaGanancia","precioMaquila","pesoTaraCosto","pesoTaraVenta","nombresMedidasPersonalizados","notaRendimientos"],t={};if(i.forEach(a=>{void 0!==e[a]?t[a]=e[a]:e.docData&&void 0!==e.docData[a]&&(t[a]=e.docData[a])}),0===Object.keys(t).length)return;await this.persistirCamposRendimientos(t)}catch(a){console.error("[Rendimientos] Error al sincronizar datos offline:",a)}},toLocalYMD(a){if(!a)return"";let e;if("object"===typeof a&&a.seconds)e=new Date(1e3*a.seconds);else if(a instanceof Date)e=a;else if("string"===typeof a&&a.includes("-")){const[i,t,s]=a.split("-");e=new Date(i,t-1,s)}else e=new Date(a);const i=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${i}-${t}-${s}`},normalizarFecha(a){if(!a)return null;try{if("object"===typeof a&&a.seconds)return new Date(1e3*a.seconds);const e=new Date(a);return isNaN(e.getTime())?(console.error("Fecha inv√°lida:",a),null):e}catch(e){return console.error("Error al normalizar fecha:",a,e),null}},obtenerNombreCliente(a){if(!this.embarqueData||!this.embarqueData.clientes)return"";const e=this.embarqueData.clientes.find(e=>e.id.toString()===a.toString());return e?e.nombre:""},calcularTarasCrudosPorMedida(){if(!this.embarqueData||!this.embarqueData.clientes)return{};const a={};return this.embarqueData.clientes.forEach(e=>{e.crudos&&Array.isArray(e.crudos)&&e.crudos.forEach(i=>{i&&i.items&&Array.isArray(i.items)&&i.items.forEach(i=>{if(i.talla){const t="Ozuna"!==e.nombre||i.esVenta;if(t){const t=i.talla;a[t]||(a[t]={totalTaras:0,totalKilos:0,detalles:[]});let s=0,o=0;if(i.taras){const a=/^(\d+)-(\d+)$/.exec(i.taras);if(a){const e=parseInt(a[1])||0;let i=parseInt(a[2])||0;19===i&&(i=this.pesoTaraCosto),s+=e,o+=e*i}else{const[a,e]=i.taras.split("-").map(Number);s+=a||0,o+=(a||0)*(e||0)}}if(i.sobrante){const a=/^(\d+)-(\d+)$/.exec(i.sobrante);if(a){const e=parseInt(a[1])||0;let i=parseInt(a[2])||0;19===i&&(i=this.pesoTaraCosto),s+=e,o+=e*i}else{const[a,e]=i.sobrante.split("-").map(Number);s+=a||0,o+=(a||0)*(e||0)}}a[t].totalTaras+=s,a[t].totalKilos+=o,s>0&&a[t].detalles.push({cliente:e.nombre,taras:i.taras,sobrante:i.sobrante,tarasCalculadas:s,kilosCalculados:o})}}})})}),a},calcularCostosCrudos(a){if(!a||!this.embarqueData)return{};const e={},i=this.embarqueData.costosPorMedida||{},t=Object.keys(a);return t.forEach(a=>{const t=Number(i[a])||0,s=t+3.5;e[a]={costoBase:t,costoFinal:s}}),e},obtenerClienteIdParaPrecios(a){const e=a.toLowerCase();return e.includes("joselito")?"joselito":e.includes("catarro")?"catarro":e.includes("otilio")?"otilio":e.includes("ozuna")?"ozuna":e.includes("veronica")||e.includes("lorena")?"veronica":null},async cargarEmbarque(){try{const a=Object(o["h"])(),e=this.$route.params.id,i=Object(o["e"])(a,"embarques",e);if(!navigator.onLine){const a=await c["a"].getById(e).catch(()=>null);if(a)return void this.aplicarDatosOffline(a)}const t=await Object(o["f"])(i);if(t.exists()){this.embarqueData=t.data(),this.nombresMedidasPersonalizados=this.embarqueData.nombresMedidasPersonalizados||{},this.obtenerMedidasUnicas(),this.medidaOculta=this.embarqueData.medidaOculta||{},this.analizarGanancia=this.embarqueData.analizarGanancia||{},this.analizarGananciaCrudos=this.embarqueData.analizarGananciaCrudos||{},this.aplicarCostoExtra=this.embarqueData.aplicarCostoExtra||{},this.analizarMaquilaGanancia=this.embarqueData.analizarMaquilaGanancia||{},this.precioMaquila=this.embarqueData.precioMaquila||{},this.pesoTaraCosto=this.embarqueData.pesoTaraCosto||19,this.pesoTaraVenta=this.embarqueData.pesoTaraVenta||20;const a=this.embarqueData.kilosCrudos||{};this.kilosCrudos={...a},this.medidasUnicas.forEach(a=>{this.kilosCrudos[a]||(this.esMedidaMix(a)?this.$set(this.kilosCrudos,a,{medida1:0,medida2:0,etiqueta1:"Kilos en crudo (Medida 1)",etiqueta2:"Kilos en crudo (Medida 2)"}):this.$set(this.kilosCrudos,a,0))}),this.guardadoAutomaticoActivo=!0,await c["a"].mergeSave(e,a=>{var i;const t={...a||{},id:e,docData:this.deepClone(this.embarqueData)};return{record:t,options:{pendingSync:null!==(i=null===a||void 0===a?void 0:a.pendingSync)&&void 0!==i&&i,syncState:null!==a&&void 0!==a&&a.pendingSync?a.syncState:"synced"}}}),await this.actualizarOfflineRendimientos(!1,this.crearPayloadRendimientos()),Object.keys(this.preciosVenta).length>0&&this.$nextTick(async()=>{await this.calcularGanancias()})}else console.error("No se encontr√≥ el embarque")}catch(a){console.error("Error al cargar el embarque:",a)}},async cargarPreciosVenta(){try{if(!navigator.onLine){if(0===Object.keys(this.preciosVenta).length){const a=await c["a"].getById(this.$route.params.id).catch(()=>null);null!==a&&void 0!==a&&a.preciosVentaCache&&(this.preciosVenta=this.deepClone(a.preciosVentaCache))}return}const a=Object(o["h"])(),e=Object(o["c"])(a,"precios"),i=Object(o["o"])(e,Object(o["l"])("fecha","desc")),t=await Object(o["g"])(i),s=new Map;t.docs.forEach(a=>{const e={id:a.id,...a.data()},i=e.producto.toLowerCase().trim();s.has(i)||s.set(i,[]),s.get(i).push(e)});const n={};s.forEach((a,e)=>{const i=a.sort((a,e)=>new Date(e.fecha)-new Date(a.fecha));n[e]=i}),this.preciosVenta=n,await this.actualizarOfflineRendimientos(!1,{preciosVentaCache:n},{includeInDocData:!1}),this.embarqueData&&this.$nextTick(async()=>{await this.calcularGanancias()})}catch(a){console.error("Error al cargar precios de venta:",a)}},encontrarPreciosParaMedida(a){let e=this.preciosVenta[a.toLowerCase().trim()];if(e&&e.length>0)return{medidaEncontrada:a,precios:e};const i=a.toLowerCase().trim().replace(" maquila ozuna","").replace(/\s+(vayon|ahumada|sin\s+cal|cal|c\/c|crudo|limpio).*$/g,"").trim();if(e=this.preciosVenta[i],e&&e.length>0)return{medidaEncontrada:i,precios:e};const t=i.replace(/-/g," "),s=i.replace(/ /g,"-");if(e=this.preciosVenta[t],e&&e.length>0)return{medidaEncontrada:t,precios:e};if(e=this.preciosVenta[s],e&&e.length>0)return{medidaEncontrada:s,precios:e};const o=i.toLowerCase();for(const[n,r]of Object.entries(this.preciosVenta)){const a=n.toLowerCase().trim();if(o.includes(a)&&a.length>2)return{medidaEncontrada:n,precios:r};if(a.includes(o)&&o.length>2)return{medidaEncontrada:n,precios:r}}return null},obtenerPrecioVentaParaFecha(a,e,i=null){const t=this.encontrarPreciosParaMedida(a);if(!t)return console.log(`[${a}] No se encontraron precios para ninguna variaci√≥n`),console.log(`[${a}] Precios disponibles:`,Object.keys(this.preciosVenta)),null;const{medidaEncontrada:s,precios:o}=t;s!==a&&console.log(`[${a}] Precio encontrado como: ${s}`);const n=this.normalizarFecha(e);if(!n)return console.warn(`[${a}] Fecha de embarque inv√°lida:`,e),null;const r=this.toLocalYMD(n),c=new Date(r),l=this.toLocalYMD(new Date),d=new Date(l),u=Math.floor((d-c)/864e5),m=u<=this.diasRecientes,h=r>=l,p=m||h;if(o&&0!==o.length||console.log(`[${a}] ‚ö†Ô∏è No se encontraron precios disponibles`),p){let a="";if(h?a="(embarque de hoy/futuro)":m&&(a=`(embarque reciente: hace ${u} d√≠a${1!==u?"s":""})`),i){const a=o.find(a=>a.clienteId===i);if(a)return a}const e=o.find(a=>!a.clienteId);if(e)return e}else{if(i)for(const a of o){const e=this.normalizarFecha(a.fecha);if(!e)continue;const t=this.toLocalYMD(e);if(t<=r&&a.clienteId===i)return a}for(const a of o){const e=this.normalizarFecha(a.fecha);if(!e)continue;const i=this.toLocalYMD(e);if(i<=r&&!a.clienteId)return a}}const C=o.filter(a=>!a.clienteId);return C.length>0?C[C.length-1]:o[o.length-1]},async encontrarCostoParaMedida(a){var e;const i=(null===(e=this.embarqueData)||void 0===e?void 0:e.costosPorMedida)||{};console.log(`üîç Buscando costo para: "${a}"`),console.log("üìã Costos en embarque:",Object.keys(i));let t=Number(i[a]);if(t&&t>0)return console.log(`‚úÖ Coincidencia exacta en embarque: ${a} = $${t}`),{medidaEncontrada:a,costo:t};const s=a.toLowerCase().trim();for(const[r,c]of Object.entries(i))if(r.toLowerCase().trim()===s){const a=Number(c);if(a>0)return console.log(`‚úÖ Coincidencia exacta (case insensitive) en embarque: ${r} = $${a}`),{medidaEncontrada:r,costo:a}}console.log("üåê Buscando en medidas registradas globales...");const o=await this.obtenerCostosRegistradosGlobales();if(o[a])return console.log(`‚úÖ Coincidencia exacta en medidas registradas: ${a} = $${o[a].costoBase}`),{medidaEncontrada:a,costo:o[a].costoBase};for(const[r,c]of Object.entries(o))if(r.toLowerCase().trim()===s)return console.log(`‚úÖ Coincidencia exacta (case insensitive) en medidas registradas: ${r} = $${c.costoBase}`),{medidaEncontrada:r,costo:c.costoBase};const n=a.toLowerCase().trim().replace(" maquila ozuna","").replace(/\s+(vayon|ahumada|sin\s+cal|cal|c\/c|crudo|limpio|tirado).*$/g,"").trim();console.log(`üîç Medida normalizada: "${n}"`);for(const[r,c]of Object.entries(i)){const e=r.toLowerCase().trim().replace(" maquila ozuna","").replace(/\s+(vayon|ahumada|sin\s+cal|cal|c\/c|crudo|limpio|tirado).*$/g,"").trim();if(e===n){const e=Number(c);if(e>0)return console.log(`‚ö†Ô∏è [${a}] Usando costo normalizado del embarque: ${r} ($${e})`),{medidaEncontrada:r,costo:e}}}for(const[r,c]of Object.entries(o)){const e=r.toLowerCase().trim().replace(" maquila ozuna","").replace(/\s+(vayon|ahumada|sin\s+cal|cal|c\/c|crudo|limpio|tirado).*$/g,"").trim();if(e===n)return console.log(`‚ö†Ô∏è [${a}] Usando costo normalizado de medidas registradas: ${r} ($${c.costoBase})`),{medidaEncontrada:r,costo:c.costoBase}}return console.log(`‚ùå No se encontr√≥ costo para: "${a}"`),null},async obtenerCostosRegistradosGlobales(){try{var a;const e=Object(o["h"])(),i=Object(o["c"])(e,"historial_costos"),t=await Object(o["g"])(i),s=[];t.forEach(a=>{const e=a.data();s.push({...e,id:a.id})});const n=a=>{try{return a?a.toDate&&"function"===typeof a.toDate?a.toDate():a.seconds?new Date(1e3*a.seconds):"string"===typeof a?new Date(a):a instanceof Date?a:new Date(a):null}catch{return null}};s.sort((a,e)=>{const i=n(a.fecha)||n(a.timestamp)||new Date(0),t=n(e.fecha)||n(e.timestamp)||new Date(0);return t-i});const r=this.normalizarFecha(null===(a=this.embarqueData)||void 0===a?void 0:a.fecha),c=r||new Date;c.setHours(12,0,0,0);const l={},d=new Set;return s.forEach(a=>{if(!d.has(a.medida)){const e=n(a.fecha)||n(a.timestamp)||new Date(0);e.setHours(12,0,0,0),e<=c&&!a.eliminado&&!a.medidaEliminada&&(l[a.medida]={costoBase:a.costoBase,fecha:a.fecha,timestamp:a.timestamp,id:a.id},d.add(a.medida))}}),l}catch(e){return console.error("Error al obtener costos registrados globales:",e),{}}},async precargarCostos(){if(!this.medidasUnicas||0===this.medidasUnicas.length)return;console.log("üîÑ Precargando costos para todas las medidas..."),this.costosGlobalesCache||(this.costosGlobalesCache=await this.obtenerCostosRegistradosGlobales());const a=this.medidasUnicas.map(async a=>{try{const e=await this.calcularCostoFinal(a);this.$set(this.costosCalculados,a,e)}catch(e){console.error(`Error al calcular costo para ${a}:`,e),this.$set(this.costosCalculados,a,0)}});await Promise.all(a),console.log("‚úÖ Costos precargados:",this.costosCalculados)},calcularCostoFinalSync(a){var e,i;if(void 0!==this.costosCalculados[a])return this.costosCalculados[a];const t=(null===(e=this.embarqueData)||void 0===e?void 0:e.costosPorMedida)||{};let s=Number(t[a])||0;if(0===s&&this.costosGlobalesCache)if(this.costosGlobalesCache[a])s=this.costosGlobalesCache[a].costoBase,console.log(`üí∞ [${a}] Usando costo global del cache: $${s}`);else{const e=a.toLowerCase().trim();for(const[i,t]of Object.entries(this.costosGlobalesCache))if(i.toLowerCase().trim()===e){s=t.costoBase,console.log(`üí∞ [${a}] Usando costo global (case insensitive): ${i} = $${s}`);break}}const o=this.getRendimiento(a),n=Math.round(100*o)/100,r=Number(null===(i=this.embarqueData)||void 0===i?void 0:i.costoExtra)||18,c=this.debeAplicarCostoExtra(a);let l;return l=c?Math.round(s*n+r):Math.round(s*n),this.$set(this.costosCalculados,a,l),l},async calcularCostoFinal(a){var e;const i=await this.encontrarCostoParaMedida(a);let t=0,s=a;i?(t=i.costo,s=i.medidaEncontrada,s!==a&&console.log(`üí∞ [${a}] Usando costo de: ${s} ($${t})`)):console.warn(`‚ö†Ô∏è [${a}] No se encontr√≥ costo para esta medida`);const o=this.getRendimiento(a),n=Math.round(100*o)/100,r=Number(null===(e=this.embarqueData)||void 0===e?void 0:e.costoExtra)||18,c=this.debeAplicarCostoExtra(a);return c?Math.round(t*n+r):Math.round(t*n)},async calcularGanancias(){if(!this.embarqueData)return;const a=this.normalizarFecha(this.embarqueData.fecha),e=a?this.toLocalYMD(a):this.toLocalYMD(new Date),i={};for(const s of this.medidasUnicas){var t;if(!this.analizarGanancia[s])continue;const a=await this.calcularCostoFinal(s);this.$set(this.costosCalculados,s,a);const o=(null===(t=this.embarqueData)||void 0===t?void 0:t.costosPorMedida)||{},n=Number(o[s])||0,r=this.obtenerClientesConMedida(s),c=this.calcularPrecioYGanancias(s,e,r,a,n);c&&(i[s]=c)}this.gananciasCalculadas=i,this.calcularGananciasCrudos()},calcularPrecioYGanancias(a,e,i,t,s){let o=[],n=0,r=0,c=0;const l=this.obtenerPrecioVentaParaFecha(a,e,null),d=l?this.normalizarFecha(l.fecha):null;if(i.forEach(({cliente:i,totalEmbarcado:s})=>{const u=this.obtenerClienteIdParaPrecios(i.nombre),m=this.obtenerPrecioVentaParaFecha(a,e,u);let h=l,p=!1;if(m&&m.clienteId){const a=this.normalizarFecha(m.fecha);a&&(!d||a>d)&&(h=m,p=!0)}if(h){const a=Math.round(h.precio),e=Math.round(a-t),l=Math.round(e*s);o.push({cliente:i.nombre,precioVenta:a,totalEmbarcado:s,gananciaUnitaria:e,gananciaTotal:l,fechaPrecio:h.fecha,esEspecifico:p,clienteId:h.clienteId||null}),n+=s,r+=l,c+=a*s}}),0===o.length)return null;const u=n>0?Math.round(c/n):0,m=o.filter(a=>a.esEspecifico),h=new Set(o.map(a=>a.precioVenta)),p=h.size>1,C=1===o.length;console.log(`[${a}] C√°lculo de precios:`,{fechaEmbarque:e,precioGeneral:l?{precio:l.precio,fecha:l.fecha,clienteId:l.clienteId}:null,fechaGeneral:null===l||void 0===l?void 0:l.fecha,clientesConEspecifico:m.map(a=>({cliente:a.cliente,precio:a.precioVenta,fecha:a.fechaPrecio,clienteId:a.clienteId})),precioPromedio:u,tieneMultiplesPrecios:p,soloUnCliente:C,totalClientes:o.length,detallesPorCliente:o.map(a=>({cliente:a.cliente,precio:a.precioVenta,fecha:a.fechaPrecio,esEspecifico:a.esEspecifico}))});let b={esPromedio:p,esEspecifico:!1,clienteEspecifico:null,clientesConEspecifico:m.map(a=>a.cliente),fechaMasReciente:o.reduce((a,e)=>{const i=this.normalizarFecha(e.fechaPrecio);return!a||i&&i>a?i:a},null)};return 1===m.length&&C&&(b.esEspecifico=!0,b.esPromedio=!1,b.clienteEspecifico=m[0].cliente),{precioVenta:u,costoFinal:Math.round(t),costoBase:Math.round(s||0),gananciaUnitaria:Math.round(u-t),gananciaTotal:r,totalEmbarcado:Math.round(n),fechaPrecio:b.fechaMasReciente?this.toLocalYMD(b.fechaMasReciente):void 0,esPromedio:b.esPromedio,esEspecifico:b.esEspecifico,clienteEspecifico:b.clienteEspecifico,clientesConEspecifico:b.clientesConEspecifico,detallesPorCliente:o}},obtenerTallasCrudosUnicas(){if(!this.embarqueData||!this.embarqueData.clientes)return[];const a=new Set;return this.embarqueData.clientes.forEach(e=>{e.crudos&&Array.isArray(e.crudos)&&e.crudos.forEach((i,t)=>{i&&i.items&&Array.isArray(i.items)&&i.items.forEach((i,t)=>{if(i.talla){const t="Ozuna"!==e.nombre||i.esVenta;t?(a.add(i.talla)):0}})})}),Array.from(a).sort()},calcularGananciasCrudos(){if(!this.embarqueData)return;const a=this.toLocalYMD(this.normalizarFecha(this.embarqueData.fecha)||new Date),e={},i=this.obtenerTallasCrudosUnicas();i.forEach(i=>{if(!this.analizarGananciaCrudos[i])return;const t=this.calcularGananciasPorTallaCrudo(i,a);t&&(e[i]=t)}),this.gananciasCalculadasCrudos=e},calcularGananciasPorTallaCrudo(a,e){var i;if(!this.embarqueData||!this.embarqueData.clientes)return null;let t=0,s=0,o=[],n=!1;const r=this.calcularCostoCrudoPorTalla(a),c=r+3.5,l=this.calcularTarasCrudosPorMedida(),d=(null===(i=l[a])||void 0===i?void 0:i.totalKilos)||0;if(this.embarqueData.clientes.forEach(i=>{i.crudos&&Array.isArray(i.crudos)&&i.crudos.forEach(r=>{r&&r.items&&Array.isArray(r.items)&&r.items.forEach(r=>{if(r.talla===a){const c="Ozuna"!==i.nombre||r.esVenta;if(c){const c=this.calcularKilosCrudosItem(r);t+=c;let l=null,d="";if(r.precio&&r.precio>0)l=r.precio,d="individual",n=!0;else{const t=this.obtenerClienteIdParaPrecios(i.nombre),s=this.obtenerPrecioVentaParaFecha(a,e,t);s&&(l=s.precio,d=s.clienteId?"sistema-especifico":"sistema-general")}l&&c>0&&(s+=l*c,o.push({cliente:i.nombre,kilos:c,precioVenta:l,gananciaUnitaria:0,gananciaTotal:0,fuentePrecio:d,taras:r.taras,sobrante:r.sobrante}))}}})})}),0===t)return null;const u=c*d,m=s-u,h=t>0?s/t:0,p=t>0?m/t:0;o.forEach(a=>{a.gananciaUnitaria=p,a.gananciaTotal=a.gananciaUnitaria*a.kilos});const C={talla:a,totalKilos:Math.round(t),totalKilosCosto:Math.round(d),precioVenta:Math.round(h),costoBase:c,costoTotal:Math.round(u),gananciaUnitaria:Math.round(p),gananciaTotal:Math.round(m),hayPreciosIndividuales:n,detallesPorCliente:o,fechaCalculo:this.toLocalYMD(new Date)};return C},calcularCostoCrudoPorTalla(a){var e;const i=(null===(e=this.embarqueData)||void 0===e?void 0:e.costosPorMedida)||{};let t=Number(i[a])||0,s=a;if(0===t){const e=a.toLowerCase();for(const[a,o]of Object.entries(i))if(a.toLowerCase()===e){t=Number(o)||0,s=a;break}}if(0===t&&(!this.embarqueData.costosPorMedida||0===Object.keys(this.embarqueData.costosPorMedida).length)){var o;console.log(`‚ö†Ô∏è No se encontr√≥ costo para talla ${a}. Inicializando costosPorMedida autom√°ticamente.`),this.inicializarCostosPorMedida();const e=(null===(o=this.embarqueData)||void 0===o?void 0:o.costosPorMedida)||{};if(t=Number(e[a])||0,0===t){const i=a.toLowerCase();for(const[a,o]of Object.entries(e))if(a.toLowerCase()===i){t=Number(o)||0,s=a;break}}}return console.log(`üîç DEBUG - Calculando costo para talla ${a}:`,{tallaBuscada:a,medidaEncontrada:s,costosDisponibles:Object.keys(i),costoEncontrado:i[s],costoCalculado:t,esCrudo:a.includes("c/c"),busquedaCaseInsensitive:a!==s}),t},calcularKilosCrudosItem(a){let e=0,i={talla:a.talla,taras:a.taras,sobrante:a.sobrante,kilosDeTaras:0,kilosDeSobrante:0};if(a.taras){const t=/^(\d+)-(\d+)$/.exec(a.taras);if(t){const a=parseInt(t[1])||0;let s=parseInt(t[2])||0;19===s&&(s=this.pesoTaraVenta),i.kilosDeTaras=a*s,e+=i.kilosDeTaras}else{const[t,s]=a.taras.split("-").map(Number);i.kilosDeTaras=(t||0)*(s||0),e+=i.kilosDeTaras}}if(a.sobrante){const t=/^(\d+)-(\d+)$/.exec(a.sobrante);if(t){const a=parseInt(t[1])||0;let s=parseInt(t[2])||0;19===s&&(s=this.pesoTaraVenta),i.kilosDeSobrante=a*s,e+=i.kilosDeSobrante}else{const[t,s]=a.sobrante.split("-").map(Number);i.kilosDeSobrante=(t||0)*(s||0),e+=i.kilosDeSobrante}}return i.kilosTotales=e,e},async guardarEstadoAnalisisCrudos(){await this.persistirCamposRendimientos({analizarGananciaCrudos:this.deepClone(this.analizarGananciaCrudos)})},async inicializarCostosPorMedida(){try{var a;if(!navigator.onLine)return void console.warn("No se puede inicializar costos por medida sin conexi√≥n a internet.");const e=Object(o["h"])(),i=Object(o["c"])(e,"historial_costos"),t=await Object(o["g"])(i),s=[];t.forEach(a=>{const e=a.data();s.push({...e,id:a.id})}),s.sort((a,e)=>{var i,t,s,o;const n=(null===(i=a.timestamp)||void 0===i||null===(t=i.toDate)||void 0===t?void 0:t.call(i))||new Date(a.timestamp),r=(null===(s=e.timestamp)||void 0===s||null===(o=s.toDate)||void 0===o?void 0:o.call(s))||new Date(e.timestamp);return r-n});const n={},r=new Set;s.forEach(a=>{r.has(a.medida)||(a.eliminado||a.medidaEliminada||(n[a.medida]={costoBase:a.costoBase,fecha:a.fecha,timestamp:a.timestamp,id:a.id}),r.add(a.medida))});const c=(null===(a=this.embarqueData)||void 0===a?void 0:a.costosPorMedida)||{};let l=!1;const d=this.obtenerTallasCrudosUnicas();d.forEach(a=>{let e=null;if(n[a])e=n[a];else{const i=a.toLowerCase();for(const[a,t]of Object.entries(n))if(a.toLowerCase()===i){e=t;break}}e&&!c[a]&&(c[a]=e.costoBase,l=!0,console.log(`üí∞ Aplicando costo autom√°tico para ${a}: $${e.costoBase}`))}),l&&(this.embarqueData.costosPorMedida||(this.embarqueData.costosPorMedida={}),Object.assign(this.embarqueData.costosPorMedida,c),await this.persistirCamposRendimientos({costosPorMedida:this.deepClone(this.embarqueData.costosPorMedida)}),console.log("‚úÖ Costos inicializados y guardados autom√°ticamente"))}catch(e){console.error("Error al inicializar costos por medida:",e)}},obtenerNombreClienteDeId(a){const e={joselito:"Joselito",catarro:"Catarro",otilio:"Otilio",ozuna:"Ozuna"};return e[a]||a},obtenerClientesConMedida(a){if(!this.embarqueData||!this.embarqueData.clientes)return[];const e=[],i=a.includes("Maquila Ozuna"),t=a.replace(" Maquila Ozuna","").toLowerCase().trim();return this.embarqueData.clientes.forEach(a=>{let s=0;a.productos.forEach(e=>{if(!e.medida)return;let o=!1;if(o=i?e.medida.toLowerCase().trim()===t&&"Ozuna"===a.nombre&&!e.esVenta:e.medida.toLowerCase().trim()===t&&("Ozuna"!==a.nombre||e.esVenta),o&&!e.refrigerar)if("c/h20"===e.tipo){const a=this.calcularTotalBolsas(e),i=parseFloat(e.camaronNeto)||.65;s+=a*i}else{const a=e.kilos.reduce((a,e)=>a+(Number(e)||0),0),i=this.calcularTotalTaras(e),t=e.restarTaras?3*i:0;s+=a-t}}),s>0&&e.push({cliente:a,totalEmbarcado:s})}),e},async guardarCambiosEnTiempoReal(){if(!this.guardadoAutomaticoActivo)return;const a=this.crearPayloadRendimientos();if(await this.actualizarOfflineRendimientos(!navigator.onLine,a),navigator.onLine)try{const e=Object(o["h"])(),i=Object(o["e"])(e,"embarques",this.$route.params.id);await Object(o["s"])(i,{kilosCrudos:a.kilosCrudos,medidaOculta:a.medidaOculta,analizarGanancia:a.analizarGanancia,analizarGananciaCrudos:a.analizarGananciaCrudos,analizarMaquilaGanancia:a.analizarMaquilaGanancia,precioMaquila:a.precioMaquila,pesoTaraCosto:a.pesoTaraCosto,pesoTaraVenta:a.pesoTaraVenta,nombresMedidasPersonalizados:a.nombresMedidasPersonalizados,notaRendimientos:a.notaRendimientos}),await this.actualizarOfflineRendimientos(!1,a),console.log("Rendimientos guardados (online).")}catch(e){console.error("Error al guardar los rendimientos:",e)}},obtenerMedidasUnicas(){if(!this.embarqueData||!this.embarqueData.clientes)return;const a=new Map,e=new Map;this.embarqueData.clientes.forEach(i=>{i.productos.forEach(t=>{if(t.medida){const s=t.medida.toLowerCase().trim();let o=t.medida.trim(),n=s;if("Ozuna"!==i.nombre||t.esVenta||(o=t.medida.trim()+" Maquila Ozuna",n=s+"_maquila_ozuna"),s.endsWith("mix")){const a=s.split(" ")[0];e.set(a,o)}else a.has(n)||a.set(n,o)}})});const i=Array.from(e.keys()).sort();if(i.length>=2)for(let t=0;t<i.length;t+=2)if(t+1<i.length){const e=`${i[t]}-${i[t+1]} mix`,s=e.toLowerCase();a.has(s)||a.set(s,e),this.kilosCrudos[e]||this.$set(this.kilosCrudos,e,{medida1:0,medida2:0,etiqueta1:`Kilos en crudo (${i[t]})`,etiqueta2:`Kilos en crudo (${i[t+1]})`})}this.medidasUnicas=Array.from(a.values())},obtenerTotalEmbarcado(a){if(!this.embarqueData||!this.embarqueData.clientes)return 0;if(a.includes("-")&&a.endsWith("mix")){const[e,i]=a.split("-").map(a=>a.trim()),t=this.calcularTotalParaMedida(e+" mix"),s=this.calcularTotalParaMedida(i.replace(" mix","")+" mix");return t+s}return this.calcularTotalParaMedida(a)},calcularTotalParaMedida(a){const e=a.includes("Maquila Ozuna"),i=a.replace(" Maquila Ozuna","").toLowerCase().trim();return this.embarqueData.clientes.reduce((a,t)=>a+t.productos.filter(a=>!!a.medida&&(e?a.medida.toLowerCase().trim()===i&&"Ozuna"===t.nombre&&!a.esVenta:a.medida.toLowerCase().trim()===i&&("Ozuna"!==t.nombre||a.esVenta))).reduce((a,e)=>{if("c/h20"===e.tipo){const i=this.calcularTotalBolsas(e),t=parseFloat(e.camaronNeto)||.65;return a+i*t}{const i=e.kilos.reduce((a,e)=>a+(Number(e)||0),0),t=this.calcularTotalTaras(e),s=e.restarTaras?3*t:0;return a+(i-s)}},0),0)},obtenerTotalParaRendimiento(a){if(!this.embarqueData||!this.embarqueData.clientes)return 0;const e=a.toLowerCase(),i=this.embarqueData.clientes.flatMap(a=>a.productos.filter(a=>a.medida&&a.medida.toLowerCase()===e)),t=i.some(a=>"c/h20"===a.tipo);return t?this.obtenerTotalEmbarcado(a):this.obtenerTotalReal(a)},obtenerTotalReal(a){if(!this.embarqueData||!this.embarqueData.clientes)return 0;const e=a.includes("Maquila Ozuna"),i=a.replace(" Maquila Ozuna","").toLowerCase().trim();return this.embarqueData.clientes.reduce((a,t)=>a+t.productos.filter(a=>!!a.medida&&(e?a.medida.toLowerCase().trim()===i&&"Ozuna"===t.nombre&&!a.esVenta:a.medida.toLowerCase().trim()===i&&("Ozuna"!==t.nombre||a.esVenta))).reduce((a,e)=>a+this.calcularTotalKilos(e),0),0)},calcularTotalKilos(a){if(!a.kilos)return 0;const e=a.kilos.reduce((a,e)=>a+(Number(e)||0),0),i=(a.taras||[]).reduce((a,e)=>a+(Number(e)||0),0),t=a.restarTaras?3*i:0;return e-t},calcularTotalTaras(a){const e=(a.taras||[]).reduce((a,e)=>a+(Number(e)||0),0),i=(a.tarasExtra||[]).reduce((a,e)=>a+(Number(e)||0),0);return e+i},calcularTotalBolsas(a){const e=a.reporteTaras||[],i=a.reporteBolsas||[];let t=0;for(let s=0;s<e.length;s++){const a=parseInt(e[s])||0,o=parseInt(i[s])||0;t+=a*o}return t},calcularRendimiento(a){const e=this.obtenerTotalEmbarcado(a);if(0===e)return 0;let i;var t,s;this.esMedidaMix(a)?i=Number((null===(t=this.kilosCrudos[a])||void 0===t?void 0:t.medida1)||0)+Number((null===(s=this.kilosCrudos[a])||void 0===s?void 0:s.medida2)||0):i=Number(this.kilosCrudos[a]||0);const o=i/e;return this.guardarCambiosEnTiempoReal(),o},getRendimiento(a){return this.calcularRendimiento(a)||0},volverAEmbarque(){this.$router.push({name:"EditarEmbarque",params:{id:this.$route.params.id}})},esMedidaMix(a){return a.toLowerCase().includes("mix")},debeAplicarCostoExtra(a){if(!a)return!1;if(this.aplicarCostoExtra||this.$set(this,"aplicarCostoExtra",{}),Object.prototype.hasOwnProperty.call(this.aplicarCostoExtra,a))return Boolean(this.aplicarCostoExtra[a]);const e=(a||"").trim(),i=/maquila\s+ozuna/i.test(e),t=/^(\d+\/\d+)/.test(e)||/^(\d+)\s/.test(e)||/^\d+$/.test(e),s=t&&!i;return this.$set(this.aplicarCostoExtra,a,s),s},obtenerEtiqueta(a,e){return this.kilosCrudos[a]?"medida1"===e?this.kilosCrudos[a].etiqueta1||"Kilos en crudo (Medida 1)":this.kilosCrudos[a].etiqueta2||"Kilos en crudo (Medida 2)":"medida1"===e?"Kilos en crudo (Medida 1)":"Kilos en crudo (Medida 2)"},editarEtiqueta(a,e){this.kilosCrudos[a]||this.$set(this.kilosCrudos,a,{medida1:0,medida2:0,etiqueta1:"Kilos en crudo (Medida 1)",etiqueta2:"Kilos en crudo (Medida 2)"});const i="medida1"===e?this.kilosCrudos[a].etiqueta1:this.kilosCrudos[a].etiqueta2,t=prompt("Ingrese el nuevo nombre para la medida:",i);null!==t&&("medida1"===e?this.$set(this.kilosCrudos[a],"etiqueta1",t):this.$set(this.kilosCrudos[a],"etiqueta2",t),this.guardarCambiosEnTiempoReal())},generarPDF(){var a;const e=this.medidasUnicas.filter(a=>!this.medidaOculta[a]).map(a=>{let e;var i,t;this.esMedidaMix(a)?e={medida1:Number((null===(i=this.kilosCrudos[a])||void 0===i?void 0:i.medida1)||0),medida2:Number((null===(t=this.kilosCrudos[a])||void 0===t?void 0:t.medida2)||0)}:e=Number(this.kilosCrudos[a]||0);const s=this.getRendimiento(a),o=!!this.analizarGanancia[a],n=o?this.calcularCostoFinalSync(a):null;return{medida:a,kilosCrudos:e,totalEmbarcado:this.obtenerTotalEmbarcado(a),rendimiento:s,costoFinal:n,incluyeCostoFinal:o}}),i={...this.embarqueData,notaRendimientos:(null===(a=this.embarqueData)||void 0===a?void 0:a.notaRendimientos)||"",mostrarColumnaCosto:!0},t=Object.entries(this.gananciasCalculadas).filter(([a])=>!this.medidaOculta[a]&&this.analizarGanancia[a]).reduce((a,[e,i])=>(a[e]=i,a),{}),s=this.calcularTarasCrudosPorMedida(),o=Object.entries(this.gananciasCalculadasCrudos).filter(([a])=>this.analizarGananciaCrudos[a]).reduce((a,[e,i])=>(a[e]=i,a),{}),n=this.calcularCostosCrudos(s),c={pesoTaraCosto:this.pesoTaraCosto,pesoTaraVenta:this.pesoTaraVenta},l={};Object.keys(this.analizarMaquilaGanancia).forEach(a=>{this.analizarMaquilaGanancia[a]&&!this.medidaOculta[a]&&(l[a]={totalEmbarcado:this.obtenerTotalEmbarcado(a),precioMaquila:Number(this.precioMaquila[a])||0,gananciaTotal:this.calcularGananciaMaquila(a)})}),Object(r["a"])(e,i,t,s,o,n,c,l)},obtenerNombreMedidaPersonalizado(a){return this.nombresMedidasPersonalizados[a]||a},async editarNombreMedida(a){const e=this.obtenerNombreMedidaPersonalizado(a),i=prompt("Ingrese el nuevo nombre para la medida:",e);null!==i&&""!==i.trim()&&(this.$set(this.nombresMedidasPersonalizados,a,i.trim()),await this.persistirCamposRendimientos({nombresMedidasPersonalizados:{...this.nombresMedidasPersonalizados}}),console.log("Nombre de medida actualizado correctamente"))},abrirModalNota(){var a;this.nota=(null===(a=this.embarqueData)||void 0===a?void 0:a.notaRendimientos)||"",this.mostrarModal=!0},async guardarNota(){await this.persistirCamposRendimientos({notaRendimientos:this.nota}),this.embarqueData||(this.embarqueData={}),this.embarqueData.notaRendimientos=this.nota,this.cerrarModal(),console.log("Nota guardada correctamente")},cerrarModal(){this.mostrarModal=!1,this.nota=""},async guardarEstadoOculto(){await this.persistirCamposRendimientos({medidaOculta:{...this.medidaOculta}}),console.log("Estado de ocultaci√≥n guardado correctamente")},async guardarEstadoAnalisis(){await this.persistirCamposRendimientos({analizarGanancia:{...this.analizarGanancia},analizarGananciaCrudos:{...this.analizarGananciaCrudos},analizarMaquilaGanancia:{...this.analizarMaquilaGanancia},precioMaquila:{...this.precioMaquila}}),console.log("Estado de an√°lisis de ganancia guardado correctamente")},irAGestionCostos(){this.$router.push({name:"GestionCostos",params:{id:this.$route.params.id}})},irAPreparacion(){if(this.embarqueData&&this.embarqueData.fecha){let a=this.embarqueData.fecha;if("string"===typeof a&&/^\d{4}-\d{2}-\d{2}$/.test(a))console.log("Fecha ya est√° en formato YYYY-MM-DD:",a);else if("object"===typeof a&&a.seconds){const e=new Date(1e3*a.seconds),i=e.getUTCFullYear(),t=String(e.getUTCMonth()+1).padStart(2,"0"),s=String(e.getUTCDate()).padStart(2,"0");a=`${i}-${t}-${s}`,console.log("Fecha convertida de Timestamp usando UTC:",a)}else if(a instanceof Date){const e=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),t=String(a.getDate()).padStart(2,"0");a=`${e}-${i}-${t}`,console.log("Fecha convertida de Date:",a)}else"string"===typeof a&&(a.includes("T")&&(a=a.split("T")[0]),console.log("Fecha procesada desde string:",a));this.$router.push({name:"Preparacion",query:{fecha:a,embarqueId:this.$route.params.id}}),console.log("Navegando a Preparaci√≥n con fecha:",a)}else this.$router.push({name:"Preparacion"}),console.log("Navegando a Preparaci√≥n sin fecha espec√≠fica")},formatearPrecio(a){if(!a)return"0";const e=Math.round(a);return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},formatearNumero(a){if(!a)return"0";const e=Math.floor(a);return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},formatearFecha(a){if(!a)return"";const e=this.normalizarFecha(a);return e?e.toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"}):""},mostrarIndicadorPrecioReciente(a){if(!this.embarqueData||!this.embarqueData.fecha)return!1;const e=this.normalizarFecha(this.embarqueData.fecha);if(!e)return!1;const i=this.toLocalYMD(e),t=this.toLocalYMD(new Date),s=new Date(i),o=new Date(t),n=Math.floor((o-s)/864e5),r=n<=this.diasRecientes,c=i>=t;return r||c},abrirModalConfiguracion(){this.mostrarModalConfiguracion=!0},cerrarModalConfiguracion(){this.mostrarModalConfiguracion=!1},async guardarConfiguracion(){const a={pesoTaraCosto:Number(this.pesoTaraCosto)||0,pesoTaraVenta:Number(this.pesoTaraVenta)||0};await this.persistirCamposRendimientos(a),console.log("Configuraci√≥n de pesos guardada correctamente"),this.cerrarModalConfiguracion(),this.calcularGanancias()},deberMostrarDetallePorCliente(a){const e=this.gananciasCalculadasCrudos[a];if(!e||!e.detallesPorCliente)return!1;if(e.detallesPorCliente.length<=1)return!1;const i=e.detallesPorCliente.map(a=>a.precioVenta),t=new Set(i);return t.size>1},calcularGananciaMaquila(a){const e=this.obtenerTotalEmbarcado(a),i=Number(this.precioMaquila[a])||0;return e*i}},watch:{kilosCrudos:{handler(){this.guardarCambiosEnTiempoReal(),this.$nextTick(async()=>{await this.calcularGanancias()})},deep:!0},analizarGanancia:{handler(){this.$nextTick(async()=>{await this.calcularGanancias()})},deep:!0},analizarGananciaCrudos:{handler(a,e){const i=Object.keys(a).some(i=>a[i]&&!e[i]);i?this.inicializarCostosPorMedida().then(()=>{this.$nextTick(()=>{this.calcularGananciasCrudos()})}):this.$nextTick(()=>{this.calcularGananciasCrudos()})},deep:!0},pesoTaraCosto:{handler(){this.embarqueData&&this.$nextTick(()=>{this.calcularGanancias()})}},pesoTaraVenta:{handler(){this.embarqueData&&this.$nextTick(()=>{this.calcularGanancias()})}},analizarMaquilaGanancia:{handler(){this.guardarCambiosEnTiempoReal()},deep:!0},precioMaquila:{handler(){this.guardarCambiosEnTiempoReal()},deep:!0}},beforeDestroy(){this.guardarCambiosEnTiempoReal.cancel&&this.guardarCambiosEnTiempoReal.cancel(),window.removeEventListener("online",this.syncOfflineRendimientos)}},d=l,u=(i("e987"),i("2877")),m=Object(u["a"])(d,t,s,!1,null,"4769e46a",null);e["default"]=m.exports},ca14:function(a,e,i){},e987:function(a,e,i){"use strict";i("ca14")}}]);