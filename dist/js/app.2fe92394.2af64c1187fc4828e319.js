(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app.2fe92394"],{"54f9":function(e,t,a){"use strict";var o=function(){var e=this,t=e._self._c;return t("div",{staticClass:"recuperacion-emergencia"},[t("div",{staticClass:"header-section"},[e._m(0),t("div",{staticClass:"back-button"},[t("button",{staticClass:"btn-back",on:{click:function(t){return e.$router.back()}}},[t("i",{staticClass:"icon"},[e._v("‚¨ÖÔ∏è")]),e._v(" Volver ")])])]),t("div",{staticClass:"search-section"},[t("div",{staticClass:"search-card"},[t("h3",[e._v("üîç Buscar embarque perdido")]),t("div",{staticClass:"search-input-group"},[t("label",[e._v("Fecha del embarque perdido:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.fechaBusqueda,expression:"fechaBusqueda"}],staticClass:"fecha-input",attrs:{type:"date"},domProps:{value:e.fechaBusqueda},on:{input:function(t){t.target.composing||(e.fechaBusqueda=t.target.value)}}}),t("button",{staticClass:"btn-search",attrs:{disabled:e.buscando},on:{click:e.buscarEmbarque}},[t("i",{staticClass:"icon"},[e._v("üîç")]),e._v(" "+e._s(e.buscando?"Buscando...":"Buscar")+" ")])])])]),e.resultadosBusqueda.length>0?t("div",{staticClass:"resultados-section"},[t("h3",[e._v("üìã Embarques encontrados para "+e._s(e.fechaBusqueda))]),t("div",{staticClass:"embarques-encontrados"},e._l(e.resultadosBusqueda,(function(a){return t("div",{key:a.id,staticClass:"embarque-resultado",class:{"embarque-vacio":e.esEmbarqueVacio(a)}},[t("div",{staticClass:"embarque-header"},[t("h4",[e._v(e._s(e.formatearFecha(a.fecha)))]),t("div",{staticClass:"embarque-status"},[e.esEmbarqueVacio(a)?t("span",{staticClass:"status-vacio"},[e._v("‚ö†Ô∏è Vac√≠o/Incompleto")]):t("span",{staticClass:"status-completo"},[e._v("‚úÖ Con datos")])])]),t("div",{staticClass:"embarque-details"},[t("p",[t("strong",[e._v("ID:")]),e._v(" "+e._s(a.id))]),t("p",[t("strong",[e._v("Carga con:")]),e._v(" "+e._s(a.cargaCon||"No especificado"))]),t("p",[t("strong",[e._v("Clientes:")]),e._v(" "+e._s(a.clientes?a.clientes.length:0))]),t("p",[t("strong",[e._v("Total productos:")]),e._v(" "+e._s(e.contarProductos(a)))]),t("p",[t("strong",[e._v("Kilos limpios:")]),e._v(" "+e._s(e.calcularKilosLimpios(a))+" kg")]),t("p",[t("strong",[e._v("Kilos crudos:")]),e._v(" "+e._s(e.calcularKilosCrudos(a))+" kg")])]),t("div",{staticClass:"embarque-actions"},[t("button",{staticClass:"btn-ver",on:{click:function(t){return e.verEmbarque(a.id)}}},[t("i",{staticClass:"icon"},[e._v("üëÅÔ∏è")]),e._v(" Ver/Editar ")]),e.esEmbarqueVacio(a)?e._e():t("button",{staticClass:"btn-recuperar",on:{click:function(t){return e.usarComoRecuperacion(a)}}},[t("i",{staticClass:"icon"},[e._v("üíæ")]),e._v(" Usar este ")])])])})),0)]):e._e(),t("div",{staticClass:"respaldos-section"},[t("div",{staticClass:"respaldos-card"},[t("h3",[e._v("üíæ Buscar en respaldos de emergencia")]),t("p",[e._v("Si no se encontr√≥ el embarque, buscar en respaldos autom√°ticos")]),t("button",{staticClass:"btn-search-respaldos",attrs:{disabled:e.buscandoRespaldos},on:{click:e.buscarEnRespaldos}},[t("i",{staticClass:"icon"},[e._v("üíæ")]),e._v(" "+e._s(e.buscandoRespaldos?"Buscando respaldos...":"Buscar respaldos")+" ")])])]),e.respaldosEncontrados.length>0?t("div",{staticClass:"respaldos-resultados"},[t("h3",[e._v("üíæ Respaldos encontrados")]),t("div",{staticClass:"respaldos-grid"},e._l(e.respaldosEncontrados,(function(a){return t("div",{key:a.id,staticClass:"respaldo-card"},[t("div",{staticClass:"respaldo-header"},[t("h4",[e._v("Respaldo del "+e._s(e.formatearFecha(a.fechaEmbarqueOriginal)))]),t("span",{staticClass:"respaldo-tipo"},[e._v(e._s(a.razonRespaldo))])]),t("div",{staticClass:"respaldo-details"},[t("p",[t("strong",[e._v("ID original:")]),e._v(" "+e._s(a.embarqueOriginalId))]),t("p",[t("strong",[e._v("Clientes:")]),e._v(" "+e._s(a.cantidadClientes))]),t("p",[t("strong",[e._v("Productos:")]),e._v(" "+e._s(a.totalProductos))]),t("p",[t("strong",[e._v("Kilos limpios:")]),e._v(" "+e._s(a.kilosLimpiosAprox)+" kg")]),t("p",[t("strong",[e._v("Kilos crudos:")]),e._v(" "+e._s(a.kilosCrudosAprox)+" kg")]),t("p",[t("strong",[e._v("Respaldado:")]),e._v(" "+e._s(e.formatearFecha(a.fechaRespaldo)))])]),t("div",{staticClass:"respaldo-actions"},[t("button",{staticClass:"btn-recuperar-respaldo",on:{click:function(t){return e.recuperarDesdeRespaldo(a.id)}}},[t("i",{staticClass:"icon"},[e._v("üîÑ")]),e._v(" Recuperar embarque ")])])])})),0)]):e._e(),t("div",{staticClass:"duplicados-section"},[t("div",{staticClass:"duplicados-card"},[t("h3",[e._v("üîç Buscar todos los duplicados")]),t("p",[e._v("Encuentra embarques que podr√≠an haberse considerado duplicados")]),t("button",{staticClass:"btn-search-duplicados",attrs:{disabled:e.buscandoDuplicados},on:{click:e.buscarDuplicados}},[t("i",{staticClass:"icon"},[e._v("üìä")]),e._v(" "+e._s(e.buscandoDuplicados?"Analizando...":"Analizar duplicados")+" ")])])]),e.duplicadosEncontrados.length>0?t("div",{staticClass:"duplicados-resultados"},[t("h3",[e._v("‚ö†Ô∏è Embarques duplicados encontrados")]),e._l(e.embarquesPorFecha,(function(a,o){return t("div",{key:o,staticClass:"grupo-duplicados"},[t("h4",[e._v(e._s(o)+" ("+e._s(a.length)+" embarques)")]),t("div",{staticClass:"embarques-grupo"},e._l(a,(function(a){return t("div",{key:a.id,staticClass:"embarque-mini",class:{"embarque-vacio":e.esEmbarqueVacio(a)}},[t("p",[t("strong",[e._v("ID:")]),e._v(" "+e._s(a.id.substring(0,8))+"...")]),t("p",[t("strong",[e._v("Productos:")]),e._v(" "+e._s(e.contarProductos(a)))]),t("button",{staticClass:"btn-mini",on:{click:function(t){return e.verEmbarque(a.id)}}},[e._v("Ver")])])})),0)])}))],2):e._e(),e.buscando||e.buscandoDuplicados?t("div",{staticClass:"loading-state"},[t("div",{staticClass:"loading-spinner"}),t("p",[e._v(e._s(e.buscando?"Buscando embarques...":"Analizando duplicados..."))])]):e._e(),e._m(1),e._m(2)])},i=[function(){var e=this,t=e._self._c;return t("div",{staticClass:"header-content"},[t("h1",{staticClass:"main-title"},[t("i",{staticClass:"icon-emergency"},[e._v("üÜò")]),e._v(" Recuperaci√≥n de Emergencia ")]),t("p",{staticClass:"subtitle"},[e._v("Herramienta para buscar y recuperar embarques perdidos")])])},function(){var e=this,t=e._self._c;return t("div",{staticClass:"sistema-respaldos"},[t("div",{staticClass:"sistema-card"},[t("h3",[e._v("üõ°Ô∏è Sistema de respaldos autom√°ticos")]),t("div",{staticClass:"estado-respaldos"},[t("div",{staticClass:"estado-item activo"},[t("span",{staticClass:"estado-icon"},[e._v("‚úÖ")]),t("span",{staticClass:"estado-text"},[e._v("Respaldos autom√°ticos ACTIVADOS")])]),t("div",{staticClass:"estado-item"},[t("span",{staticClass:"estado-icon"},[e._v("üîÑ")]),t("span",{staticClass:"estado-text"},[e._v("Se crean respaldos antes de eliminar duplicados")])]),t("div",{staticClass:"estado-item"},[t("span",{staticClass:"estado-icon"},[e._v("üíæ")]),t("span",{staticClass:"estado-text"},[e._v("Los respaldos se guardan en Firebase permanentemente")])])]),t("div",{staticClass:"algoritmo-info"},[t("h4",[e._v("üß† Algoritmo inteligente activado:")]),t("ul",[t("li",[e._v('Eval√∫a la "completitud" de cada embarque')]),t("li",[e._v("Solo elimina embarques claramente inferiores")]),t("li",[e._v("Siempre crea respaldo antes de eliminar")]),t("li",[e._v("Si no puede crear respaldo, NO elimina")])])])])])},function(){var e=this,t=e._self._c;return t("div",{staticClass:"help-section"},[t("div",{staticClass:"help-card"},[t("h3",[e._v("‚ÑπÔ∏è ¬øQu√© hacer si encuentro mi embarque?")]),t("ol",[t("li",[t("strong",[e._v("Si hay m√∫ltiples embarques:")]),e._v(" Elige el que tenga m√°s datos")]),t("li",[t("strong",[e._v("Si est√° vac√≠o:")]),e._v(" Es posible que el algoritmo haya eliminado el embarque correcto")]),t("li",[t("strong",[e._v("Para recuperar:")]),e._v(' Usa el bot√≥n "Ver/Editar" para revisar el embarque')]),t("li",[t("strong",[e._v("Si no aparece nada:")]),e._v(" Busca en respaldos autom√°ticos")])]),t("div",{staticClass:"emergency-contact"},[t("p",[t("strong",[e._v("üÜò Si necesitas ayuda urgente:")])]),t("p",[e._v("Contacta al administrador del sistema inmediatamente")])])])])}],r=(a("14d9"),a("13d5"),a("1494")),s=a("ebad"),n={name:"RecuperacionEmergencia",data(){return{fechaBusqueda:"",buscando:!1,buscandoDuplicados:!1,buscandoRespaldos:!1,resultadosBusqueda:[],duplicadosEncontrados:[],embarquesPorFecha:{},respaldosEncontrados:[]}},mounted(){this.fechaBusqueda="2025-07-17"},methods:{async buscarEmbarque(){if(this.fechaBusqueda){this.buscando=!0,this.resultadosBusqueda=[];try{const e=Object(r["h"])(),t=Object(r["c"])(e,"embarques"),a=await Object(r["g"])(t),o=new Date(this.fechaBusqueda),i=o.toISOString().split("T")[0],s=[];a.docs.forEach(e=>{const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return;a=new Date(t.fecha)}const o=a.toISOString().split("T")[0];o===i&&s.push({id:e.id,fecha:a,...t})}),this.resultadosBusqueda=s.sort((e,t)=>this.contarProductos(t)-this.contarProductos(e)),0===s.length&&alert("No se encontraron embarques para la fecha "+this.fechaBusqueda)}catch(e){console.error("Error al buscar embarques:",e),alert("Error al buscar embarques. Revisa la consola.")}finally{this.buscando=!1}}else alert("Por favor selecciona una fecha")},async buscarDuplicados(){this.buscandoDuplicados=!0,this.duplicadosEncontrados=[],this.embarquesPorFecha={};try{const e=Object(r["h"])(),t=Object(r["c"])(e,"embarques"),a=await Object(r["g"])(t),o={};a.docs.forEach(e=>{const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return;a=new Date(t.fecha)}const i=a.toISOString().split("T")[0];o[i]||(o[i]=[]),o[i].push({id:e.id,fecha:a,...t})});const i={};for(const r in o)o[r].length>1&&(i[r]=o[r]);this.embarquesPorFecha=i,this.duplicadosEncontrados=Object.keys(i)}catch(e){console.error("Error al buscar duplicados:",e),alert("Error al buscar duplicados. Revisa la consola.")}finally{this.buscandoDuplicados=!1}},async buscarEnRespaldos(){if(this.fechaBusqueda){this.buscandoRespaldos=!0,this.respaldosEncontrados=[];try{const e=await s["a"].buscarRespaldosPorFecha(this.fechaBusqueda);this.respaldosEncontrados=e,0===e.length?alert("No se encontraron respaldos para la fecha "+this.fechaBusqueda):alert(`¬°Encontrados ${e.length} respaldos para el ${this.fechaBusqueda}!`)}catch(e){console.error("Error al buscar respaldos:",e),alert("Error al buscar respaldos. Revisa la consola.")}finally{this.buscandoRespaldos=!1}}else alert("Por favor selecciona una fecha")},async recuperarDesdeRespaldo(e){if(confirm("¬øEst√°s seguro de que quieres recuperar este embarque desde el respaldo?\n\nEsto crear√° un nuevo embarque con los datos respaldados."))try{const t=await s["a"].recuperarDesdeRespaldo(e);alert("¬°Embarque recuperado exitosamente!\n\nSe ha creado un nuevo embarque con ID: "+t),this.$router.push("/embarques/"+t)}catch(t){console.error("Error al recuperar desde respaldo:",t),alert("Error al recuperar embarque: "+t.message)}},esEmbarqueVacio(e){const t=this.contarProductos(e),a=this.calcularKilosLimpios(e),o=this.calcularKilosCrudos(e);return 0===t&&0===a&&0===o},contarProductos(e){return e.clientes?e.clientes.reduce((e,t)=>e+(t.productos?t.productos.length:0),0):0},calcularKilosLimpios(e){if(!e.clientes)return 0;let t=0;return e.clientes.forEach(e=>{e.productos&&e.productos.forEach(e=>{if("c/h20"===e.tipo){const a=e.reporteTaras||[],o=e.reporteBolsas||[];let i=0;for(let e=0;e<a.length;e++){const t=parseInt(a[e])||0,r=parseInt(o[e])||0;i+=t*r}t+=.45*i}})}),t.toFixed(1)},calcularKilosCrudos(e){if(!e.clientes)return 0;let t=0;return e.clientes.forEach(e=>{e.crudos&&Array.isArray(e.crudos)&&e.crudos.forEach(e=>{t+=parseFloat(e.kilos)||0})}),t.toFixed(1)},formatearFecha(e){if(!e)return"Fecha no disponible";let t;return t="function"===typeof e.toDate?e.toDate():e instanceof Date?e:new Date(e),t.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"})},verEmbarque(e){this.$router.push("/embarques/"+e)},usarComoRecuperacion(e){confirm("¬øEst√°s seguro de que quieres usar este embarque como recuperaci√≥n?\n\nEsto te llevar√° al editor para verificar y ajustar los datos.")&&this.verEmbarque(e.id)}}},c=n,d=(a("f10b"),a("2877")),l=Object(d["a"])(c,o,i,!1,null,"43dcc865",null);t["a"]=l.exports},5617:function(e,t,a){},"5a6f":function(e,t,a){},a9cc:function(e,t,a){"use strict";a("5617")},f10b:function(e,t,a){"use strict";a("5a6f")},f458:function(e,t,a){"use strict";var o=function(){var e,t,a,o,i,r,s=this,n=s._self._c;return n("div",{staticClass:"nuevo-embarque-container"},[n("Sidebar",{attrs:{embarque:s.embarque,clientesPredefinidos:s.clientesPredefinidos,clientesPersonalizadosEmbarque:s.clientesPersonalizadosEmbarque,clienteCrudos:s.clienteCrudos,clienteActivo:s.clienteActivo},on:{"seleccionar-cliente":function(e){s.clienteActivo=e},"toggle-sidebar":function(e){s.sidebarCollapsed=e},"mostrar-modal-nuevo-cliente":function(e){s.mostrarModalNuevoCliente=!0}}}),n("div",{staticClass:"nuevo-embarque",class:{"sidebar-collapsed":s.sidebarCollapsed}},[n("header-embarque",{attrs:{"modo-edicion":s.modoEdicion,"embarque-bloqueado":s.embarqueBloqueado,embarque:s.embarque,"is-generating-pdf":s.isGeneratingPdf,"pdf-type":s.pdfType,"embarque-id":s.embarqueId},on:{volver:s.volverAEmbarquesMenu,"toggle-bloqueo":s.toggleBloqueo,"update:fecha":function(e){s.embarque.fecha=e},"update:cargaCon":function(e){s.embarque.cargaCon=e},"generar-taras":function(e){return s.generarPDF("taras")},"generar-resumen":function(e){s.mostrarEscalaResumen=!0},"verificar-fecha":s.verificarFechaExistente,"abrir-configuracion-medidas":s.abrirModalConfiguracionMedidas,"precio-agregado":s.onPrecioAgregado,"generar-esqueleto":s.aplicarEsqueletoDesdePedido,"esqueleto-error":s.onEsqueletoError}}),s.mostrarEscalaResumen?n("div",{staticClass:"scale-control scale-control-resumen"},[n("label",[s._v("Escala del resumen PDF:")]),n("input",{directives:[{name:"model",rawName:"v-model",value:s.escalaResumen,expression:"escalaResumen"}],staticClass:"scale-slider",attrs:{type:"range",min:"30",max:"100",step:"1"},domProps:{value:s.escalaResumen},on:{__r:function(e){s.escalaResumen=e.target.value}}}),n("span",{staticClass:"scale-value"},[s._v(s._s(s.escalaResumen)+"%")]),n("button",{staticClass:"btn btn-primary",on:{click:s.generarPDFResumenConEscala}},[s._v("Generar PDF Resumen")]),n("button",{staticClass:"btn btn-secondary",on:{click:function(e){s.mostrarEscalaResumen=!1}}},[s._v("Cancelar")])]):s._e(),n("div",{staticClass:"botones-undo-redo"},[n("button",{staticClass:"btn btn-secondary btn-sm",attrs:{type:"button",disabled:s.undoStack.length<=1},on:{click:s.undo}},[s._v(" Deshacer ")]),n("button",{staticClass:"btn btn-secondary btn-sm",attrs:{type:"button",disabled:0===s.redoStack.length},on:{click:s.redo}},[s._v(" Rehacer ")])]),n("form",{on:{submit:function(e){return e.preventDefault(),s.guardarEmbarque.apply(null,arguments)},keydown:function(e){if(!e.type.indexOf("key")&&s._k(e.keyCode,"enter",13,e.key,"Enter"))return null;e.preventDefault()}}},s._l(s.productosPorCliente,(function(e,t){return n("ClienteProductos",{key:t,attrs:{"cliente-id":t,productos:e,crudos:s.clienteCrudos[t]||[],"clientes-juntar-medidas":s.clientesJuntarMedidas,"clientes-regla-otilio":s.clientesReglaOtilio,"clientes-incluir-precios":s.clientesIncluirPrecios,"clientes-cuenta-en-pdf":s.clientesCuentaEnPdf,"clientes-sumar-kg-catarro":s.clientesSumarKgCatarro,"nombre-cliente":s.obtenerNombreCliente(t),"cliente-activo":s.clienteActivo,"embarque-bloqueado":s.embarqueBloqueado,"medidas-usadas":s.medidasUsadas,"medidas-configuracion":s.medidasConfiguracion,"is-generating-pdf":s.isGeneratingPdf,"pdf-type":s.pdfType,"is-creating-account":s.isCreatingAccount,"precios-actuales":s.preciosActuales,"fecha-embarque":s.embarque.fecha},on:{"update:productos":function(e){return s.actualizarProductosCliente(t,e)},"update:crudos":function(e){return s.actualizarCrudosCliente(t,e)},"juntarMedidas-change":s.handleJuntarMedidasChange,"reglaOtilio-change":s.handleReglaOtilioChange,"incluirPrecios-change":s.handleIncluirPreciosChange,"cuentaEnPdf-change":s.handleCuentaEnPdfChange,"sumarKgCatarro-change":s.handleSumarKgCatarroChange,"marcar-campo-edicion":s.marcarCampoEnEdicion,"desmarcar-campo-edicion":s.desmarcarCampoEnEdicion,"eliminar-cliente":s.eliminarCliente,"eliminar-producto":s.eliminarProducto,"eliminar-crudo":s.eliminarCrudo,"eliminar-crudo-item":s.eliminarCrudoItem,"agregar-producto":s.agregarProducto,"agregar-crudo":s.agregarCrudo,"agregar-crudo-item":s.agregarCrudoItem,"toggle-sobrante":s.toggleSobrante,"mostrar-modal-precio":s.abrirModalPrecio,"mostrar-modal-hilos":s.abrirModalHilos,"mostrar-modal-nota":s.abrirModalNota,"mostrar-modal-nombre-alternativo":s.abrirModalNombreAlternativo,"mostrar-modal-alt":s.abrirModalAlt,"seleccionar-medida":s.seleccionarMedida,"generar-pdf":s.generarPDF,"crear-cuenta-joselito":s.crearCuentaJoselito,"crear-cuenta-catarro":s.crearCuentaCatarro,"crear-cuenta-ozuna":s.crearCuentaOzuna,"crear-cuenta-otilio":s.crearCuentaOtilio,"crear-cuenta-veronica":s.crearCuentaVeronica,"ver-pedido-cliente":function(e){return s.abrirModalPedidoCliente(t)}}})})),1)],1),n("NuevoClienteModal",{attrs:{mostrar:s.mostrarModalNuevoCliente},on:{cerrar:function(e){s.mostrarModalNuevoCliente=!1},agregar:s.agregarNuevoCliente}}),n("NombreAlternativoModal",{attrs:{mostrar:s.mostrarModalNombreAlternativo,"nombre-original":(null===(e=s.productoSeleccionado)||void 0===e?void 0:e.medida)||"","nombre-alternativo":(null===(t=s.productoSeleccionado)||void 0===t?void 0:t.nombreAlternativoPDF)||""},on:{cerrar:s.cerrarModalNombreAlternativo,guardar:s.guardarNombreAlternativo}}),n("PrecioModal",{attrs:{mostrar:s.mostrarModalPrecio,precio:(null===(a=s.itemSeleccionado)||void 0===a?void 0:a.precio)||"",guardando:s.guardandoModal},on:{cerrar:s.cerrarModalPrecio,guardar:s.guardarPrecio}}),n("HilosModal",{attrs:{mostrar:s.mostrarModalHilos,hilos:(null===(o=s.itemSeleccionado)||void 0===o?void 0:o.hilos)||"",guardando:s.guardandoModal},on:{cerrar:s.cerrarModalHilos,guardar:s.guardarHilos}}),n("NotaModal",{attrs:{mostrar:s.mostrarModalNota,nota:(null===(i=s.itemSeleccionado)||void 0===i?void 0:i.nota)||"",guardando:s.guardandoModal},on:{cerrar:s.cerrarModalNota,guardar:s.guardarNota}}),n("AltModal",{attrs:{mostrar:s.mostrarModalAlt,alt:(null===(r=s.itemSeleccionado)||void 0===r?void 0:r.textoAlternativo)||"",guardando:s.guardandoModal},on:{cerrar:s.cerrarModalAlt,guardar:s.guardarAlt}}),n("ConfiguracionMedidasModal",{attrs:{mostrar:s.mostrarModalConfiguracionMedidas,"medidas-configuracion":s.medidasConfiguracion,"medidas-usadas":s.medidasUsadas},on:{cerrar:s.cerrarModalConfiguracionMedidas,guardar:s.guardarConfiguracionMedidas}}),n("PedidoClienteModal",{attrs:{mostrar:s.mostrarModalPedidoCliente,"fecha-embarque":s.embarque.fecha,"nombre-cliente":s.clienteSeleccionadoPedido},on:{cerrar:s.cerrarModalPedidoCliente}}),n("SaveStatusIndicator"),n("AuthErrorNotification",{attrs:{show:s.showAuthError,message:s.authErrorMessage},on:{hide:function(e){s.showAuthError=!1}}})],1)},i=[],r=(a("d9e2"),a("14d9"),a("13d5"),a("88e6"),a("70cc"),a("eb03"),a("22e5c"),a("c01e"),a("fa76"),a("8306"),a("1494")),s=(a("2ef0"),a("7c01")),n=a("dc59"),c=a("f549"),d=a("d954"),l=a("6521"),u=a("e343"),h=(a("29a7"),a("2b0e")),m=a("5ea5"),p=a("fdb2"),g=a("e7ae"),b=a("ad72"),f=a("b9b6"),C=a("ec26"),v=a("e7e0"),E=a("eb99"),q=a("57d4"),S=a("6123"),P=a("c005"),I=a("6d00"),M=a("c0b0"),y=a("d830"),A=a("d10f"),O=a("fa1c"),w=a("fa40"),D=a("b1ba");const N=e=>{const t=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return"string"===typeof e&&t.test(e)},R=Object(h["defineAsyncComponent"])(()=>Promise.resolve().then(a.bind(null,"4dc0")));var _={mixins:[g["a"],b["a"]],name:"NuevoEmbarque",components:{Rendimientos:R,Sidebar:m["a"],HeaderEmbarque:p["a"],ClienteProductos:f["a"],NuevoClienteModal:E["a"],NombreAlternativoModal:q["a"],PrecioModal:S["a"],HilosModal:P["a"],NotaModal:I["a"],AltModal:M["a"],ConfiguracionMedidasModal:y["a"],PedidoClienteModal:A["a"],SaveStatusIndicator:l["a"],AuthErrorNotification:u["a"]},setup(){const e=Object(c["useAuthStore"])();return{authStore:e}},data(){return{usuariosActivos:[],clientesJuntarMedidas:{},clientesReglaOtilio:{},clientesIncluirPrecios:{},clientesCuentaEnPdf:{},clientesSumarKgCatarro:{},clientesPredefinidos:v["a"],clientesPersonalizados:[],ultimoIdPersonalizado:0,costosPorMedida:{},aplicarCostoExtra:{},costoExtra:18,embarque:{fecha:null,cargaCon:"",productos:[],crudos:[]},nuevoClienteId:"",undoStack:[],redoStack:[],isUndoRedo:!1,cambios:[],producto:{reporteTaras:[],reporteBolsas:[]},embarqueId:null,modoEdicion:!1,guardadoAutomaticoActivo:!1,clienteCrudos:{},unsubscribe:null,medidasSugeridas:[],medidasUsadas:[],mostrarSugerencias:!1,sugerenciasMedidas:[],mostrarModalNuevoCliente:!1,nuevoClienteNombre:"",nuevoClienteColor:"#007bff",mostrarModalConfiguracionMedidas:!1,medidasConfiguracion:[],mostrarModalNombreAlternativo:!1,nombreAlternativoTemp:"",productoSeleccionado:null,mostrarModalPrecio:!1,precioTemp:"",itemSeleccionado:null,mostrarModalHilos:!1,hilosTemp:"",mostrarModalNota:!1,notaTemp:"",mostrarModalAlt:!1,altTemp:"",mostrarModalPedidoCliente:!1,clienteSeleccionadoPedido:null,clientesOffsets:{},embarqueBloqueado:!1,clienteActivo:null,sidebarCollapsed:!1,isGeneratingPdf:!1,pdfType:null,showAuthError:!1,authErrorMessage:"Su sesi√≥n ha expirado o hay un problema con su autenticaci√≥n.",isCreatingAccount:!1,_creandoEmbarque:!1,_guardandoEmbarque:!1,mostrarEscalaResumen:!1,escalaResumen:100,_guardandoInicial:!1,_inicializandoEmbarque:!1,debouncedSave:null,saveManager:null,preciosActuales:[],_aplicandoRemoto:!1,clientesModificados:{},fechaModificada:!1,cargaConModificada:!1,productosEliminadosLocalmente:new Set,productosNuevosPendientes:new Map,agregandoProducto:!1,camposEnEdicion:new Set,productoNombreAlternativoEnEdicionId:null,nombreAlternativoPendienteSync:new Map,autoSaveBackoffMs:0,autoSaveDisabledUntil:0,lastAutoSaveQuotaAlert:!1,guardandoModal:!1}},computed:{clientesDisponibles(){const e=new Set,t=this.clientesPredefinidos.filter(t=>!e.has(t.nombre)&&(e.add(t.nombre),!0)),a=this.clientesPersonalizados.filter(t=>!e.has(t.nombre)&&(e.add(t.nombre),!0));return[...t,...a,{id:"otro",nombre:"Otro",key:"otro"}]},productosPorCliente(){const e={};return this.clientesPredefinidos.forEach(t=>{const a=t.id.toString();e[a]=[],this.clienteCrudos[a]||this.$set(this.clienteCrudos,a,[])}),this.clientesPersonalizados.forEach(t=>{const a=t.id.toString();e[a]=[],this.clienteCrudos[a]||this.$set(this.clienteCrudos,a,[])}),this.embarque.productos.forEach(t=>{const a=t.clienteId;e[a]||(e[a]=[]),e[a].push(t),t.isEditing||e[a].sort((e,t)=>e.medida&&e.tipo&&t.medida&&t.tipo?this.compararMedidas(t.medida,e.medida):e.medida&&e.tipo?t.medida&&t.tipo?0:-1:1)}),e},clientesPersonalizadosEmbarque(){const e=new Set(this.embarque.productos.map(e=>e.clienteId.toString()));return this.clientesPersonalizados.filter(t=>e.has(t.id.toString()))},totalKilosCrudoActivo(){return this.clienteActivo&&this.clienteCrudos[this.clienteActivo]?this.clienteCrudos[this.clienteActivo].reduce((e,t)=>e+(parseFloat(t.kilos)||0),0):0},totalTarasCrudoActivo(){return this.clienteActivo&&this.clienteCrudos[this.clienteActivo]?this.clienteCrudos[this.clienteActivo].reduce((e,t)=>{if(!t||!t.items||!Array.isArray(t.items))return e;const a=t.items.reduce((e,t)=>{let a=0;if(t.taras){const[e]=t.taras.split("-");a+=parseInt(e)||0}if(t.sobrante){const[e]=t.sobrante.split("-");a+=parseInt(e)||0}return e+a},0);return e+a},0):0},resumenKilosProductos(){const e={};return this.embarque.productos.forEach(t=>{e[t.clienteId]||(e[t.clienteId]={kilos:0,taras:0}),e[t.clienteId].kilos+=this.calcularKilos(t),e[t.clienteId].taras+=this.calcularTotalTaras(t)}),e},resumenKilosCrudos(){const e={};for(const t in this.clienteCrudos)e[t]||(e[t]={kilos:0,taras:0}),this.clienteCrudos[t].forEach(a=>{e[t].kilos+=parseFloat(a.kilos)||0;const o=a.items.reduce((e,t)=>{let a=0;if(t.taras){const[e]=t.taras.split("-");a+=parseInt(e)||0}if(t.sobrante){const[e]=t.sobrante.split("-");a+=parseInt(e)||0}return e+a},0);e[t].taras+=o});return e}},methods:{mostrarErrorAutenticacion(e=null){this.authErrorMessage=e||"Su sesi√≥n ha expirado o hay un problema con su autenticaci√≥n.",this.showAuthError=!0},mostrarError(e){this.$toast?this.$toast.error(e,{duration:5e3}):(console.error("[ERROR]",e),(e.includes("recarga la p√°gina")||e.includes("No se pudieron guardar"))&&setTimeout(()=>{alert(e)},100)),this.guardarSnapshotOffline({pendingSync:!navigator.onLine}).catch(e=>{console.warn("[mostrarError] No se pudo registrar snapshot offline del error:",e)})},mostrarMensaje(e){this.$toast&&this.$toast.info(e,{duration:3e3})},onEsqueletoError(e){e&&this.mostrarError(e)},productoTieneContenido(e){if(!e)return!1;const t=e.medida&&""!==e.medida.toString().trim(),a=Array.isArray(e.kilos)&&e.kilos.some(e=>Number(e)>0),o=Array.isArray(e.taras)&&e.taras.some(e=>Number(e)>0),i=Array.isArray(e.tarasExtra)&&e.tarasExtra.some(e=>Number(e)>0),r=Array.isArray(e.reporteTaras)&&e.reporteTaras.some(e=>Number(e)>0)||Array.isArray(e.reporteBolsas)&&e.reporteBolsas.some(e=>Number(e)>0);return t||a||o||i||r},aplicarEsqueletoDesdePedido(e){if(!e||"object"!==typeof e)return void console.warn("[aplicarEsqueletoDesdePedido] Datos de esqueleto inv√°lidos:",e);const t=Object.keys(e).filter(t=>Array.isArray(e[t]));if(0===t.length)return void this.mostrarMensaje("No se encontraron medidas en los pedidos para generar el esqueleto.");const a=t.filter(t=>e[t].length>0);if(0===a.length)return void this.mostrarMensaje("Los pedidos no tienen medidas registradas para los clientes predeterminados.");const o=this.embarque.productos.filter(e=>a.includes(e.clienteId.toString())&&this.productoTieneContenido(e));if(o.length>0){const e=confirm("Se reemplazar√°n los productos y crudos existentes de los clientes predeterminados por los pedidos. ¬øDeseas continuar?");if(!e)return}this.productosEliminadosLocalmente||(this.productosEliminadosLocalmente=new Set);const i=new Set(a.map(e=>e.toString()));this.embarque.productos.forEach(e=>{const t=e.clienteId.toString();i.has(t)&&(this.productosEliminadosLocalmente.add(e.id),this.$set(this.clientesModificados,t,!0))}),this.embarque.productos=this.embarque.productos.filter(e=>!i.has(e.clienteId.toString())),i.forEach(e=>{this.clienteCrudos[e]&&this.$set(this.clienteCrudos,e,[])}),this.productosNuevosPendientes||(this.productosNuevosPendientes=new Map);const r=[],s={};if(a.forEach(t=>{const a=e[t]||[],o=this.obtenerNombreCliente(t);a.forEach(e=>{if("crudo"===e.tipo)s[t]||(s[t]=[{items:[]}]),s[t][0].items.push({talla:e.medida||"",medida:e.medida||"",barco:"",taras:null,sobrante:null,mostrarSobrante:!1,precio:null});else{const a=Object(v["c"])(t.toString());a.nombreCliente=o,a.medida=(e.medida||"").toString().trim(),"c/h20"===e.tipo||"s/h20"===e.tipo?a.tipo=e.tipo:"otro"===e.tipo?(a.tipo="otro",a.tipoPersonalizado=(e.tipoPersonalizado||"").toString()):e.tipo?a.tipo=e.tipo:this.setTipoDefaultParaCliente(a),this.productosNuevosPendientes.set(a.id,{...a}),r.push(a)}})}),0===r.length&&0===Object.keys(s).length)return void this.mostrarMensaje("No se crearon productos o crudos nuevos porque las medidas del pedido est√°n vac√≠as.");r.length>0&&this.embarque.productos.push(...r),Object.entries(s).forEach(([e,t])=>{this.clienteCrudos[e]||this.$set(this.clienteCrudos,e,[]),this.clienteCrudos[e].push(...t)}),!this.guardadoAutomaticoActivo&&this.embarqueId&&(this.guardadoAutomaticoActivo=!0),this.actualizarMedidasUsadas(),this.$forceUpdate(),this.embarqueId&&this.guardarCambiosEnTiempoReal();const n=[];if(r.length>0&&n.push(r.length+" producto(s) limpio(s)"),Object.keys(s).length>0){const e=Object.values(s).reduce((e,t)=>e+t.reduce((e,t)=>e+(t.items?t.items.length:0),0),0);n.push(e+" medida(s) de crudo(s)")}this.mostrarMensaje(`Esqueleto generado: ${n.join(" y ")}.`),a.length>0&&(this.clienteActivo=a[0])},marcarCampoEnEdicion(e,t){const a=`${e}-${t}`;this.camposEnEdicion.add(a)},desmarcarCampoEnEdicion(e,t){const a=`${e}-${t}`;this.camposEnEdicion.delete(a)},esCampoEnEdicion(e,t){const a=`${e}-${t}`;return this.camposEnEdicion.has(a)},mergeProductosConCamposEnEdicion(e,t){const a=this.embarque.productos||[],o=[];t.forEach(e=>{const t=a.find(t=>t.id===e.id);if(!t)return void o.push(e);const i={...e};if(t.kilos&&Array.isArray(t.kilos)&&t.kilos.forEach((t,a)=>{this.esCampoEnEdicion(e.id,"kilos-"+a)&&(console.log(`[MERGE] Preservando kilo en edici√≥n: ${e.id}-kilos-${a}`),i.kilos||(i.kilos=[]),i.kilos[a]=t)}),t.taras&&Array.isArray(t.taras)&&t.taras.forEach((t,a)=>{this.esCampoEnEdicion(e.id,"taras-"+a)&&(console.log(`[MERGE] Preservando tara en edici√≥n: ${e.id}-taras-${a}`),i.taras||(i.taras=[]),i.taras[a]=t)}),this.esCampoEnEdicion(e.id,"nombreAlternativoPDF")?Object.prototype.hasOwnProperty.call(t,"nombreAlternativoPDF")?i.nombreAlternativoPDF=t.nombreAlternativoPDF:delete i.nombreAlternativoPDF:Object.prototype.hasOwnProperty.call(t,"nombreAlternativoPDF")&&t.nombreAlternativoPDF!==e.nombreAlternativoPDF&&(i.nombreAlternativoPDF=t.nombreAlternativoPDF),this.nombreAlternativoPendienteSync.has(e.id)){const t=this.nombreAlternativoPendienteSync.get(e.id);t?i.nombreAlternativoPDF=t:delete i.nombreAlternativoPDF;const a=e.nombreAlternativoPDF||null;(t||null)===a&&this.nombreAlternativoPendienteSync.delete(e.id)}o.push(i)});const i=[];return this.productosNuevosPendientes&&this.productosNuevosPendientes.size>0&&this.productosNuevosPendientes.forEach((t,a)=>{const o=e.some(e=>e.id===a);o?this.productosNuevosPendientes.delete(a):i.push(t)}),a.forEach(t=>{!N(t.id)||e.some(e=>e.id===t.id)||i.some(e=>e.id===t.id)||(i.push(t),this.productosNuevosPendientes.has(t.id)||this.productosNuevosPendientes.set(t.id,{...t}))}),[...o,...i]},async triggerGuardadoInicial(){this.embarqueId||this.embarque.fecha&&this.embarque.cargaCon&&await this.guardarEmbarqueInicial()},seleccionarMedida(e){this.productoSeleccionado&&(this.productoSeleccionado.medida=e,this.mostrarSugerencias=!1,this.productoSeleccionado.isEditing=!0,this.$nextTick(()=>{setTimeout(()=>{this.productoSeleccionado.isEditing=!1},100)}))},actualizarProductosCliente(e,t){let a=t;this.productosEliminadosLocalmente&&this.productosEliminadosLocalmente.size>0&&(a=t.filter(e=>!this.productosEliminadosLocalmente.has(e.id)),a.length!==t.length&&console.log("[actualizarProductosCliente] Filtrando productos eliminados localmente")),this.embarque.productos=this.embarque.productos.filter(t=>t.clienteId!==e),this.embarque.productos=[...this.embarque.productos,...a];const o=a.some(e=>e.medida&&""!==e.medida.trim());o&&(this.$set(this.clientesModificados,e,!0),this.guardadoAutomaticoActivo&&this.embarqueId&&this.guardarCambiosEnTiempoReal())},actualizarCrudosCliente(e,t){this.$set(this.clienteCrudos,e,t),this.$set(this.clientesModificados,e,!0),this.guardadoAutomaticoActivo&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},agregarProducto(e){this.agregandoProducto=!0;const t=this.embarque.productos.some(t=>t.clienteId===e&&(t.isNew||t.isEditing)&&!t.medida);if(t)return console.warn(`Ya existe un producto nuevo vac√≠o para el cliente ${this.obtenerNombreCliente(e)}. No se agregar√° otro.`),this.$nextTick(()=>{const t=document.querySelectorAll(".medida-input"),a=Array.from(t).find(t=>{var a;const o=t.closest(".producto");if(!o)return!1;const i=null===(a=o.dataset)||void 0===a?void 0:a.productoId,r=this.embarque.productos.find(e=>String(e.id)===i);return r&&r.clienteId===e&&!r.medida});a&&a.focus()}),void(this.agregandoProducto=!1);const a=Object(v["c"])(e);this.setTipoDefaultParaCliente(a),a.nombreCliente=this.obtenerNombreCliente(e),this.productosEliminadosLocalmente&&this.productosEliminadosLocalmente.has(a.id)&&(console.log("[AGREGAR-PRODUCTO] Removiendo producto de la lista de eliminados:",a.id),this.productosEliminadosLocalmente.delete(a.id)),this.productosNuevosPendientes||(this.productosNuevosPendientes=new Map);const o={...a};this.productosNuevosPendientes.set(a.id,o),console.log("[AGREGAR-PRODUCTO] Producto marcado como nuevo pendiente:",a.id),this.embarque.productos.push(a),this.$forceUpdate(),!this.guardadoAutomaticoActivo&&this.embarqueId&&(this.guardadoAutomaticoActivo=!0),this.embarqueId&&this.guardarCambiosEnTiempoReal(),this.actualizarMedidasUsadas(),this.$nextTick(()=>{const e=document.querySelectorAll(".medida-input"),t=Array.from(e).find(e=>{var t;const o=null===(t=e.closest(".producto"))||void 0===t||null===(t=t.dataset)||void 0===t?void 0:t.productoId;return o===String(a.id)});t&&t.focus(),setTimeout(()=>{this.agregandoProducto=!1},200)})},eliminarProducto(e){console.log(`[ELIMINAR-PRODUCTO] Intentando eliminar: ID: ${e.id}, Medida: ${e.medida}, Cliente: ${this.obtenerNombreCliente(e.clienteId)}`),this.productosEliminadosLocalmente||(this.productosEliminadosLocalmente=new Set),this.productosEliminadosLocalmente.add(e.id),this.$set(this.clientesModificados,e.clienteId,!0);let t=this.embarque.productos.findIndex(t=>t.id===e.id);if(t>-1)return console.log("[ELIMINAR-PRODUCTO] ‚úÖ Encontrado por ID en √≠ndice "+t),void this._eliminarProductoPorIndice(t,"ID exacto");console.warn("[ELIMINAR-PRODUCTO] ‚ö†Ô∏è  Producto NO encontrado por ID: "+e.id);const a=this.embarque.productos.filter((t,a)=>{const o=t.medida===e.medida,i=t.clienteId===e.clienteId,r=t.tipo===e.tipo;return o&&i&&r});if(console.log(`[ELIMINAR-PRODUCTO] üîç Encontrados ${a.length} candidatos por medida/cliente/tipo`),1===a.length){const e=a[0];return t=this.embarque.productos.findIndex(t=>t===e),console.log(`[ELIMINAR-PRODUCTO] üéØ Candidato √∫nico encontrado en √≠ndice ${t}:`,{id:e.id,medida:e.medida,tipo:e.tipo}),void this._eliminarProductoPorIndice(t,"candidato √∫nico")}if(a.length>1)return console.warn(`[ELIMINAR-PRODUCTO] ‚ö†Ô∏è  M√∫ltiples candidatos encontrados (${a.length}). No es seguro eliminar autom√°ticamente.`),console.log("[ELIMINAR-PRODUCTO] Candidatos:",a.map(e=>({id:e.id,medida:e.medida}))),void alert(`No se pudo eliminar el producto autom√°ticamente.\n\nSe encontraron ${a.length} productos similares.\nPor favor, recarga la p√°gina e intenta de nuevo.`);console.error("[ELIMINAR-PRODUCTO] ‚ùå No se encontr√≥ ning√∫n producto que coincida con:",{id:e.id,medida:e.medida,clienteId:e.clienteId,tipo:e.tipo}),console.log("[ELIMINAR-PRODUCTO] üìä Total productos en embarque: "+this.embarque.productos.length),this.embarque.productos.length>0&&console.log("[ELIMINAR-PRODUCTO] Primeros 3 productos en embarque:",this.embarque.productos.slice(0,3).map(e=>({id:e.id,medida:e.medida,clienteId:e.clienteId}))),alert("Error: No se pudo encontrar el producto para eliminar.\nEsto puede indicar un problema de sincronizaci√≥n.\n\nPor favor, recarga la p√°gina.")},_eliminarProductoPorIndice(e,t){const a=this.embarque.productos[e];console.log(`[ELIMINAR-PRODUCTO] üóëÔ∏è  Eliminando producto (${t}):`,{indice:e,id:a.id,medida:a.medida,clienteId:a.clienteId}),this.embarque.productos.splice(e,1),console.log("[ELIMINAR-PRODUCTO] ‚úÖ Producto eliminado exitosamente. Productos restantes: "+this.embarque.productos.length),this.embarqueId&&this.guardarCambiosEnTiempoReal(),this.actualizarMedidasUsadas()},verificarIntegridadProductos(){console.log("\nüîç === VERIFICACI√ìN DE INTEGRIDAD DE PRODUCTOS ==="),console.log("üìä Total productos en embarque: "+this.embarque.productos.length);const e=this.embarque.productos.map(e=>e.id),t=[...new Set(e)];if(e.length!==t.length){console.error(`‚ùå IDs duplicados detectados! Total: ${e.length}, √önicos: ${t.length}`);const a=e.filter((t,a)=>e.indexOf(t)!==a);console.log("üîç IDs duplicados:",a)}else console.log("‚úÖ Todos los IDs son √∫nicos");const a=this.embarque.productos.filter(e=>!e.id||!N(e.id));a.length>0?console.error(`‚ùå ${a.length} productos con IDs inv√°lidos:`,a):console.log("‚úÖ Todos los IDs tienen formato v√°lido");const o=this.embarque.productos.filter(e=>!e.medida||!e.clienteId);o.length>0?console.error(`‚ùå ${o.length} productos incompletos:`,o):console.log("‚úÖ Todos los productos tienen campos requeridos");const i={};this.embarque.productos.forEach(e=>{const t=e.clienteId||"Sin cliente";i[t]||(i[t]=[]),i[t].push(e.medida)}),console.log("üìã Productos por cliente:",i),console.log("‚úÖ Verificaci√≥n de integridad completada\n");const r=e.length!==t.length||a.length>0||o.length>0;return r&&console.log("\nüí° Para solucionar problemas autom√°ticamente, ejecuta en consola: this.repararIDsProductos()"),{total:this.embarque.productos.length,idsUnicos:t.length,tieneProblemas:r}},repararIDsProductos(){console.log("\nüîß === REPARANDO IDs DE PRODUCTOS ===");this.embarque.productos.map(e=>e.id);const e=new Set;let t=0;return this.embarque.productos.forEach(a=>{const o=a.id;let i=!1;if(o&&N(o)?e.has(o)&&(i=!0,console.log("üîß ID duplicado detectado: "+o)):(i=!0,console.log("üîß ID inv√°lido detectado: "+o)),i){const e=Object(C["a"])();a.id=e,t++,console.log(`‚úÖ ID reparado: ${o} ‚Üí ${e} (${a.medida})`)}e.add(a.id)}),t>0?(console.log(`\nüéâ Reparaci√≥n completada: ${t} productos reparados`),this.embarqueId&&(this.guardarCambiosEnTiempoReal(),console.log("üíæ Cambios guardados autom√°ticamente")),console.log("\nüîç Verificando integridad despu√©s de la reparaci√≥n..."),setTimeout(()=>{this.verificarIntegridadProductos()},500)):console.log("‚úÖ No se necesitaron reparaciones"),t},async agregarClienteProducto(){const e=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(!e)if(this.embarque.fecha){if("otro"===this.nuevoClienteId){const e=prompt("Ingrese el nombre del nuevo cliente:");if(e&&""!==e.trim()){this.ultimoIdPersonalizado++;const t="personalizado_"+this.ultimoIdPersonalizado,a={id:t,nombre:e.trim(),editable:!0,personalizado:!0};this.clientesPersonalizados.push(a),await this.guardarEmbarqueInicial(t)}}else this.nuevoClienteId&&await this.guardarEmbarqueInicial(this.nuevoClienteId);this.nuevoClienteId=""}else alert("Por favor, seleccione una fecha para el embarque.")},async guardarEmbarqueInicial(e){const t=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(t)return null;if(!this.embarqueId&&this._guardandoInicial)return console.warn("Guardado inicial autom√°tico a√∫n en progreso. Esperando para agregar cliente/producto."),null;if(this._creandoEmbarque)return console.warn("Ya hay una operaci√≥n de creaci√≥n de embarque en curso"),null;this._creandoEmbarque=!0;try{if(this.embarqueId)return this.agregarProducto(e),this.clienteActivo=e,this._creandoEmbarque=!1,this.embarqueId;{const t=new Date(this.embarque.fecha),o=t.toISOString().split("T")[0],i=this.prepararDatosEmbarque();if(!navigator.onLine)try{await D["a"].init();const t=await D["a"].getAll(),a=t.some(e=>{if(!e||!e.fecha)return!1;try{const t=new Date(e.fecha).toISOString().split("T")[0];return t===o&&e.id!==this.embarqueId}catch(t){return!1}});return a?(alert("Ya existe un embarque guardado offline para la fecha seleccionada. Por favor, seleccione otra fecha."),this._creandoEmbarque=!1,null):(this.embarqueId=Object(C["a"])(),this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0,await this.guardarSnapshotOffline({pendingSync:!0,docData:i,syncState:"pending-create"}),this.agregarProducto(e),this.clienteActivo=e,this._creandoEmbarque=!1,this.embarqueId)}catch(a){return console.error("[guardarEmbarqueInicial] Error al crear embarque offline:",a),this._creandoEmbarque=!1,alert("No se pudo crear el embarque en modo offline. Intente nuevamente."),null}const s=Object(r["h"])();try{const t=Object(r["c"])(s,"embarques"),n=await Object(r["g"])(t),c=n.docs.filter(e=>{const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return!1;a=new Date(t.fecha)}const i=a.toISOString().split("T")[0];return i===o&&e.id!==this.embarqueId});if(c.length>0)return alert("Ya existe un embarque para la fecha seleccionada. Por favor, seleccione otra fecha."),this._creandoEmbarque=!1,null;const d=Object(r["e"])(s,"reservas_fechas",o);await Object(r["r"])(d,{fecha:o,timestamp:Object(r["q"])(),usuario:this.authStore.userId||"an√≥nimo","expiraci√≥n":new Date(Date.now()+6e4)});const l=await Object(r["b"])(Object(r["c"])(s,"embarques"),i);try{await Object(r["d"])(d)}catch(a){console.error("Error al eliminar la reserva de fecha:",a)}return this.embarqueId=l.id,this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0,await this.guardarSnapshotOffline({pendingSync:!1,docData:i,syncState:"synced"}),this.agregarProducto(e),this.clienteActivo=e,this._creandoEmbarque=!1,this.embarqueId}catch(a){return this._creandoEmbarque=!1,console.error("[LOG] Error catastr√≥fico dentro de guardarEmbarqueInicial:",a),alert("Hubo un error muy grave al intentar crear el embarque. Revise la consola."),null}}}catch(o){return this._creandoEmbarque=!1,console.error("[LOG] Error al crear el embarque:",o),alert("Hubo un error al crear el embarque. Por favor, intente de nuevo."),null}},async eliminarCliente(e){const t=this.obtenerNombreCliente(e);console.log(`[eliminarCliente] Eliminando cliente: ${t} (ID: ${e})`);const a=this.embarque.productos.length;this.embarque.productos=this.embarque.productos.filter(t=>t.clienteId!==e);const o=a-this.embarque.productos.length;console.log(`[eliminarCliente] ${o} productos eliminados del cliente ${t}`);const i=this.clientesPersonalizados.findIndex(t=>t.id.toString()===e.toString());i>-1&&(this.clientesPersonalizados.splice(i,1),console.log(`[eliminarCliente] Cliente personalizado ${t} eliminado de la lista`)),this.clienteCrudos[e]&&delete this.clienteCrudos[e],this.clientesJuntarMedidas[e]&&delete this.clientesJuntarMedidas[e],this.clientesReglaOtilio[e]&&delete this.clientesReglaOtilio[e],this.clientesIncluirPrecios[e]&&delete this.clientesIncluirPrecios[e],this.clientesCuentaEnPdf[e]&&delete this.clientesCuentaEnPdf[e],this.clientesSumarKgCatarro[e]&&delete this.clientesSumarKgCatarro[e],this.clienteActivo===e&&(this.clienteActivo=null),this.$set(this.clientesModificados,e,!0),localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados)),this.guardarCambiosEnTiempoReal(),this.$forceUpdate(),setTimeout(()=>{this.clientesModificados[e]&&delete this.clientesModificados[e]},1e3),this.cambios.push(`Cliente ${t} eliminado completamente`),console.log(`[eliminarCliente] Cliente ${t} eliminado exitosamente`)},obtenerNombreCliente(e){if(!e)return"Cliente Desconocido";const t=this.clientesDisponibles.find(t=>t.id.toString()===e.toString());if(t&&t.nombre)return t.nombre;const a=this.embarque.productos.find(t=>t.clienteId.toString()===e.toString());if(a&&a.nombreCliente)return a.nombreCliente;const o=this.clientesPersonalizados.find(t=>t.id.toString()===e.toString());return o&&o.nombre?o.nombre:"Cliente Desconocido"},obtenerClientesConProductos(){const e={};return this.embarque.productos.forEach(t=>{const a=t.clienteId;e[a]||(e[a]={id:a,nombre:this.obtenerNombreCliente(a),productos:[]}),e[a].productos.push(t)}),Object.values(e).map(e=>({...e,crudos:this.clienteCrudos[e.id]||[]}))},editarNombreCliente(e){const t=this.clientesDisponibles.find(t=>t.id===e);if(t&&t.editable){const a=prompt("Ingrese el nuevo nombre del cliente:",t.nombre);null!==a&&""!==a.trim()&&(t.nombre=a.trim(),this.embarque.productos.forEach(t=>{t.clienteId===e&&(t.nombreCliente=a.trim())}))}},async cargarEmbarque(e){if("nuevo"===e)return localStorage.removeItem("ultimoEmbarqueId"),this.productosEliminadosLocalmente&&this.productosEliminadosLocalmente.size>0&&this.productosEliminadosLocalmente.clear(),this.productosNuevosPendientes&&this.productosNuevosPendientes.size>0&&this.productosNuevosPendientes.clear(),this.camposEnEdicion&&this.camposEnEdicion.size>0&&this.camposEnEdicion.clear(),void this.resetearEmbarque();if(this.productosEliminadosLocalmente&&this.productosEliminadosLocalmente.size>0&&this.productosEliminadosLocalmente.clear(),this.productosNuevosPendientes&&this.productosNuevosPendientes.size>0&&this.productosNuevosPendientes.clear(),this.camposEnEdicion&&this.camposEnEdicion.size>0&&(console.log("[cargarEmbarque] Limpiando campos en edici√≥n"),this.camposEnEdicion.clear()),this._inicializandoEmbarque=!0,this.limpiarConexionesFirestore(),!navigator.onLine){const t=await this.cargarEmbarqueOffline(e);return t||(console.warn("[cargarEmbarque] No se encontr√≥ informaci√≥n offline para el embarque solicitado:",e),alert("No se encontr√≥ informaci√≥n local para este embarque. Con√©ctate a internet para recuperarlo."),this.resetearEmbarque(),this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1),void(this._inicializandoEmbarque=!1)}const t=Object(r["h"])(),a=Object(r["e"])(t,"embarques",e);this.unsubscribe=Object(r["k"])(a,t=>{if(t.exists()){const a=t.data();let o;this._aplicandoRemoto=!0,this.embarqueBloqueado=a.embarqueBloqueado||!1,a.clientesPersonalizados&&Array.isArray(a.clientesPersonalizados)?(this.clientesPersonalizados=a.clientesPersonalizados,console.log("[cargarEmbarque] Clientes personalizados cargados desde Firebase:",this.clientesPersonalizados),localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados))):console.log("[cargarEmbarque] No se encontraron clientes personalizados en Firebase, usando localStorage como respaldo"),a.clientesJuntarMedidas?this.clientesJuntarMedidas=a.clientesJuntarMedidas:(this.clientesJuntarMedidas={},a.clientes.forEach(e=>{this.$set(this.clientesJuntarMedidas,e.id,!1)})),a.clientesReglaOtilio?this.clientesReglaOtilio=a.clientesReglaOtilio:(this.clientesReglaOtilio={},a.clientes.forEach(e=>{const t=e.nombre&&e.nombre.toLowerCase().includes("otilio");this.$set(this.clientesReglaOtilio,e.id,t)})),a.clientesIncluirPrecios?this.clientesIncluirPrecios=a.clientesIncluirPrecios:(this.clientesIncluirPrecios={},a.clientes.forEach(e=>{this.$set(this.clientesIncluirPrecios,e.id,!1)})),a.clientesCuentaEnPdf?this.clientesCuentaEnPdf=a.clientesCuentaEnPdf:(this.clientesCuentaEnPdf={},a.clientes.forEach(e=>{this.$set(this.clientesCuentaEnPdf,e.id,!1)})),a.clientesSumarKgCatarro?this.clientesSumarKgCatarro=a.clientesSumarKgCatarro:(this.clientesSumarKgCatarro={},a.clientes.forEach(e=>{const t=e.nombre&&e.nombre.toLowerCase().includes("catarro");this.$set(this.clientesSumarKgCatarro,e.id,t)})),a.fecha&&"function"===typeof a.fecha.toDate?o=a.fecha.toDate():a.fecha instanceof Date?o=a.fecha:"string"===typeof a.fecha?o=new Date(a.fecha):(console.warn("Formato de fecha no reconocido, usando la fecha actual"),o=new Date);const i=new Map(this.clientesPredefinidos.map(e=>[e.id.toString(),e])),r=(a.clientes||[]).filter(e=>!i.has(e.id.toString())).map(e=>({id:e.id,nombre:e.nombre,editable:!0,personalizado:!0,key:"personalizado_"+e.id})),s=new Map;(this.clientesPersonalizados||[]).forEach(e=>{s.set(String(e.id),{...e})}),r.forEach(e=>{s.set(String(e.id),{...e})}),this.clientesPersonalizados=Array.from(s.values());const n=a.clientes.flatMap(e=>{const t=i.get(e.id.toString())||e;return e.productos.map(a=>({...a,clienteId:e.id,nombreCliente:t.nombre,restarTaras:a.restarTaras||!1}))});let c,d=n;if(this.productosEliminadosLocalmente&&this.productosEliminadosLocalmente.size>0&&(console.log("[onSnapshot] Filtrando productos eliminados localmente:",this.productosEliminadosLocalmente),d=n.filter(e=>!this.productosEliminadosLocalmente.has(e.id))),this.agregandoProducto)console.log("[onSnapshot] Agregando producto en proceso, preservando productos locales"),c=this.embarque.productos||[];else if(this.camposEnEdicion&&this.camposEnEdicion.size>0)console.log("[onSnapshot] Hay campos en edici√≥n, mergear cuidadosamente"),c=this.mergeProductosConCamposEnEdicion(n,d);else{const e=[];this.productosNuevosPendientes&&this.productosNuevosPendientes.size>0&&(console.log("[onSnapshot] Preservando productos nuevos pendientes:",this.productosNuevosPendientes.size),this.productosNuevosPendientes.forEach((t,a)=>{const o=n.some(e=>e.id===a);o?(this.productosNuevosPendientes.delete(a),console.log("[onSnapshot] Producto sincronizado, removiendo de pendientes:",a)):(e.push(t),console.log("[onSnapshot] Preservando producto nuevo:",a))}));const t=this.embarque.productos||[];t.forEach(t=>{!N(t.id)||n.some(e=>e.id===t.id)||e.some(e=>e.id===t.id)||(console.log("[onSnapshot] Preservando producto local no sincronizado:",t.id),e.push(t),this.productosNuevosPendientes.has(t.id)||this.productosNuevosPendientes.set(t.id,{...t}))}),c=[...d,...e]}this.embarque={fecha:o.toISOString().split("T")[0],cargaCon:a.cargaCon||"",productos:c,kilosCrudos:a.kilosCrudos||{}},this.costosPorMedida={...a.costosPorMedida||{}},this.aplicarCostoExtra={...a.aplicarCostoExtra||{}},this.costoExtra=void 0!==a.costoExtra?a.costoExtra:18,this.clienteCrudos={},a.clientes.forEach(e=>{e.crudos&&e.crudos.length>0?this.$set(this.clienteCrudos,e.id,e.crudos):this.$set(this.clienteCrudos,e.id,[])}),this.embarqueId=e,this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0,this.guardarSnapshotOffline({pendingSync:!1,docData:a,syncState:"synced"}),this.$nextTick(()=>{this._inicializandoEmbarque=!1,this._aplicandoRemoto=!1})}else localStorage.removeItem("embarque"),localStorage.removeItem("ultimoEmbarqueId"),localStorage.removeItem("ultimaRuta"),alert("El embarque no existe o est√° corrupto. Se reiniciar√° el formulario para evitar errores."),this.resetearEmbarque()},e=>{console.error("Error al escuchar cambios del embarque:",e),"unavailable"===e.code||e.message.includes("network")||e.message.includes("NETWORK")?(console.warn("[onSnapshot] Error de red detectado, reintentando conexi√≥n en 5 segundos..."),setTimeout(()=>{this.embarqueId&&!this.unsubscribe&&(console.log("[onSnapshot] Reintentando conexi√≥n..."),this.cargarEmbarque(this.embarqueId))},5e3)):"permission-denied"===e.code?(console.error("[onSnapshot] Error de permisos:",e),alert("Error de permisos. Por favor, verifique su acceso.")):console.error("[onSnapshot] Error desconocido:",e),this._inicializandoEmbarque=!1,this._aplicandoRemoto=!1})},limpiarConexionesFirestore(){if(this.unsubscribe){console.log("[limpiarConexiones] Cerrando conexi√≥n onSnapshot existente");try{this.unsubscribe()}catch(e){console.warn("[limpiarConexiones] Error al cerrar conexi√≥n:",e)}this.unsubscribe=null}},configurarReconexionAutomatica(){window.addEventListener("online",()=>{console.log("[Reconexi√≥n] Conexi√≥n restaurada, reestableciendo listeners..."),this.embarqueId&&!this.unsubscribe&&setTimeout(()=>{this.cargarEmbarque(this.embarqueId)},1e3)}),window.addEventListener("offline",()=>{console.warn("[Conexi√≥n] Conexi√≥n perdida, modo offline activado")})},async resetearEmbarque(){const e=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(e)return;this._inicializandoEmbarque=!0;const t=(new Date).toISOString().split("T")[0];this.costosPorMedida={},this.aplicarCostoExtra={},this.costoExtra=18;try{const e=Object(r["h"])(),a=Object(r["c"])(e,"embarques"),o=await Object(r["g"])(a),i={};o.docs.forEach(e=>{const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return;a=new Date(t.fecha)}const o=a.toISOString().split("T")[0];i[o]||(i[o]=[]),i[o].push({id:e.id,fecha:o,data:e.data()})});const s=i[t]||[];let n=t;if(s.length>0){let e=new Date(t),a=!1;for(let t=1;t<=7&&!a;t++){e.setDate(e.getDate()+1);const t=e.toISOString().split("T")[0];i[t]&&0!==i[t].length||(a=!0,n=t)}if(!a)return this.embarque={fecha:t,cargaCon:"",productos:[]},this.clientesJuntarMedidas={},this.clientesReglaOtilio={},this.clientesIncluirPrecios={},this.embarqueId=null,this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1,this.embarqueBloqueado=!1,this.clientesPersonalizados=[],void(esRecargaPagina||alert("Ya existe un embarque para hoy y los pr√≥ximos d√≠as. Por favor, seleccione manually una fecha diferente."))}this.embarque={fecha:n,cargaCon:"",productos:[],crudos:[]},this.clienteCrudos={},this.clientesJuntarMedidas={},this.clientesReglaOtilio={},this.clientesIncluirPrecios={},this.embarqueId=null,this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1,this.embarqueBloqueado=!1,this.clientesPersonalizados=[];const c=this.clientesPredefinidos.map(e=>{const t=Object(v["c"])(e.id.toString());return t.nombreCliente=e.nombre,this.setTipoDefaultParaCliente(t),t});this.clienteCrudos={},this.embarque.productos=c,this.clientesPredefinidos.forEach(e=>{const t=e.nombre&&e.nombre.toLowerCase().includes("otilio");this.$set(this.clientesReglaOtilio,e.id.toString(),t)}),this.clientesPredefinidos.forEach(e=>{e.nombre&&e.nombre.toLowerCase().includes("catarro");this.$set(this.clientesSumarKgCatarro,e.id.toString(),!1)}),this.clientesPredefinidos.forEach(e=>{this.$set(this.clientesIncluirPrecios,e.id.toString(),!1)}),this.clientesPredefinidos.forEach(e=>{this.$set(this.clientesCuentaEnPdf,e.id.toString(),!1)}),this.clientesPredefinidos.forEach(e=>{this.$set(this.clientesJuntarMedidas,e.id.toString(),!1)}),this.clientesPredefinidos.length>0&&(this.clienteActivo=this.clientesPredefinidos[0].id.toString()),this.embarque.fecha&&(this._guardandoInicial=!0,this.$nextTick(async()=>{try{const t=Object(r["c"])(e,"embarques"),a=await Object(r["g"])(t),o=a.docs.some(e=>{const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return!1;a=new Date(t.fecha)}const o=a.toISOString().split("T")[0];return o===this.embarque.fecha});if(o)return void(this._guardandoInicial=!1);const i=this.prepararDatosEmbarque(),s=await Object(r["b"])(Object(r["c"])(e,"embarques"),i);this.embarqueId=s.id,this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0,localStorage.setItem("ultimoEmbarqueId",this.embarqueId)}catch(t){console.error("Error en el guardado inicial autom√°tico:",t)}finally{this._guardandoInicial=!1}}))}catch(a){console.error("Error al resetear el embarque:",a),this.embarque={fecha:t,cargaCon:"",productos:[]},this.clientesJuntarMedidas={},this.clientesReglaOtilio={},this.clientesIncluirPrecios={},this.clientesPredefinidos.forEach(e=>{const t=e.nombre&&e.nombre.toLowerCase().includes("otilio");this.$set(this.clientesReglaOtilio,e.id.toString(),t)}),this.embarqueId=null,this.modoEdicion=!1,this.guardadoAutomaticoActivo=!1,this.embarqueBloqueado=!1,this.clientesPersonalizados=[]}this.$nextTick(()=>{this._inicializandoEmbarque=!1})},buildOfflineSnapshot(e=null){if(!this.embarqueId)return null;const t=(e,t)=>{if(void 0===e||null===e)return t;try{return JSON.parse(JSON.stringify(e))}catch(a){return console.warn("[buildOfflineSnapshot] Error al clonar valor, devolviendo fallback:",a),t}},a=e||this.prepararDatosEmbarque();return{id:this.embarqueId,fecha:(null===a||void 0===a?void 0:a.fecha)||this.embarque.fecha||null,cargaCon:(null===a||void 0===a?void 0:a.cargaCon)||this.embarque.cargaCon||"",embarqueBloqueado:this.embarqueBloqueado||!1,productos:t(this.embarque.productos||[],[]),clienteCrudos:t(this.clienteCrudos||{},{}),clientesJuntarMedidas:t(this.clientesJuntarMedidas||{},{}),clientesReglaOtilio:t(this.clientesReglaOtilio||{},{}),clientesIncluirPrecios:t(this.clientesIncluirPrecios||{},{}),clientesCuentaEnPdf:t(this.clientesCuentaEnPdf||{},{}),clientesSumarKgCatarro:t(this.clientesSumarKgCatarro||{},{}),clientesPersonalizados:t(this.clientesPersonalizados||[],[]),costosPorMedida:t(this.costosPorMedida||{},{}),aplicarCostoExtra:t(this.aplicarCostoExtra||{},{}),costoExtra:this.costoExtra,medidasConfiguracion:t(this.medidasConfiguracion||[],[]),preciosActuales:t(this.preciosActuales||[],[]),clientes:t((null===a||void 0===a?void 0:a.clientes)||[],[]),docData:t(a||{},{})}},async guardarSnapshotOffline(e={}){if(this.embarqueId&&!this._inicializandoEmbarque)try{await D["a"].init();const t=this.buildOfflineSnapshot(e.docData);if(!t)return;const a=void 0!==e.pendingSync?e.pendingSync:!navigator.onLine;await D["a"].save(t,{pendingSync:a,syncState:e.syncState,lastSyncError:e.lastSyncError})}catch(t){console.error("[guardarSnapshotOffline] Error al guardar snapshot offline:",t)}},async cargarEmbarqueOffline(e){try{await D["a"].init();const t=await D["a"].getById(e);return!!t&&(this.aplicarSnapshotOffline(t),!0)}catch(t){return console.error("[cargarEmbarqueOffline] No se pudo cargar el embarque offline:",t),!1}},aplicarSnapshotOffline(e){if(!e||!e.id)return;const t=(e,t)=>{if(void 0===e||null===e)return t;try{return JSON.parse(JSON.stringify(e))}catch(a){return console.warn("[aplicarSnapshotOffline] Error al clonar valor, usando fallback:",a),t}};this._inicializandoEmbarque=!0,this.embarqueId=e.id,this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0,this.embarqueBloqueado=Boolean(e.embarqueBloqueado),this.embarque={fecha:e.fecha||null,cargaCon:e.cargaCon||"",productos:t(e.productos||[],[])},this.clienteCrudos=t(e.clienteCrudos||{},{}),this.clientesJuntarMedidas=t(e.clientesJuntarMedidas||{},{}),this.clientesReglaOtilio=t(e.clientesReglaOtilio||{},{}),this.clientesIncluirPrecios=t(e.clientesIncluirPrecios||{},{}),this.clientesCuentaEnPdf=t(e.clientesCuentaEnPdf||{},{}),this.clientesSumarKgCatarro=t(e.clientesSumarKgCatarro||{},{}),this.clientesPersonalizados=t(e.clientesPersonalizados||[],[]),this.costosPorMedida=t(e.costosPorMedida||{},{}),this.aplicarCostoExtra=t(e.aplicarCostoExtra||{},{}),this.costoExtra=void 0!==e.costoExtra?e.costoExtra:this.costoExtra,this.medidasConfiguracion=t(e.medidasConfiguracion||[],[]),this.preciosActuales=t(e.preciosActuales||[],[]);try{localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados))}catch(a){console.warn("[aplicarSnapshotOffline] No se pudo sincronizar clientes personalizados con localStorage:",a)}this.productosEliminadosLocalmente=new Set,this.productosNuevosPendientes=new Map,this.camposEnEdicion=new Set,this._inicializandoEmbarque=!1,this.actualizarMedidasUsadas(),this.undoStack=[JSON.stringify(this.embarque)],this.redoStack=[],this.clienteActivo=this.embarque.productos.length>0?this.embarque.productos[0].clienteId:null},normalizarDocDataParaFirestore(e,t={}){var a,o;const i=e?JSON.parse(JSON.stringify(e)):this.prepararDatosEmbarque(),r=e=>{if(!e){const e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${o}`}if("string"===typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;if(e instanceof Date){const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${o}`}if("object"===typeof e&&null!==e){if("number"===typeof e.seconds){const t=new Date(1e3*e.seconds),a=t.getUTCFullYear(),o=String(t.getUTCMonth()+1).padStart(2,"0"),i=String(t.getUTCDate()).padStart(2,"0");return`${a}-${o}-${i}`}if("number"===typeof e._seconds){const t=new Date(1e3*e._seconds),a=t.getUTCFullYear(),o=String(t.getUTCMonth()+1).padStart(2,"0"),i=String(t.getUTCDate()).padStart(2,"0");return`${a}-${o}-${i}`}}if("string"===typeof e)try{const t=new Date(e);if(!Number.isNaN(t.getTime())){const e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${o}`}}catch(r){console.warn("[normalizarDocDataParaFirestore] No se pudo parsear la fecha:",e,r)}const t=new Date,a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${a}-${o}-${i}`},s={cargaCon:i.cargaCon||"",clientes:Array.isArray(i.clientes)?i.clientes:[],clientesJuntarMedidas:i.clientesJuntarMedidas||{},clientesReglaOtilio:i.clientesReglaOtilio||{},clientesIncluirPrecios:i.clientesIncluirPrecios||{},clientesCuentaEnPdf:i.clientesCuentaEnPdf||{},clientesSumarKgCatarro:i.clientesSumarKgCatarro||{},clientesPersonalizados:Array.isArray(i.clientesPersonalizados)?i.clientesPersonalizados:[],embarqueBloqueado:null!==(a=null!==(o=t.embarqueBloqueado)&&void 0!==o?o:i.embarqueBloqueado)&&void 0!==a&&a,costosPorMedida:i.costosPorMedida||{},aplicarCostoExtra:i.aplicarCostoExtra||{},costoExtra:"number"===typeof i.costoExtra?i.costoExtra:this.costoExtra||18,medidasConfiguracion:Array.isArray(i.medidasConfiguracion)?i.medidasConfiguracion:[],preciosActuales:Array.isArray(i.preciosActuales)?i.preciosActuales:[],fecha:r(i.fecha||t.fecha||this.embarque.fecha)};return s.clientes=s.clientes.map(e=>({...e,productos:Array.isArray(e.productos)?e.productos.map(e=>({...e,restarTaras:e.restarTaras||!1,noSumarKilos:e.noSumarKilos||!1})):[],crudos:Array.isArray(e.crudos)?e.crudos:[]})),s},async sincronizarRegistroOffline(e){if(e&&e.id)try{var t;const a=Object(r["h"])(),o=Object(r["e"])(a,"embarques",e.id),i=e.docData||(e.id===this.embarqueId?this.prepararDatosEmbarque():null),s=this.normalizarDocDataParaFirestore(i,e),n={userId:this.authStore.userId,username:(null===(t=this.authStore.user)||void 0===t?void 0:t.username)||"Usuario desconocido",timestamp:Object(r["q"])()},c=await Object(r["f"])(o);if(e.deleted)return c.exists()&&await Object(r["d"])(o),void await D["a"].hardDelete(e.id);const d={...s,ultimaEdicion:n};c.exists()?await Object(r["r"])(o,d,{merge:!1}):await Object(r["r"])(o,d),await D["a"].markSynced(e.id),e.id===this.embarqueId&&(this.guardadoAutomaticoActivo=!0,this.modoEdicion=!0)}catch(a){console.error("[sincronizarRegistroOffline] Error al sincronizar embarque offline:",a);try{await D["a"].markSyncError(e.id,a.message||a)}catch(o){console.warn("[sincronizarRegistroOffline] No se pudo marcar el error de sincronizaci√≥n:",o)}}},async guardarCambiosEnTiempoReal(e=!1,t={}){const{desdeModal:a=!1,immediate:o=!1,merge:i=!0}=t;if(!e&&(!this.guardadoAutomaticoActivo||!this.embarqueId||this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente)&&!a)return Promise.resolve();if(await this.guardarSnapshotOffline({pendingSync:!navigator.onLine}),!navigator.onLine)return Promise.resolve();if(!this.saveManager)return console.warn("[guardarCambiosEnTiempoReal] SaveManager no inicializado"),Promise.reject(new Error("SaveManager no inicializado"));const s=async()=>{try{const e=Object.keys(this.clientesModificados||{}).length>0,t=!(!this.fechaModificada&&!this.cargaConModificada);if(!e&&!t)return;const a=Object(r["h"])(),o=Object(r["e"])(a,"embarques",this.embarqueId);await Object(r["p"])(a,async e=>{var t;const a=await e.get(o);if(!a.exists())return;const i=a.data(),s=new Map((i.clientes||[]).map(e=>[String(e.id),e])),n=new Map(s);Object.keys(this.clientesModificados||{}).forEach(e=>{const t=this.productosPorCliente[e]||[];console.log("[guardarCambiosEnTiempoReal] Preparando productos para guardar",{clienteId:e,productos:t.map(e=>({id:e.id,medida:e.medida,nombreAlternativoPDF:e.nombreAlternativoPDF}))});const a=t.filter(e=>e.medida&&""!==e.medida.trim()),o=a.length>0?a:t;n.set(String(e),{id:e,nombre:this.obtenerNombreCliente(e),productos:JSON.parse(JSON.stringify(o)).map(e=>({...e,restarTaras:e.restarTaras||!1,noSumarKilos:e.noSumarKilos||!1})),crudos:this.clienteCrudos[e]?JSON.parse(JSON.stringify(this.clienteCrudos[e])):[]})});try{this.authStore.ensureAuthenticated()}catch(d){return console.error("[guardarCambiosEnTiempoReal] Error de autenticaci√≥n:",d.message),void this.mostrarErrorAutenticacion(d.message)}const c={fecha:new Date(this.embarque.fecha),cargaCon:this.embarque.cargaCon,clientesJuntarMedidas:{...this.clientesJuntarMedidas},clientesReglaOtilio:{...this.clientesReglaOtilio},clientesIncluirPrecios:{...this.clientesIncluirPrecios},clientesCuentaEnPdf:{...this.clientesCuentaEnPdf},clientesSumarKgCatarro:{...this.clientesSumarKgCatarro},clientesPersonalizados:[...this.clientesPersonalizados],clientes:Array.from(n.values()),ultimaEdicion:{userId:this.authStore.userId,username:(null===(t=this.authStore.user)||void 0===t?void 0:t.username)||"Usuario desconocido",timestamp:Object(r["q"])()}};e.update(o,c)}),this.clientesModificados={},this.fechaModificada=!1,this.cargaConModificada=!1,this.productosEliminadosLocalmente&&(console.log("[guardarCambiosEnTiempoReal] Limpiando lista de productos eliminados localmente"),this.productosEliminadosLocalmente.clear()),this.productosNuevosPendientes&&(console.log("[guardarCambiosEnTiempoReal] Limpiando lista de productos nuevos pendientes"),this.productosNuevosPendientes.clear()),this.autoSaveBackoffMs=0,this.autoSaveDisabledUntil=0,console.log("Cambios guardados autom√°ticamente:",(new Date).toLocaleString()),this.$emit("guardado-automatico")}catch(e){console.error("Error al guardar autom√°ticamente:",e);const a=e&&(e.message||e.code||"")||"",o=/Usuario no autenticado/i.test(a)||/Unsupported field value: undefined.*userId/i.test(a)||/invalid.*data.*userId/i.test(a);if(o)return console.error("[guardarCambiosEnTiempoReal] Error de autenticaci√≥n detectado"),void this.mostrarErrorAutenticacion("Error de autenticaci√≥n al guardar. Verifique su sesi√≥n.");const i=/quota/i.test(a)||/resource[-_ ]?exhausted/i.test(a);if(i){if(this.autoSaveBackoffMs=Math.min(this.autoSaveBackoffMs>0?2*this.autoSaveBackoffMs:5e3,6e4),this.autoSaveDisabledUntil=Date.now()+this.autoSaveBackoffMs,!this.lastAutoSaveQuotaAlert){this.lastAutoSaveQuotaAlert=!0;try{alert("Se alcanz√≥ la cuota de Firebase. Se pausar√° el auto-guardado temporalmente y se reintentar√° autom√°ticamente. Tus cambios locales est√°n guardados.")}catch(t){}setTimeout(()=>{this.lastAutoSaveQuotaAlert=!1},6e4)}setTimeout(()=>{this.guardarCambiosEnTiempoReal()},this.autoSaveBackoffMs+200)}}},n=a||this.fechaModificada||this.cargaConModificada?"high":"normal";return this.saveManager.scheduleSave("embarque-"+this.embarqueId,s,{priority:n,merge:!a&&i,immediate:a||o}).catch(e=>{throw console.error("[guardarCambiosEnTiempoReal] Error al programar guardado:",e),e})},async guardarEmbarque(){if(!this.embarque.fecha)return void alert("Por favor, seleccione una fecha para el embarque.");const e=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(e)return;if(this._guardandoEmbarque)return void console.warn("Ya hay una operaci√≥n de guardado en curso");if(this._guardandoEmbarque=!0,this.embarqueId||(this.embarqueId=Object(C["a"])(),this.modoEdicion=!0,this.guardadoAutomaticoActivo=!0),await this.guardarSnapshotOffline({pendingSync:!navigator.onLine}),!navigator.onLine)return this._guardandoEmbarque=!1,void this.mostrarMensaje("Embarque guardado de forma offline. Se sincronizar√° autom√°ticamente cuando recuperes la conexi√≥n.");const t=this.prepararDatosEmbarque(),a=Object(r["h"])();try{if(this.modoEdicion){const e=Object(r["e"])(a,"embarques",this.embarqueId);await Object(r["p"])(a,async a=>{var o;const i=await a.get(e);if(i.exists()){try{this.authStore.ensureAuthenticated()}catch(s){return console.error("[guardarEmbarque] Error de autenticaci√≥n:",s.message),void this.mostrarErrorAutenticacion(s.message)}a.update(e,{...t,ultimaEdicion:{userId:this.authStore.userId,username:(null===(o=this.authStore.user)||void 0===o?void 0:o.username)||"Usuario desconocido",timestamp:Object(r["q"])()}})}}),await this.guardarSnapshotOffline({pendingSync:!1,docData:t,syncState:"synced"}),this.mostrarMensaje("Embarque actualizado exitosamente."),this._guardandoEmbarque=!1}else{const e=new Date(this.embarque.fecha),d=e.toISOString().split("T")[0],l=Object(r["c"])(a,"embarques"),u=await Object(r["g"])(l),h=u.docs.filter(e=>{const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return!1;a=new Date(t.fecha)}const o=a.toISOString().split("T")[0];return o===d});if(h.length>0)return alert("Ya existe un embarque para la fecha seleccionada. Por favor, seleccione otra fecha."),void(this._guardandoEmbarque=!1);const m=Object(r["e"])(a,"reservas_fechas",d);await Object(r["r"])(m,{fecha:d,timestamp:Object(r["q"])(),usuario:this.authStore.userId||"an√≥nimo","expiraci√≥n":new Date(Date.now()+6e4)});try{var o,i;try{this.authStore.ensureAuthenticated()}catch(c){return console.error("[guardarEmbarque] Error de autenticaci√≥n:",c.message),void this.mostrarErrorAutenticacion(c.message)}const e=await Object(r["b"])(Object(r["c"])(a,"embarques"),{...t,ultimaEdicion:{userId:this.authStore.userId,username:(null===(o=this.authStore.user)||void 0===o?void 0:o.username)||"Usuario desconocido",timestamp:Object(r["q"])()}}),d=Object(s["d"])(n["c"],"cambios/"+e.id);await Object(s["e"])(d,{tipo:"guardar",userId:this.authStore.userId,username:(null===(i=this.authStore.user)||void 0===i?void 0:i.username)||"Usuario desconocido",timestamp:Object(r["q"])()}),this.embarqueId=e.id,this.mostrarMensaje("Embarque creado exitosamente y guardado en la base de datos."),this.modoEdicion=!0,await this.guardarSnapshotOffline({pendingSync:!1,docData:t,syncState:"synced"})}finally{try{await Object(r["d"])(m)}catch(c){console.error("Error al eliminar la reserva de fecha:",c)}this._guardandoEmbarque=!1}}this.guardadoAutomaticoActivo=!0}catch(c){this._guardandoEmbarque=!1,console.error("Error al guardar el embarque: ",c),alert("Hubo un error al guardar el embarque. Por favor, intente nuevamente.")}},prepararDatosEmbarque(){const e={fecha:this.embarque.fecha,cargaCon:this.embarque.cargaCon,clientes:[],clientesJuntarMedidas:this.clientesJuntarMedidas,clientesReglaOtilio:this.clientesReglaOtilio,clientesIncluirPrecios:this.clientesIncluirPrecios,clientesCuentaEnPdf:this.clientesCuentaEnPdf,clientesSumarKgCatarro:this.clientesSumarKgCatarro,clientesPersonalizados:this.clientesPersonalizados,embarqueBloqueado:this.embarqueBloqueado},t=new Map(this.clientesPredefinidos.map(e=>[e.id.toString(),e]));if(0===Object.keys(this.productosPorCliente).length&&this.clientesPredefinidos.length>0){const e=this.clientesPredefinidos[0].id.toString(),t=this.clientesPredefinidos[0],a=Object(v["c"])(e);a.nombreCliente=t.nombre,this.embarque.productos.push(a),this.clienteActivo=e,this.$forceUpdate()}const a=this.clientesDisponibles.filter(e=>"otro"!==e.id).map(e=>e.id.toString());return a.forEach(e=>{const a=this.embarque.productos.some(t=>t.clienteId.toString()===e);if(!a){const a=t.get(e)||this.clientesDisponibles.find(t=>t.id.toString()===e);if(a){const t=Object(v["c"])(e);t.nombreCliente=a.nombre,this.setTipoDefaultParaCliente(t),this.embarque.productos.push(t),console.log(`Se ha creado un producto para el cliente ${t.nombreCliente} que no ten√≠a ninguno.`)}}}),Object.entries(this.productosPorCliente).forEach(([a,o])=>{const i=t.get(a);let r=this.clienteCrudos[a]||[];const s={id:a,nombre:i?i.nombre:this.obtenerNombreCliente(a),productos:o.map(e=>({...e,restarTaras:e.restarTaras||!1,noSumarKilos:e.noSumarKilos||!1})),crudos:r};e.clientes.push(s)}),e},setTipoDefaultParaCliente(e){const t=this.obtenerNombreCliente(e.clienteId);"Catarro"===t&&(e.tipo="s/h20")},undo(){if(this.undoStack.length>1){const e=this.undoStack.pop();this.redoStack.push(e);const t=this.undoStack[this.undoStack.length-1];this.isUndoRedo=!0,this.embarque=JSON.parse(t),console.log("Undo realizado. Estado actual restaurado."),this.guardarCambiosEnTiempoReal()}else console.log("No hay m√°s acciones para deshacer.")},redo(){if(this.redoStack.length>0){const e=this.redoStack.pop();this.undoStack.push(e),this.isUndoRedo=!0,this.embarque=JSON.parse(e),console.log("Redo realizado. Estado actual restaurado."),this.guardarCambiosEnTiempoReal()}else console.log("No hay m√°s acciones para rehacer.")},actualizarProducto(e){const t=this.embarque.productos.findIndex(t=>t.id===e.id);-1!==t&&(Object.keys(e).forEach(a=>{"id"!==a&&"clienteId"!==a&&this.$set(this.embarque.productos[t],a,e[a])}),this.$forceUpdate())},onTipoChange(e){"otro"!==e.tipo&&(e.tipoPersonalizado=""),"c/h20"!==e.tipo||e.camaronNeto||(e.camaronNeto=.65),e.isEditing=!0,this.$nextTick(()=>{setTimeout(()=>{e.medida&&e.tipo&&(e.isEditing=!1)},100)})},agregarCrudo(e){this.clienteCrudos[e]||this.$set(this.clienteCrudos,e,[]),this.clienteCrudos[e].push({items:[Object(v["b"])()]}),this.guardarCambiosEnTiempoReal()},agregarCrudoItem(e,t){this.clienteCrudos[e]||this.$set(this.clienteCrudos,e,[]),this.clienteCrudos[e][t]||this.$set(this.clienteCrudos[e],t,{items:[]}),Array.isArray(this.clienteCrudos[e][t].items)||this.$set(this.clienteCrudos[e][t],"items",[]),this.clienteCrudos[e][t].items.push(Object(v["b"])()),this.guardarCambiosEnTiempoReal()},eliminarCrudoItem(e,t,a){this.clienteCrudos[e]?this.clienteCrudos[e][t]?this.clienteCrudos[e][t].items?(this.clienteCrudos[e][t].items.splice(a,1),0===this.clienteCrudos[e][t].items.length&&this.eliminarCrudo(e,t),this.guardarCambiosEnTiempoReal()):console.error("El objeto crudo no tiene propiedad items"):console.error("√çndice de crudo no v√°lido:",t):console.error("Cliente no encontrado:",e)},eliminarCrudo(e,t){this.clienteCrudos[t]?(this.clienteCrudos[t].splice(e,1),0===this.clienteCrudos[t].length&&this.$delete(this.clienteCrudos,t),this.guardarCambiosEnTiempoReal()):console.error("Cliente no encontrado:",t)},toggleSobrante(e,t,a){if(!this.clienteCrudos[e])return void console.error("Cliente no encontrado:",e);if(!this.clienteCrudos[e][t])return void console.error("√çndice de crudo no v√°lido:",t);if(!this.clienteCrudos[e][t].items)return this.$set(this.clienteCrudos[e][t],"items",[]),void console.error("El objeto crudo no tiene propiedad items");if(!this.clienteCrudos[e][t].items[a])return void console.error("√çndice de item no v√°lido:",a);const o=this.clienteCrudos[e][t].items[a];o.hasOwnProperty("mostrarSobrante")?o.mostrarSobrante=!o.mostrarSobrante:this.$set(o,"mostrarSobrante",!0),this.guardarCambiosEnTiempoReal()},actualizarTotalCrudos(e,t){this.$forceUpdate(),this.guardarCambiosEnTiempoReal()},actualizarCrudos(){this.guardarCambiosEnTiempoReal()},onRestarTarasChange(e){console.log("Restar taras cambiado:",e.restarTaras),this.$nextTick(()=>{this.actualizarProducto(e)})},handleJuntarMedidasChange(e,t){this.$set(this.clientesJuntarMedidas,e,t),this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},handleReglaOtilioChange(e,t){this.$set(this.clientesReglaOtilio,e,t),this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},handleIncluirPreciosChange(e,t){this.$set(this.clientesIncluirPrecios,e,t),!t&&this.clientesCuentaEnPdf[e]&&this.$set(this.clientesCuentaEnPdf,e,!1),this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},handleCuentaEnPdfChange(e,t){this.$set(this.clientesCuentaEnPdf,e,t),this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},handleSumarKgCatarroChange(e,t){console.log("[DEBUG] Handle Sumar Kg Catarro Change:",{clienteId:e,checked:t,estadoAnterior:this.clientesSumarKgCatarro[e],estadoCompleto:{...this.clientesSumarKgCatarro}}),this.$set(this.clientesSumarKgCatarro,e,t),console.log("[DEBUG] Estado despu√©s del cambio:",{nuevoEstado:this.clientesSumarKgCatarro[e],estadoCompleto:{...this.clientesSumarKgCatarro}}),this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()},async agregarNuevoCliente(e){if(!e||!e.nombre)return;const t=String(e.nombre).trim();if(!t)return;const a=new Set([...this.clientesPredefinidos,...this.clientesPersonalizados].map(e=>String(e.nombre).toLowerCase()));let o=t;if(a.has(o.toLowerCase())){let e=2;while(a.has(`${t} (${e})`.toLowerCase()))e++;o=`${t} (${e})`}const i={id:Object(C["a"])(),nombre:o,color:e.color||this.nuevoClienteColor,editable:!0,personalizado:!0,key:"personalizado_"+Date.now()};this.clientesPersonalizados.push(i),this.agregarProducto(i.id);const r=this.embarque.productos[this.embarque.productos.length-1];r&&r.clienteId===i.id&&this.$set(r,"nombreCliente",o),this.clienteCrudos[i.id]||this.$set(this.clienteCrudos,i.id,[]);const s=o.toLowerCase().includes("otilio");this.$set(this.clientesReglaOtilio,i.id,s),localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados)),this.guardarCambiosEnTiempoReal(),this.mostrarModalNuevoCliente=!1,this.seleccionarCliente(i.id)},abrirModalNombreAlternativo(e){this.productoSeleccionado=e,this.productoNombreAlternativoEnEdicionId=(null===e||void 0===e?void 0:e.id)||null,this.productoNombreAlternativoEnEdicionId&&this.marcarCampoEnEdicion(this.productoNombreAlternativoEnEdicionId,"nombreAlternativoPDF"),this.mostrarModalNombreAlternativo=!0},cerrarModalNombreAlternativo(){this.productoNombreAlternativoEnEdicionId&&(this.desmarcarCampoEnEdicion(this.productoNombreAlternativoEnEdicionId,"nombreAlternativoPDF"),this.nombreAlternativoPendienteSync.delete(this.productoNombreAlternativoEnEdicionId),this.productoNombreAlternativoEnEdicionId=null),this.mostrarModalNombreAlternativo=!1,this.productoSeleccionado=null},async guardarNombreAlternativo(e){const t=this.productoSeleccionado;if(!t)return void this.cerrarModalNombreAlternativo();const a=t.clienteId;Object.prototype.hasOwnProperty.call(t,"nombreAlternativoPDF")?t.nombreAlternativoPDF:t.medida;e?this.$set(t,"nombreAlternativoPDF",e):this.$delete(t,"nombreAlternativoPDF"),this.nombreAlternativoPendienteSync.set(t.id,e||null),a&&this.$set(this.clientesModificados,a,!0),this.$forceUpdate(),this.mostrarModalNombreAlternativo=!1;try{await this.$nextTick(),await this.guardarCambiosEnTiempoReal(!0)}finally{this.productoNombreAlternativoEnEdicionId&&(this.desmarcarCampoEnEdicion(this.productoNombreAlternativoEnEdicionId,"nombreAlternativoPDF"),this.productoNombreAlternativoEnEdicionId=null),this.productoSeleccionado=null}},abrirModalPrecio(e){this.itemSeleccionado=e,this.mostrarModalPrecio=!0},cerrarModalPrecio(){this.mostrarModalPrecio=!1,this.itemSeleccionado=null},async guardarPrecio(e){if(this.itemSeleccionado){this.guardandoModal=!0;try{const t=this.itemSeleccionado.clienteId;null!==e?(this.$set(this.itemSeleccionado,"precio",e),this.$set(this.itemSeleccionado,"precioBorradoManualmente",!1)):(this.$delete(this.itemSeleccionado,"precio"),this.$set(this.itemSeleccionado,"precioBorradoManualmente",!0)),t?(this.$set(this.clientesModificados,t,!0),console.log(`[guardarPrecio] Cliente ${t} marcado como modificado por cambio en precio`)):console.warn("[guardarPrecio] Item seleccionado no tiene clienteId:",this.itemSeleccionado),this.$forceUpdate(),await this.$nextTick(),await this.guardarCambiosEnTiempoReal(!0,{desdeModal:!0,immediate:!0,merge:!1}),console.log("[guardarPrecio] Guardado completado exitosamente"),this.cerrarModalPrecio()}catch(t){console.error("[guardarPrecio] Error al guardar:",t),alert("Error al guardar el precio. Por favor, int√©ntelo de nuevo.")}finally{this.guardandoModal=!1}}else this.cerrarModalPrecio()},abrirModalHilos(e){this.itemSeleccionado=e,this.mostrarModalHilos=!0},cerrarModalHilos(){this.mostrarModalHilos=!1,this.itemSeleccionado=null},async guardarHilos(e){if(this.itemSeleccionado){this.guardandoModal=!0;try{const t=this.itemSeleccionado.clienteId;e?this.$set(this.itemSeleccionado,"hilos",e):this.$delete(this.itemSeleccionado,"hilos"),t?(this.$set(this.clientesModificados,t,!0),console.log(`[guardarHilos] Cliente ${t} marcado como modificado por cambio en hilos`)):console.warn("[guardarHilos] Item seleccionado no tiene clienteId:",this.itemSeleccionado),this.$forceUpdate(),await this.$nextTick(),await this.guardarCambiosEnTiempoReal(!0,{desdeModal:!0,immediate:!0,merge:!1}),console.log("[guardarHilos] Guardado completado exitosamente"),this.cerrarModalHilos()}catch(t){console.error("[guardarHilos] Error al guardar:",t),alert("Error al guardar los hilos. Por favor, int√©ntelo de nuevo.")}finally{this.guardandoModal=!1}}else this.cerrarModalHilos()},abrirModalNota(e){this.itemSeleccionado=e,this.mostrarModalNota=!0},cerrarModalNota(){this.mostrarModalNota=!1,this.itemSeleccionado=null},async guardarNota(e){if(this.itemSeleccionado){this.guardandoModal=!0;try{const t=this.itemSeleccionado.clienteId;e?this.$set(this.itemSeleccionado,"nota",e):this.$delete(this.itemSeleccionado,"nota"),t?(this.$set(this.clientesModificados,t,!0),console.log(`[guardarNota] Cliente ${t} marcado como modificado por cambio en nota`)):console.warn("[guardarNota] Item seleccionado no tiene clienteId:",this.itemSeleccionado),this.$forceUpdate(),await this.$nextTick(),await this.guardarCambiosEnTiempoReal(!0,{desdeModal:!0,immediate:!0,merge:!1}),console.log("[guardarNota] Guardado completado exitosamente"),this.cerrarModalNota()}catch(t){console.error("[guardarNota] Error al guardar:",t),alert("Error al guardar la nota. Por favor, int√©ntelo de nuevo.")}finally{this.guardandoModal=!1}}else this.cerrarModalNota()},abrirModalAlt(e){this.itemSeleccionado=e,this.mostrarModalAlt=!0},cerrarModalAlt(){this.mostrarModalAlt=!1,this.itemSeleccionado=null},async guardarAlt(e){if(this.itemSeleccionado){this.guardandoModal=!0;try{const t=this.itemSeleccionado.clienteId;e?this.$set(this.itemSeleccionado,"textoAlternativo",e):this.$delete(this.itemSeleccionado,"textoAlternativo"),t?(this.$set(this.clientesModificados,t,!0),console.log(`[guardarAlt] Cliente ${t} marcado como modificado por cambio en texto alternativo`)):console.warn("[guardarAlt] Item seleccionado no tiene clienteId:",this.itemSeleccionado),this.$forceUpdate(),await this.$nextTick(),await this.guardarCambiosEnTiempoReal(!0,{desdeModal:!0,immediate:!0,merge:!1}),console.log("[guardarAlt] Guardado completado exitosamente"),this.cerrarModalAlt()}catch(t){console.error("[guardarAlt] Error al guardar:",t),alert("Error al guardar el texto alternativo. Por favor, int√©ntelo de nuevo.")}finally{this.guardandoModal=!1}}else this.cerrarModalAlt()},abrirModalConfiguracionMedidas(){this.mostrarModalConfiguracionMedidas=!0},cerrarModalConfiguracionMedidas(){this.mostrarModalConfiguracionMedidas=!1},guardarConfiguracionMedidas(e){this.medidasConfiguracion=e,this.guardarMedidasConfiguracion(),this.cerrarModalConfiguracionMedidas()},abrirModalPedidoCliente(e){const t=this.obtenerNombreCliente(e);this.clienteSeleccionadoPedido=t,this.mostrarModalPedidoCliente=!0},cerrarModalPedidoCliente(){this.mostrarModalPedidoCliente=!1,this.clienteSeleccionadoPedido=null},cargarMedidasConfiguracion(){const e=localStorage.getItem("medidasConfiguracion");if(e)try{this.medidasConfiguracion=JSON.parse(e)}catch(t){console.error("Error al cargar medidas de configuraci√≥n:",t),this.medidasConfiguracion=[]}else this.medidasConfiguracion=["16/20","21/25","26/30","31/35","36/40","41/50","51/60","61/70","71/90","91/110","U-10","U-12","U-15","U-20","U-24","U-30","Colita","Entero"]},guardarMedidasConfiguracion(){localStorage.setItem("medidasConfiguracion",JSON.stringify(this.medidasConfiguracion))},seleccionarCliente(e){const t=this.mostrarModalPrecio||this.mostrarModalHilos||this.mostrarModalNota||this.mostrarModalAlt||this.mostrarModalNombreAlternativo||this.mostrarModalNuevoCliente;if(t)return;if(!this.embarque.fecha)return void alert("Por favor, seleccione una fecha para el embarque.");const a=this.embarque.productos.some(t=>t.clienteId.toString()===e.toString());a?this.clienteActivo=e:this.guardarEmbarqueInicial(e).then(()=>{this.clienteActivo=e})},scrollToCliente(e){this.$nextTick(()=>{const t=document.querySelector(`.cliente-header[data-cliente="${this.obtenerNombreCliente(e)}"]`);t&&(document.querySelectorAll(".cliente-header").forEach(e=>{e.classList.remove("cliente-seleccionado")}),t.classList.add("cliente-seleccionado"),t.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{t.classList.remove("cliente-seleccionado")},2e3))})},toggleSidebar(){this.sidebarCollapsed=!this.sidebarCollapsed},toggleBloqueo(){if(this.embarqueBloqueado=!this.embarqueBloqueado,this.modoEdicion&&this.embarqueId){const e=Object(r["h"])();Object(r["s"])(Object(r["e"])(e,"embarques",this.embarqueId),{embarqueBloqueado:this.embarqueBloqueado}).catch(e=>{console.error("Error al guardar estado de bloqueo:",e)})}},actualizarMedidasUsadas(){this.medidasUsadas=[...new Set(this.embarque.productos.filter(e=>e.medida&&""!==e.medida.trim()).map(e=>e.medida.trim()))]},validarYRepararIDsProductos(){console.log("Validando IDs de productos en busca de duplicados...");const e=new Map;let t=0;return this.embarque.productos.forEach(a=>{if(e.has(a.id)){console.warn(`ID duplicado encontrado: ${a.id} - Medida: ${a.medida} - Cliente: ${this.obtenerNombreCliente(a.clienteId)}`),console.warn("Conflicto con producto existente:","Medida: "+e.get(a.id).medida,"Cliente: "+this.obtenerNombreCliente(e.get(a.id).clienteId));const o=Object(C["a"])();console.log(`Corrigiendo ID duplicado: ${a.id} -> ${o} para producto ${a.medida}`),a.id=o,t++,e.set(o,a)}else e.set(a.id,a)}),t>0?(console.log(`Se corrigieron ${t} productos con IDs duplicados.`),this.guardarCambiosEnTiempoReal()):console.log("No se encontraron IDs duplicados en los productos."),t},onMedidaInput(e,t){const a=t.target.value.toLowerCase();this.productoEditandoId=e.id,e.medida=t.target.value,this.sugerenciasMedidas=a?this.medidasUsadas.filter(e=>e.toLowerCase().includes(a)&&e.toLowerCase()!==a):[],e.isEditing=!0},onMedidaBlur(e){setTimeout(()=>{this.productoEditandoId=null},200),e.medida&&e.medida.length>0&&(e.isEditing=!1,e.isNew=!1),this.actualizarMedidasUsadas()},seleccionarMedida(e,t){e.medida=t,this.productoEditandoId=null},onTallaCrudoChange(e){e.medida||(e.medida=e.talla),this.guardarCambiosEnTiempoReal()},async guardarClientesPersonalizados(){if(localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados)),this.embarqueId)try{console.log("[guardarClientesPersonalizados] Guardando clientes personalizados en Firebase:",this.clientesPersonalizados);const e=async()=>{const e=Object(r["h"])(),t=Object(r["e"])(e,"embarques",this.embarqueId);await Object(r["s"])(t,{clientesPersonalizados:this.clientesPersonalizados,ultimaActualizacionClientes:Object(r["q"])()}),console.log("[guardarClientesPersonalizados] Clientes personalizados guardados exitosamente en Firebase")};this.saveManager?await this.saveManager.scheduleSave("clientes-personalizados-"+this.embarqueId,e,{priority:"high",merge:!1,immediate:!0}):await e()}catch(e){console.error("[guardarClientesPersonalizados] Error al guardar clientes personalizados en Firebase:",e)}},async cargarClientesPersonalizados(){if(this.embarqueId)try{const e=Object(r["h"])(),t=Object(r["e"])(e,"embarques",this.embarqueId),a=await Object(r["f"])(t);if(a.exists()){const e=a.data();if(e.clientesPersonalizados&&Array.isArray(e.clientesPersonalizados))return console.log("[cargarClientesPersonalizados] Cargando clientes personalizados desde Firebase:",e.clientesPersonalizados),this.clientesPersonalizados=e.clientesPersonalizados,void localStorage.setItem("clientesPersonalizados",JSON.stringify(this.clientesPersonalizados))}}catch(t){console.error("[cargarClientesPersonalizados] Error al cargar desde Firebase, intentando localStorage:",t)}const e=localStorage.getItem("clientesPersonalizados");if(e)try{this.clientesPersonalizados=JSON.parse(e),console.log("[cargarClientesPersonalizados] Clientes cargados desde localStorage:",this.clientesPersonalizados)}catch(t){console.error("[cargarClientesPersonalizados] Error al parsear clientes desde localStorage:",t),this.clientesPersonalizados=[]}},async escucharUsuariosActivos(){try{const t=Object(s["d"])(n["c"],"status");if(this.authStore.isLoggedIn&&this.authStore.user){const t=Object(s["d"])(n["c"],"status/"+this.authStore.userId);try{await Object(s["e"])(t,{username:this.authStore.user.username,status:"online",lastSeen:(new Date).toISOString()})}catch(e){console.error("Error al actualizar estado del usuario:",e)}}else console.log("Usuario no autenticado");this.unsubscribeUsuarios=Object(s["c"])(t,e=>{const t=[];console.log("Recibiendo actualizaci√≥n de usuarios activos"),e.forEach(e=>{const a=e.val();console.log("Usuario encontrado:",a),a&&a.username&&t.push({userId:e.key,username:a.username,status:a.status||"online",lastSeen:a.lastSeen})}),console.log("Total usuarios activos:",t.length),this.usuariosActivos=t},e=>{console.error("Error al escuchar usuarios activos:",e)})}catch(e){console.error("Error al iniciar escucha de usuarios:",e)}},async iniciarPresenciaUsuario(){try{if(!this.authStore.isLoggedIn||!this.authStore.user)return void console.log("Usuario no autenticado");const e=Object(s["d"])(n["c"],"status/"+this.authStore.userId);await Object(s["b"])(e).remove(),await Object(s["e"])(e,{username:this.authStore.user.username,status:"online",lastSeen:(new Date).toISOString()})}catch(e){console.error("Error al iniciar presencia:",e.message,e.stack)}},volverAEmbarquesMenu(){this.$router.push({name:"EmbarquesMenu"})},calcularPosicionSticky(e){const t=Object.keys(this.productosPorCliente),a=t.indexOf(e.toString());if(0===a)return 0;let o=0;for(let r=0;r<a;r++){var i;const e=t[r],a=(null===(i=this.$el.querySelector(`[data-cliente="${this.obtenerNombreCliente(e)}"]`))||void 0===i?void 0:i.offsetHeight)||0;o+=a}return o},async crearCuentaJoselito(e,t,a){try{this.isCreatingAccount=!0;const e="1",o={...this.embarque,productos:t,clienteCrudos:{[e]:a},productosTotales:this.embarque.productos,clienteCrudosTotales:this.clienteCrudos,costosPorMedida:{...this.costosPorMedida},aplicarCostoExtra:{...this.aplicarCostoExtra},costoExtra:this.costoExtra};await w["a"].crearCuentaJoselito(o,this.$router)}catch(o){console.error("Error al crear cuenta para Joselito:",o),alert("Error al crear cuenta para Joselito")}finally{this.isCreatingAccount=!1}},async crearCuentaCatarro(e,t,a){try{this.isCreatingAccount=!0;const e="2",o={...this.embarque,productos:t,clienteCrudos:{[e]:a},productosTotales:this.embarque.productos,clienteCrudosTotales:this.clienteCrudos,costosPorMedida:{...this.costosPorMedida},aplicarCostoExtra:{...this.aplicarCostoExtra},costoExtra:this.costoExtra};await w["a"].crearCuentaCatarro(o,this.$router),alert("Cuenta de Catarro creada exitosamente y abierta en una nueva pesta√±a.")}catch(o){console.error("Error al crear cuenta para Catarro:",o),alert("Error al crear cuenta para Catarro: "+o.message)}finally{this.isCreatingAccount=!1}},esClienteJoselito(e){const t=this.clientesDisponibles.find(t=>t.id.toString()===e.toString());return t&&t.nombre.toLowerCase().includes("joselito")},esClienteCatarro(e){const t=this.clientesDisponibles.find(t=>t.id.toString()===e.toString());return t&&t.nombre.toLowerCase().includes("catarro")},esClienteVeronica(e){const t=this.clientesDisponibles.find(t=>t.id.toString()===e.toString());return t&&(t.nombre.toLowerCase().includes("veronica")||t.nombre.toLowerCase().includes("lorena"))},obtenerEmbarqueCliente(e){const t=this.productosPorCliente[e],a=this.clienteCrudos[e];return{fecha:this.embarque.fecha,cargaCon:this.embarque.cargaCon,productos:t,clienteCrudos:{[e]:a},kilosCrudos:this.embarque.kilosCrudos||{}}},async verificarFechaExistente(e){if(this.embarqueBloqueado)alert("El embarque est√° bloqueado. No se puede cambiar la fecha.");else if(e!==this.embarque.fecha)try{const t=Object(r["h"])(),a=new Date(e),o=a.toISOString().split("T")[0],i=Object(r["c"])(t,"embarques"),s=await Object(r["g"])(i),n=s.docs.filter(e=>{if(this.embarqueId&&e.id===this.embarqueId)return!1;const t=e.data();let a;if(t.fecha&&"function"===typeof t.fecha.toDate)a=t.fecha.toDate();else if(t.fecha instanceof Date)a=t.fecha;else{if("string"!==typeof t.fecha)return!1;a=new Date(t.fecha)}const i=a.toISOString().split("T")[0];return i===o});if(n.length>0)return void alert("Ya existe un embarque para la fecha seleccionada. Por favor, seleccione otra fecha.");this.embarqueId&&localStorage.setItem("ultimoEmbarqueId",this.embarqueId),this.embarque.fecha=e,this.modoEdicion&&this.embarqueId&&this.guardarCambiosEnTiempoReal()}catch(t){console.error("Error al verificar fecha existente:",t),alert("Hubo un error al verificar la fecha. Por favor, intente nuevamente.")}},async crearCuentaOzuna(e,t,a){try{this.isCreatingAccount=!0;const e="4",o={...this.embarque,productos:t,clienteCrudos:{[e]:a},productosTotales:this.embarque.productos,clienteCrudosTotales:this.clienteCrudos,costosPorMedida:{...this.costosPorMedida},aplicarCostoExtra:{...this.aplicarCostoExtra},costoExtra:this.costoExtra};await w["a"].crearCuentaOzuna(o,this.$router),alert("Cuenta de Ozuna creada exitosamente y abierta en una nueva pesta√±a.")}catch(o){console.error("Error al crear cuenta para Ozuna:",o),alert("Error al crear cuenta para Ozuna: "+o.message)}finally{this.isCreatingAccount=!1}},async crearCuentaOtilio(e,t,a){try{this.isCreatingAccount=!0;const e="3",o={...this.embarque,productos:t,clienteCrudos:{[e]:a},productosTotales:this.embarque.productos,clienteCrudosTotales:this.clienteCrudos,costosPorMedida:{...this.costosPorMedida},aplicarCostoExtra:{...this.aplicarCostoExtra},costoExtra:this.costoExtra};await w["a"].crearCuentaOtilio(o,this.$router),alert("Cuenta de Otilio creada exitosamente y abierta en una nueva pesta√±a.")}catch(o){console.error("Error al crear cuenta para Otilio:",o),alert("Error al crear cuenta para Otilio: "+o.message)}finally{this.isCreatingAccount=!1}},async crearCuentaVeronica(e,t,a){try{this.isCreatingAccount=!0,console.log("[DEBUG] crearCuentaVeronica - clienteId recibido:",e),console.log("[DEBUG] crearCuentaVeronica - clienteProductos recibidos:",t),console.log("[DEBUG] crearCuentaVeronica - clienteCrudos recibidos:",a);const o="5",i={...this.embarque,productos:t,clienteCrudos:{[o]:a},productosTotales:this.embarque.productos,clienteCrudosTotales:this.clienteCrudos,costosPorMedida:{...this.costosPorMedida},aplicarCostoExtra:{...this.aplicarCostoExtra},costoExtra:this.costoExtra};console.log("[DEBUG] crearCuentaVeronica - embarqueCliente final:",i),await w["a"].crearCuentaVeronica(i,this.$router),alert("Cuenta de Veronica creada exitosamente y abierta en una nueva pesta√±a.")}catch(o){console.error("Error al crear cuenta para Veronica:",o),alert("Error al crear cuenta para Veronica: "+o.message)}finally{this.isCreatingAccount=!1}},async syncOffline(){try{await D["a"].init();const e=await D["a"].getPendingSync();if(Array.isArray(e)&&e.length>0)for(const t of e)await this.sincronizarRegistroOffline(t);this.embarqueId&&this.guardarCambiosEnTiempoReal()}catch(e){console.error("[syncOffline] Error general al sincronizar embarques offline:",e)}},async generarPDFResumenConEscala(){this.mostrarEscalaResumen=!1,this.$options.mixins&&this.$options.mixins.some(e=>e.methods&&e.methods.generarPDFResumen)||"function"===typeof this.generarPDFResumen?await this.generarPDFResumen(this.escalaResumen):await this.generarPDF("resumen",null,this.escalaResumen)},detectarRecarga(){if(window.performance&&window.performance.navigation)return 1===window.performance.navigation.type;if(window.performance&&window.performance.getEntriesByType&&window.performance.getEntriesByType("navigation")){const e=window.performance.getEntriesByType("navigation");if(e.length>0&&e[0].type)return"reload"===e[0].type}const e=localStorage.getItem("ultimaVisita"),t=Date.now();return localStorage.setItem("ultimaVisita",t),!!(e&&t-parseInt(e)<5e3)},handleBeforeUnload(e){if(this.embarqueId&&(localStorage.setItem("ultimoEmbarqueId",this.embarqueId),localStorage.setItem("ultimaRuta",window.location.pathname)),this.saveManager&&this.guardadoAutomaticoActivo){const t=this.saveManager.getStatus();if(t.pendingOperations>0)return this.saveManager.forceProcessAll(),e.preventDefault(),e.returnValue="Hay cambios pendientes de guardar. ¬øEst√°s seguro de que quieres salir?",e.returnValue}},async seleccionarClienteParaProducto(e){if(this.embarque.fecha&&this.embarque.cargaCon)if(this.embarqueId)this.agregarProducto(e),this.clienteActivo=e;else{const t=await this.guardarEmbarqueInicial();t&&(this.agregarProducto(e),this.clienteActivo=e)}else alert("Por favor, seleccione la fecha y con qui√©n se carga el embarque antes de agregar productos.")},agregarCliente(e){},async cargarPreciosActuales(){try{const t=Object(r["h"])(),a=Object(r["c"])(t,"precios"),o=await Object(r["g"])(a);if(0===o.size)return console.warn('[NUEVO-EMBARQUE] ‚ö†Ô∏è  La colecci√≥n "precios" est√° vac√≠a. Verificar si los precios se est√°n guardando correctamente.'),void(this.preciosActuales=[]);let i;try{const e=Object(r["o"])(a,Object(r["l"])("fecha","desc"),Object(r["l"])("timestamp","desc"));i=await Object(r["g"])(e)}catch(e){console.warn("[NUEVO-EMBARQUE] ‚ö†Ô∏è  Error en query con timestamp, usando solo fecha:",e);const t=Object(r["o"])(a,Object(r["l"])("fecha","desc"));i=await Object(r["g"])(t)}this.preciosActuales=i.docs.map(e=>{const t=e.data();return{id:e.id,...t,timestamp:t.timestamp||0,fecha:Object(O["c"])(t.fecha)}}),this.preciosActuales.length;new Set(this.preciosActuales.map(e=>e.fecha));const s=Object(O["c"])(new Date),n=(this.preciosActuales.filter(e=>e.fecha===s),this.preciosActuales.filter(e=>!e.timestamp||0===e.timestamp));n.length>0&&console.warn(`[NUEVO-EMBARQUE] ‚ö†Ô∏è  ${n.length} precios sin timestamp (pueden causar problemas de ordenamiento)`);this.preciosActuales.filter(e=>e.producto&&e.producto.toLowerCase().includes("golfo"))}catch(t){console.error("[NUEVO-EMBARQUE] Error al cargar precios:",t),this.preciosActuales=[]}},async onPrecioAgregado(e){await this.cargarPreciosActuales()}},watch:{embarque:{handler(e){if(this.isUndoRedo)return void(this.isUndoRedo=!1);if(this._inicializandoEmbarque)return;if(this._aplicandoRemoto)return;localStorage.setItem("embarque",JSON.stringify(e)),this.undoStack.push(JSON.stringify(e)),this.redoStack=[];const t=(e.productos||[]).some(e=>e.medida&&""!==e.medida.trim());(t||e.fecha||e.cargaCon)&&this.guardarCambiosEnTiempoReal()},deep:!0},clienteCrudos:{handler(){localStorage.setItem("clienteCrudos",JSON.stringify(this.clienteCrudos)),this.guardarCambiosEnTiempoReal()},deep:!0},"embarque.productos":{handler(e){e.forEach(e=>{})},deep:!0},"embarque.fecha":{handler(e,t){this.embarqueId?(this.fechaModificada=!0,this.guardarCambiosEnTiempoReal()):this.triggerGuardadoInicial()}},"embarque.cargaCon":{handler(e,t){this.embarqueId?(this.cargaConModificada=!0,this.guardarCambiosEnTiempoReal()):this.triggerGuardadoInicial()}}},beforeUnmount(){console.log("[beforeUnmount] Limpiando conexiones y listeners..."),this.limpiarConexionesFirestore(),window.removeEventListener("online",this.configurarReconexionAutomatica),window.removeEventListener("offline",this.configurarReconexionAutomatica),window.removeEventListener("beforeunload",this.handleBeforeUnload)},async created(){try{if(this.authStore.checkAuth(),!this.authStore.isAuthenticated)return console.warn("[NuevoEmbarque] Usuario no autenticado al inicializar, redirigiendo al login"),void this.$router.push("/login")}catch(t){return console.error("[NuevoEmbarque] Error de autenticaci√≥n al inicializar:",t),void this.mostrarErrorAutenticacion("Error de autenticaci√≥n al cargar la p√°gina. Por favor, inicie sesi√≥n nuevamente.")}this.saveManager=Object(d["a"])(),this.configurarReconexionAutomatica(),this.saveManager.addListener("quota-error",e=>{console.warn("[SaveManager] Error de cuota detectado:",e);const t=Math.ceil(e.resetIn/6e4);this.mostrarError(`Se ha alcanzado el l√≠mite de operaciones. Los cambios se guardar√°n autom√°ticamente en ${t} minuto(s).`)}),this.saveManager.addListener("save-failed",e=>{console.error("[SaveManager] Fallo al guardar despu√©s de m√∫ltiples intentos:",e),this.mostrarError("No se pudieron guardar algunos cambios. Por favor, recarga la p√°gina e intenta de nuevo.")}),window.addEventListener("beforeunload",this.handleBeforeUnload),this.cargarMedidasConfiguracion(),await D["a"].init(),window.addEventListener("online",this.syncOffline),navigator.onLine&&await this.syncOffline();const e=this.$route.params.id;if(!navigator.onLine){let a=!1;if(e&&"nuevo"!==e)a=await this.cargarEmbarqueOffline(e);else{const e=await D["a"].getAll();e.length>0&&(this.aplicarSnapshotOffline(e[0]),a=!0)}if(!a){const e=localStorage.getItem("embarque");if(e)try{this.embarque=JSON.parse(e);const t=localStorage.getItem("clienteCrudos");t&&(this.clienteCrudos=JSON.parse(t)),a=!0}catch(t){console.warn("[NuevoEmbarque] Error al restaurar embarque desde localStorage:",t)}}if(a)return this.undoStack.push(JSON.stringify(this.embarque)),this.actualizarMedidasUsadas(),await this.cargarClientesPersonalizados(),this.guardadoAutomaticoActivo=!0,void await this.cargarPreciosActuales();console.warn("[NuevoEmbarque] No se encontraron datos offline para el embarque solicitado.")}await this.cargarEmbarque(e),this.undoStack.push(JSON.stringify(this.embarque)),this.actualizarMedidasUsadas(),await this.cargarClientesPersonalizados(),await this.iniciarPresenciaUsuario(),this.escucharUsuariosActivos(),await this.cargarPreciosActuales()},async beforeRouteLeave(e,t,a){if(this.saveManager&&this.embarqueId&&this.guardadoAutomaticoActivo){const e=this.saveManager.getStatus();if(e.pendingOperations>0){console.log("[NuevoEmbarque] Guardando cambios pendientes antes de cambiar de ruta...");try{this.mostrarMensaje("Guardando cambios antes de salir..."),await this.saveManager.forceProcessAll(),console.log("[NuevoEmbarque] Cambios guardados exitosamente"),a()}catch(o){console.error("[NuevoEmbarque] Error al guardar cambios:",o);const e=confirm("Hay cambios pendientes de guardar. ¬øDeseas salir sin guardar?");e?a():a(!1)}}else a()}else a()},beforeDestroy(){if(this.saveManager&&this.embarqueId&&this.guardadoAutomaticoActivo){const e=this.saveManager.getStatus();e.pendingOperations>0&&(console.log("[NuevoEmbarque] Forzando guardado antes de destruir componente"),this.saveManager.forceProcessAll().catch(e=>{console.error("[NuevoEmbarque] Error al forzar guardado en destrucci√≥n:",e)}))}this.unsubscribe&&this.unsubscribe(),this.debouncedSave&&this.debouncedSave.cancel&&this.debouncedSave.cancel(),this.saveManager&&(this.saveManager=null);const e=document.querySelectorAll(".crudo input, .crudo select");e.forEach(e=>{e.removeEventListener("input",this.actualizarCrudos)}),this.unsubscribeUsuarios&&(console.log("Limpiando escucha de usuarios activos"),this.unsubscribeUsuarios()),window.removeEventListener("beforeunload",this.handleBeforeUnload),window.removeEventListener("online",this.syncOffline)},updated(){}},$=_,z=(a("a9cc"),a("2877")),T=Object(z["a"])($,o,i,!1,null,"7eded700",null);t["a"]=T.exports}}]);