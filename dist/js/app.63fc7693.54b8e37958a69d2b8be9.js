(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app.63fc7693"],{"015b":function(e,a,o){},"0a04":function(e,a,o){},"586e":function(e,a,o){"use strict";var t=function(){var e=this,a=e._self._c;return a("div",{staticClass:"gestion-costos-container"},[a("div",{staticClass:"header-container"},[a("button",{staticClass:"btn-volver",on:{click:e.volverAEmbarque}},[a("i",{staticClass:"fas fa-arrow-left"}),e._v(" Volver al Embarque ")]),a("button",{staticClass:"btn-rendimientos",on:{click:e.volverARendimientos}},[a("i",{staticClass:"fas fa-chart-line"}),e._v(" Volver a Rendimientos ")]),a("h2",[e._v("Gesti√≥n de Costos")]),a("button",{staticClass:"btn-nuevo-costo",on:{click:e.abrirModalNuevoCosto}},[a("i",{staticClass:"fas fa-plus"}),e._v(" Nueva Medida ")])]),a("div",{staticClass:"costos-section"},[a("h3",[e._v("Medidas Registradas")]),a("div",{staticClass:"costos-grid"},e._l(e.costosRegistrados,(function(o,t){return a("div",{key:t,staticClass:"costo-card"},[a("div",{staticClass:"costo-header"},[a("h4",[e._v(e._s(t))]),a("div",{staticClass:"costo-actions"},[a("button",{staticClass:"btn-historial",on:{click:function(a){return e.verHistorial(t)}}},[a("i",{staticClass:"fas fa-history"})]),a("button",{staticClass:"btn-eliminar",attrs:{title:`Eliminar medida ${t} completamente`},on:{click:function(a){return e.eliminarMedida(t)}}},[a("i",{staticClass:"fas fa-trash"})])])]),a("div",{staticClass:"costo-info"},[a("p",[a("strong",[e._v("Costo Actual:")]),e._v(" $"+e._s(o.costoBase.toFixed(2)))]),a("p",[a("strong",[e._v("√öltima Actualizaci√≥n:")]),e._v(" "+e._s(e.formatearFecha(o.fecha)))]),a("button",{staticClass:"btn-editar-costo",on:{click:function(a){return e.editarCosto(t)}}},[a("i",{staticClass:"fas fa-edit"}),e._v(" Editar Costo ")])])])})),0)]),e.embarqueData?a("div",{staticClass:"medidas-embarque-section"},[a("div",{staticClass:"seccion-header"},[a("h3",[e._v("Medidas del Embarque Actual")]),a("button",{staticClass:"btn-sincronizar",attrs:{title:"Sincronizar costos con los valores m√°s recientes"},on:{click:e.sincronizarCostos}},[a("i",{staticClass:"fas fa-sync-alt"}),e._v(" Sincronizar Costos ")]),a("button",{staticClass:"btn-crear-medidas",attrs:{title:"Crear medidas faltantes"},on:{click:e.sugerirCrearMedidasFaltantes}},[a("i",{staticClass:"fas fa-plus-circle"}),e._v(" Crear Medidas Faltantes ")])]),a("div",{staticClass:"costo-extra-section"},[a("label",{attrs:{for:"costoExtra"}},[e._v("Costo Extra:")]),a("input",{directives:[{name:"model",rawName:"v-model",value:e.costoExtra,expression:"costoExtra"}],staticClass:"input-costo-extra",attrs:{type:"number",id:"costoExtra",min:"0",step:"0.01",placeholder:"18"},domProps:{value:e.costoExtra},on:{input:[function(a){a.target.composing||(e.costoExtra=a.target.value)},e.guardarCostoExtraDebounced]}}),a("span",{staticClass:"input-help"},[e._v("Se suma al c√°lculo del costo final")])]),a("div",{staticClass:"medidas-grid"},e._l(e.medidasVisibles,(function(o){return a("div",{key:`${o}-${e.costosEmbarque[o]||"global"}`,staticClass:"medida-card"},[a("div",{staticClass:"medida-header"},[a("h4",[e._v(e._s(o))]),a("div",{staticClass:"medida-actions"},[a("label",{staticClass:"checkbox-container"},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.medidaSeleccionada[o],expression:"medidaSeleccionada[medida]"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(e.medidaSeleccionada[o])?e._i(e.medidaSeleccionada[o],null)>-1:e.medidaSeleccionada[o]},on:{change:[function(a){var t=e.medidaSeleccionada[o],r=a.target,s=!!r.checked;if(Array.isArray(t)){var i=null,d=e._i(t,i);r.checked?d<0&&e.$set(e.medidaSeleccionada,o,t.concat([i])):d>-1&&e.$set(e.medidaSeleccionada,o,t.slice(0,d).concat(t.slice(d+1)))}else e.$set(e.medidaSeleccionada,o,s)},e.guardarSeleccionMedidas]}}),a("span",{staticClass:"checkmark"}),e._v(" Mostrar en PDF ")]),a("label",{staticClass:"checkbox-container"},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.aplicarCostoExtra[o],expression:"aplicarCostoExtra[medida]"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(e.aplicarCostoExtra[o])?e._i(e.aplicarCostoExtra[o],null)>-1:e.aplicarCostoExtra[o]},on:{change:[function(a){var t=e.aplicarCostoExtra[o],r=a.target,s=!!r.checked;if(Array.isArray(t)){var i=null,d=e._i(t,i);r.checked?d<0&&e.$set(e.aplicarCostoExtra,o,t.concat([i])):d>-1&&e.$set(e.aplicarCostoExtra,o,t.slice(0,d).concat(t.slice(d+1)))}else e.$set(e.aplicarCostoExtra,o,s)},e.guardarConfiguracionCostoExtra]}}),a("span",{staticClass:"checkmark"}),e._v(" Aplicar costo extra ")])])]),a("div",{staticClass:"medida-info"},[a("div",{staticClass:"costo-container"},[a("div",{staticClass:"costo-valor"},[a("div",{staticClass:"costo-display",class:{clickeable:!0,"costo-especifico":e.costosEmbarque[o]},on:{click:function(a){return e.editarCostoEmbarque(o)}}},[a("strong",[e._v("Costo:")]),a("span",{staticClass:"costo-amount"},[e._v("$"+e._s(e.costosActuales[o]||"0.00"))]),e.costosEmbarque[o]?a("span",{staticClass:"badge-especifico"},[e._v("Espec√≠fico")]):e._e(),a("i",{staticClass:"fas fa-edit costo-edit-icon"})]),a("div",{staticClass:"costo-origen"},[e.costosEmbarque[o]?a("span",{staticClass:"costo-especifico"},[a("i",{staticClass:"fas fa-ship"}),e._v(" Costo espec√≠fico del embarque "),a("button",{staticClass:"btn-limpiar-costo",attrs:{title:"Volver al costo global"},on:{click:function(a){return a.stopPropagation(),e.limpiarCostoEspecifico(o)}}},[a("i",{staticClass:"fas fa-times"})])]):e.encontrarCostoParaMedida(o)?a("span",{staticClass:"costo-global"},[a("i",{staticClass:"fas fa-globe"}),e._v(" Costo global ("+e._s(e.encontrarCostoParaMedida(o).medidaEncontrada)+") ")]):a("span",{staticClass:"sin-costo"},[a("i",{staticClass:"fas fa-exclamation-triangle"}),e._v(" Sin costo asignado ")])])]),(e.costosEmbarque[o]||e.encontrarCostoParaMedida(o))&&e.rendimientos[o]?a("div",{staticClass:"costo-calculado"},[a("strong",[e._v("Costo Final: $"+e._s(e.calcularCostoFinal(o)))]),e.aplicarCostoExtra[o]?a("span",{staticClass:"costo-extra-indicator"},[e._v(" (+ $"+e._s(e.costoExtra)+" extra) ")]):e._e()]):e._e()]),e.rendimientos[o]?a("p",[a("strong",[e._v("Rendimiento:")]),e._v(" "+e._s(e.rendimientos[o].toFixed(2))+" ")]):e._e()])])})),0)]):e._e(),a("MedidaModal",{attrs:{mostrar:e.mostrarModalNuevaMedida,medida:e.nuevaMedida.nombre},on:{cerrar:e.cerrarModalNuevaMedida,guardar:e.siguienteNuevaMedida}}),a("CostoModal",{attrs:{mostrar:e.mostrarModalNuevoCosto,costo:e.nuevaMedida.costo,medida:e.nuevaMedida.nombre,esNuevo:!0},on:{cerrar:e.cerrarModalNuevoCosto,guardar:e.guardarNuevoCosto}}),a("CostoModal",{attrs:{mostrar:e.mostrarModalEditarCosto,costo:e.costoEditando.costo,medida:e.costoEditando.medida,esNuevo:!1,costoAnterior:e.costoEditando.costoAnterior,fechaUltimaActualizacion:e.costoEditando.fechaUltimaActualizacion,fecha:e.costoEditando.fecha},on:{cerrar:e.cerrarModalEditarCosto,guardar:e.guardarCostoEditado}}),a("CostoModal",{attrs:{mostrar:e.mostrarModalCostoEmbarque,costo:e.costoEmbarqueEditando.costo,medida:e.costoEmbarqueEditando.medida,esNuevo:!1,esCostoEmbarque:!0},on:{cerrar:e.cerrarModalCostoEmbarque,guardar:e.guardarCostoEmbarque}}),e.mostrarModalHistorial?a("div",{staticClass:"modal-overlay"},[a("div",{staticClass:"modal-content modal-historial"},[a("h3",[e._v("Historial de Costos - "+e._s(e.medidaSeleccionadaHistorial))]),a("div",{staticClass:"historial-container"},[e.cargandoHistorial?a("div",{staticClass:"loading-historial"},[e._m(0)]):0===e.historialCostos.length?a("div",{staticClass:"no-historial"},[a("p",[e._v("No hay historial de costos para esta medida.")])]):a("div",{staticClass:"historial-list"},e._l(e.historialCostos,(function(o){return a("div",{key:o.id,staticClass:"historial-item",class:{eliminado:o.eliminado,restaurado:o.restaurado,medidaEliminada:o.medidaEliminada,nuevo:o.nuevo}},[a("div",{staticClass:"historial-info"},[a("div",{staticClass:"historial-costo"},[a("strong",[e._v("$"+e._s(o.costoBase.toFixed(2)))]),o.eliminado?a("span",{staticClass:"estado-badge eliminado"},[e._v("Eliminado")]):e._e(),o.restaurado?a("span",{staticClass:"estado-badge restaurado"},[e._v("Restaurado")]):e._e(),o.medidaEliminada?a("span",{staticClass:"estado-badge medida-eliminada"},[e._v("Medida Eliminada")]):e._e(),o.nuevo?a("span",{staticClass:"estado-badge nuevo"},[e._v("Nueva Medida")]):e._e()]),a("div",{staticClass:"historial-fecha"},[e._v(" "+e._s(e.formatearFechaCompleta(o.fecha))+" ")]),o.observacion?a("div",{staticClass:"historial-observacion"},[a("em",[e._v(e._s(o.observacion))])]):e._e()]),a("div",{staticClass:"historial-actions"},[a("button",{staticClass:"btn-eliminar-entrada",attrs:{title:"Eliminar esta entrada del historial"},on:{click:function(a){return e.eliminarEntradaHistorial(o)}}},[a("i",{staticClass:"fas fa-times"})])])])})),0)]),a("div",{staticClass:"modal-buttons"},[a("button",{staticClass:"btn-cancelar",on:{click:e.cerrarModalHistorial}},[e._v("Cerrar")])])])]):e._e()],1)},r=[function(){var e=this,a=e._self._c;return a("p",[a("i",{staticClass:"fas fa-spinner fa-spin"}),e._v(" Cargando historial...")])}],s=(o("14d9"),o("13d5"),o("88e6"),o("70cc"),o("eb03"),o("22e5c"),o("c01e"),o("fa76"),o("8306"),o("1494")),i=o("2ef0"),d=o("7b75"),c=o("0d65"),n={name:"GestionCostos",components:{CostoModal:d["a"],MedidaModal:c["a"]},data(){return{embarqueData:null,medidasEmbarque:[],costosRegistrados:{},costosRegistradosPorFecha:{},costosEmbarque:{},medidaSeleccionada:{},medidaOculta:{},aplicarCostoExtra:{},rendimientos:{},costoExtra:18,mostrarModalNuevaMedida:!1,mostrarModalNuevoCosto:!1,mostrarModalEditarCosto:!1,mostrarModalCostoEmbarque:!1,mostrarModalHistorial:!1,medidaSeleccionadaHistorial:"",historialCostos:[],cargandoHistorial:!1,nuevaMedida:{nombre:"",costo:0},costoEditando:{medida:"",costo:0,costoAnterior:null,fechaUltimaActualizacion:"",fecha:""},costoEmbarqueEditando:{medida:"",costo:0},unsubscribePreciosGlobales:null,guardarCostoExtraDebounced:null}},async created(){console.log("[GestionCostos] Componente creado, iniciando carga..."),await this.cargarEmbarque(),await this.iniciarEscuchaPreciosGlobales(),this.guardarCostoExtraDebounced=Object(i["debounce"])(this.guardarCostoExtra,500),console.log("[GestionCostos] Inicializaci√≥n completa")},methods:{async cargarEmbarque(){try{console.log("[GestionCostos] Cargando embarque...");const e=Object(s["h"])(),a=this.$route.params.id;console.log("[GestionCostos] ID del embarque:",a);const o=Object(s["e"])(e,"embarques",a),t=await Object(s["f"])(o);t.exists()&&(this.embarqueData=t.data(),console.log("[GestionCostos] Embarque cargado:",this.embarqueData),this.embarqueData.fecha||(this.embarqueData.fecha=(new Date).toISOString().split("T")[0],await Object(s["s"])(o,{fecha:this.embarqueData.fecha})),this.obtenerMedidasEmbarque(),this.medidaSeleccionada=this.embarqueData.medidaSeleccionada||{},this.medidaOculta=this.embarqueData.medidaOculta||{},this.aplicarCostoExtra=this.embarqueData.aplicarCostoExtra||{},this.costosEmbarque=this.embarqueData.costosPorMedida||{},this.costoExtra=this.embarqueData.costoExtra||18,this.calcularRendimientos(),await this.inicializarConfiguracionCostoExtra(),await this.aplicarCostosRegistrados())}catch(e){console.error("Error al cargar el embarque:",e)}},obtenerMedidasEmbarque(){if(!this.embarqueData||!this.embarqueData.clientes)return;const e=new Set;this.embarqueData.clientes.forEach(a=>{a.productos.forEach(o=>{if(o.medida){let t=o.medida;"Ozuna"!==a.nombre||o.esVenta||(t=o.medida+" Maquila Ozuna"),e.add(t)}}),a.crudos&&Array.isArray(a.crudos)&&a.crudos.forEach(a=>{a&&a.items&&Array.isArray(a.items)&&a.items.forEach(a=>{a.talla&&e.add(a.talla)})})}),this.medidasEmbarque=Array.from(e)},calcularRendimientos(){this.embarqueData&&this.embarqueData.kilosCrudos&&this.medidasEmbarque.forEach(e=>{const a=this.obtenerTotalEmbarcado(e);if(a>0){let o;const t=this.embarqueData.kilosCrudos[e];o=this.esMedidaMix(e)&&t?Number(t.medida1||0)+Number(t.medida2||0):Number(t||0),this.$set(this.rendimientos,e,o/a)}})},obtenerTotalEmbarcado(e){if(!this.embarqueData||!this.embarqueData.clientes)return 0;const a=e.includes("Maquila Ozuna"),o=e.replace(" Maquila Ozuna","").toLowerCase().trim();return this.embarqueData.clientes.reduce((e,t)=>e+t.productos.filter(e=>!!e.medida&&(a?e.medida.toLowerCase().trim()===o&&"Ozuna"===t.nombre&&!e.esVenta:e.medida.toLowerCase().trim()===o&&("Ozuna"!==t.nombre||e.esVenta))).reduce((e,a)=>{if("c/h20"===a.tipo){const o=this.calcularTotalBolsas(a),t=parseFloat(a.camaronNeto)||.65;return e+o*t}{const o=a.kilos.reduce((e,a)=>e+(Number(a)||0),0),t=this.calcularTotalTaras(a),r=a.restarTaras?3*t:0;return e+(o-r)}},0),0)},calcularTotalTaras(e){const a=(e.taras||[]).reduce((e,a)=>e+(Number(a)||0),0),o=(e.tarasExtra||[]).reduce((e,a)=>e+(Number(a)||0),0);return a+o},calcularTotalBolsas(e){const a=e.reporteTaras||[],o=e.reporteBolsas||[];let t=0;for(let r=0;r<a.length;r++){const e=parseInt(a[r])||0,s=parseInt(o[r])||0;t+=e*s}return t},esMedidaMix(e){return e.toLowerCase().includes("mix")},calcularCostoFinal(e){let a=0;if(this.costosEmbarque[e])a=Number(this.costosEmbarque[e]);else{const o=this.encontrarCostoParaMedida(e);o&&(a=Number(o.costo))}const o=Number(this.rendimientos[e])||0,t=Math.round(100*o)/100,r=Number(this.costoExtra)||18,s=this.aplicarCostoExtra[e]||!1;let i;return i=s?Math.round(a*t+r):Math.round(a*t),i.toFixed(1)},async iniciarEscuchaPreciosGlobales(){try{const e=Object(s["h"])(),a=Object(s["c"])(e,"historial_costos");console.log("[GestionCostos] Iniciando escucha de precios globales..."),this.unsubscribePreciosGlobales=Object(s["k"])(a,e=>{var a;console.log("[GestionCostos] Snapshot recibido, documentos:",e.size);const o=[];e.forEach(e=>{const a=e.data();console.log("[GestionCostos] Documento encontrado:",e.id,a),o.push({...a,id:e.id})});const t=e=>{try{return e?e.toDate&&"function"===typeof e.toDate?e.toDate():e.seconds?new Date(1e3*e.seconds):"string"===typeof e?new Date(e):e instanceof Date?e:new Date(e):null}catch{return null}};o.sort((e,a)=>{const o=t(e.fecha)||t(e.timestamp)||new Date(0),r=t(a.fecha)||t(a.timestamp)||new Date(0);return r-o});const r=(null===(a=this.embarqueData)||void 0===a?void 0:a.fecha)||new Date,s=t(r)||new Date;s.setHours(12,0,0,0);const i={},d={},c=new Set,n=new Set;o.forEach(e=>{if(e.eliminado||e.medidaEliminada)return;const a=t(e.fecha)||t(e.timestamp)||new Date(0);a.setHours(12,0,0,0),c.has(e.medida)||(i[e.medida]={costoBase:e.costoBase,fecha:e.fecha,timestamp:e.timestamp,id:e.id},c.add(e.medida)),!n.has(e.medida)&&a<=s&&(d[e.medida]={costoBase:e.costoBase,fecha:e.fecha,timestamp:e.timestamp,id:e.id},n.add(e.medida))});const l=(e,a)=>{Object.keys(e).forEach(o=>{a[o]||this.$delete(e,o)}),Object.keys(a).forEach(o=>{this.$set(e,o,a[o])})};l(this.costosRegistrados,i),l(this.costosRegistradosPorFecha,d),console.log("[GestionCostos] Costos globales actualizados:",this.costosRegistrados),console.log("[GestionCostos] Costos v√°lidos para el embarque:",this.costosRegistradosPorFecha),this.embarqueData&&this.aplicarCostosRegistrados().catch(e=>{console.error("Error al aplicar costos registrados:",e)})})}catch(e){console.error("Error al iniciar escucha de historial:",e)}},abrirModalNuevoCosto(){this.mostrarModalNuevaMedida=!0,this.nuevaMedida={nombre:"",costo:0}},cerrarModalNuevaMedida(){this.mostrarModalNuevaMedida=!1,this.nuevaMedida={nombre:"",costo:0}},siguienteNuevaMedida(e){this.nuevaMedida.nombre=e,this.mostrarModalNuevaMedida=!1,this.mostrarModalNuevoCosto=!0},cerrarModalNuevoCosto(){this.mostrarModalNuevoCosto=!1,this.nuevaMedida={nombre:"",costo:0}},async guardarNuevoCosto(e){if(this.nuevaMedida.nombre.trim())try{const a=Object(s["h"])(),o=new Date(e.fecha);o.setHours(12,0,0,0),await Object(s["b"])(Object(s["c"])(a,"historial_costos"),{medida:this.nuevaMedida.nombre,costoBase:Number(e.costo||0),timestamp:o,fecha:e.fecha,nuevo:!0}),this.cerrarModalNuevoCosto(),console.log("Nuevo costo guardado correctamente")}catch(a){console.error("Error al guardar el nuevo costo:",a),alert("Error al guardar el costo")}else alert("Por favor ingrese el nombre de la medida")},editarCosto(e){const a=this.costosRegistrados[e];this.costoEditando={medida:e,costo:a.costoBase,costoAnterior:a.costoBase,fechaUltimaActualizacion:this.formatearFecha(a.fecha),fecha:this.obtenerFechaParaInput(a.fecha)},this.mostrarModalEditarCosto=!0},cerrarModalEditarCosto(){this.mostrarModalEditarCosto=!1,this.costoEditando={medida:"",costo:0,costoAnterior:null,fechaUltimaActualizacion:"",fecha:""}},async guardarCostoEditado(e){try{const a=Object(s["h"])(),o=this.costoEditando.medida;if(!e.fecha)return void alert("Por favor selecciona una fecha v√°lida");const t=new Date(e.fecha);t.setHours(12,0,0,0),await Object(s["b"])(Object(s["c"])(a,"historial_costos"),{medida:o,costoBase:Number(e.costo),fecha:e.fecha,timestamp:t}),this.cerrarModalEditarCosto(),console.log("Costo actualizado correctamente")}catch(a){console.error("Error al actualizar el costo:",a),alert("Error al actualizar el costo")}},async eliminarMedida(e){if(confirm(`¬øEst√° seguro de eliminar completamente la medida "${e}" y todo su historial?`))try{const a=Object(s["h"])();this.$delete(this.costosRegistrados,e),this.$delete(this.costosRegistradosPorFecha,e);const o=Object(s["c"])(a,"historial_costos"),t=Object(s["o"])(o,Object(s["t"])("medida","==",e)),r=await Object(s["g"])(t),i=r.docs.map(e=>Object(s["d"])(e.ref));await Promise.all(i),console.log(`Medida "${e}" y todo su historial eliminados correctamente`)}catch(a){console.error("Error al eliminar la medida:",a),alert("Error al eliminar la medida")}},async eliminarEntradaHistorial(e){if(confirm(`¬øEst√° seguro de eliminar esta entrada del historial ($${e.costoBase.toFixed(2)} - ${this.formatearFecha(e.fecha)})?`))try{const a=Object(s["h"])();await Object(s["d"])(Object(s["e"])(a,"historial_costos",e.id)),this.historialCostos=this.historialCostos.filter(a=>a.id!==e.id),console.log("Entrada del historial eliminada correctamente")}catch(a){console.error("Error al eliminar entrada del historial:",a),alert("Error al eliminar la entrada del historial")}},editarCostoEmbarque(e){let a=0;if(this.costosEmbarque[e])a=this.costosEmbarque[e];else{const o=this.encontrarCostoParaMedida(e);o&&(a=o.costo)}this.costoEmbarqueEditando={medida:e,costo:a},this.mostrarModalCostoEmbarque=!0},cerrarModalCostoEmbarque(){this.mostrarModalCostoEmbarque=!1,this.costoEmbarqueEditando={medida:"",costo:0}},async guardarCostoEmbarque(e){try{const a=Object(s["h"])(),o=this.$route.params.id,t=Object(s["e"])(a,"embarques",o),r=this.costoEmbarqueEditando.medida;null!==e?(this.$set(this.costosEmbarque,r,Number(e)),console.log(`Costo espec√≠fico establecido para ${r}: ${this.costosEmbarque[r]}`)):(this.$delete(this.costosEmbarque,r),console.log("Costo espec√≠fico eliminado para "+r)),await Object(s["s"])(t,{costosPorMedida:this.costosEmbarque}),this.cerrarModalCostoEmbarque(),console.log("Costo del embarque actualizado correctamente")}catch(a){console.error("Error al actualizar el costo del embarque:",a),alert("Error al actualizar el costo del embarque")}},async limpiarCostoEspecifico(e){if(confirm(`¬øVolver al costo global para "${e}"?`))try{const a=Object(s["h"])(),o=this.$route.params.id,t=Object(s["e"])(a,"embarques",o);this.$delete(this.costosEmbarque,e),await Object(s["s"])(t,{costosPorMedida:this.costosEmbarque}),console.log(`Costo espec√≠fico eliminado para ${e}, volviendo al costo global`)}catch(a){console.error("Error al eliminar el costo espec√≠fico:",a),alert("Error al eliminar el costo espec√≠fico")}},async guardarSeleccionMedidas(){try{const e=Object(s["h"])(),a=this.$route.params.id,o=Object(s["e"])(e,"embarques",a);await Object(s["s"])(o,{medidaSeleccionada:this.medidaSeleccionada}),console.log("Selecci√≥n de medidas guardada correctamente")}catch(e){console.error("Error al guardar la selecci√≥n de medidas:",e)}},async guardarConfiguracionCostoExtra(){try{const e=Object(s["h"])(),a=this.$route.params.id,o=Object(s["e"])(e,"embarques",a);await Object(s["s"])(o,{aplicarCostoExtra:this.aplicarCostoExtra}),console.log("Configuraci√≥n de costo extra guardada correctamente")}catch(e){console.error("Error al guardar la configuraci√≥n de costo extra:",e)}},async guardarCostoExtra(){try{const e=Object(s["h"])(),a=this.$route.params.id,o=Object(s["e"])(e,"embarques",a);await Object(s["s"])(o,{costoExtra:Number(this.costoExtra)||18}),console.log("Costo extra guardado correctamente")}catch(e){console.error("Error al guardar el costo extra:",e)}},volverAEmbarque(){this.$router.push({name:"EditarEmbarque",params:{id:this.$route.params.id}})},volverARendimientos(){this.$router.push({name:"Rendimientos",params:{id:this.$route.params.id}})},async inicializarConfiguracionCostoExtra(){if(Object.keys(this.aplicarCostoExtra).length>0)return;let e=!1;this.medidasEmbarque.forEach(a=>{const o=a.includes("Maquila Ozuna"),t=/^\d+\/\d+/.test(a.trim())||/^\d+\s/.test(a.trim())||/^\d+$/.test(a.trim());!o&&t?(this.$set(this.aplicarCostoExtra,a,!0),e=!0):this.$set(this.aplicarCostoExtra,a,!1)}),e&&await this.guardarConfiguracionCostoExtra()},normalizarMedida(e){return e?e.toLowerCase().trim().replace(/\s+/g," ").replace(/\s*\/\s*/g,"/").replace(/\s*-\s*/g,"-"):""},encontrarCostoParaMedida(e,a={}){if(!e)return null;const{incluirCostosFuturos:o=!1}=a,t=[{etiqueta:"v√°lidos para embarque",mapa:this.costosRegistradosPorFecha}];o&&t.push({etiqueta:"globales",mapa:this.costosRegistrados});const r=({etiqueta:a,mapa:o})=>{if(!o||0===Object.keys(o).length)return null;if(console.log(`üîç Buscando costo (${a}) para: "${e}"`),console.log(`üìã Medidas disponibles (${a}):`,Object.keys(o)),o[e])return console.log(`‚úì Coincidencia exacta encontrada (${a}): "${e}"`),{medidaEncontrada:e,costo:o[e].costoBase};if(e.includes("Maquila Ozuna")){const t=e.replace(" Maquila Ozuna","").trim();if(console.log(`üîç Buscando medida base sin "Maquila Ozuna": "${t}"`),o[t])return console.log(`‚úì Encontrado costo para medida base (${a}): "${t}"`),{medidaEncontrada:t,costo:o[t].costoBase}}const t=this.normalizarMedida(e);console.log(`üîç Medida normalizada (${a}): "${t}"`);for(const[e,s]of Object.entries(o)){const o=this.normalizarMedida(e);if(t===o)return console.log(`‚úì Coincidencia normalizada encontrada (${a}): "${e}"`),{medidaEncontrada:e,costo:s.costoBase}}const r=t.replace(/\s+maquila\s+ozuna/g,"").replace(/\s+c\/c/g,"").trim();console.log(`üîç Buscando coincidencias parciales (${a}) para: "${r}"`);for(const[e,s]of Object.entries(o)){const o=this.normalizarMedida(e);if(r.includes(o)&&o.length>2)return console.log(`‚úì Coincidencia parcial encontrada (${a}, registrada contenida en embarque): "${e}"`),{medidaEncontrada:e,costo:s.costoBase};if(o.includes(r)&&r.length>2)return console.log(`‚úì Coincidencia parcial encontrada (${a}, embarque contenido en registrada): "${e}"`),{medidaEncontrada:e,costo:s.costoBase}}return null};for(const s of t){const e=r(s);if(e)return e}return console.log(`‚úó No se encontr√≥ coincidencia para: "${e}"`),null},async sugerirCrearMedidasFaltantes(){const e=[],a=new Set;if(this.medidasEmbarque.forEach(o=>{if(!this.costosEmbarque[o]&&!this.encontrarCostoParaMedida(o))if(e.push(o),o.includes("Maquila Ozuna")){const e=o.replace(" Maquila Ozuna","").trim();a.add(e)}else a.add(o)}),e.length>0){console.log("üìù Medidas sin costo encontradas: "+e.join(", "));const o=Array.from(a),t=`Se encontraron ${e.length} medidas sin costo asignado:\n\n${e.map(e=>"‚Ä¢ "+e).join("\n")}\n\nSe crear√°n ${o.length} medidas base:\n\n${o.map(e=>"‚Ä¢ "+e).join("\n")}\n\n¬øDesea crear estas medidas con un costo base de $130?\n\n(Podr√° editarlas despu√©s individualmente si es necesario)`;confirm(t)&&await this.crearMedidasFaltantes(o)}else alert("Todas las medidas ya tienen costos asignados.")},async crearMedidasFaltantes(e){try{const a=Object(s["h"])(),o=new Date;o.setHours(12,0,0,0);const t=o.toISOString().split("T")[0],r=e.map(e=>Object(s["b"])(Object(s["c"])(a,"historial_costos"),{medida:e,costoBase:130,timestamp:o,fecha:t,nuevo:!0}));await Promise.all(r),console.log(`‚úì Se crearon ${e.length} medidas faltantes`),alert(`Se crearon ${e.length} medidas con costo base de $130`)}catch(a){console.error("Error al crear medidas faltantes:",a),alert("Error al crear las medidas faltantes")}},async aplicarCostosRegistrados(){let e=!1;if(console.log("Medidas del embarque:",this.medidasEmbarque),console.log("Costos v√°lidos para embarque disponibles:",Object.keys(this.costosRegistradosPorFecha)),this.medidasEmbarque.forEach(a=>{const o=this.encontrarCostoParaMedida(a);if(o){const t=o.costo,r=this.costosEmbarque[a];r?console.log(`‚Üí Manteniendo costo espec√≠fico de ${a}: ${r} (no se sobrescribe con costo global: ${t})`):(this.$set(this.costosEmbarque,a,t),e=!0,console.log(`‚úì Aplicando costo global de ${a}: ${t} (encontrado como: ${o.medidaEncontrada})`))}else console.log("‚úó No se encontr√≥ costo para la medida: "+a)}),e)try{const e=Object(s["h"])(),a=this.$route.params.id,o=Object(s["e"])(e,"embarques",a);await Object(s["s"])(o,{costosPorMedida:this.costosEmbarque}),console.log("Costos sincronizados correctamente")}catch(a){console.error("Error al guardar costos aplicados:",a)}},async verHistorial(e){this.medidaSeleccionadaHistorial=e,this.mostrarModalHistorial=!0,this.cargandoHistorial=!0;try{const a=Object(s["h"])(),o=Object(s["c"])(a,"historial_costos"),t=Object(s["o"])(o,Object(s["t"])("medida","==",e)),r=await Object(s["g"])(t),i=r.docs.map(e=>({id:e.id,...e.data()}));this.historialCostos=i.sort((e,a)=>{var o,t,r,s;const i=(null===(o=e.timestamp)||void 0===o||null===(t=o.toDate)||void 0===t?void 0:t.call(o))||new Date(e.timestamp),d=(null===(r=a.timestamp)||void 0===r||null===(s=r.toDate)||void 0===s?void 0:s.call(r))||new Date(a.timestamp);return d-i})}catch(a){console.error("Error al cargar historial:",a),this.historialCostos=[]}finally{this.cargandoHistorial=!1}},cerrarModalHistorial(){this.mostrarModalHistorial=!1,this.medidaSeleccionadaHistorial="",this.historialCostos=[],this.cargandoHistorial=!1},async sincronizarCostos(){try{await this.sincronizarCostosForzado(),alert("Costos sincronizados con los valores m√°s recientes.")}catch(e){console.error("Error al sincronizar costos:",e),alert("Error al sincronizar costos.")}},async sincronizarCostosForzado(){let e=!1;if(this.medidasEmbarque.forEach(a=>{const o=this.encontrarCostoParaMedida(a);if(o){const t=o.costo,r=this.costosEmbarque[a];r&&r===t||(this.$set(this.costosEmbarque,a,t),e=!0,console.log(`‚úì Sincronizaci√≥n forzada - Actualizando costo de ${a}: ${r} -> ${t} (encontrado como: ${o.medidaEncontrada})`))}else console.log("‚úó No se encontr√≥ costo para sincronizar: "+a)}),e)try{const e=Object(s["h"])(),a=this.$route.params.id,o=Object(s["e"])(e,"embarques",a);await Object(s["s"])(o,{costosPorMedida:this.costosEmbarque}),console.log("Costos sincronizados forzadamente")}catch(a){console.error("Error al guardar costos sincronizados:",a)}},obtenerFechaParaInput(e){try{if(!e)return(new Date).toISOString().split("T")[0];if("string"===typeof e){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;if(/^\d{2}\/\d{2}\/\d{4}$/.test(e)){const[a,o,t]=e.split("/");return`${t}-${o}-${a}`}const a=new Date(e);if(!isNaN(a.getTime()))return a.toISOString().split("T")[0]}let a=e;if(e.toDate&&"function"===typeof e.toDate?a=e.toDate():e.seconds&&(a=new Date(1e3*e.seconds)),a instanceof Date&&!isNaN(a.getTime()))return a.toISOString().split("T")[0]}catch(a){console.error("Error al convertir fecha para input:",a)}return(new Date).toISOString().split("T")[0]},formatearFecha(e){if(!e)return"N/A";try{if("string"===typeof e){const[a,o,t]=e.split("-");return`${t}/${o}/${a}`}if(e.toDate&&"function"===typeof e.toDate?e=e.toDate():e.seconds&&(e=new Date(1e3*e.seconds)),e instanceof Date){const a=e.getDate().toString().padStart(2,"0"),o=(e.getMonth()+1).toString().padStart(2,"0"),t=e.getFullYear();return`${a}/${o}/${t}`}return"Fecha inv√°lida"}catch(a){return console.error("Error al formatear fecha:",a),"Error en fecha"}},formatearFechaCompleta(e){if(!e)return"N/A";try{if("string"===typeof e){const[a,o,t]=e.split("-");return new Date(a,o-1,t).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}return e.toDate&&"function"===typeof e.toDate?e=e.toDate():e.seconds&&(e=new Date(1e3*e.seconds)),e instanceof Date?e.toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Fecha inv√°lida"}catch(a){return console.error("Error al formatear fecha completa:",a),"Error en fecha"}}},computed:{medidasVisibles(){return this.medidasEmbarque.filter(e=>!this.medidaOculta[e])},costosActuales(){const e={};return this.medidasEmbarque.forEach(a=>{if(this.costosEmbarque[a])e[a]=Number(this.costosEmbarque[a]).toFixed(2);else{const o=this.encontrarCostoParaMedida(a);e[a]=o?Number(o.costo).toFixed(2):"0.00"}}),e}},beforeDestroy(){this.unsubscribePreciosGlobales&&this.unsubscribePreciosGlobales(),this.guardarCostoExtraDebounced&&this.guardarCostoExtraDebounced.cancel&&this.guardarCostoExtraDebounced.cancel()}},l=n,m=(o("aa5b"),o("2877")),u=Object(m["a"])(l,t,r,!1,null,"2fd2c46a",null);a["a"]=u.exports},7508:function(e,a,o){"use strict";var t=function(){var e=this,a=e._self._c;return a("div",{staticClass:"gestion-proveedores-container"},[a("button",{staticClass:"btn-gestion",on:{click:e.mostrarModal}},[a("i",{staticClass:"fas fa-cogs"}),e._v(" Gesti√≥n de Proveedores ")]),a("b-modal",{attrs:{title:"Gesti√≥n de Proveedores",size:"lg","hide-footer":!0},on:{show:e.cargarProveedores},model:{value:e.showModal,callback:function(a){e.showModal=a},expression:"showModal"}},[a("div",{staticClass:"modal-content-custom"},[a("div",{staticClass:"agregar-proveedor"},[a("h5",[a("i",{staticClass:"fas fa-plus-circle"}),e._v(" Agregar Nuevo Proveedor")]),a("div",{staticClass:"input-group"},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.nuevoProveedor,expression:"nuevoProveedor"}],staticClass:"form-control",attrs:{type:"text",placeholder:"Nombre del proveedor",maxlength:"50"},domProps:{value:e.nuevoProveedor},on:{keyup:function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"enter",13,a.key,"Enter")?null:e.agregarProveedor.apply(null,arguments)},input:function(a){a.target.composing||(e.nuevoProveedor=a.target.value)}}}),a("button",{staticClass:"btn-agregar",attrs:{disabled:!e.nuevoProveedor.trim()},on:{click:e.agregarProveedor}},[a("i",{staticClass:"fas fa-plus"}),e._v(" Agregar ")])])]),a("div",{staticClass:"lista-proveedores"},[a("h5",[a("i",{staticClass:"fas fa-list"}),e._v(" Proveedores Registrados ("+e._s(e.proveedores.length)+")")]),0===e.proveedores.length?a("div",{staticClass:"no-proveedores"},[a("i",{staticClass:"fas fa-inbox"}),a("p",[e._v("No hay proveedores registrados")])]):a("div",{staticClass:"proveedores-grid"},e._l(e.proveedoresOrdenados,(function(o){return a("div",{key:o.id,staticClass:"proveedor-card"},[e.proveedorEditando===o.id?a("div",{staticClass:"proveedor-editando"},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.nombreEditando,expression:"nombreEditando"}],ref:"inputEdit",refInFor:!0,staticClass:"form-control-edit",attrs:{type:"text",maxlength:"50"},domProps:{value:e.nombreEditando},on:{keyup:[function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"enter",13,a.key,"Enter")?null:e.guardarEdicion(o)},function(a){return!a.type.indexOf("key")&&e._k(a.keyCode,"escape",void 0,a.key,void 0)?null:e.cancelarEdicion.apply(null,arguments)}],input:function(a){a.target.composing||(e.nombreEditando=a.target.value)}}}),a("div",{staticClass:"botones-edicion"},[a("button",{staticClass:"btn-guardar",attrs:{disabled:!e.nombreEditando.trim()},on:{click:function(a){return e.guardarEdicion(o)}}},[a("i",{staticClass:"fas fa-check"})]),a("button",{staticClass:"btn-cancelar",on:{click:e.cancelarEdicion}},[a("i",{staticClass:"fas fa-times"})])])]):a("div",{staticClass:"proveedor-info"},[a("span",{staticClass:"proveedor-nombre"},[e._v(e._s(o.nombre))]),a("div",{staticClass:"proveedor-meta"},[a("small",{staticClass:"fecha-creacion"},[e._v(" Creado: "+e._s(e.formatearFecha(o.createdAt))+" ")])]),a("div",{staticClass:"proveedor-acciones"},[a("button",{staticClass:"btn-editar",on:{click:function(a){return e.editarProveedor(o)}}},[a("i",{staticClass:"fas fa-edit"})]),a("button",{staticClass:"btn-eliminar",attrs:{disabled:o.enUso,title:o.enUso?"No se puede eliminar porque est√° en uso":"Eliminar proveedor"},on:{click:function(a){return e.confirmarEliminar(o)}}},[a("i",{staticClass:"fas fa-trash"})])])])])})),0)]),a("div",{staticClass:"modal-footer-custom"},[a("div",{staticClass:"footer-info"},[a("small",{staticClass:"text-muted"},[a("i",{staticClass:"fas fa-info-circle"}),e._v(" Los proveedores en uso no pueden ser eliminados ")])]),a("button",{staticClass:"btn-cerrar",on:{click:e.cerrarModal}},[a("i",{staticClass:"fas fa-times"}),e._v(" Cerrar ")])])])]),a("div",{staticClass:"toast-container"},[e.mensaje.visible?a("div",{class:["toast-mensaje",e.mensaje.tipo]},[a("i",{class:e.mensaje.icono}),e._v(" "+e._s(e.mensaje.texto)+" ")]):e._e()])],1)},r=[],s=(o("14d9"),o("88e6"),o("70cc"),o("eb03"),o("22e5c"),o("c01e"),o("fa76"),o("8306"),o("1494")),i={name:"GestionProveedores",data(){return{showModal:!1,proveedores:[],nuevoProveedor:"",proveedorEditando:null,nombreEditando:"",mensaje:{visible:!1,texto:"",tipo:"",icono:""}}},computed:{proveedoresOrdenados(){return[...this.proveedores].sort((e,a)=>e.nombre.localeCompare(a.nombre,"es",{sensitivity:"base"}))}},methods:{mostrarModal(){this.showModal=!0},cerrarModal(){this.showModal=!1,this.cancelarEdicion(),this.nuevoProveedor=""},async cargarProveedores(){try{const e=Object(s["h"])(),a=Object(s["o"])(Object(s["c"])(e,"proveedores"),Object(s["l"])("nombre")),o=await Object(s["g"])(a);this.proveedores=o.docs.map(e=>({id:e.id,...e.data()})),await this.verificarProveedoresEnUso()}catch(e){console.error("Error al cargar proveedores:",e),this.mostrarMensaje("Error al cargar proveedores","error")}},async verificarProveedoresEnUso(){try{const e=Object(s["h"])(),a=await Object(s["g"])(Object(s["c"])(e,"preparacion")),o=new Set;a.docs.forEach(e=>{const a=e.data();a.medidas&&a.medidas.forEach(e=>{e.proveedor&&o.add(e.proveedor)})}),this.proveedores.forEach(e=>{e.enUso=o.has(e.nombre)})}catch(e){console.error("Error al verificar proveedores en uso:",e)}},async agregarProveedor(){if(!this.nuevoProveedor.trim())return;const e=this.nuevoProveedor.trim();if(this.proveedores.some(a=>a.nombre.toLowerCase()===e.toLowerCase()))this.mostrarMensaje("Este proveedor ya existe","warning");else try{const a=Object(s["h"])(),o=await Object(s["b"])(Object(s["c"])(a,"proveedores"),{nombre:e,createdAt:new Date,updatedAt:new Date});this.proveedores.push({id:o.id,nombre:e,createdAt:new Date,updatedAt:new Date,enUso:!1}),this.nuevoProveedor="",this.mostrarMensaje("Proveedor agregado exitosamente","success"),this.$emit("proveedores-actualizados")}catch(a){console.error("Error al agregar proveedor:",a),this.mostrarMensaje("Error al agregar proveedor","error")}},editarProveedor(e){this.proveedorEditando=e.id,this.nombreEditando=e.nombre,this.$nextTick(()=>{this.$refs.inputEdit&&this.$refs.inputEdit.length>0&&(this.$refs.inputEdit[0].focus(),this.$refs.inputEdit[0].select())})},async guardarEdicion(e){if(!this.nombreEditando.trim())return;const a=this.nombreEditando.trim();if(this.proveedores.some(o=>o.id!==e.id&&o.nombre.toLowerCase()===a.toLowerCase()))this.mostrarMensaje("Ya existe un proveedor con este nombre","warning");else try{const o=Object(s["h"])();await Object(s["s"])(Object(s["e"])(o,"proveedores",e.id),{nombre:a,updatedAt:new Date});const t=this.proveedores.findIndex(a=>a.id===e.id);-1!==t&&(this.proveedores[t].nombre=a,this.proveedores[t].updatedAt=new Date),this.cancelarEdicion(),this.mostrarMensaje("Proveedor actualizado exitosamente","success"),this.$emit("proveedores-actualizados")}catch(o){console.error("Error al actualizar proveedor:",o),this.mostrarMensaje("Error al actualizar proveedor","error")}},cancelarEdicion(){this.proveedorEditando=null,this.nombreEditando=""},async confirmarEliminar(e){if(e.enUso)return void this.mostrarMensaje("No se puede eliminar un proveedor que est√° en uso","warning");const a=await this.$bvModal.msgBoxConfirm(`¬øEst√°s seguro de que deseas eliminar el proveedor "${e.nombre}"?`,{title:"Confirmar eliminaci√≥n",size:"md",buttonSize:"sm",okVariant:"danger",okTitle:"Eliminar",cancelTitle:"Cancelar"});a&&await this.eliminarProveedor(e)},async eliminarProveedor(e){try{const a=Object(s["h"])();await Object(s["d"])(Object(s["e"])(a,"proveedores",e.id)),this.proveedores=this.proveedores.filter(a=>a.id!==e.id),this.mostrarMensaje("Proveedor eliminado exitosamente","success"),this.$emit("proveedores-actualizados")}catch(a){console.error("Error al eliminar proveedor:",a),this.mostrarMensaje("Error al eliminar proveedor","error")}},formatearFecha(e){if(!e)return"";const a=e.toDate?e.toDate():new Date(e);return a.toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"})},mostrarMensaje(e,a){const o={success:"fas fa-check-circle",error:"fas fa-exclamation-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"};this.mensaje={visible:!0,texto:e,tipo:a,icono:o[a]||o.info},setTimeout(()=>{this.mensaje.visible=!1},4e3)}}},d=i,c=(o("e3dd"),o("2877")),n=Object(c["a"])(d,t,r,!1,null,"ea491d0a",null);a["a"]=n.exports},"8cca":function(e,a,o){"use strict";var t=function(){var e,a,o=this,t=o._self._c;return o.mostrar?t("div",{staticClass:"modal-overlay",on:{click:o.cerrarModal}},[t("div",{staticClass:"modal-content",on:{click:function(e){e.stopPropagation()}}},[t("div",{staticClass:"modal-header"},[t("h2",[o._v("Gestionar Proveedores y Medidas de Crudos")]),t("button",{staticClass:"close-button",on:{click:function(e){return o.$emit("cerrar")}}},[o._v("√ó")])]),t("div",{staticClass:"modal-body"},[t("div",{staticClass:"seccion-proveedores"},[t("div",{staticClass:"seccion-header"},[t("h3",[o._v("Proveedores de Crudos")]),t("button",{staticClass:"btn-agregar",on:{click:function(e){o.mostrarFormularioProveedor=!o.mostrarFormularioProveedor}}},[o._v(" + Nuevo Proveedor ")])]),o.mostrarFormularioProveedor?t("div",{staticClass:"formulario-proveedor"},[t("div",{staticClass:"form-row"},[t("input",{directives:[{name:"model",rawName:"v-model",value:o.nuevoProveedor.nombre,expression:"nuevoProveedor.nombre"}],staticClass:"form-input",attrs:{placeholder:"Nombre del proveedor",required:""},domProps:{value:o.nuevoProveedor.nombre},on:{keyup:function(e){return!e.type.indexOf("key")&&o._k(e.keyCode,"enter",13,e.key,"Enter")?null:o.agregarProveedor.apply(null,arguments)},input:function(e){e.target.composing||o.$set(o.nuevoProveedor,"nombre",e.target.value)}}}),t("input",{directives:[{name:"model",rawName:"v-model",value:o.nuevoProveedor.contacto,expression:"nuevoProveedor.contacto"}],staticClass:"form-input",attrs:{placeholder:"Contacto (opcional)"},domProps:{value:o.nuevoProveedor.contacto},on:{input:function(e){e.target.composing||o.$set(o.nuevoProveedor,"contacto",e.target.value)}}}),t("button",{staticClass:"btn-guardar",attrs:{disabled:o.guardandoProveedor},on:{click:o.agregarProveedor}},[o._v(" "+o._s(o.guardandoProveedor?"Guardando...":"Guardar")+" ")]),t("button",{staticClass:"btn-cancelar",on:{click:o.cancelarProveedor}},[o._v(" Cancelar ")])])]):o._e(),t("div",{staticClass:"lista-proveedores"},[o.cargandoProveedores?t("div",{staticClass:"loading"},[o._v("Cargando proveedores...")]):0===o.proveedores.length?t("div",{staticClass:"no-datos"},[o._v(" No hay proveedores registrados. Agrega el primer proveedor. ")]):t("div",o._l(o.proveedores,(function(e){var a;return t("div",{key:e.id,staticClass:"proveedor-card",class:{selected:(null===(a=o.proveedorSeleccionado)||void 0===a?void 0:a.id)===e.id},on:{click:function(a){return o.seleccionarProveedor(e)}}},[t("div",{staticClass:"proveedor-info"},[t("h4",[o._v(o._s(e.nombre))]),e.contacto?t("p",{staticClass:"contacto"},[o._v(o._s(e.contacto))]):o._e(),t("p",{staticClass:"medidas-count"},[o._v(" "+o._s(o.contarMedidasProveedor(e.id))+" medida(s) registrada(s) ")])]),t("div",{staticClass:"proveedor-acciones"},[t("button",{staticClass:"btn-editar",attrs:{title:"Editar"},on:{click:function(a){return a.stopPropagation(),o.editarProveedor(e)}}},[o._v(" ‚úèÔ∏è ")]),t("button",{staticClass:"btn-eliminar",attrs:{title:"Eliminar"},on:{click:function(a){return a.stopPropagation(),o.eliminarProveedor(e)}}},[o._v(" üóëÔ∏è ")])])])})),0)])]),o.proveedorSeleccionado?t("div",{staticClass:"seccion-medidas"},[t("div",{staticClass:"seccion-header"},[t("h3",[o._v("Medidas/Productos - "+o._s(o.proveedorSeleccionado.nombre))]),t("button",{staticClass:"btn-agregar",on:{click:function(e){o.mostrarFormularioMedida=!o.mostrarFormularioMedida}}},[o._v(" + Nueva Medida ")])]),o.mostrarFormularioMedida?t("div",{staticClass:"formulario-medida"},[t("div",{staticClass:"form-row"},[t("input",{directives:[{name:"model",rawName:"v-model",value:o.nuevaMedida.nombre,expression:"nuevaMedida.nombre"}],staticClass:"form-input",attrs:{placeholder:"Nombre de la medida/producto",required:""},domProps:{value:o.nuevaMedida.nombre},on:{keyup:function(e){return!e.type.indexOf("key")&&o._k(e.keyCode,"enter",13,e.key,"Enter")?null:o.agregarMedida.apply(null,arguments)},input:function(e){e.target.composing||o.$set(o.nuevaMedida,"nombre",e.target.value)}}}),t("input",{directives:[{name:"model",rawName:"v-model",value:o.nuevaMedida.descripcion,expression:"nuevaMedida.descripcion"}],staticClass:"form-input",attrs:{placeholder:"Descripci√≥n (opcional)"},domProps:{value:o.nuevaMedida.descripcion},on:{input:function(e){e.target.composing||o.$set(o.nuevaMedida,"descripcion",e.target.value)}}}),t("button",{staticClass:"btn-guardar",attrs:{disabled:o.guardandoMedida},on:{click:o.agregarMedida}},[o._v(" "+o._s(o.guardandoMedida?"Guardando...":"Guardar")+" ")]),t("button",{staticClass:"btn-cancelar",on:{click:o.cancelarMedida}},[o._v(" Cancelar ")])])]):o._e(),t("div",{staticClass:"lista-medidas"},[o.cargandoMedidas?t("div",{staticClass:"loading"},[o._v("Cargando medidas...")]):0===o.medidasProveedor.length?t("div",{staticClass:"no-datos"},[o._v(" No hay medidas registradas para este proveedor. Agrega la primera medida. ")]):t("div",{staticClass:"medidas-grid"},o._l(o.medidasProveedor,(function(e){return t("div",{key:e.id,staticClass:"medida-card"},[t("div",{staticClass:"medida-info"},[t("h5",[o._v(o._s(e.nombre))]),e.descripcion?t("p",{staticClass:"descripcion"},[o._v(o._s(e.descripcion))]):o._e(),e.precioActual?t("p",{staticClass:"precio-actual"},[o._v(" Precio actual: $"+o._s(o.formatearPrecio(e.precioActual))+" ")]):o._e(),t("p",{staticClass:"fecha-creacion"},[o._v(" Creado: "+o._s(o.formatearFecha(e.fechaCreacion))+" ")])]),t("div",{staticClass:"medida-acciones"},[t("button",{staticClass:"btn-historial",attrs:{title:"Ver historial de precios"},on:{click:function(a){return o.verHistorialPrecios(e)}}},[o._v(" üìä ")]),t("button",{staticClass:"btn-editar",attrs:{title:"Editar"},on:{click:function(a){return o.editarMedida(e)}}},[o._v(" ‚úèÔ∏è ")]),t("button",{staticClass:"btn-eliminar",attrs:{title:"Eliminar"},on:{click:function(a){return o.eliminarMedida(e)}}},[o._v(" üóëÔ∏è ")])])])})),0)])]):t("div",{staticClass:"mensaje-seleccionar"},[t("p",[o._v("Selecciona un proveedor para gestionar sus medidas/productos")])])]),o.editandoProveedor?t("div",{staticClass:"modal-overlay-edit",on:{click:o.cancelarEdicionProveedor}},[t("div",{staticClass:"modal-edit",on:{click:function(e){e.stopPropagation()}}},[t("div",{staticClass:"modal-header"},[t("h3",[o._v("Editar Proveedor")]),t("button",{staticClass:"close-button",on:{click:o.cancelarEdicionProveedor}},[o._v("√ó")])]),t("div",{staticClass:"modal-body-edit"},[t("div",{staticClass:"form-group"},[t("label",[o._v("Nombre:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:o.proveedorEditando.nombre,expression:"proveedorEditando.nombre"}],staticClass:"form-input",attrs:{required:""},domProps:{value:o.proveedorEditando.nombre},on:{input:function(e){e.target.composing||o.$set(o.proveedorEditando,"nombre",e.target.value)}}})]),t("div",{staticClass:"form-group"},[t("label",[o._v("Contacto:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:o.proveedorEditando.contacto,expression:"proveedorEditando.contacto"}],staticClass:"form-input",domProps:{value:o.proveedorEditando.contacto},on:{input:function(e){e.target.composing||o.$set(o.proveedorEditando,"contacto",e.target.value)}}})]),t("div",{staticClass:"form-actions"},[t("button",{staticClass:"btn-guardar",attrs:{disabled:o.guardandoProveedor},on:{click:o.guardarEdicionProveedor}},[o._v(" "+o._s(o.guardandoProveedor?"Guardando...":"Actualizar")+" ")]),t("button",{staticClass:"btn-cancelar",on:{click:o.cancelarEdicionProveedor}},[o._v(" Cancelar ")])])])])]):o._e(),o.editandoMedida?t("div",{staticClass:"modal-overlay-edit",on:{click:o.cancelarEdicionMedida}},[t("div",{staticClass:"modal-edit",on:{click:function(e){e.stopPropagation()}}},[t("div",{staticClass:"modal-header"},[t("h3",[o._v("Editar Medida")]),t("button",{staticClass:"close-button",on:{click:o.cancelarEdicionMedida}},[o._v("√ó")])]),t("div",{staticClass:"modal-body-edit"},[t("div",{staticClass:"form-group"},[t("label",[o._v("Nombre:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:o.medidaEditando.nombre,expression:"medidaEditando.nombre"}],staticClass:"form-input",attrs:{required:""},domProps:{value:o.medidaEditando.nombre},on:{input:function(e){e.target.composing||o.$set(o.medidaEditando,"nombre",e.target.value)}}})]),t("div",{staticClass:"form-group"},[t("label",[o._v("Descripci√≥n:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:o.medidaEditando.descripcion,expression:"medidaEditando.descripcion"}],staticClass:"form-input",domProps:{value:o.medidaEditando.descripcion},on:{input:function(e){e.target.composing||o.$set(o.medidaEditando,"descripcion",e.target.value)}}})]),t("div",{staticClass:"form-actions"},[t("button",{staticClass:"btn-guardar",attrs:{disabled:o.guardandoMedida},on:{click:o.guardarEdicionMedida}},[o._v(" "+o._s(o.guardandoMedida?"Guardando...":"Actualizar")+" ")]),t("button",{staticClass:"btn-cancelar",on:{click:o.cancelarEdicionMedida}},[o._v(" Cancelar ")])])])])]):o._e()]),t("HistorialPreciosCrudos",{attrs:{mostrar:o.mostrarHistorialPrecios,medida:o.medidaSeleccionada,"proveedor-id":null===(e=o.proveedorSeleccionado)||void 0===e?void 0:e.id,"proveedor-nombre":null===(a=o.proveedorSeleccionado)||void 0===a?void 0:a.nombre},on:{cerrar:o.cerrarHistorialPrecios,actualizado:o.onHistorialActualizado}})],1):o._e()},r=[],s=(o("14d9"),o("dc59")),i=o("1494"),d=o("6f61"),c={name:"GestionProveedoresCrudos",components:{HistorialPreciosCrudos:d["a"]},props:{mostrar:{type:Boolean,required:!0}},emits:["cerrar","actualizado"],data(){return{cargandoProveedores:!1,cargandoMedidas:!1,guardandoProveedor:!1,guardandoMedida:!1,proveedores:[],medidas:[],proveedorSeleccionado:null,mostrarFormularioProveedor:!1,mostrarFormularioMedida:!1,nuevoProveedor:{nombre:"",contacto:""},nuevaMedida:{nombre:"",descripcion:""},editandoProveedor:!1,editandoMedida:!1,proveedorEditando:{},medidaEditando:{},mostrarHistorialPrecios:!1,medidaSeleccionada:null}},computed:{medidasProveedor(){return this.proveedorSeleccionado?this.medidas.filter(e=>e.proveedorId===this.proveedorSeleccionado.id):[]}},methods:{cerrarModal(e){e.target===e.currentTarget&&this.$emit("cerrar")},async cargarProveedores(){try{this.cargandoProveedores=!0;const e=await Object(i["g"])(Object(i["c"])(s["a"],"proveedoresCrudos"));this.proveedores=e.docs.map(e=>({id:e.id,...e.data()})),this.proveedores.sort((e,a)=>e.nombre.localeCompare(a.nombre))}catch(e){console.error("Error al cargar proveedores:",e),alert("Error al cargar proveedores")}finally{this.cargandoProveedores=!1}},async agregarProveedor(){if(this.nuevoProveedor.nombre.trim())if(this.proveedores.some(e=>e.nombre.toLowerCase()===this.nuevoProveedor.nombre.toLowerCase()))alert("Ya existe un proveedor con ese nombre");else try{this.guardandoProveedor=!0;const e={nombre:this.nuevoProveedor.nombre.trim(),contacto:this.nuevoProveedor.contacto.trim()||null,fechaCreacion:new Date,tipo:"crudos"},a=await Object(i["b"])(Object(i["c"])(s["a"],"proveedoresCrudos"),e);this.proveedores.push({id:a.id,...e}),this.proveedores.sort((e,a)=>e.nombre.localeCompare(a.nombre)),this.cancelarProveedor(),this.$emit("actualizado")}catch(e){console.error("Error al agregar proveedor:",e),alert("Error al agregar proveedor")}finally{this.guardandoProveedor=!1}else alert("El nombre del proveedor es requerido")},editarProveedor(e){this.proveedorEditando={...e},this.editandoProveedor=!0},async guardarEdicionProveedor(){if(this.proveedorEditando.nombre.trim())try{var e,a;this.guardandoProveedor=!0;const o=Object(i["e"])(s["a"],"proveedoresCrudos",this.proveedorEditando.id),t={nombre:this.proveedorEditando.nombre.trim(),contacto:(null===(e=this.proveedorEditando.contacto)||void 0===e?void 0:e.trim())||null};await Object(i["s"])(o,t);const r=this.proveedores.findIndex(e=>e.id===this.proveedorEditando.id);-1!==r&&(this.proveedores[r]={...this.proveedores[r],...t}),(null===(a=this.proveedorSeleccionado)||void 0===a?void 0:a.id)===this.proveedorEditando.id&&(this.proveedorSeleccionado={...this.proveedorSeleccionado,...t}),this.cancelarEdicionProveedor(),this.$emit("actualizado")}catch(o){console.error("Error al actualizar proveedor:",o),alert("Error al actualizar proveedor")}finally{this.guardandoProveedor=!1}else alert("El nombre del proveedor es requerido")},async eliminarProveedor(e){const a=this.medidas.filter(a=>a.proveedorId===e.id);let o=`¬øEst√°s seguro de que quieres eliminar el proveedor "${e.nombre}"?`;if(a.length>0&&(o+=`\n\nEsto tambi√©n eliminar√° ${a.length} medida(s) asociada(s).`),confirm(o))try{var t;for(const e of a)await Object(i["d"])(Object(i["e"])(s["a"],"medidasCrudos",e.id));await Object(i["d"])(Object(i["e"])(s["a"],"proveedoresCrudos",e.id)),this.proveedores=this.proveedores.filter(a=>a.id!==e.id),this.medidas=this.medidas.filter(a=>a.proveedorId!==e.id),(null===(t=this.proveedorSeleccionado)||void 0===t?void 0:t.id)===e.id&&(this.proveedorSeleccionado=null),this.$emit("actualizado")}catch(r){console.error("Error al eliminar proveedor:",r),alert("Error al eliminar proveedor")}},cancelarProveedor(){this.nuevoProveedor={nombre:"",contacto:""},this.mostrarFormularioProveedor=!1},cancelarEdicionProveedor(){this.editandoProveedor=!1,this.proveedorEditando={}},seleccionarProveedor(e){this.proveedorSeleccionado=e,this.cargarMedidas(),this.mostrarFormularioMedida=!1},async cargarMedidas(){try{this.cargandoMedidas=!0;const e=await Object(i["g"])(Object(i["c"])(s["a"],"medidasCrudos"));this.medidas=e.docs.map(e=>({id:e.id,...e.data()})),await this.cargarPreciosActuales()}catch(e){console.error("Error al cargar medidas:",e),alert("Error al cargar medidas")}finally{this.cargandoMedidas=!1}},async cargarPreciosActuales(){try{const e=await Object(i["g"])(Object(i["c"])(s["a"],"historialPreciosCrudos")),a=e.docs.map(e=>e.data()),o={};a.forEach(e=>{o[e.medidaId]||(o[e.medidaId]=[]),o[e.medidaId].push(e)}),Object.keys(o).forEach(e=>{const a=o[e],t=a.sort((e,a)=>new Date(a.fecha)-new Date(e.fecha))[0],r=this.medidas.findIndex(a=>a.id===e);-1!==r&&(this.medidas[r].precioActual=t.precio)})}catch(e){console.error("Error al cargar precios actuales:",e)}},async agregarMedida(){if(!this.nuevaMedida.nombre.trim())return void alert("El nombre de la medida es requerido");if(!this.proveedorSeleccionado)return void alert("Debe seleccionar un proveedor");const e=this.medidas.some(e=>e.proveedorId===this.proveedorSeleccionado.id&&e.nombre.toLowerCase()===this.nuevaMedida.nombre.toLowerCase());if(e)alert("Ya existe una medida con ese nombre para este proveedor");else try{this.guardandoMedida=!0;const e={nombre:this.nuevaMedida.nombre.trim(),descripcion:this.nuevaMedida.descripcion.trim()||null,proveedorId:this.proveedorSeleccionado.id,proveedorNombre:this.proveedorSeleccionado.nombre,fechaCreacion:new Date,tipo:"crudos"},a=await Object(i["b"])(Object(i["c"])(s["a"],"medidasCrudos"),e);this.medidas.push({id:a.id,...e}),this.cancelarMedida(),this.$emit("actualizado")}catch(a){console.error("Error al agregar medida:",a),alert("Error al agregar medida")}finally{this.guardandoMedida=!1}},editarMedida(e){this.medidaEditando={...e},this.editandoMedida=!0},async guardarEdicionMedida(){if(this.medidaEditando.nombre.trim())try{var e;this.guardandoMedida=!0;const a=Object(i["e"])(s["a"],"medidasCrudos",this.medidaEditando.id),o={nombre:this.medidaEditando.nombre.trim(),descripcion:(null===(e=this.medidaEditando.descripcion)||void 0===e?void 0:e.trim())||null};await Object(i["s"])(a,o);const t=this.medidas.findIndex(e=>e.id===this.medidaEditando.id);-1!==t&&(this.medidas[t]={...this.medidas[t],...o}),this.cancelarEdicionMedida(),this.$emit("actualizado")}catch(a){console.error("Error al actualizar medida:",a),alert("Error al actualizar medida")}finally{this.guardandoMedida=!1}else alert("El nombre de la medida es requerido")},async eliminarMedida(e){if(confirm(`¬øEst√°s seguro de que quieres eliminar la medida "${e.nombre}"?`))try{await Object(i["d"])(Object(i["e"])(s["a"],"medidasCrudos",e.id)),this.medidas=this.medidas.filter(a=>a.id!==e.id),this.$emit("actualizado")}catch(a){console.error("Error al eliminar medida:",a),alert("Error al eliminar medida")}},cancelarMedida(){this.nuevaMedida={nombre:"",descripcion:""},this.mostrarFormularioMedida=!1},cancelarEdicionMedida(){this.editandoMedida=!1,this.medidaEditando={}},contarMedidasProveedor(e){return this.medidas.filter(a=>a.proveedorId===e).length},formatearPrecio(e){return e?e.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00"},formatearFecha(e){if(!e)return"";const a=e instanceof Date?e:e.toDate();return a.toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"})},verHistorialPrecios(e){this.medidaSeleccionada=e,this.mostrarHistorialPrecios=!0},cerrarHistorialPrecios(){this.mostrarHistorialPrecios=!1,this.medidaSeleccionada=null},onHistorialActualizado(){this.cargarPreciosActuales(),this.$emit("actualizado")}},async mounted(){await Promise.all([this.cargarProveedores(),this.cargarMedidas()])}},n=c,l=(o("d36d"),o("2877")),m=Object(l["a"])(n,t,r,!1,null,"a0077b3c",null);a["a"]=m.exports},aa5b:function(e,a,o){"use strict";o("015b")},d36d:function(e,a,o){"use strict";o("de31")},de31:function(e,a,o){},e3dd:function(e,a,o){"use strict";o("0a04")}}]);