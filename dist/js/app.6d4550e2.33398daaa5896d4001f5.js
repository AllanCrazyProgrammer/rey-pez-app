(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app.6d4550e2"],{"92f0":function(t,e,o){"use strict";o("98fd")},"98fd":function(t,e,o){},fc3d:function(t,e,o){"use strict";var r=function(){var t=this,e=t._self._c;return e("div",{staticClass:"existencias-crudos-container"},[e("h1",[t._v("Existencias de Crudos")]),e("div",{staticClass:"actions-container"},[e("router-link",{staticClass:"action-button new-entrada-btn",attrs:{to:"/existencias-crudos/new"}},[t._v(" Nueva Entrada/Salida ")]),e("button",{staticClass:"action-button",on:{click:t.showGestionarModal}},[t._v(" Gestionar Proveedores y Medidas ")]),e("button",{staticClass:"action-button",on:{click:t.imprimirReporte}},[t._v(" Imprimir Reporte ")])],1),e("div",{staticClass:"resumen-existencias"},[e("h2",[t._v("Resumen de Existencias Actuales")]),t.isLoadingExistencias?e("div",{staticClass:"loading"},[t._v("Cargando existencias...")]):0===Object.keys(t.existenciasPorProveedor).length?e("div",{staticClass:"no-existencias"},[t._v(" No hay existencias registradas. ")]):e("div",{staticClass:"existencias-grid"},t._l(t.existenciasPorProveedor,(function(o,r){return e("div",{key:r,staticClass:"proveedor-card"},[e("h3",[t._v(t._s(r))]),e("table",{staticClass:"productos-table"},[t._m(0,!0),e("tbody",t._l(o,(function(o){return o.kilos>0?e("tr",{key:o.clave},[e("td",[t._v(t._s(o.nombre))]),e("td",{staticClass:"kilos-cell"},[t._v(t._s(t.formatNumber(o.kilos)))]),e("td",{staticClass:"precio-cell"},[t._v("$"+t._s(t.formatearPrecio(o.ultimoPrecio)))]),e("td",{staticClass:"valor-cell"},[t._v("$"+t._s(t.formatearValor(o.valor)))])]):t._e()})),0)]),e("div",{staticClass:"total-proveedor"},[e("div",[e("strong",[t._v("Total "+t._s(r)+": "+t._s(t.formatNumber(t.calcularTotalProveedor(o)))+" kg")])]),e("div",[e("strong",[t._v("Valor Total: $"+t._s(t.formatearValor(t.calcularTotalValorProveedor(o))))])])])])})),0),e("div",{staticClass:"total-general"},[e("h3",[t._v("Total General: "+t._s(t.formatNumber(t.totalGeneral))+" kg")]),e("h3",[t._v("Valor Total General: $"+t._s(t.formatearValor(t.valorTotalGeneral)))])])]),e("div",{staticClass:"registros-list"},[e("h2",[t._v("Registros Recientes")]),t.isLoadingRegistros?e("div",{staticClass:"loading"},[t._v("Cargando registros...")]):0===t.registros.length?e("div",{staticClass:"no-records"},[t._v(" No hay registros de crudos. ")]):e("ul",t._l(t.paginatedRegistros,(function(o){return e("li",{key:o.id,staticClass:"registro-item"},[e("div",{staticClass:"registro-content",on:{click:function(e){return t.editRegistro(o.id)}}},[e("span",{staticClass:"registro-date"},[t._v(t._s(t.formatDate(o.fecha)))]),e("div",{staticClass:"registro-summary"},[e("div",{staticClass:"registro-entry"},[e("span",{staticClass:"registro-label"},[t._v("Entradas:")]),e("span",{staticClass:"registro-value"},[t._v(t._s(t.formatNumber(o.totalEntradas))+" kg")])]),e("div",{staticClass:"registro-entry"},[e("span",{staticClass:"registro-label"},[t._v("Salidas:")]),e("span",{staticClass:"registro-value"},[t._v(t._s(t.formatNumber(o.totalSalidas))+" kg")])])])]),e("div",{staticClass:"registro-actions"},[e("button",{staticClass:"delete-btn",on:{click:function(e){return e.stopPropagation(),t.deleteRegistro(o.id)}}},[t._v("Borrar")])])])})),0),e("div",{staticClass:"pagination"},[e("button",{attrs:{disabled:1===t.currentPage},on:{click:t.prevPage}},[t._v("Anterior")]),e("span",[t._v("Página "+t._s(t.currentPage)+" de "+t._s(t.totalPages))]),e("button",{attrs:{disabled:t.currentPage===t.totalPages},on:{click:t.nextPage}},[t._v("Siguiente")])])]),e("GestionProveedoresCrudos",{attrs:{mostrar:t.showGestionModal},on:{cerrar:t.closeGestionarModal,actualizado:t.onProveedoresActualizados}})],1)},a=[function(){var t=this,e=t._self._c;return e("thead",[e("tr",[e("th",[t._v("Medida")]),e("th",[t._v("Kilos")]),e("th",[t._v("Precio")]),e("th",[t._v("Valor")])])])}],s=(o("14d9"),o("13d5"),o("fa1c"),o("dc59")),i=o("1494"),n=o("c1df"),c=o.n(n),l=o("8cca"),d={name:"ExistenciasCrudos",components:{GestionProveedoresCrudos:l["a"]},data(){return{registros:[],existenciasPorProveedor:{},isLoadingRegistros:!0,isLoadingExistencias:!0,currentPage:1,itemsPerPage:10,showGestionModal:!1}},computed:{paginatedRegistros(){const t=(this.currentPage-1)*this.itemsPerPage,e=t+this.itemsPerPage;return this.registros.slice(t,e)},totalPages(){return Math.ceil(this.registros.length/this.itemsPerPage)},totalGeneral(){return Object.values(this.existenciasPorProveedor).flat().reduce((t,e)=>t+e.kilos,0)},valorTotalGeneral(){return Object.values(this.existenciasPorProveedor).flat().reduce((t,e)=>t+e.valor,0)}},methods:{async loadRegistros(){try{this.isLoadingRegistros=!0;const t=Object(i["c"])(s["a"],"existenciasCrudos"),e=Object(i["o"])(t,Object(i["l"])("fecha","desc")),o=await Object(i["g"])(e);this.registros=o.docs.map(t=>{const e=t.data();let o;return o=e.fecha instanceof Date?c()(e.fecha).toDate():e.fecha&&"function"===typeof e.fecha.toDate?c()(e.fecha.toDate()).toDate():c()(e.fecha).toDate(),{id:t.id,...e,fecha:o,totalEntradas:e.totalEntradas||0,totalSalidas:e.totalSalidas||0}})}catch(t){console.error("Error al cargar registros de crudos: ",t),this.registros=[]}finally{this.isLoadingRegistros=!1}},async loadExistencias(){try{this.isLoadingExistencias=!0;const t=await Object(i["g"])(Object(i["c"])(s["a"],"existenciasCrudos")),e={},o=t.docs.map(t=>({id:t.id,...t.data()})).sort((t,e)=>{const o=t.fecha instanceof Date?t.fecha:t.fecha.toDate(),r=e.fecha instanceof Date?e.fecha:e.fecha.toDate();return o-r});o.forEach(t=>{t.entradas&&t.entradas.forEach(t=>{e[t.proveedor]||(e[t.proveedor]={});const o=t.precio?t.precio.toString():"sin_precio",r=`${t.producto}_${o}`;e[t.proveedor][r]||(e[t.proveedor][r]={nombre:t.producto,kilos:0,ultimoPrecio:t.precio||0,proveedor:t.proveedor,producto:t.producto}),e[t.proveedor][r].kilos+=t.kilos,t.precio&&(e[t.proveedor][r].ultimoPrecio=t.precio)}),t.salidas&&t.salidas.forEach(t=>{e[t.proveedor]||(e[t.proveedor]={});const o=Object.keys(e[t.proveedor]).filter(o=>e[t.proveedor][o].producto===t.producto).sort((o,r)=>{const a=e[t.proveedor][o].ultimoPrecio,s=e[t.proveedor][r].ultimoPrecio;return a-s});let r=t.kilos;for(const a of o){if(r<=0)break;const o=e[t.proveedor][a];if(o.kilos>0){const t=Math.min(r,o.kilos);o.kilos-=t,r-=t}}})}),await this.actualizarPreciosDelHistorial(e);const r={};Object.keys(e).forEach(t=>{const o=Object.values(e[t]).filter(t=>t.kilos>0).map(t=>({...t,clave:`${t.producto}_${t.ultimoPrecio}`,valor:t.kilos*t.ultimoPrecio}));o.length>0&&(r[t]=o)}),this.existenciasPorProveedor=r}catch(t){console.error("Error al cargar existencias de crudos: ",t),this.existenciasPorProveedor={}}finally{this.isLoadingExistencias=!1}},async actualizarPreciosDelHistorial(t){try{const e=await Object(i["g"])(Object(i["c"])(s["a"],"historialPreciosCrudos")),o={};e.docs.forEach(t=>{const e=t.data(),r=`${e.proveedor}_${e.medida}`;o[r]||(o[r]=[]),o[r].push({precio:e.precio,fecha:e.fecha instanceof Date?e.fecha:e.fecha.toDate()})}),Object.keys(o).forEach(t=>{o[t].sort((t,e)=>e.fecha-t.fecha)}),Object.keys(t).forEach(e=>{Object.keys(t[e]).forEach(r=>{const a=t[e][r];if(0===a.ultimoPrecio){const t=`${e}_${a.producto}`;o[t]&&o[t].length>0&&(a.ultimoPrecio=o[t][0].precio)}})})}catch(e){console.error("Error al actualizar precios del historial: ",e)}},formatDate(t){return c()(t).format("DD [de] MMMM [de] YYYY")},formatNumber(t){return(t||0).toLocaleString("es-ES",{minimumFractionDigits:0,maximumFractionDigits:0})},formatearPrecio(t){return t?t.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00"},formatearValor(t){return t?t.toLocaleString("es-MX",{minimumFractionDigits:0,maximumFractionDigits:0}):"0"},calcularTotalProveedor(t){return t.reduce((t,e)=>t+e.kilos,0)},calcularTotalValorProveedor(t){return t.reduce((t,e)=>t+e.valor,0)},editRegistro(t){this.$router.push("/existencias-crudos/"+t)},async deleteRegistro(t){if(confirm("¿Estás seguro de que quieres borrar este registro de crudos?"))try{await Object(i["d"])(Object(i["e"])(s["a"],"existenciasCrudos",t)),this.registros=this.registros.filter(e=>e.id!==t),await this.loadExistencias(),alert("Registro de crudos borrado con éxito")}catch(e){console.error("Error al borrar el registro de crudos: ",e),alert("Error al borrar el registro de crudos")}},prevPage(){this.currentPage>1&&this.currentPage--},nextPage(){this.currentPage<this.totalPages&&this.currentPage++},showGestionarModal(){this.showGestionModal=!0},closeGestionarModal(){this.showGestionModal=!1},imprimirReporte(){const t=(new Date).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"}),e='\n        <style>\n          @page { \n            size: A4 landscape; \n            margin: 0.5cm 0.5cm;\n            @bottom-right {\n              content: "Página " counter(page) " de " counter(pages);\n              font-size: 11pt;\n            }\n          }\n          body {\n            font-family: Arial, sans-serif;\n            font-size: 16pt;\n            line-height: 1.2;\n            color: #333;\n            margin: 0;\n            padding: 0;\n          }\n          .header {\n            margin-bottom: 15px;\n            padding-bottom: 8px;\n            text-align: center;\n          }\n          h1 {\n            color: #3760b0;\n            font-size: 26pt;\n            margin: 0;\n            padding: 0;\n          }\n          .fecha-reporte {\n            font-size: 18pt;\n            color: #666;\n            margin-top: 5px;\n          }\n          .existencias-grid {\n            display: grid;\n            grid-template-columns: repeat(4, 1fr);\n            gap: 12px;\n            margin-top: 15px;\n          }\n          .proveedor-card {\n            background-color: white;\n            border: 2px solid #3760b0;\n            border-radius: 8px;\n            padding: 12px;\n            break-inside: avoid;\n            page-break-inside: avoid;\n          }\n          .proveedor-card h2 {\n            color: #3760b0;\n            font-size: 20pt;\n            margin: 0 0 8px 0;\n            padding-bottom: 6px;\n            border-bottom: 2px solid #3760b0;\n          }\n          table {\n            width: 100%;\n            border-collapse: collapse;\n            margin-top: 8px;\n          }\n          th {\n            background-color: #3760b0;\n            color: white;\n            text-align: left;\n            padding: 6px;\n            font-size: 14pt;\n            border: 1px solid #3760b0;\n          }\n          td {\n            padding: 5px 6px;\n            font-size: 14pt;\n            border: 1px solid #ddd;\n          }\n          tr:nth-child(even) {\n            background-color: #f8f9fa;\n          }\n          .kilos-cell, .precio-cell, .valor-cell {\n            text-align: right;\n            font-weight: bold;\n          }\n          .precio-cell {\n            color: #2c3e50;\n          }\n          .valor-cell {\n            color: #27ae60;\n          }\n          .total-proveedor {\n            text-align: right;\n            font-size: 14pt;\n            color: #3760b0;\n            font-weight: bold;\n            margin-top: 8px;\n          }\n          .total-general {\n            margin-top: 20px;\n            text-align: center;\n            background-color: #f0f4f8;\n            padding: 15px;\n            border-radius: 8px;\n            border: 2px solid #3760b0;\n          }\n          .total-general h2 {\n            color: #3760b0;\n            font-size: 22pt;\n            margin: 0;\n          }\n          @media print {\n            .existencias-grid {\n              display: grid;\n              grid-template-columns: repeat(4, 1fr);\n            }\n            .proveedor-card {\n              break-inside: avoid;\n              page-break-inside: avoid;\n            }\n            .total-general {\n              break-before: avoid;\n              page-break-before: avoid;\n            }\n          }\n        </style>\n      ';let o=`\n        ${e}\n        <div class="header">\n          <h1>Reporte de Existencias de Crudos</h1>\n          <div class="fecha-reporte">Fecha: ${t}</div>\n        </div>\n        <div class="existencias-grid">\n      `;Object.keys(this.existenciasPorProveedor).forEach(t=>{const e=this.existenciasPorProveedor[t];o+=`\n          <div class="proveedor-card">\n            <h2>${t}</h2>\n            <table>\n              <thead>\n                <tr>\n                  <th>Medida</th>\n                  <th>Kilos</th>\n                  <th>Precio</th>\n                  <th>Valor</th>\n                </tr>\n              </thead>\n              <tbody>\n        `,e.forEach(t=>{o+=`\n            <tr>\n              <td>${t.nombre}</td>\n              <td class="kilos-cell">${this.formatNumber(t.kilos)}</td>\n              <td class="precio-cell">$${this.formatearPrecio(t.ultimoPrecio)}</td>\n              <td class="valor-cell">$${this.formatearValor(t.valor)}</td>\n            </tr>\n          `}),o+=`\n              </tbody>\n            </table>\n            <div class="total-proveedor">\n              <div>Total ${t}: ${this.formatNumber(this.calcularTotalProveedor(e))} kg</div>\n              <div>Valor Total: $${this.formatearValor(this.calcularTotalValorProveedor(e))}</div>\n            </div>\n          </div>\n        `}),o+=`\n        </div>\n        <div class="total-general">\n          <h2>Total General: ${this.formatNumber(this.totalGeneral)} kg</h2>\n          <h2>Valor Total General: $${this.formatearValor(this.valorTotalGeneral)}</h2>\n        </div>\n      `;const r=window.open("","_blank");r.document.write(o),r.document.close(),setTimeout(()=>{r.print(),r.close()},250)},async onProveedoresActualizados(){await this.loadExistencias()}},async mounted(){await Promise.all([this.loadRegistros(),this.loadExistencias()])}},g=d,u=(o("92f0"),o("2877")),h=Object(u["a"])(g,r,a,!1,null,"271fe88a",null);e["a"]=h.exports}}]);