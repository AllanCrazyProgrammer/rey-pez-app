(function(e){function t(t){for(var i,r,n=t[0],d=t[1],l=t[2],c=0,p=[];c<n.length;c++)r=n[c],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&p.push(o[r][0]),o[r]=0;for(i in d)Object.prototype.hasOwnProperty.call(d,i)&&(e[i]=d[i]);u&&u(t);while(p.length)p.shift()();return s.push.apply(s,l||[]),a()}function a(){for(var e,t=0;t<s.length;t++){for(var a=s[t],i=!0,r=1;r<a.length;r++){var d=a[r];0!==o[d]&&(i=!1)}i&&(s.splice(t--,1),e=n(n.s=a[0]))}return e}var i={},o={"app.dc372872":0},s=[];function r(e){return n.p+"js/"+({}[e]||e)+"."+{"chunk-2d0a385c":"60c79ddb52b824ec604b","chunk-2d216214":"1cff4ebd36170ed65128","chunk-f333e3ae":"627ce2f718d5205fdc66","chunk-60d9baba":"1ad98b105cfa2ab1c9bf"}[e]+".js"}function n(t){if(i[t])return i[t].exports;var a=i[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.e=function(e){var t=[],a=o[e];if(0!==a)if(a)t.push(a[2]);else{var i=new Promise((function(t,i){a=o[e]=[t,i]}));t.push(a[2]=i);var s,d=document.createElement("script");d.charset="utf-8",d.timeout=120,n.nc&&d.setAttribute("nonce",n.nc),d.src=r(e);var l=new Error;s=function(t){d.onerror=d.onload=null,clearTimeout(c);var a=o[e];if(0!==a){if(a){var i=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;l.message="Loading chunk "+e+" failed.\n("+i+": "+s+")",l.name="ChunkLoadError",l.type=i,l.request=s,a[1](l)}o[e]=void 0}};var c=setTimeout((function(){s({type:"timeout",target:d})}),12e4);d.onerror=d.onload=s,document.head.appendChild(d)}return Promise.all(t)},n.m=e,n.c=i,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(a,i,function(t){return e[t]}.bind(null,i));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n.oe=function(e){throw console.error(e),e};var d=window["webpackJsonp"]=window["webpackJsonp"]||[],l=d.push.bind(d);d.push=t,d=d.slice();for(var c=0;c<d.length;c++)t(d[c]);var u=l;s.push([0,"npm.bootstrap-vue.4e2612d6","npm.bootstrap-vue.df25b021","npm.bootstrap-vue.6f27f355","npm.bootstrap-vue.eb7344d5","npm.bootstrap-vue.ab9cc731","npm.bootstrap-vue.6bcf42e1","npm.bootstrap-vue.0802902c","npm.bootstrap-vue.ae606773","npm.bootstrap-vue.7a8621bb","npm.bootstrap-vue.f8ef863f","npm.bootstrap-vue.0a18e71a","npm.bootstrap-vue.36c5d7d2","npm.moment.399b027d","npm.moment.e258e298","npm.moment.d22b72d1","npm.moment.15f0789d","npm.moment.b3938def","app.d0ae3f07","app.253ae210","app.0c53a363","app.55c52a2a","app.f00ed565","app.8128a265","app.d939e436","app.bc517470","app.203e0718","app.07982b9e","app.f25e5b0e","app.7d359b94","app.67f3a751","app.30ae1c67","app.3af8bccc","app.1c74e113","app.93bb6541","app.cfbf0a2e","app.aaac3122","app.06837ae4","app.21833f8f","app.e73b60ec","app.9fa10dbc","app.193e24cd","app.deb7d3b8","app.63fc7693","app.fde2bf1c","app.c714bc7b","app.ea1f58e8","app.cee491b7","app.ce05ead1","app.be1b1ab5","app.51a12d86","app.76e92ee3","app.b7ac1004","app.f0397a4c","app.569545fd","app.78b6be89","app.3a8781c2","app.ec030a48","app.2fe92394","app.69dbab32","app.13c3a502","app.dbc275fd","app.6d4550e2","app.e346c0ac","app.36c23e6b","app.3a037446","app.6f9cb5a9","app.29f3534c","app.2b6196f6"]),a()})({"32e5":function(e,t,a){"use strict";var i=function(){var e=this,t=e._self._c;return e.isLoaded?t("div",{staticClass:"sacadas-container"},[t("div",{staticClass:"back-button-container"},[t("BackButton",{attrs:{to:"/sacadas"}}),e.tienePedidoOrigen?t("button",{staticClass:"btn-regresar-pedido",on:{click:e.regresarAlPedido}},[e._v("Regresar al Pedido")]):e._e()],1),t("h2",{staticClass:"date-header"},[e._v(e._s(e.formattedDate))]),t("div",{staticClass:"date-selector"},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.selectedDate,expression:"selectedDate"}],attrs:{type:"date"},domProps:{value:e.selectedDate},on:{change:e.updateCurrentDate,input:function(t){t.target.composing||(e.selectedDate=t.target.value)}}})]),t("div",{staticClass:"sacadas-content"},[t("div",{staticClass:"salidas-section"},[t("h3",[e._v("Salidas")]),t("div",{staticClass:"input-group"},[t("select",{directives:[{name:"model",rawName:"v-model",value:e.newSalida.tipo,expression:"newSalida.tipo"}],attrs:{required:""},on:{change:[function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.newSalida,"tipo",t.target.multiple?a:a[0])},e.resetSalidaSelections]}},[t("option",{attrs:{value:""}},[e._v("Tipo")]),t("option",{attrs:{value:"proveedor"}},[e._v("Proveedor")]),t("option",{attrs:{value:"maquila"}},[e._v("Maquila")])]),t("select",{directives:[{name:"model",rawName:"v-model",value:e.newSalida.proveedor,expression:"newSalida.proveedor"}],attrs:{required:""},on:{change:function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.newSalida,"proveedor",t.target.multiple?a:a[0])}}},[t("option",{attrs:{value:""}},[e._v(e._s("maquila"===e.newSalida.tipo?"Maquila":"Proveedor"))]),e._l(e.filteredProveedoresSalida,(function(a){return t("option",{key:a.id,domProps:{value:a.nombre}},[e._v(" "+e._s(a.nombre)+" ")])}))],2),t("select",{directives:[{name:"model",rawName:"v-model",value:e.newSalida.medida,expression:"newSalida.medida"}],attrs:{required:""},on:{change:function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.newSalida,"medida",t.target.multiple?a:a[0])}}},[t("option",{attrs:{value:""}},[e._v("Medida")]),e._l(e.filteredMedidasSalida,(function(a){return t("option",{key:a.id,domProps:{value:a.nombre}},[e._v(" "+e._s(a.nombre)+" ")])}))],2),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.newSalida.kilos,expression:"newSalida.kilos",modifiers:{number:!0}}],attrs:{type:"number",inputmode:"decimal",step:"0.1",pattern:"[0-9]*",placeholder:"Kilos",required:""},domProps:{value:e.newSalida.kilos},on:{input:function(t){t.target.composing||e.$set(e.newSalida,"kilos",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}}),t("button",{attrs:{disabled:!e.isSalidaValid||e.newSalida.kilos>e.kilosDisponibles},on:{click:e.addSalida}},[e._v("Agregar Salida")]),e.newSalida.proveedor?t("button",{staticClass:"clear-button",on:{click:e.limpiarSeleccionSalida}},[e._v("üóëÔ∏è Limpiar")]):e._e(),e.newSalida.proveedor&&"proveedor"===e.newSalida.tipo?t("button",{staticClass:"refresh-button",on:{click:e.refrescarMedidasManual}},[e._v("üîÑ Refrescar")]):e._e()]),null!==e.kilosDisponibles?t("p",{staticClass:"kilos-disponibles"},[e._v(" Kilos disponibles: "),t("span",{class:{"low-stock":e.kilosDisponibles<100}},[e._v(e._s(e.formatNumber(e.kilosDisponibles))+" kg")])]):e._e(),t("ul",{staticClass:"list"},e._l(e.salidas,(function(a,i){return t("li",{key:"salida-"+i},[t("span",[e._v(e._s("maquila"===a.tipo?"Maquila":"Proveedor")+": "+e._s(a.proveedor)+" - "+e._s(a.medida)+e._s(a.precio?` ($${a.precio})`:"")+": "+e._s(e.formatNumber(a.kilos))+" kg")]),t("div",{staticClass:"action-buttons"},[t("button",{staticClass:"delete-btn",on:{click:function(t){return e.removeSalida(i)}}},[e._v("√ó")])])])})),0),t("p",{staticClass:"total"},[e._v("Total Salidas: "+e._s(e.formatNumber(e.totalSalidas))+" kg")])]),t("div",{staticClass:"entradas-section"},[t("h3",[e._v("Entradas")]),t("div",{staticClass:"input-group"},[t("select",{directives:[{name:"model",rawName:"v-model",value:e.newEntrada.tipo,expression:"newEntrada.tipo"}],attrs:{required:""},on:{change:[function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.newEntrada,"tipo",t.target.multiple?a:a[0])},e.resetEntradaSelections]}},[t("option",{attrs:{value:""}},[e._v("Tipo")]),t("option",{attrs:{value:"proveedor"}},[e._v("Proveedor")]),t("option",{attrs:{value:"maquila"}},[e._v("Maquila")])]),t("select",{directives:[{name:"model",rawName:"v-model",value:e.newEntrada.proveedor,expression:"newEntrada.proveedor"}],attrs:{required:""},on:{change:function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.newEntrada,"proveedor",t.target.multiple?a:a[0])}}},[t("option",{attrs:{value:""}},[e._v(e._s("maquila"===e.newEntrada.tipo?"Maquila":"Proveedor"))]),e._l(e.filteredProveedoresEntrada,(function(a){return t("option",{key:a.id,domProps:{value:a.nombre}},[e._v(" "+e._s(a.nombre)+" ")])}))],2),t("select",{directives:[{name:"model",rawName:"v-model",value:e.newEntrada.medida,expression:"newEntrada.medida"}],attrs:{required:""},on:{change:function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.newEntrada,"medida",t.target.multiple?a:a[0])}}},[t("option",{attrs:{value:""}},[e._v("Medida")]),e._l(e.filteredMedidasEntrada,(function(a){return t("option",{key:a.id,domProps:{value:a.nombre}},[e._v(" "+e._s(a.nombre)+" ")])}))],2),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.newEntrada.kilos,expression:"newEntrada.kilos",modifiers:{number:!0}}],attrs:{type:"number",inputmode:"decimal",step:"0.1",pattern:"[0-9]*",placeholder:"Kilos",required:""},domProps:{value:e.newEntrada.kilos},on:{input:function(t){t.target.composing||e.$set(e.newEntrada,"kilos",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}}),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.newEntrada.precio,expression:"newEntrada.precio",modifiers:{number:!0}}],attrs:{type:"number",inputmode:"decimal",step:"0.01",pattern:"[0-9]*",placeholder:"Precio (opcional)"},domProps:{value:e.newEntrada.precio},on:{input:function(t){t.target.composing||e.$set(e.newEntrada,"precio",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}}),t("button",{on:{click:e.addEntrada}},[e._v("Agregar Entrada")])]),t("ul",{staticClass:"list"},e._l(e.entradas,(function(a,i){return t("li",{key:"entrada-"+i},[t("span",[e._v(e._s("maquila"===a.tipo?"Maquila":"Proveedor")+": "+e._s(a.proveedor)+" - "+e._s(a.medida)+e._s(a.precio?` ($${a.precio})`:"")+": "+e._s(e.formatNumber(a.kilos))+" kg")]),t("div",{staticClass:"action-buttons"},[t("button",{staticClass:"edit-btn",attrs:{title:"Editar"},on:{click:function(t){return e.editarEntrada(i)}}},[e._v("‚úèÔ∏è")]),t("button",{staticClass:"delete-btn",on:{click:function(t){return e.removeEntrada(i)}}},[e._v("√ó")])])])})),0),t("p",{staticClass:"total"},[e._v("Total Entradas: "+e._s(e.formatNumber(e.totalEntradas))+" kg")])])]),t("div",{staticClass:"summary"},[t("h3",[e._v("Resumen del D√≠a")]),t("p",[e._v("Total Entradas: "+e._s(e.formatNumber(e.totalEntradas))+" kg")]),t("p",[e._v("Total Salidas: "+e._s(e.formatNumber(e.totalSalidas))+" kg")]),t("h4",[e._v("Salidas clientes:")]),t("table",{staticClass:"medidas-summary"},[e._m(0),t("tbody",e._l(e.salidasProveedoresPorMedida,(function(a,i){return t("tr",{key:i},[t("td",[e._v(e._s(a.medida)+" ("+e._s(a.proveedor)+")")]),t("td",[e._v(e._s(e.formatNumber(a.total)))])])})),0)]),t("h4",[e._v("Salidas maquilas:")]),t("table",{staticClass:"medidas-summary"},[e._m(1),t("tbody",e._l(e.salidasMaquilasFlat,(function(a){return t("tr",{key:a.key},[t("td",[e._v(e._s(a.maquila))]),t("td",[e._v(e._s(a.medida))]),t("td",[e._v(e._s(e.formatNumber(a.total)))])])})),0)])]),t("button",{staticClass:"save-button",on:{click:e.saveReport}},[e._v(e._s(e.isEditing?"Actualizar":"Guardar")+" Informe del D√≠a")]),e.editandoEntrada?t("div",{staticClass:"modal-overlay",on:{click:function(t){return t.target!==t.currentTarget?null:e.cancelarEdicionEntrada.apply(null,arguments)}}},[t("div",{staticClass:"modal-content"},[t("h3",[e._v("Editar Entrada")]),null!==e.entradaEditIndex?t("div",{staticClass:"modal-info"},[t("p",[t("strong",[e._v("Proveedor:")]),e._v(" "+e._s(e.entradas[e.entradaEditIndex].proveedor))]),t("p",[t("strong",[e._v("Medida:")]),e._v(" "+e._s(e.entradas[e.entradaEditIndex].medida))])]):e._e(),t("div",{staticClass:"modal-form"},[t("label",[e._v(" Kilos: "),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.entradaEditData.kilos,expression:"entradaEditData.kilos",modifiers:{number:!0}}],attrs:{type:"number",inputmode:"decimal",step:"0.1",pattern:"[0-9]*",placeholder:"Kilos",required:""},domProps:{value:e.entradaEditData.kilos},on:{input:function(t){t.target.composing||e.$set(e.entradaEditData,"kilos",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})]),t("label",[e._v(" Precio (opcional): "),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.entradaEditData.precio,expression:"entradaEditData.precio",modifiers:{number:!0}}],attrs:{type:"number",inputmode:"decimal",step:"0.01",pattern:"[0-9]*",placeholder:"Precio"},domProps:{value:e.entradaEditData.precio},on:{input:function(t){t.target.composing||e.$set(e.entradaEditData,"precio",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})])]),t("div",{staticClass:"modal-actions"},[t("button",{staticClass:"btn-guardar",on:{click:e.guardarEdicionEntrada}},[e._v("Guardar")]),t("button",{staticClass:"btn-cancelar",on:{click:e.cancelarEdicionEntrada}},[e._v("Cancelar")])])])]):e._e()]):e._e()},o=[function(){var e=this,t=e._self._c;return t("thead",[t("tr",[t("th",[e._v("Medida")]),t("th",[e._v("Total (kg)")])])])},function(){var e=this,t=e._self._c;return t("thead",[t("tr",[t("th",[e._v("Maquila")]),t("th",[e._v("Medida")]),t("th",[e._v("Total (kg)")])])])}],s=(a("14d9"),a("13d5"),a("dc59")),r=a("1494"),n=a("74c9"),d=a("c1df"),l=a.n(d),c={name:"Sacadas",components:{BackButton:n["a"]},data(){return{currentDate:l()(),selectedDate:l()().format("YYYY-MM-DD"),entradas:[],salidas:[],proveedores:[],medidas:[],medidasConPrecio:[],medidasMaquilaDisponibles:[],newEntrada:{tipo:"proveedor",proveedor:"",medida:"",kilos:null,precio:null},newSalida:{tipo:"proveedor",proveedor:"",medida:"",kilos:null},isEditing:!1,sacadaId:null,isLoaded:!1,kilosDisponibles:null,editandoEntrada:!1,entradaEditIndex:null,entradaEditData:{kilos:null,precio:null}}},computed:{tienePedidoOrigen(){return!(!this.$route.query||!this.$route.query.pedidoFecha&&!this.$route.query.pedidoId)},formattedDate(){return this.currentDate.format("DD/MM/YYYY")},filteredProveedoresEntrada(){return this.proveedores.filter(e=>e.tipo===this.newEntrada.tipo)},filteredProveedoresSalida(){return this.proveedores.filter(e=>e.tipo===this.newSalida.tipo)},filteredMedidasEntrada(){if("maquila"===this.newEntrada.tipo){const e=this.proveedores.find(e=>e.nombre===this.newEntrada.proveedor);return e?this.medidas.filter(t=>"maquila"===t.tipo&&t.maquilaId===e.id):[]}{const e=this.proveedores.find(e=>e.nombre===this.newEntrada.proveedor);return e?this.medidas.filter(t=>t.proveedorId===e.id||!t.proveedorId&&"general"===t.tipo):this.medidas.filter(e=>"general"===e.tipo)}},filteredMedidasSalida(){if("maquila"===this.newSalida.tipo)return this.newSalida.proveedor?this.medidasMaquilaDisponibles:[];{const e=this.proveedores.find(e=>e.nombre===this.newSalida.proveedor);return e?this.medidasConPrecio.sort((e,t)=>{const a=e=>e.split(" ")[0];return a(e.nombre).localeCompare(a(t.nombre))}):[]}},totalEntradas(){return Number(this.entradas.reduce((e,t)=>e+t.kilos,0).toFixed(1))},totalSalidas(){return Number(this.salidas.reduce((e,t)=>e+t.kilos,0).toFixed(1))},salidasProveedoresPorMedida(){const e=this.salidas.filter(e=>"proveedor"===e.tipo).reduce((e,t)=>{const a=`${t.medida}-${t.proveedor}`;return e[a]||(e[a]={medida:t.medida,proveedor:t.proveedor,total:0,displayName:t.precio?`${t.medida} ($${t.precio})`:t.medida}),e[a].total+=t.kilos,e},{});return Object.values(e).sort((e,t)=>{const a=e.medida.split(" ($")[0],i=t.medida.split(" ($")[0];return a.localeCompare(i)})},salidasMaquilasPorMedida(){const e=this.salidas.filter(e=>"maquila"===e.tipo).reduce((e,t)=>{e[t.proveedor]||(e[t.proveedor]={});const a=t.precio?`${t.medida} ($${t.precio})`:t.medida;return e[t.proveedor][a]||(e[t.proveedor][a]=0),e[t.proveedor][a]+=t.kilos,e},{});for(const t in e){const a={};Object.keys(e[t]).sort((e,t)=>{const a=e.split(" ($")[0],i=t.split(" ($")[0];return a.localeCompare(i)}).forEach(i=>{a[i]=e[t][i]}),e[t]=a}return e},salidasMaquilasFlat(){const e=[];return Object.entries(this.salidasMaquilasPorMedida).forEach(([t,a])=>{Object.entries(a).forEach(([a,i])=>{e.push({key:`${t}-${a}`,maquila:t,medida:a,total:i})})}),e},isSalidaValid(){return this.newSalida.tipo&&this.newSalida.proveedor&&this.newSalida.medida&&this.newSalida.kilos&&this.newSalida.kilos>0&&null!==this.kilosDisponibles&&this.newSalida.kilos<=this.kilosDisponibles}},methods:{regresarAlPedido(){const e=this.$route.query.pedidoTipo||"limpio",t=this.$route.query.pedidoFecha,a=this.$route.query.pedidoId;if("limpio"===e){const e=a?{edit:"true",id:a,fecha:t}:{fecha:t};this.$router.push({path:"/procesos/pedidos/limpio",query:e})}else if("crudo"===e){const e=a?{edit:"true",id:a,fecha:t}:{fecha:t};this.$router.push({path:"/procesos/pedidos/crudo",query:e})}else this.$router.push("/procesos/pedidos")},async loadProveedores(){const e=await Object(r["g"])(Object(r["c"])(s["a"],"proveedores"));this.proveedores=e.docs.map(e=>({id:e.id,...e.data()}))},async loadMedidas(){const e=await Object(r["g"])(Object(r["c"])(s["a"],"medidas"));this.medidas=e.docs.map(e=>({id:e.id,...e.data()}))},async checkExistingSacada(){const e=Object(r["c"])(s["a"],"sacadas"),t=this.currentDate.clone().startOf("day"),a=this.currentDate.clone().endOf("day"),i=Object(r["o"])(e,Object(r["t"])("fecha",">=",t.toDate()),Object(r["t"])("fecha","<=",a.toDate())),o=await Object(r["g"])(i);return!o.empty},resetEntradaSelections(){this.newEntrada.proveedor="",this.newEntrada.medida=""},resetSalidaSelections(){this.newSalida.proveedor="",this.newSalida.medida="",this.kilosDisponibles=null,this.medidasConPrecio=[],this.medidasMaquilaDisponibles=[]},limpiarSeleccionSalida(){this.newSalida={tipo:"proveedor",proveedor:"",medida:"",kilos:null},this.kilosDisponibles=null,this.medidasConPrecio=[],this.medidasMaquilaDisponibles=[]},async refrescarMedidasDespuesSalida(e){return this.medidasConPrecio=[],await this.$nextTick(),this.medidasConPrecio=await this.getMedidasConPrecio(e),this.medidasConPrecio},async refrescarMedidasManual(){this.newSalida.proveedor&&"proveedor"===this.newSalida.tipo&&(await this.refrescarMedidasDespuesSalida(this.newSalida.proveedor),this.newSalida.medida&&await this.updateKilosDisponibles())},async addEntrada(){if(this.newEntrada.tipo&&this.newEntrada.proveedor&&this.newEntrada.medida&&this.newEntrada.kilos){const e=this.newEntrada.proveedor,t=this.newEntrada.tipo;this.entradas.push({tipo:this.newEntrada.tipo,proveedor:this.newEntrada.proveedor,medida:this.newEntrada.medida,kilos:Number(this.newEntrada.kilos.toFixed(1)),precio:this.newEntrada.precio?Number(this.newEntrada.precio.toFixed(2)):null}),this.newEntrada={tipo:t,proveedor:e,medida:"",kilos:null,precio:null},this.newSalida.proveedor===e&&("proveedor"===this.newSalida.tipo?this.medidasConPrecio=await this.getMedidasConPrecio(e):"maquila"===this.newSalida.tipo&&(this.medidasMaquilaDisponibles=await this.getMedidasDisponiblesMaquila(e))),await this.updateKilosDisponibles()}},async addSalida(){if(this.isSalidaValid&&this.newSalida.kilos<=this.kilosDisponibles){let e=this.newSalida.medida,t=!1,a=null,i=this.newSalida.medida;if(e.startsWith("üïê ")&&(t=!0,e=e.substring(2).trim()),e.includes(" ($")){const t=e.match(/\(\$(\d+(?:\.\d+)?)\)/);t&&(a=Number(t[1]),i=e.split(" ($")[0])}else e.includes(" - (")&&(i=e.split(" - (")[0],a=null);if(!t&&"proveedor"===this.newSalida.tipo&&null!==a){const e=this.medidasConPrecio.find(e=>e.nombreOriginal.split(" ($")[0]===i&&e.esElMasAntiguo);if(e){const t=confirm(`‚ö†Ô∏è ADVERTENCIA: Est√°s registrando una salida con precio que NO es el m√°s antiguo.\n\nMedida seleccionada: ${i} ($${a})\nExiste una m√°s antigua disponible: ${e.nombre.replace("üïê ","").split(" - (")[0]}\n\nSe recomienda usar primero el precio m√°s antiguo para un mejor control de inventario FIFO.\n\n¬øDeseas continuar registrando esta salida?`);if(!t)return}}if(a=null,i=this.newSalida.medida,e=this.newSalida.medida,e.startsWith("üïê ")&&(e=e.substring(2).trim()),e.includes(" ($")){const t=e.match(/\(\$(\d+(?:\.\d+)?)\)/);t&&(a=Number(t[1]),i=e.split(" ($")[0])}else e.includes(" - (")&&(i=e.split(" - (")[0],a=null);const o=this.newSalida.proveedor,s=this.newSalida.tipo;this.salidas.push({tipo:this.newSalida.tipo,proveedor:this.newSalida.proveedor,medida:i,precio:a,kilos:Number(this.newSalida.kilos.toFixed(1))}),this.newSalida={tipo:s,proveedor:o,medida:"",kilos:null},o&&("proveedor"===s?await this.refrescarMedidasDespuesSalida(o):"maquila"===s&&(this.medidasMaquilaDisponibles=await this.getMedidasDisponiblesMaquila(o)),this.kilosDisponibles=null),await this.updateKilosDisponibles()}else this.newSalida.kilos>this.kilosDisponibles&&alert(`No hay suficientes kilos disponibles. Kilos disponibles: ${this.kilosDisponibles.toFixed(1)} kg`)},async updateKilosDisponibles(){this.newSalida.proveedor&&this.newSalida.medida?this.kilosDisponibles=await this.getKilosDisponibles(this.newSalida.proveedor,this.newSalida.medida):this.kilosDisponibles=null},async getKilosDisponibles(e,t){let a=0,i=0,o=0,n=null,d=t;if(t.startsWith("üïê ")&&(t=t.substring(2).trim()),t.includes(" ($")){const e=t.match(/\(\$(\d+(?:\.\d+)?)\)/);e&&(n=Number(e[1]),d=t.split(" ($")[0])}else t.includes(" - (")&&(d=t.split(" - (")[0],n=null);const c=Object(r["c"])(s["a"],"sacadas"),u=await Object(r["g"])(c),p=u.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>e.fecha.toDate()-t.fecha.toDate()),m=this.currentDate.clone().endOf("day");return p.forEach(t=>{const s=t.fecha instanceof Date?t.fecha:t.fecha.toDate();l()(s).isSameOrBefore(m)&&(t.entradas.forEach(t=>{const o=t.proveedor===e&&t.medida===d,s=null===n?null===t.precio||void 0===t.precio:t.precio===n;o&&s&&(a+=t.kilos,i+=t.kilos)}),t.salidas.forEach(t=>{const i=t.proveedor===e&&t.medida===d,s=null===n?null===t.precio||void 0===t.precio:t.precio===n;i&&s&&(a-=t.kilos,o+=t.kilos)}))}),Number(a.toFixed(1))},editarEntrada(e){this.entradaEditIndex=e;const t=this.entradas[e];this.entradaEditData={kilos:t.kilos,precio:t.precio},this.editandoEntrada=!0},cancelarEdicionEntrada(){this.editandoEntrada=!1,this.entradaEditIndex=null,this.entradaEditData={kilos:null,precio:null}},async guardarEdicionEntrada(){if(null!==this.entradaEditIndex&&this.entradaEditData.kilos&&this.entradaEditData.kilos>0){const e=this.entradas[this.entradaEditIndex],t=e.proveedor;e.kilos=Number(this.entradaEditData.kilos.toFixed(1)),e.precio=this.entradaEditData.precio?Number(this.entradaEditData.precio.toFixed(2)):null,this.newSalida.proveedor===t&&("proveedor"===this.newSalida.tipo?this.medidasConPrecio=await this.getMedidasConPrecio(t):"maquila"===this.newSalida.tipo&&(this.medidasMaquilaDisponibles=await this.getMedidasDisponiblesMaquila(t))),await this.updateKilosDisponibles(),this.cancelarEdicionEntrada()}},async removeEntrada(e){const t=this.entradas[e];this.entradas.splice(e,1),this.newSalida.proveedor===t.proveedor&&("proveedor"===this.newSalida.tipo?this.medidasConPrecio=await this.getMedidasConPrecio(t.proveedor):"maquila"===this.newSalida.tipo&&(this.medidasMaquilaDisponibles=await this.getMedidasDisponiblesMaquila(t.proveedor))),await this.updateKilosDisponibles()},async removeSalida(e){const t=this.salidas[e];this.salidas.splice(e,1),this.newSalida.proveedor===t.proveedor&&("proveedor"===this.newSalida.tipo?this.medidasConPrecio=await this.getMedidasConPrecio(t.proveedor):"maquila"===this.newSalida.tipo&&(this.medidasMaquilaDisponibles=await this.getMedidasDisponiblesMaquila(t.proveedor))),await this.updateKilosDisponibles()},formatNumber(e){return e.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})},async loadSacada(e){const t=Object(r["e"])(s["a"],"sacadas",e),a=await Object(r["f"])(t);if(a.exists()){const t=a.data();this.currentDate=l()(t.fecha.toDate()),this.entradas=t.entradas||[],this.salidas=t.salidas||[],this.sacadaId=e,this.isEditing=!0,await this.updateKilosDisponibles()}},async saveReport(){try{if(!this.isEditing){const e=await this.checkExistingSacada();if(e)return void alert("Ya existe un registro de sacada para esta fecha. No se puede crear uno nuevo.")}const e={fecha:this.currentDate.toDate(),entradas:this.entradas,salidas:this.salidas,totalEntradas:this.totalEntradas,totalSalidas:this.totalSalidas};this.isEditing?(await Object(r["s"])(Object(r["e"])(s["a"],"sacadas",this.sacadaId),e),alert("Informe del d√≠a actualizado exitosamente")):(await Object(r["b"])(Object(r["c"])(s["a"],"sacadas"),e),alert("Informe del d√≠a guardado exitosamente")),this.$router.push("/sacadas")}catch(e){console.error("Error al guardar/actualizar el documento: ",e),alert("Error al guardar/actualizar el informe del d√≠a: "+e.message)}},updateCurrentDate(){this.currentDate=l()(this.selectedDate)},async getMedidasConPrecio(e){const t=new Map;this.currentDate.clone().endOf("day");const a=Object(r["c"])(s["a"],"sacadas"),i=await Object(r["g"])(a),o=i.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>e.fecha.toDate()-t.fecha.toDate()),n=(e,a,i,o,s=!0)=>{const r=null!==a&&void 0!==a?a:null,n=null!==r?`${e} ($${r})`:e;t.has(n)||t.set(n,{medida:e,precio:r,kilos:0,nombre:n,primeraFecha:null,esElMasAntiguo:!1});const d=t.get(n);d.kilos;d.kilos+=s?i:-i,s&&null!==r&&(null===d.primeraFecha||o<d.primeraFecha)&&(d.primeraFecha=o)},d=this.currentDate.clone().startOf("day");o.forEach(t=>{const a=t.fecha instanceof Date?t.fecha:t.fecha.toDate(),i=l()(a);i.isBefore(d)&&(t.entradas.forEach(t=>{t.proveedor===e&&n(t.medida,t.precio,t.kilos,a,!0)}),t.salidas.forEach(t=>{t.proveedor===e&&n(t.medida,t.precio,t.kilos,a,!1)}))}),this.entradas.forEach((t,a)=>{if(t.proveedor===e){const e=this.currentDate.toDate();n(t.medida,t.precio,t.kilos,e,!0)}}),this.salidas.forEach((t,a)=>{if(t.proveedor===e){const e=this.currentDate.toDate();n(t.medida,t.precio,t.kilos,e,!1)}});const c=new Map;for(const[s,r]of t)if(r.kilos>0&&null!==r.precio&&null!==r.primeraFecha){const e=r.medida;c.has(e)||c.set(e,[]),c.get(e).push(r)}for(const[s,r]of c)if(r.length>1){const e=r.reduce((e,t)=>t.primeraFecha<e.primeraFecha?t:e);e.esElMasAntiguo=!0}const u=[];for(const[s,r]of t)if(r.kilos>0){let e=r.nombre;if(null!==r.precio&&null!==r.primeraFecha){const t=l()(r.primeraFecha).format("DD/MM/YY");e=r.esElMasAntiguo?`üïê ${r.medida} ($${r.precio}) - M√°s antiguo (${t})`:`${r.medida} ($${r.precio}) - (${t})`}else null===r.precio&&(e=r.medida+" - (Sin precio)");u.push({id:r.nombre,nombre:e,nombreOriginal:r.nombre,tipo:"general",precio:r.precio,kilos:r.kilos,primeraFecha:r.primeraFecha,esElMasAntiguo:r.esElMasAntiguo||!1})}return u.sort((e,t)=>{const a=e.nombreOriginal.split(" ($")[0],i=t.nombreOriginal.split(" ($")[0];return a!==i?a.localeCompare(i):null===e.precio&&null!==t.precio?-1:null!==e.precio&&null===t.precio?1:e.primeraFecha&&t.primeraFecha?e.primeraFecha-t.primeraFecha:0})},async getMedidasDisponiblesMaquila(e){const t=this.proveedores.find(t=>t.nombre===e&&"maquila"===t.tipo);if(!t)return[];const a=this.medidas.filter(e=>"maquila"===e.tipo&&e.maquilaId===t.id);if(!a.length)return[];const i=new Map,o=(e,t)=>{if(!e)return;const a=i.get(e)||0;i.set(e,a+(Number(t)||0))},n=Object(r["c"])(s["a"],"sacadas"),d=await Object(r["g"])(n),c=d.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>e.fecha.toDate()-t.fecha.toDate()),u=this.currentDate.clone().startOf("day");return c.forEach(t=>{const a=t.fecha instanceof Date?t.fecha:t.fecha.toDate(),i=l()(a);i.isBefore(u)&&((t.entradas||[]).forEach(t=>{"maquila"===t.tipo&&t.proveedor===e&&o(t.medida,t.kilos)}),(t.salidas||[]).forEach(t=>{"maquila"===t.tipo&&t.proveedor===e&&o(t.medida,-(t.kilos||0))}))}),this.entradas.forEach(t=>{"maquila"===t.tipo&&t.proveedor===e&&o(t.medida,t.kilos)}),this.salidas.forEach(t=>{"maquila"===t.tipo&&t.proveedor===e&&o(t.medida,-(t.kilos||0))}),a.map(e=>{const t=Number(i.get(e.nombre)||0);return{...e,kilos:Number(t.toFixed(1))}}).filter(e=>e.kilos>0).sort((e,t)=>e.nombre.localeCompare(t.nombre))}},async created(){this.$route.query&&this.$route.query.fecha&&(this.selectedDate=this.$route.query.fecha,this.updateCurrentDate()),await this.loadProveedores(),await this.loadMedidas(),this.$route.params.id&&await this.loadSacada(this.$route.params.id),this.isLoaded=!0},watch:{"newSalida.medida":"updateKilosDisponibles","newSalida.kilos":"updateKilosDisponibles",async"newSalida.proveedor"(e){this.updateKilosDisponibles();const t=this.newSalida.tipo;if(!e)return this.medidasConPrecio=[],void(this.medidasMaquilaDisponibles=[]);"proveedor"===t?(this.medidasMaquilaDisponibles=[],this.medidasConPrecio=await this.getMedidasConPrecio(e)):"maquila"===t?(this.medidasConPrecio=[],this.medidasMaquilaDisponibles=await this.getMedidasDisponiblesMaquila(e)):(this.medidasConPrecio=[],this.medidasMaquilaDisponibles=[])}}},u=c,p=(a("e227"),a("2877")),m=Object(p["a"])(u,i,o,!1,null,"340bb35e",null);t["a"]=m.exports},"64fd":function(e,t,a){},"6a8a":function(e,t,a){"use strict";a("b8c3")},"6e51":function(e,t,a){},9302:function(e,t,a){"use strict";var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"sacadas-menu-container"},[t("h1",[e._v("Men√∫ de Sacadas")]),t("div",{staticClass:"actions-container"},[t("router-link",{staticClass:"action-button new-sacada-btn",attrs:{to:"/sacadas/new"}},[e._v(" Nueva Sacada ")]),t("router-link",{staticClass:"action-button",attrs:{to:"/gestionar-productos"}},[e._v(" Gestionar Productos ")]),t("button",{staticClass:"action-button",on:{click:e.showHistorialModal}},[e._v(" Ver Historial de Productos ")])],1),t("div",{staticClass:"sacadas-list"},[t("h2",[e._v("Registros de Sacadas")]),e.isLoading?t("div",{staticClass:"loading"},[e._v("Cargando registros...")]):0===e.sacadas.length?t("div",{staticClass:"no-records"},[e._v(" No hay registros de sacadas. ")]):t("ul",e._l(e.paginatedSacadas,(function(a){return t("li",{key:a.id,staticClass:"sacada-item"},[t("div",{staticClass:"sacada-content",on:{click:function(t){return e.editSacada(a.id)}}},[t("span",{staticClass:"sacada-date"},[e._v(e._s(e.formatDate(a.fecha)))]),t("div",{staticClass:"sacada-summary"},[t("div",{staticClass:"sacada-entry"},[t("span",{staticClass:"sacada-label"},[e._v("Entradas:")]),t("span",{staticClass:"sacada-value"},[e._v(e._s(e.formatNumber(a.totalEntradas))+" kg")])]),t("div",{staticClass:"sacada-entry"},[t("span",{staticClass:"sacada-label"},[e._v("Salidas:")]),t("span",{staticClass:"sacada-value"},[e._v(e._s(e.formatNumber(a.totalSalidas))+" kg")])])])]),t("div",{staticClass:"sacada-actions"},[t("button",{staticClass:"delete-btn",on:{click:function(t){return t.stopPropagation(),e.deleteSacada(a.id)}}},[e._v("Borrar")])])])})),0),t("div",{staticClass:"pagination"},[t("button",{attrs:{disabled:1===e.currentPage},on:{click:e.prevPage}},[e._v("Anterior")]),t("span",[e._v("P√°gina "+e._s(e.currentPage)+" de "+e._s(e.totalPages))]),t("button",{attrs:{disabled:e.currentPage===e.totalPages},on:{click:e.nextPage}},[e._v("Siguiente")])])]),t("HistorialProductoModal",{attrs:{"is-open":e.isHistorialModalOpen,proveedores:e.proveedores,medidas:e.medidas},on:{close:e.closeHistorialModal}})],1)},o=[],s=(a("14d9"),a("fa1c"),a("dc59")),r=a("1494"),n=a("c1df"),d=a.n(n),l=a("9df4"),c={name:"SacadasMenu",components:{HistorialProductoModal:l["a"]},data(){return{sacadas:[],isLoading:!0,currentPage:1,itemsPerPage:10,isHistorialModalOpen:!1,proveedores:[],medidas:[]}},computed:{paginatedSacadas(){const e=(this.currentPage-1)*this.itemsPerPage,t=e+this.itemsPerPage;return this.sacadas.slice(e,t)},totalPages(){return Math.ceil(this.sacadas.length/this.itemsPerPage)}},methods:{async loadSacadas(){try{this.isLoading=!0;const e=Object(r["c"])(s["a"],"sacadas"),t=Object(r["o"])(e,Object(r["l"])("fecha","desc")),a=await Object(r["g"])(t);this.sacadas=a.docs.map(e=>{const t=e.data();let a;return a=t.fecha instanceof Date?d()(t.fecha).toDate():t.fecha&&"function"===typeof t.fecha.toDate?d()(t.fecha.toDate()).toDate():d()(t.fecha).toDate(),a=d()(a).toDate(),{id:e.id,...t,fecha:a,totalEntradas:t.totalEntradas||0,totalSalidas:t.totalSalidas||0}})}catch(e){console.error("Error al cargar sacadas: ",e),this.sacadas=[]}finally{this.isLoading=!1}},formatDate(e){return d()(e).format("DD [de] MMMM [de] YYYY")},formatNumber(e){return(e||0).toLocaleString("es-ES",{minimumFractionDigits:1,maximumFractionDigits:1})},editSacada(e){this.$router.push("/sacadas/"+e)},async deleteSacada(e){if(confirm("¬øEst√°s seguro de que quieres borrar este registro de sacadas?"))try{await Object(r["d"])(Object(r["e"])(s["a"],"sacadas",e)),this.sacadas=this.sacadas.filter(t=>t.id!==e),alert("Registro de sacadas borrado con √©xito")}catch(t){console.error("Error al borrar el registro de sacadas: ",t),alert("Error al borrar el registro de sacadas")}},prevPage(){this.currentPage>1&&this.currentPage--},nextPage(){this.currentPage<this.totalPages&&this.currentPage++},async loadProveedores(){try{const e=await Object(r["g"])(Object(r["c"])(s["a"],"proveedores"));this.proveedores=e.docs.map(e=>({id:e.id,...e.data()}))}catch(e){console.error("Error al cargar proveedores:",e)}},async loadMedidas(){try{const e=await Object(r["g"])(Object(r["c"])(s["a"],"medidas"));this.medidas=e.docs.map(e=>({id:e.id,...e.data()}))}catch(e){console.error("Error al cargar medidas:",e)}},showHistorialModal(){this.isHistorialModalOpen=!0},closeHistorialModal(){this.isHistorialModalOpen=!1}},async mounted(){await Promise.all([this.loadSacadas(),this.loadProveedores(),this.loadMedidas()])}},u=c,p=(a("ebeb"),a("2877")),m=Object(p["a"])(u,i,o,!1,null,"0ec6c134",null);t["a"]=m.exports},"98cf":function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("div",{staticClass:"sale-note"},[t("div",{staticClass:"back-button-container"},[t("BackButton",{attrs:{to:"/NoteMenu"}})],1),t("h2",{staticClass:"sale-note-title"},[e._v("Nota de Venta")]),t("div",{staticClass:"folio-date"},[t("p",[t("strong",[e._v("Folio:")]),e._v(" "+e._s(e.formattedFolio))]),t("p",[t("strong",[e._v("Fecha de Creaci√≥n:")]),e._v(" "+e._s(e.formattedCreationDate))])]),t("form",{on:{submit:function(t){return t.preventDefault(),e.addProduct.apply(null,arguments)}}},[t("div",{staticClass:"form-row"},[t("div",[t("label",{attrs:{for:"client"}},[e._v("Cliente:")]),t("select",{directives:[{name:"model",rawName:"v-model",value:e.client,expression:"client"}],attrs:{required:""},on:{change:function(t){var a=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.client=t.target.multiple?a:a[0]}}},e._l(e.clients,(function(a){return t("option",{key:a.id,domProps:{value:a.name}},[e._v(" "+e._s(a.name)+" ")])})),0),e.clientBalance>0?t("div",{staticClass:"client-balance-indicator"},[t("span",{staticClass:"balance-text"},[e._v("Saldo a favor: $"+e._s(e.formatNumber(e.clientBalance)))])]):e._e()]),t("div",[t("label",{attrs:{for:"date"}},[e._v("Fecha:")]),t("DatePicker",{attrs:{"value-type":"format",format:"DD MMMM YYYY",placeholder:"Selecciona una fecha"},model:{value:e.currentDate,callback:function(t){e.currentDate=t},expression:"currentDate"}})],1)]),t("div",{staticClass:"form-row"},[t("div",[t("label",{attrs:{for:"kilos"}},[e._v("Kilos:")]),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.newProduct.kilos,expression:"newProduct.kilos",modifiers:{number:!0}}],attrs:{type:"number",step:"0.01",required:""},domProps:{value:e.newProduct.kilos},on:{input:function(t){t.target.composing||e.$set(e.newProduct,"kilos",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})]),t("div",[t("label",{attrs:{for:"product"}},[e._v("Producto:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.newProduct.product,expression:"newProduct.product"}],attrs:{type:"text",id:"product",required:""},domProps:{value:e.newProduct.product},on:{input:function(t){t.target.composing||e.$set(e.newProduct,"product",t.target.value)}}})]),t("div",[t("label",{attrs:{for:"pricePerKilo"}},[e._v("Precio por Kilo:")]),t("input",{directives:[{name:"model",rawName:"v-model",value:e.newProduct.pricePerKilo,expression:"newProduct.pricePerKilo"}],attrs:{type:"number",id:"pricePerKilo",required:""},domProps:{value:e.newProduct.pricePerKilo},on:{input:function(t){t.target.composing||e.$set(e.newProduct,"pricePerKilo",t.target.value)}}})]),t("button",{attrs:{type:"submit"}},[e._v("Agregar Producto")])])]),e.products.length||e.abonos.length?t("div",[t("div",{ref:"printSection",staticClass:"print-section"},[t("div",{staticClass:"folio-date"},[t("p",[t("strong",[e._v("Folio:")]),e._v(" "+e._s(e.formattedFolio))]),t("p",[t("strong",[e._v("Fecha de Creaci√≥n:")]),e._v(" "+e._s(e.formattedCreationDate))])]),e.products.length?t("div",[t("h3",[e._v("Resumen")]),t("table",[e._m(0),t("tbody",e._l(e.products,(function(a,i){return t("tr",{key:i,on:{touchstart:function(t){return e.startLongPress(i)},touchend:e.endLongPress,touchmove:e.endLongPress}},[e.editIndex===i?[t("td",[t("input",{directives:[{name:"model",rawName:"v-model",value:e.editProduct.product,expression:"editProduct.product"}],attrs:{type:"text"},domProps:{value:e.editProduct.product},on:{input:function(t){t.target.composing||e.$set(e.editProduct,"product",t.target.value)}}})]),t("td",[t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.editProduct.kilos,expression:"editProduct.kilos",modifiers:{number:!0}}],attrs:{type:"number"},domProps:{value:e.editProduct.kilos},on:{input:function(t){t.target.composing||e.$set(e.editProduct,"kilos",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})]),t("td",[t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.editProduct.pricePerKilo,expression:"editProduct.pricePerKilo",modifiers:{number:!0}}],attrs:{type:"number"},domProps:{value:e.editProduct.pricePerKilo},on:{input:function(t){t.target.composing||e.$set(e.editProduct,"pricePerKilo",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})]),t("td",[e._v("$"+e._s(e.formatNumber(e.editProduct.kilos*e.editProduct.pricePerKilo)))]),t("td",{staticClass:"action-column"},[t("button",{on:{click:e.confirmEdit}},[t("span",[e._v("‚úî")])]),t("button",{on:{click:e.cancelEdit}},[t("span",[e._v("‚ùå")])])])]:[t("td",[e._v(e._s(a.product))]),t("td",[e._v(e._s(e.formatNumber(a.kilos)))]),t("td",[e._v("$"+e._s(e.formatNumber(a.pricePerKilo)))]),t("td",[e._v("$"+e._s(e.formatNumber(a.total)))]),t("td",{staticClass:"action-column"},[t("button",{on:{click:function(t){return e.editProductDetails(i)}}},[e._v("Editar")]),t("button",{on:{click:function(t){return e.removeProduct(i)}}},[e._v("Borrar")])])]],2)})),0)]),t("div",{staticClass:"flete-section"},[t("div",{staticClass:"form-row"},[t("div",[t("label",{attrs:{for:"flete"}},[e._v("Flete ($):")]),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.flete,expression:"flete",modifiers:{number:!0}}],attrs:{type:"number",id:"flete",step:"0.01",min:"0"},domProps:{value:e.flete},on:{input:function(t){t.target.composing||(e.flete=e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})])])]),t("div",{staticClass:"total-general"},[t("h3",[e._v("Subtotal: $"+e._s(e.formatNumber(e.grandTotal)))]),e.flete>0?t("h3",[e._v("Flete: -$"+e._s(e.formatNumber(e.flete)))]):e._e(),t("h3",{staticClass:"total-final"},[e._v("Total General: $"+e._s(e.formatNumber(e.totalFinal)))])])]):e._e(),t("div",{staticClass:"abonos-container"},[t("div",{staticClass:"abonos-section"},[t("h3",[e._v("Registrar Abonos")]),t("form",{on:{submit:function(t){return t.preventDefault(),e.addAbono.apply(null,arguments)}}},[t("div",{staticClass:"form-row"},[t("div",[t("label",{attrs:{for:"abonoMonto"}},[e._v("Monto del Abono:")]),t("input",{directives:[{name:"model",rawName:"v-model.number",value:e.newAbono.monto,expression:"newAbono.monto",modifiers:{number:!0}}],attrs:{type:"number",id:"abonoMonto",required:""},domProps:{value:e.newAbono.monto},on:{input:function(t){t.target.composing||e.$set(e.newAbono,"monto",e._n(t.target.value))},blur:function(t){return e.$forceUpdate()}}})]),t("div",[t("label",{attrs:{for:"abonoFecha"}},[e._v("Fecha del Abono:")]),t("DatePicker",{attrs:{"value-type":"format",format:"DD MMMM YYYY",placeholder:"Selecciona una fecha"},model:{value:e.newAbono.fecha,callback:function(t){e.$set(e.newAbono,"fecha",t)},expression:"newAbono.fecha"}})],1)]),t("button",{staticClass:"add-abono-button",attrs:{type:"submit"}},[e._v("Agregar Abono")])]),e.abonos.length?t("div",[t("h3",[e._v("Abonos Realizados")]),t("div",{staticClass:"table-responsive"},[t("table",{staticClass:"abonos-table"},[e._m(1),t("tbody",e._l(e.abonos,(function(a,i){return t("tr",{key:i},[t("td",[e._v("$"+e._s(e.formatNumber(a.monto)))]),t("td",[e._v(e._s(e.formatDate(a.fecha)))]),t("td",{staticClass:"action-column-abonos"},[t("button",{staticClass:"delete-abono-button",on:{click:function(t){return e.confirmDeleteAbono(i)}}},[t("span",[e._v("üóëÔ∏è")])])])])})),0)])]),t("div",{staticClass:"abonos-summary"},[t("p",[t("strong",[e._v("Total Abonado:")]),e._v(" $"+e._s(e.formatNumber(e.totalAbonado)))]),t("p",[t("strong",[e._v("Saldo Restante:")]),e._v(" $"+e._s(e.formatNumber(e.saldoRestante)))]),t("p",{staticClass:"estado-pago",class:{pagado:e.isPaid,"no-pagado":!e.isPaid}},[t("strong",[e._v("Estado:")]),e._v(" "+e._s(e.isPaid?"Pagada":"No Pagada")+" ")])])]):e._e()])]),t("div",{staticClass:"action-buttons"},[t("div",{staticClass:"button-column"},[t("button",{on:{click:e.exportPDF}},[e._v("Exportar a PDF")]),t("button",{on:{click:e.printSection}},[e._v("Imprimir")])]),t("div",{staticClass:"button-column"},[t("button",{on:{click:e.saveNote}},[e._v("Guardar Nota")]),t("button",{staticClass:"delete-note-button",on:{click:e.deleteNote}},[e._v("Eliminar Nota")])])])]),e.showMobileActions?t("div",{staticClass:"mobile-actions-modal"},[t("button",{on:{click:function(t){return e.editProductDetails(e.selectedProductIndex)}}},[e._v("Editar")]),t("button",{on:{click:function(t){return e.removeProduct(e.selectedProductIndex)}}},[e._v("Borrar")]),-1!==e.editIndex?t("button",{on:{click:e.confirmEdit}},[e._v("Confirmar Edici√≥n")]):e._e(),t("button",{on:{click:e.cancelMobileActions}},[e._v("Cancelar")])]):e._e(),e.showDeleteAbonoModal?t("div",{staticClass:"modal"},[t("div",{staticClass:"modal-content"},[t("h2",[e._v("Confirmar Eliminaci√≥n")]),t("p",[e._v("¬øEst√°s seguro de que quieres eliminar este abono?")]),t("div",{staticClass:"modal-buttons"},[t("button",{staticClass:"confirm-delete-button",on:{click:e.deleteAbono}},[e._v("Confirmar")]),t("button",{staticClass:"cancel-button",on:{click:e.closeDeleteAbonoModal}},[e._v("Cancelar")])])])]):e._e()]):e._e()])},o=[function(){var e=this,t=e._self._c;return t("thead",[t("tr",[t("th",[e._v("Producto")]),t("th",[e._v("Kg")]),t("th",[e._v("Precio")]),t("th",[e._v("Total")]),t("th",{staticClass:"action-column"},[e._v("Accion")])])])},function(){var e=this,t=e._self._c;return t("thead",[t("tr",[t("th",[e._v("Monto")]),t("th",[e._v("Fecha")]),t("th",{staticClass:"action-column-abonos"},[e._v("Acciones")])])])}],s=(a("14d9"),a("13d5"),a("74c9")),r=a("ec45"),n=(a("411c"),a("d67e")),d=a.n(n),l=a("4e00"),c=a("dc59"),u=a("1494"),p={components:{DatePicker:r["a"],AddClient:l["a"],BackButton:s["a"]},data(){const e=new Date;return{folio:Math.floor(1e4*Math.random()),client:"",currentDate:e.toISOString().substr(0,10),newProduct:{product:"",kilos:null,pricePerKilo:null,total:0},editProduct:{product:"",kilos:0,pricePerKilo:0,total:0},products:[],clients:[],editIndex:-1,newAbono:{monto:null,fecha:e.toISOString().substr(0,10)},abonos:[],flete:0,isPaid:!1,creationDate:e.toISOString().substr(0,10),noteId:null,longPressTimer:null,showMobileActions:!1,selectedProductIndex:null,clientBalance:0,showDeleteAbonoModal:!1,selectedAbonoIndex:null}},computed:{grandTotal(){return this.products.reduce((e,t)=>e+t.total,0)},totalFinal(){return this.grandTotal-(this.flete||0)},totalAbonado(){return this.abonos.reduce((e,t)=>e+Number(t.monto),0)},saldoRestante(){return this.totalFinal-this.totalAbonado},formattedFolio(){return"F-"+this.folio.toString().padStart(4,"0")},formattedCreationDate(){return this.formatDate(this.creationDate)}},watch:{saldoRestante(e){this.isPaid=e<=0},async client(e){e&&await this.fetchClientBalance(e)}},methods:{async deleteNote(){if(this.noteId){if(confirm("¬øEst√°s seguro de que quieres eliminar esta nota?"))try{await Object(u["d"])(Object(u["e"])(c["a"],"notes",this.noteId)),alert("Nota eliminada con √©xito"),this.$router.push({name:"NoteMenu"})}catch(e){console.error("Error al eliminar la nota: ",e),alert("Error al eliminar la nota: "+e.message)}}else alert("El ID de la nota no est√° definido")},async saveNote(){try{const e={folio:this.folio,client:this.client,currentDate:this.currentDate,products:this.products,abonos:this.abonos,flete:this.flete,isPaid:this.isPaid,creationDate:this.creationDate};if(this.noteId)await Object(u["r"])(Object(u["e"])(c["a"],"notes",this.noteId),e);else{const t=await Object(u["b"])(Object(u["c"])(c["a"],"notes"),e);this.noteId=t.id}alert("Nota guardada exitosamente."),this.$router.push({name:"NoteMenu"})}catch(e){console.error("Error saving note: ",e),alert("Hubo un error al guardar la nota.")}},async addProduct(){this.newProduct.total=this.newProduct.kilos*this.newProduct.pricePerKilo,this.products.push({...this.newProduct}),this.resetForm(),1===this.products.length&&this.client&&(await this.fetchClientBalance(this.client),await this.applyClientBalanceAsAbono())},resetForm(){this.newProduct={product:"",kilos:null,pricePerKilo:null,total:0}},removeProduct(e){this.products.splice(e,1),this.showMobileActions=!1},editProductDetails(e){this.editIndex=e,this.editProduct={...this.products[e]}},confirmEdit(){-1!==this.editIndex&&(this.editProduct.total=this.editProduct.kilos*this.editProduct.pricePerKilo,this.products[this.editIndex]={...this.editProduct},this.editIndex=-1,this.showMobileActions=!1)},cancelEdit(){this.editIndex=-1},async fetchClients(){try{const e=await Object(u["g"])(Object(u["c"])(c["a"],"clients"));this.clients=e.docs.map(e=>({id:e.id,...e.data()}))}catch(e){console.error("Error fetching clients: ",e)}},async fetchClientBalance(e){if(e)try{const t=Object(u["e"])(c["a"],"clientBalances",e),a=await Object(u["f"])(t);this.clientBalance=a.exists()&&a.data().balance||0}catch(t){console.error("Error fetching client balance: ",t),this.clientBalance=0}},async updateClientBalance(e,t){try{const a=Object(u["e"])(c["a"],"clientBalances",e);await Object(u["r"])(a,{balance:t},{merge:!0}),this.clientBalance=t}catch(a){console.error("Error updating client balance: ",a)}},async applyClientBalanceAsAbono(){if(this.clientBalance>0&&this.products.length>0){const e=new Date;this.abonos.push({monto:this.clientBalance,fecha:e.toISOString().substr(0,10)}),await this.updateClientBalance(this.client,0),alert(`Se aplic√≥ autom√°ticamente el saldo a favor de $${this.clientBalance.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2})} como abono.`)}},async fetchNoteData(){try{const e=Object(u["e"])(c["a"],"notes",this.noteId),t=await Object(u["f"])(e);if(t.exists()){const e=t.data();this.folio=e.folio,this.client=e.client,this.currentDate=e.currentDate,this.products=e.products,this.abonos=e.abonos,this.flete=e.flete||0,this.isPaid=e.isPaid,this.creationDate=e.creationDate}else console.log("No such document!")}catch(e){console.error("Error fetching note: ",e)}},addAbono(){this.abonos.push({...this.newAbono}),this.resetAbonoForm()},resetAbonoForm(){this.newAbono={monto:null,fecha:(new Date).toISOString().substr(0,10)}},formatNumber(e){return e.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})},formatDate(e){const t={year:"numeric",month:"long",day:"numeric"};return new Date(e).toLocaleDateString("es-ES",t)},exportPDF(){const e=this.$refs.printSection,t={margin:.5,filename:`Nota_de_Venta_${this.formattedFolio}_${(new Date).toLocaleDateString()}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}},a=e.cloneNode(!0),i=a.querySelectorAll("button");i.forEach(e=>e.style.display="none");const o=a.querySelectorAll("td:nth-child(5), th:nth-child(5)");o.forEach(e=>e.style.display="none");const s=a.querySelector(".abonos-section form");s&&(s.style.display="none");const r=a.querySelector(".abonos-section h3:first-child");r&&(r.style.display="none"),d()().from(a).set(t).save()},printSection(){const e=this.$refs.printSection.cloneNode(!0),t=e.querySelectorAll("button");t.forEach(e=>e.style.display="none");const a=e.querySelectorAll("td:nth-child(5), th:nth-child(5)");a.forEach(e=>e.style.display="none");const i=e.querySelector(".abonos-section form");i&&(i.style.display="none");const o=e.querySelector(".abonos-section h3:first-child");o&&(o.style.display="none");const s=window.open("","","width=800,height=600");s.document.write("<html><head><title>Nota de Venta</title>"),s.document.write("</head><body >"),s.document.write(e.innerHTML),s.document.write("</body></html>"),s.document.close(),s.print()},startLongPress(e){this.longPressTimer=setTimeout(()=>{this.showMobileActions=!0,this.selectedProductIndex=e},500)},endLongPress(){clearTimeout(this.longPressTimer)},cancelMobileActions(){this.showMobileActions=!1,this.selectedProductIndex=null,this.editIndex=-1},confirmDeleteAbono(e){this.selectedAbonoIndex=e,this.showDeleteAbonoModal=!0},closeDeleteAbonoModal(){this.showDeleteAbonoModal=!1,this.selectedAbonoIndex=null},deleteAbono(){null!==this.selectedAbonoIndex&&(this.abonos.splice(this.selectedAbonoIndex,1),this.closeDeleteAbonoModal(),alert("Abono eliminado exitosamente"))}},async mounted(){await this.fetchClients(),this.$route.params.noteId&&(this.noteId=this.$route.params.noteId,await this.fetchNoteData(),this.client&&await this.fetchClientBalance(this.client))}},m=p,h=(a("6a8a"),a("2877")),v=Object(h["a"])(m,i,o,!1,null,"780a8e5c",null);t["default"]=v.exports},b8c3:function(e,t,a){},e227:function(e,t,a){"use strict";a("6e51")},ebeb:function(e,t,a){"use strict";a("64fd")}});